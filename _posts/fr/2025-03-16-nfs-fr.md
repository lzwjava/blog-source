---
audio: false
generated: true
lang: fr
layout: post
title: Configuration d'un serveur NFS pour le partage de médias sur Ubuntu
translated: true
type: note
---

Pour configurer un serveur NFS (Network File System) sur Ubuntu afin de partager des fichiers multimédias, suivez ces étapes détaillées. Ce guide suppose que vous souhaitez partager un répertoire contenant des fichiers multimédias (par exemple, des vidéos, de la musique) sur votre réseau de manière sécurisée et efficace.

---

### Étape 1 : Installer le logiciel serveur NFS
Vous devez d'abord installer le paquet serveur NFS sur votre système Ubuntu.

1. Mettez à jour la liste des paquets pour obtenir les dernières versions :
   ```bash
   sudo apt update
   ```

2. Installez le paquet `nfs-kernel-server`, qui fournit la fonctionnalité de serveur NFS :
   ```bash
   sudo apt install nfs-kernel-server
   ```

Cette opération installe le logiciel nécessaire pour exécuter un serveur NFS.

---

### Étape 2 : Créer et configurer le répertoire multimédia
Vous avez besoin d'un répertoire pour stocker vos fichiers multimédias et de le configurer pour le partage.

1. Créez un répertoire pour contenir vos fichiers multimédias (par exemple, `/media/share`) :
   ```bash
   sudo mkdir -p /media/share
   ```

2. Définissez le propriétaire sur votre compte utilisateur (remplacez `$USER` par votre nom d'utilisateur réel si nécessaire) :
   ```bash
   sudo chown $USER:$USER /media/share
   ```

3. Ajustez les permissions pour autoriser l'accès. Pour les fichiers multimédias qui sont principalement en lecture seule pour les clients, vous pouvez définir :
   - Répertoires : `755` (lecture et exécution pour les autres)
   - Fichiers : `644` (lecture pour les autres)
   Cependant, pour plus de simplicité, appliquez `755` de manière récursive si vous n'avez pas besoin d'un contrôle fin :
   ```bash
   sudo chmod -R 755 /media/share
   ```
   - **Note** : Les fichiers multimédias n'ont pas besoin d'être exécutables, mais `755` sur les fichiers ne nuira pas à la fonctionnalité NFS car l'exécution se fait localement sur le client.

4. Placez vos fichiers multimédias dans `/media/share` (par exemple, copiez des vidéos ou de la musique dans ce répertoire).

---

### Étape 3 : Configurer les exports NFS
Le serveur NFS utilise le fichier `/etc/exports` pour définir quels répertoires partager et qui peut y accéder.

1. Ouvrez le fichier exports avec un éditeur de texte :
   ```bash
   sudo nano /etc/exports
   ```

2. Ajoutez une ligne pour partager `/media/share`. La syntaxe est :
   ```
   /chemin/vers/répertoire client(options)
   ```
   - **Exemple 1** : Partager avec une IP client spécifique (par exemple, `192.168.1.100`) avec un accès en lecture-écriture :
     ```
     /media/share 192.168.1.100(rw,sync,no_subtree_check)
     ```
   - **Exemple 2** : Partager avec tous les appareils de votre sous-réseau (par exemple, `192.168.1.0/24`) avec un accès en lecture seule :
     ```
     /media/share 192.168.1.0/24(ro,sync,no_subtree_check)
     ```
   - **Exemple 3** : Partager avec n'importe quel appareil (moins sécurisé, à utiliser avec prudence) :
     ```
     /media/share *(rw,sync,no_subtree_check)
     ```

   **Options expliquées** :
   - `rw` : Accès en lecture-écriture (utilisez `ro` pour la lecture seule si préféré pour le streaming multimédia).
   - `sync` : Garantit que les données sont écrites sur le disque avant de confirmer les opérations (plus sûr mais plus lent ; utilisez `async` pour les performances au risque de perte de données en cas de crash).
   - `no_subtree_check` : Améliore les performances en désactivant la vérification des sous-arbres (recommandé pour la plupart des configurations).

3. Enregistrez le fichier (`Ctrl+O`, puis `Entrée` dans nano) et quittez (`Ctrl+X`).

---

### Étape 4 : Appliquer la configuration NFS
Après avoir modifié le fichier exports, mettez à jour le serveur NFS pour refléter vos changements.

1. Exportez les partages :
   ```bash
   sudo exportfs -a
   ```

2. Redémarrez le serveur NFS pour appliquer la configuration :
   ```bash
   sudo systemctl restart nfs-kernel-server
   ```

3. Vérifiez que le service est en cours d'exécution :
   ```bash
   sudo systemctl status nfs-kernel-server
   ```
   - Recherchez "active (running)" dans la sortie.

4. Vérifiez les répertoires exportés :
   ```bash
   sudo exportfs -v
   ```
   - Cela devrait lister `/media/share` avec les options que vous avez spécifiées.

---

### Étape 5 : Configurer le pare-feu
NFS utilise des ports spécifiques, et vous devez vous assurer que votre pare-feu autorise le trafic vers eux. Ubuntu utilise souvent UFW (Uncomplicated Firewall).

1. **Ports NFS par défaut** :
   - NFS : 2049 (TCP/UDP)
   - RPC : 111 (TCP/UDP)
   - Autres services (mountd, statd, lockd) : Dynamiques par défaut, mais peuvent être définis sur des ports statiques.

2. Pour plus de simplicité, autorisez les ports essentiels avec des paramètres dynamiques (si vous ne définissez pas de ports statiques) :
   ```bash
   sudo ufw allow 2049
   sudo ufw allow 111
   ```
   - **Note** : Cela peut ne pas couvrir tout le trafic NFS si mountd, statd ou lockd utilisent des ports aléatoires.

3. **Optionnel : Définir des ports statiques pour un meilleur contrôle** (recommandé pour des règles de pare-feu précises) :
   - Modifiez `/etc/default/nfs-kernel-server` :
     ```bash
     sudo nano /etc/default/nfs-kernel-server
     ```
     Ajoutez ou modifiez :
     ```
     RPCMOUNTDOPTS="-p 4001"
     ```
   - Modifiez `/etc/default/nfs-common` :
     ```bash
     sudo nano /etc/default/nfs-common
     ```
     Ajoutez ou modifiez :
     ```
     STATDOPTS="-p 4002"
     ```
   - Créez `/etc/modprobe.d/nfs.conf` pour lockd :
     ```bash
     sudo nano /etc/modprobe.d/nfs.conf
     ```
     Ajoutez :
     ```
     options lockd nlm_udp_port=4003 nlm_tcp_port=4003
     ```
   - Redémarrez le serveur NFS :
     ```bash
     sudo systemctl restart nfs-kernel-server
     ```

4. Autorisez les ports statiques dans UFW :
   ```bash
   sudo ufw allow 2049/tcp
   sudo ufw allow 2049/udp
   sudo ufw allow 111/tcp
   sudo ufw allow 111/udp
   sudo ufw allow 4001/tcp
   sudo ufw allow 4001/udp
   sudo ufw allow 4002/tcp
   sudo ufw allow 4002/udp
   sudo ufw allow 4003/tcp
   sudo ufw allow 4003/udp
   ```

5. Activez UFW s'il n'est pas déjà actif :
   ```bash
   sudo ufw enable
   ```

---

### Étape 6 : Vérifier la configuration
Assurez-vous que le serveur NFS fonctionne correctement.

1. Vérifiez les partages exportés depuis le serveur :
   ```bash
   showmount -e localhost
   ```
   - Vous devriez voir `/media/share` listé avec les clients/options corrects.

2. Vérifiez les ports en écoute :
   ```bash
   sudo ss -tuln | grep -E "2049|111|4001|4002|4003"
   ```
   - Confirmez que ces ports sont ouverts et liés aux services NFS.

---

### Étape 7 : Tester depuis un client (Optionnel)
Sur une machine cliente (par exemple, un autre système Ubuntu), testez le montage du partage :
```bash
sudo mount -t nfs <server_ip>:/media/share /mnt
```
- Remplacez `<server_ip>` par l'adresse IP de votre serveur NFS.
- Assurez-vous que `/mnt` existe (`sudo mkdir /mnt` si nécessaire).
- Accédez à `/mnt` pour vérifier que vous pouvez voir et lire les fichiers multimédias.

---

### Notes supplémentaires pour les fichiers multimédias
- **Accès en lecture seule** : Si les clients ont seulement besoin de streamer les médias, utilisez `ro` dans `/etc/exports` pour empêcher les modifications.
- **Permissions** : Assurez-vous que les fichiers multimédias sont lisibles par les clients. Les incompatibilités UID/GID entre le serveur et le client peuvent causer des problèmes d'accès ; ajustez les permissions des fichiers ou utilisez des options NFS comme `all_squash` si nécessaire (avancé).
- **Performances** : Pour les gros fichiers multimédias, l'option `sync` par défaut est sûre mais plus lente. Testez avec `async` si la performance est une priorité et que le risque de perte de données est acceptable.
- **Version NFS** : Ubuntu utilise par défaut NFSv4, qui convient pour le service de médias. Aucune configuration supplémentaire n'est généralement nécessaire, sauf pour supporter des clients plus anciens (NFSv3).

---

### Récapitulatif des commandes
Voici une référence rapide pour la configuration de base (sans ports statiques) :
```bash
sudo apt update
sudo apt install nfs-kernel-server
sudo mkdir -p /media/share
sudo chown $USER:$USER /media/share
sudo chmod -R 755 /media/share
echo "/media/share *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo ufw allow 2049
sudo ufw allow 111
```

Avec cette configuration, votre serveur NFS Ubuntu devrait être prêt à servir des fichiers multimédias sur le réseau. Ajustez les adresses IP, les permissions et les règles du pare-feu en fonction de vos exigences de sécurité et de réseau.