---
audio: false
generated: true
lang: fr
layout: post
title: Bibliothèque cffi en Python
translated: true
type: note
---

Lorsque vous exécutez votre script Python `fetch.py` avec la commande `python scripts/supabase/fetch.py`, vous avez rencontré l'erreur suivante :

```
ModuleNotFoundError: No module named '_cffi_backend'
```

Cette erreur, ainsi que le panic Rust et le traceback qui suivent, indiquent que l'interpréteur Python ne parvient pas à trouver le module `_cffi_backend`, qui est un composant essentiel de la bibliothèque `cffi`. La bibliothèque `cffi` est une dépendance du package `cryptography`, qui est lui-même utilisé par le client `supabase` dans votre script. Ci-dessous, je vais expliquer le problème et fournir une solution étape par étape pour le résoudre.

---

### Quelle est la cause de l'erreur ?

Le module `_cffi_backend` fait partie de la bibliothèque `cffi`, qui permet à Python d'interagir avec du code C. La bibliothèque `cryptography`, une dépendance à la fois de `jwt` et de `supabase`, s'appuie sur `cffi` pour effectuer des opérations cryptographiques. Le traceback montre que l'erreur se produit lorsque `cryptography` tente d'importer les liaisons Rust :

```
File "/usr/lib/python3/dist-packages/cryptography/hazmat/_oid.py", line 9, in <module>
    from cryptography.hazmat.bindings._rust import (
        ObjectIdentifier as ObjectIdentifier,
    )
pyo3_runtime.PanicException: Python API call failed
```

Le `ModuleNotFoundError` pour `_cffi_backend` suggère que `cffi` n'est pas installé, n'est pas correctement construit, ou est incompatible avec votre environnement Python. Cela déclenche un échec dans les liaisons Rust, provoquant le panic et l'arrêt de l'exécution.

---

### Comment résoudre le problème

Suivez ces étapes pour résoudre l'erreur et faire fonctionner votre script Supabase :

#### 1. **Vérifier et installer la bibliothèque `cffi`**
La bibliothèque `cffi` est peut-être manquante ou mal installée. Vérifiez sa présence et installez-la si nécessaire.

- **Vérifier si `cffi` est installé :**
  ```bash
  pip show cffi
  ```
  Cette commande affichera des informations sur le package `cffi` s'il est installé dans votre environnement Python actuel.

- **Installer ou réinstaller `cffi` :**
  Si `cffi` n'est pas installé ou s'il est potentiellement corrompu, exécutez :
  ```bash
  pip install cffi
  ```
  Pour garantir une installation propre, vous pouvez le désinstaller et le réinstaller :
  ```bash
  pip uninstall cffi
  pip install cffi
  ```

#### 2. **Installer les dépendances système**
La bibliothèque `cffi` nécessite certaines dépendances au niveau du système pour construire son backend C (`_cffi_backend`). Sur Ubuntu (d'après votre prompt `lzwjava@lzwjava-XiaoXin-14-IAH8`), installez le package `libffi-dev` :

```bash
sudo apt-get update
sudo apt-get install libffi-dev
```

Ce package fournit les fichiers de développement pour `libffi`, dont `cffi` a besoin pour compiler son backend.

#### 3. **Vérifier la version de Python et l'environnement**
Votre traceback montre des chemins comme `/home/lzwjava/.local/lib/python3.13/site-packages/` et `/usr/lib/python3/dist-packages/`, ce qui indique que vous utilisez Python 3.13 et avez potentiellement plusieurs installations de Python.

- **S'assurer que vous ciblez la bonne version de Python :**
  Exécutez votre script avec une version explicite de Python pour éviter les conflits :
  ```bash
  python3.13 scripts/supabase/fetch.py
  ```
  Utilisez la même version de Python pour l'installation des packages :
  ```bash
  python3.13 -m pip install cffi
  ```

- **Envisager d'utiliser un environnement virtuel :**
  Pour éviter les conflits entre les packages installés globalement au niveau du système et ceux de l'utilisateur, configurez un environnement virtuel :
  ```bash
  python3.13 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
  Puis exécutez votre script :
  ```bash
  python scripts/supabase/fetch.py
  ```

#### 4. **Réinstaller les packages associés**
Le client `supabase` dépend de `cryptography` et `jwt`, qui s'appuient tous deux sur `cffi`. La réinstallation de ces packages garantit leur compatibilité avec votre environnement :

```bash
pip uninstall cryptography jwt supabase
pip install cryptography jwt supabase
```

#### 5. **Vérifier la compatibilité avec Python 3.13**
Python 3.13 est une version récente, et certains packages (par exemple, `cryptography`) pourraient ne pas encore être entièrement testés avec elle. Si les problèmes persistent, envisagez de passer à une version plus stable comme Python 3.11 :

- Installer Python 3.11 (sur Ubuntu) :
  ```bash
  sudo apt-get install python3.11 python3.11-dev python3.11-venv
  ```
- Créer un environnement virtuel avec Python 3.11 :
  ```bash
  python3.11 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
- Exécuter à nouveau votre script.

#### 6. **Déboguer les problèmes persistants**
Si l'erreur persiste, recueillez plus de détails :
- Exécutez avec un backtrace Rust pour un contexte supplémentaire :
  ```bash
  RUST_BACKTRACE=1 python scripts/supabase/fetch.py
  ```
- Vérifiez votre `PYTHONPATH` pour détecter les conflits :
  ```bash
  echo $PYTHONPATH
  ```
  S'il est défini, assurez-vous qu'il n'interfère pas avec les emplacements des packages.

---

### Pourquoi cela devrait fonctionner

L'erreur provient d'une bibliothèque `cffi` manquante ou mal configurée, ce qui perturbe la capacité du package `cryptography` à charger ses liaisons Rust. En s'assurant que `cffi` est installé, que les dépendances système sont satisfaites et que votre environnement Python est cohérent, le module `_cffi_backend` devrait devenir disponible, permettant à votre script de s'exécuter avec succès.

---

### Dernières étapes
Après avoir appliqué ces correctifs, testez à nouveau votre script :
```bash
python scripts/supabase/fetch.py
```

Si vous rencontrez toujours des problèmes, partagez le nouveau message d'erreur, et nous pourrons affiner la solution. Bon codage !