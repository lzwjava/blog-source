---
audio: false
generated: true
lang: fr
layout: post
title: Utiliser la base de données H2 pour les tests
translated: true
---

Pour utiliser la base de données H2 dans un projet Spring, notamment à des fins de test, vous devez intégrer cette base de données légère et en mémoire dans votre application Spring. La base de données H2 est idéale pour les tests car elle s'exécute en mémoire, est rapide et peut être facilement configurée et démontée sans persister les données sur le disque. Ci-dessous, je vais expliquer comment incorporer H2 dans votre projet Spring, en supposant que vous utilisez Spring Boot (une configuration courante pour les projets Spring), et clarifier la référence à `com.h2database.h2`, qui fait probablement référence à la dépendance Maven plutôt qu'à un nom de package ou de classe (la classe du pilote est en réalité `org.h2.Driver`).

---

### Étape 1 : Ajouter la dépendance H2
Pour utiliser H2 dans votre projet Spring, vous devez inclure sa dépendance dans votre fichier de build. Comme vous avez mentionné `com.h2database.h2`, cela correspond aux coordonnées Maven pour l'artefact de la base de données H2. Voici comment l'ajouter :

#### Pour Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **Note** : La balise `<scope>test</scope>` garantit que H2 est disponible uniquement pendant la phase de test, ce qui convient à votre objectif de test.

#### Pour Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

Si vous utilisez Spring Boot et avez inclus des starters comme `spring-boot-starter-data-jpa` ou `spring-boot-starter-jdbc`, la gestion des dépendances de Spring Boot tirera automatiquement une version compatible de H2 lorsque vous configurez une source de données H2 pour les tests. Dans de tels cas, l'ajout explicite de la dépendance H2 est facultatif, sauf si vous avez besoin d'une version spécifique.

---

### Étape 2 : Configurer H2 comme source de données pour les tests
Dans un projet Spring Boot, vous configurez la base de données via des propriétés, généralement dans `application.properties` ou `application.yml`. Pour les tests, placez ces configurations dans `src/test/resources` pour remplacer les paramètres de l'application principale.

#### Configuration dans `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **Explication** :
  - `spring.datasource.url=jdbc:h2:mem:testdb` : Spécifie une base de données H2 en mémoire nommée `testdb`. Le mot-clé `mem` garantit que les données sont stockées en RAM.
  - `spring.datasource.driverClassName=org.h2.Driver` : La classe de pilote JDBC pour H2 (et non `com.h2database.h2`, qui est probablement une erreur ou une confusion avec l'artefact Maven).
  - `spring.datasource.username=sa` : Nom d'utilisateur H2 par défaut.
  - `spring.datasource.password=` : Mot de passe par défaut vide.

#### Configuration minimale avec auto-configuration :
Si vous utilisez Spring Boot avec `spring-boot-starter-data-jpa` ou `spring-boot-starter-jdbc` et que H2 est sur le classpath, Spring Boot peut configurer automatiquement une base de données H2 intégrée sans propriétés explicites. Il génère un nom de base de données aléatoire (par exemple, `jdbc:h2:mem:<random-uuid>`). Cependant, la spécification des propriétés ci-dessus vous donne le contrôle sur le nom de la base de données et les paramètres.

---

### Étape 3 : Utiliser H2 dans les tests
Spring Boot fournit des annotations de test pour simplifier les tests de base de données avec H2. L'approche dépend de savoir si vous testez des dépôts (tests unitaires) ou l'ensemble de la pile d'application (tests d'intégration).

#### Option 1 : Tester les dépôts avec `@DataJpaTest`
Pour tester les dépôts Spring Data JPA, utilisez l'annotation `@DataJpaTest`. Elle configure automatiquement une base de données H2 en mémoire, analyse les classes `@Entity` et configure les dépôts.

**Exemple** :
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // En supposant que les données sont chargées (par exemple, via data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **Avantages** :
  - H2 est configuré automatiquement.
  - Les tests sont transactionnels et reviennent en arrière par défaut, garantissant un état de base de données propre par test.

#### Option 2 : Tests d'intégration avec `@SpringBootTest`
Pour les tests d'intégration complète (par exemple, tester les contrôleurs, les services et les dépôts ensemble), utilisez `@SpringBootTest`. Configurez H2 via des propriétés spécifiques aux tests.

**Exemple** :
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // Tester la logique du service qui interagit avec la base de données
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **Configuration** : Utilisez le `application.properties` dans `src/test/resources` comme montré précédemment pour vous assurer que H2 est utilisé au lieu de la base de données de production.

#### Méthodes de configuration alternatives :
- **Utilisation de `@TestPropertySource`** :
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **Utilisation de profils** :
  - Créez `src/test/resources/application-test.properties` avec la configuration H2.
  - Annotez le test avec `@ActiveProfiles("test")`.

---

### Étape 4 : Initialiser les données de test (facultatif)
Pour peupler la base de données H2 avec des données de test :

- **Utilisation de `schema.sql` et `data.sql`** :
  - Placez ces fichiers dans `src/test/resources`.
  - Spring Boot exécute `schema.sql` pour créer des tables et `data.sql` pour insérer des données lorsque la base de données intégrée démarre.
  - Exemple `data.sql` :
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **Utilisation de `@Sql`** :
  - Exécutez des scripts SQL spécifiques avant ou après les méthodes de test.
  - Exemple :
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // Logique de test
    }
    ```

---

### Étape 5 : Assurer l'isolation des tests (facultatif)
Pour empêcher les méthodes de test de s'interférer entre elles :
- Utilisez `@Transactional` sur les classes ou méthodes de test. Avec `@DataJpaTest`, cela est activé par défaut, en revenant en arrière des modifications après chaque test. Pour `@SpringBootTest`, ajoutez-le explicitement si nécessaire :
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- Cela garantit que chaque test commence avec un état de base de données cohérent.

---

### Étape 6 : Émuler la base de données de production (facultatif)
Si votre base de données de production diffère (par exemple, MySQL, PostgreSQL), configurez H2 pour l'émuler en utilisant des modes de compatibilité :
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- Les modes pris en charge incluent `MySQL`, `PostgreSQL`, etc., alignant la syntaxe SQL et le comportement de H2 avec votre base de données de production.

---

### Étape 7 : Déboguer avec la console H2 (facultatif)
Pour inspecter la base de données pendant les tests :
- Activez la console H2 :
  ```properties
  spring.h2.console.enabled=true
  ```
- Accédez-y à `http://localhost:<port>/h2-console` si vous exécutez un serveur web (par exemple, avec `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- Cela est utile pour le débogage mais moins courant dans les exécutions de tests automatisées.

---

### Notes clés
- **Pilote H2** : La classe de pilote correcte est `org.h2.Driver`, et non `com.h2database.h2`. Ce dernier fait référence à l'artefact Maven `groupId:artifactId`.
- **Avantage de Spring Boot** : L'auto-configuration simplifie la configuration de H2, notamment pour les tests.
- **Nature en mémoire** : Les données de H2 sont perdues lorsque la JVM s'arrête, ce qui en fait un choix idéal pour les exécutions de tests isolées.

En suivant ces étapes, vous pouvez utiliser efficacement la base de données H2 dans votre projet Spring pour les tests, en tirant parti de sa rapidité et de sa simplicité pour valider votre couche de données ou l'ensemble de la pile d'application.