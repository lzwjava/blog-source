---
audio: false
generated: true
lang: fr
layout: post
title: Utiliser la base de données H2 pour les tests
translated: true
type: note
---

Pour utiliser la base de données H2 dans un projets Spring, particulièrement à des fins de test, vous devez intégrer cette base de données légère en mémoire dans votre application Spring. La base de données H2 est idéale pour les tests car elle s'exécute en mémoire, est rapide et peut être facilement configurée et arrêtée sans persister les données sur le disque. Ci-dessous, je vais expliquer comment intégrer H2 dans votre projet Spring, en supposant que vous utilisez Spring Boot (une configuration courante pour les projets Spring), et clarifier la référence à `com.h2database.h2`, qui fait probablement référence à la dépendance Maven plutôt qu'à un nom de package ou de classe (la classe du pilote est en réalité `org.h2.Driver`).

---

### Étape 1 : Ajouter la dépendance H2
Pour utiliser H2 dans votre projet Spring, vous devez inclure sa dépendance dans votre fichier de build. Puisque vous avez mentionné `com.h2database.h2`, cela correspond aux coordonnées Maven de l'artefact de la base de données H2. Voici comment l'ajouter :

#### Pour Maven (`pom.xml`) :
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **Note** : Le `<scope>test</scope>` garantit que H2 n'est disponible que pendant la phase de test, ce qui correspond à votre objectif de test.

#### Pour Gradle (`build.gradle`) :
```gradle
testImplementation 'com.h2database:h2'
```

Si vous utilisez Spring Boot et avez inclus des starters comme `spring-boot-starter-data-jpa` ou `spring-boot-starter-jdbc`, la gestion des dépendances de Spring Boot récupérera automatiquement une version compatible de H2 lorsque vous configurerez une source de données H2 pour les tests. Dans de tels cas, ajouter explicitement la dépendance H2 est facultatif, sauf si vous avez besoin d'une version spécifique.

---

### Étape 2 : Configurer H2 comme source de données pour les tests
Dans un projet Spring Boot, vous configurez la base de données via des propriétés, généralement dans `application.properties` ou `application.yml`. Pour les tests, placez ces configurations dans `src/test/resources` pour écraser les paramètres principaux de l'application.

#### Configuration dans `src/test/resources/application.properties` :
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **Explication** :
  - `spring.datasource.url=jdbc:h2:mem:testdb` : Spécifie une base de données H2 en mémoire nommée `testdb`. Le mot-clé `mem` garantit que les données sont stockées dans la RAM.
  - `spring.datasource.driverClassName=org.h2.Driver` : La classe du pilote JDBC pour H2 (et non `com.h2database.h2`, qui est probablement une faute de frappe ou une confusion avec l'artefact Maven).
  - `spring.datasource.username=sa` : Nom d'utilisateur par défaut de H2.
  - `spring.datasource.password=` : Mot de passe vide par défaut.

#### Configuration minimale avec l'auto-configuration :
Si vous utilisez Spring Boot avec `spring-boot-starter-data-jpa` ou `spring-boot-starter-jdbc` et que H2 est dans le classpath, Spring Boot peut auto-configurer une base de données H2 embarquée sans propriétés explicites. Il génère un nom de base de données aléatoire (par exemple, `jdbc:h2:mem:<random-uuid>`). Cependant, spécifier les propriétés ci-dessus vous donne le contrôle sur le nom de la base de données et ses paramètres.

---

### Étape 3 : Utiliser H2 dans les tests
Spring Boot fournit des annotations de test pour simplifier les tests de base de données avec H2. L'approche dépend du fait que vous testez des référentiels (tests de type unitaire) ou la pile complète de l'application (tests d'intégration).

#### Option 1 : Tester les référentiels avec `@DataJpaTest`
Pour tester les référentiels Spring Data JPA, utilisez l'annotation `@DataJpaTest`. Elle configure automatiquement une base de données H2 en mémoire, scanne les classes `@Entity` et configure les référentiels.

**Exemple** :
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // En supposant que les données sont chargées (par exemple, via data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **Avantages** :
  - H2 est configuré automatiquement.
  - Les tests sont transactionnels et reviennent en arrière par défaut, garantissant un état de base de données propre par test.

#### Option 2 : Tests d'intégration avec `@SpringBootTest`
Pour les tests d'intégration complets (par exemple, tester les contrôleurs, les services et les référentiels ensemble), utilisez `@SpringBootTest`. Configurez H2 via des propriétés spécifiques aux tests.

**Exemple** :
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // Tester la logique du service qui interagit avec la base de données
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **Configuration** : Utilisez le `application.properties` dans `src/test/resources` comme montré précédemment pour garantir que H2 est utilisé à la place de la base de données de production.

#### Méthodes de configuration alternatives :
- **Utilisation de `@TestPropertySource`** :
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **Utilisation des profils** :
  - Créez `src/test/resources/application-test.properties` avec la configuration H2.
  - Annotez le test avec `@ActiveProfiles("test")`.

---

### Étape 4 : Initialiser les données de test (Optionnel)
Pour peupler la base de données H2 avec des données de test :

- **Utilisation de `schema.sql` et `data.sql`** :
  - Placez ces fichiers dans `src/test/resources`.
  - Spring Boot exécute `schema.sql` pour créer les tables et `data.sql` pour insérer les données lorsque la base de données embarquée démarre.
  - Exemple de `data.sql` :
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **Utilisation de `@Sql`** :
  - Exécutez des scripts SQL spécifiques avant ou après les méthodes de test.
  - Exemple :
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // Logique de test
    }
    ```

---

### Étape 5 : Assurer l'isolation des tests (Optionnel)
Pour empêcher les méthodes de test d'interférer les unes avec les autres :
- Utilisez `@Transactional` sur les classes ou méthodes de test. Avec `@DataJpaTest`, ceci est activé par défaut, annulant les changements après chaque test. Pour `@SpringBootTest`, ajoutez-le explicitement si nécessaire :
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- Ceci garantit que chaque test commence avec un état de base de données cohérent.

---

### Étape 6 : Émuler la base de données de production (Optionnel)
Si votre base de données de production est différente (par exemple, MySQL, PostgreSQL), configurez H2 pour l'émuler en utilisant les modes de compatibilité :
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- Les modes pris en charge incluent `MySQL`, `PostgreSQL`, etc., alignant la syntaxe et le comportement SQL de H2 avec votre base de données de production.

---

### Étape 7 : Débogage avec la console H2 (Optionnel)
Pour inspecter la base de données pendant les tests :
- Activez la console H2 :
  ```properties
  spring.h2.console.enabled=true
  ```
- Accédez-y à l'adresse `http://localhost:<port>/h2-console` si un serveur web est en cours d'exécution (par exemple, avec `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- Ceci est utile pour le débogage mais moins courant dans les exécutions de tests automatisées.

---

### Notes clés
- **Pilote H2** : La classe correcte du pilote est `org.h2.Driver`, et non `com.h2database.h2`. Cette dernière fait référence au `groupId:artifactId` de Maven.
- **Avantage de Spring Boot** : L'auto-configuration simplifie la configuration de H2, particulièrement pour les tests.
- **Nature en mémoire** : Les données de H2 sont perdues lorsque la JVM s'arrête, ce qui la rend idéale pour des exécutions de tests isolées.

En suivant ces étapes, vous pouvez utiliser efficacement la base de données H2 dans votre projet Spring pour les tests, en tirant parti de sa vitesse et de sa simplicité pour valider votre couche de données ou la pile complète de votre application.