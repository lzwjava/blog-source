---
audio: false
generated: true
lang: ar
layout: post
title: إعداد خادم NFS لمشاركة الوسائط على أوبونتو
translated: true
type: note
---

لإعداد خادم NFS (نظام ملفات الشبكة) على أوبونتو لتقديم ملفات الوسائط، اتبع هذه الخطوات التفصيلية. يفترض هذا الدليل أنك تريد مشاركة دليل يحتوي على ملفات وسائط (مثل مقاطع الفيديو، الموسيقى) عبر شبكتك بشكل آمن وفعال.

---

### الخطوة 1: تثبيت برنامج خادم NFS
أولاً، تحتاج إلى تثبيت حزمة خادم NFS على نظام أوبونتو الخاص بك.

1. قم بتحديث قائمة الحزم لضمان الحصول على أحدث الإصدارات:
   ```bash
   sudo apt update
   ```

2. قم بتثبيت حزمة `nfs-kernel-server`، والتي توفر وظيفة خادم NFS:
   ```bash
   sudo apt install nfs-kernel-server
   ```

سيقوم هذا بتثبيت البرنامج اللازم لتشغيل خادم NFS.

---

### الخطوة 2: إنشاء وتكوين دليل الوسائط
تحتاج إلى إنشاء دليل لتخزين ملفات الوسائط الخاصة بك وتكوينه للمشاركة.

1. أنشئ دليلًا لحفظ ملفات الوسائط الخاصة بك (مثال: `/media/share`):
   ```bash
   sudo mkdir -p /media/share
   ```

2. عيّن ملكية الدليل لحساب المستخدم الخاص بك (استبدل `$USER` باسم المستخدم الفعلي إذا لزم الأمر):
   ```bash
   sudo chown $USER:$USER /media/share
   ```

3. اضبط الأذونات للسماح بالوصول. لملفات الوسائط التي تكون للقراءة فقط للعملاء، يمكنك تعيين:
   - المجلدات: `755` (قراءة وتنفيذ للآخرين)
   - الملفات: `644` (قراءة للآخرين)
   ومع ذلك، للتبسيط، طبق `755` بشكل متكرر إذا كنت لا تحتاج إلى تحكم دقيق:
   ```bash
   sudo chmod -R 755 /media/share
   ```
   - **ملاحظة**: لا تحتاج ملفات الوسائط إلى أن تكون قابلة للتنفيذ، لكن `755` على الملفات لن يضر بوظيفة NFS حيث أن التنفيذ يحدث محليًا على العميل.

4. ضع ملفات الوسائط الخاصة بك في `/media/share` (مثال: انسخ مقاطع الفيديو أو الموسيقى إلى هذا الدليل).

---

### الخطوة 3: تكوين تصديرات NFS
يستخدم خادم NFS الملف `/etc/exports` لتحديد المجلدات التي سيتم مشاركتها ومن يمكنه الوصول إليها.

1. افتح ملف exports باستخدام محرر نصوص:
   ```bash
   sudo nano /etc/exports
   ```

2. أضف سطرًا لمشاركة `/media/share`. الصيغة هي:
   ```
   /path/to/directory client(options)
   ```
   - **مثال 1**: المشاركة مع عميل بعنوان IP محدد (مثال: `192.168.1.100`) مع صلاحية قراءة-كتابة:
     ```
     /media/share 192.168.1.100(rw,sync,no_subtree_check)
     ```
   - **مثال 2**: المشاركة مع جميع الأجهزة على شبكتك الفرعية (مثال: `192.168.1.0/24`) مع صلاحية للقراءة فقط:
     ```
     /media/share 192.168.1.0/24(ro,sync,no_subtree_check)
     ```
   - **مثال 3**: المشاركة مع أي جهاز (أقل أمانًا، استخدم بحذر):
     ```
     /media/share *(rw,sync,no_subtree_check)
     ```

   **شرح الخيارات**:
   - `rw`: صلاحية قراءة-كتابة (استخدم `ro` للقراءة فقط إذا كان مفضلاً لبث الوسائط).
   - `sync`: يضمن كتابة البيانات على القرص قبل تأكيد العمليات (أكثر أمانًا ولكن أبطأ؛ استخدم `async` للأداء مع خطر فقدان البيانات في حالات التعطل).
   - `no_subtree_check`: يحسن الأداء عن طريق تعطيل فحص الشجرة الفرعية (موصى به لمعظم الإعدادات).

3. احفظ الملف (`Ctrl+O`، ثم `Enter` في nano) واخرج (`Ctrl+X`).

---

### الخطوة 4: تطبيق تكوين NFS
بعد تحرير ملف exports، قم بتحديث خادم NFS ليعكس التغييرات الخاصة بك.

1. قم بتصدير المشاركات:
   ```bash
   sudo exportfs -a
   ```

2. أعد تشغيل خادم NFS لتطبيق التكوين:
   ```bash
   sudo systemctl restart nfs-kernel-server
   ```

3. تحقق من أن الخدمة قيد التشغيل:
   ```bash
   sudo systemctl status nfs-kernel-server
   ```
   - ابحث عن "active (running)" في الناتج.

4. تحقق من المجلدات المصدرة:
   ```bash
   sudo exportfs -v
   ```
   - يجب أن يعرض `/media/share` مع الخيارات التي حددتها.

---

### الخطوة 5: تكوين الجدار الناري
يستخدم NFS منافذ محددة، وتحتاج إلى التأكد من أن الجدار الناري الخاص بك يسمح بحركة المرور إليها. غالبًا ما يستخدم أوبونتو UFW (الجدار الناري غير المعقد).

1. **منافذ NFS الافتراضية**:
   - NFS: 2049 (TCP/UDP)
   - RPC: 111 (TCP/UDP)
   - الخدمات الأخرى (mountd, statd, lockd): ديناميكية افتراضيًا، ولكن يمكن تعيينها إلى منافذ ثابتة.

2. للتبسيط، اسمح بالمنافذ الأساسية مع الإعدادات الديناميكية (إذا لم تقم بتعيين منافذ ثابتة):
   ```bash
   sudo ufw allow 2049
   sudo ufw allow 111
   ```
   - **ملاحظة**: قد لا يغطي هذا كل حركة مرور NFS إذا استخدمت mountd أو statd أو lockd منافذ عشوائية.

3. **اختياري: تعيين منافذ ثابتة لتحسين التحكم** (موصى به لقواعد جدار ناري دقيقة):
   - حرر `/etc/default/nfs-kernel-server`:
     ```bash
     sudo nano /etc/default/nfs-kernel-server
     ```
     أضف أو عدل:
     ```
     RPCMOUNTDOPTS="-p 4001"
     ```
   - حرر `/etc/default/nfs-common`:
     ```bash
     sudo nano /etc/default/nfs-common
     ```
     أضف أو عدل:
     ```
     STATDOPTS="-p 4002"
     ```
   - أنشئ `/etc/modprobe.d/nfs.conf` لـ lockd:
     ```bash
     sudo nano /etc/modprobe.d/nfs.conf
     ```
     أضف:
     ```
     options lockd nlm_udp_port=4003 nlm_tcp_port=4003
     ```
   - أعد تشغيل خادم NFS:
     ```bash
     sudo systemctl restart nfs-kernel-server
     ```

4. اسمح بالمنافذ الثابتة في UFW:
   ```bash
   sudo ufw allow 2049/tcp
   sudo ufw allow 2049/udp
   sudo ufw allow 111/tcp
   sudo ufw allow 111/udp
   sudo ufw allow 4001/tcp
   sudo ufw allow 4001/udp
   sudo ufw allow 4002/tcp
   sudo ufw allow 4002/udp
   sudo ufw allow 4003/tcp
   sudo ufw allow 4003/udp
   ```

5. فعّل UFW إذا لم يكن نشطًا بالفعل:
   ```bash
   sudo ufw enable
   ```

---

### الخطوة 6: التحقق من الإعداد
تأكد من أن خادم NFS يعمل بشكل صحيح.

1. تحقق من المشاركات المصدرة من الخادم:
   ```bash
   showmount -e localhost
   ```
   - يجب أن ترى `/media/share` مدرجًا مع العملاء/الخيارات الصحيحة.

2. تحقق من المنافذ المستمع لها:
   ```bash
   sudo ss -tuln | grep -E "2049|111|4001|4002|4003"
   ```
   - تأكد من أن هذه المنافذ مفتوحة ومربوطة بخدمات NFS.

---

### الخطوة 7: الاختبار من عميل (اختياري)
على جهاز عميل (مثال: نظام أوبونتو آخر)، اختبر تركيب المشاركة:
```bash
sudo mount -t nfs <server_ip>:/media/share /mnt
```
- استبدل `<server_ip>` بعنوان IP لخادم NFS الخاص بك.
- تأكد من وجود `/mnt` (`sudo mkdir /mnt` إذا لزم الأمر).
- الوصول إلى `/mnt` للتحقق من إمكانية رؤية وتشغيل ملفات الوسائط.

---

### ملاحظات إضافية لملفات الوسائط
- **وصول للقراءة فقط**: إذا كان العملاء يحتاجون فقط لبث الوسائط، استخدم `ro` في `/etc/exports` لمنع التعديلات.
- **الأذونات**: تأكد من إمكانية قراءة ملفات الوسائط من قبل العملاء. عدم تطابق UID/GID بين الخادم والعميل يمكن أن يسبب مشاكل في الوصول؛ اضبط أذونات الملفات أو استخدم خيارات NFS مثل `all_squash` إذا لزم الأمر (متقدم).
- **الأداء**: لملفات الوسائط الكبيرة، خيار `sync` الافتراضي آمن ولكنه أبطأ. اختبر باستخدام `async` إذا كان الأداء أولوية ومخاطر فقدان البيانات مقبولة.
- **إصدار NFS**: أوبونتو يستخدم NFSv4 افتراضيًا، وهو مناسب لتقديم الوسائط. لا حاجة عادةً لتكوين إضافي ما لم تكن تدعم عملاء قديمين (NFSv3).

---

### ملخص الأوامر
إليك مرجع سريع للإعداد الأساسي (بدون منافذ ثابتة):
```bash
sudo apt update
sudo apt install nfs-kernel-server
sudo mkdir -p /media/share
sudo chown $USER:$USER /media/share
sudo chmod -R 755 /media/share
echo "/media/share *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo ufw allow 2049
sudo ufw allow 111
```

مع هذا الإعداد، يجب أن يكون خادم NFS على أوبونتو جاهزًا لتقديم ملفات الوسائط عبر الشبكة. اضبط عناوين IP والأذونات وقواعد الجدار الناري بناءً على متطلبات الأمان والشبكة الخاصة بك.