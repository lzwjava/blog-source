---
audio: false
generated: true
image: false
lang: ar
layout: post
title: إصلاح توافق CuPy مع Python 3.13
translated: true
type: note
---

يحدث الخطأ بسبب مشكلة توافق بين `cupy` و Python 3.13، تحديدًا في وحدة `functools.py` عند محاولة تعيين السمة `__name__` على دالة أو طريقة مضمنة (built-in)، والتي لم تعد قابلة للكتابة في Python 3.13. مكتبة `cupy`، المستخدمة بشكل غير مباشر عبر `srsly` و `spacy`، هي التي تسبب هذه المشكلة. نظرًا لأن البرنامج النصي الخاص بك يحاول تنفيذ مهمة ترجمة باستخدام `spacy` والتبعيات الأخرى، فإن الخطأ يوقف التنفيذ.

إليك نهجًا تدريجيًا لحل هذه المشكلة:

### 1. **فهم سلسلة التبعيات**
- البرنامج النصي `translate_client.py` يستخدم `translate_utils.py`، والذي يستورد `spacy`.
- `spacy` تعتمد على `thinc`، والتي تعتمد على `confection`، والتي تعتمد على `srsly`.
- `srsly` تحاول استيراد `cupy` (مكتبة للحوسبة المعجلة بواسطة وحدة معالجة الرسومات)، مما يسبب الخطأ بسبب عدم التوافق مع Python 3.13.

### 2. **السبب الجذري**
- الخطأ موجود في تفاعل `cupy` مع `functools.py` الخاص بـ Python 3.13، حيث تحاول `setattr` تعديل السمة `__name__` لدالة مضمنة، وهو ما لم يعد مسموحًا به في Python 3.13.
- أدخلت Python 3.13 قواعد أكثر صرامة لتعديل السمات على الكائنات المضمنة، ولم يتم تحديث `cupy` بالكامل بعد للتعامل مع هذا التغيير.

### 3. **الحلول**
فيما يلي عدة طرق لحل المشكلة، بدءًا من الأكثر مباشرة:

#### الخيار 1: العودة إلى إصدار Python 3.12
- Python 3.13 إصدار جديد نسبيًا (تم إصداره في أكتوبر 2024)، والعديد من المكتبات، بما في ذلك `cupy`، قد لا تكون متوافقة بالكامل معه بعد.
- العودة إلى Python 3.12، وهو أكثر استقرارًا للمكتبات مثل `cupy` و `spacy`.

**الخطوات**:
1. أزل تثبيت Python 3.13 (إذا لزم الأمر، اعتمادًا على نظامك).
2. ثبّت Python 3.12 باستخدام مدير الحزم أو `pyenv`:
   ```bash
   # On Ubuntu/Debian
   sudo apt update
   sudo apt install python3.12

   # Or using pyenv
   pyenv install 3.12
   pyenv global 3.12
   ```
3. أعد إنشاء البيئة الافتراضية (إذا كنت تستخدم واحدة):
   ```bash
   python3.12 -m venv venv
   source venv/bin/activate
   ```
4. أعد تثبيت التبعيات:
   ```bash
   pip install -r requirements.txt
   ```
   أو قم بتثبيت الحزم المطلوبة يدويًا:
   ```bash
   pip install spacy srsly langdetect
   ```
5. شغّل البرنامج النصي الخاص بك مرة أخرى:
   ```bash
   python scripts/translation/translate_client.py "Hello world" --target zh --model mistral-medium --original-lang en
   ```

#### الخيار 2: تعطيل الاعتماد على CuPy
- نظرًا لأنه يتم جلب `cupy` عن طريق `srsly` (عبر `msgpack_numpy`)، ومن المرجح أن برنامج الترجمة النصي الخاص بك لا يحتاج إلى تسريع بوحدة معالجة الرسومات، يمكنك تجاوز `cupy` من خلال التأكد من أن `srsly` يستخدم نهاية خلفية (backend) قائمة على وحدة المعالجة المركزية.
- تحاول `srsly` استيراد `cupy` لتسلسل مصفوفات NumPy، ولكن من المفترض أن تعود إلى `msgpack` القياسي إذا كان `cupy` غير متاح.

**الخطوات**:
1. أزل تثبيت `cupy` لمنع استخدامه:
   ```bash
   pip uninstall cupy
   ```
2. إذا كانت `srsly` لا تزال تحاول استيراد `cupy`، قد تحتاج إلى تعديل سلوك `srsly`. إحدى الطرق هي التأكد من تثبيت `msgpack` بدون دعم `cupy`:
   ```bash
   pip install msgpack
   ```
3. إذا استمرت المشكلة، تحقق مما إذا كانت `srsly` تحتوي على خيار لتعطيل دعم وحدة معالجة الرسومات أو قم بتصحيح الاستيراد في `srsly/msgpack/_msgpack_numpy.py` لتخطي `cupy`. على سبيل المثال، قم بتحرير الملف (مثل `/home/lzw/.local/lib/python3.13/site-packages/srsly/msgpack/_msgpack_numpy.py`) وقم بتعليق استيراد `cupy`:
   ```python
   # import cupy
   ```
   استبدلها بمسار بديل أو تخطي الاستيراد بشكل شرطي:
   ```python
   try:
       import cupy
   except ImportError:
       cupy = None
   ```
4. اختبر البرنامج النصي الخاص بك مرة أخرى.

#### الخيار 3: تحديث أو تصحيح CuPy
- تحقق مما إذا كان هناك إصدار أحدث من `cupy` يدعم Python 3.13. اعتبارًا من أغسطس 2025، قد يكون `cupy` قد أصدر إصلاحًا لهذه المشكلة.
- بدلاً من ذلك، استخدم إصدارًا أوليًا أو إصدار تطوير لـ `cupy` يعالج مشكلة التوافق مع Python 3.13.

**الخطوات**:
1. حدّث `cupy`:
   ```bash
   pip install --upgrade cupy
   ```
2. إذا لم يكن هناك إصدار مستقر يدعم Python 3.13، حاول تثبيت إصدار تطوير:
   ```bash
   pip install cupy --pre
   ```
3. إذا استمرت المشكلة، تحقق من مستودع `cupy` على GitHub للبحث عن تصحيحات أو حلول بديلة خاصة بـ Python 3.13:
   [CuPy GitHub](https://github.com/cupy/cupy)

#### الخيار 4: استخدام مكتبة ترجمة بديلة
- إذا كان الهدف الأساسي من البرنامج النصي الخاص بك هو الترجمة، ففكر في تجاوز `spacy` والتبعيات الخاصة بها تمامًا باستخدام مكتبة ترجمة مختلفة لا تعتمد على `cupy` أو `srsly`.
- على سبيل المثال، استخدم `transformers` من Hugging Face أو `googletrans` لمهام الترجمة.

**الخطوات**:
1. ثبّت مكتبة بديلة:
   ```bash
   pip install transformers
   ```
2. أعد كتابة البرنامج النصي الخاص بك لاستخدام `transformers` للترجمة. مثال:
   ```python
   from transformers import pipeline

   translator = pipeline("translation", model="Helsinki-NLP/opus-mt-en-zh")
   result = translator("Hello world", max_length=40)
   print(result[0]['translation_text'])  # Should print Chinese translation
   ```
3. حدّث البرنامج النصي الخاص بك لاستبدال منطق اكتشاف اللغة والترجمة القائم على `spacy` بـ `transformers` أو مكتبة أخرى.

#### الخيار 5: عزل البيئة
- أنشئ بيئة افتراضية نظيفة لعزل التبعيات وتجنب التعارضات:
   ```bash
   python3 -m venv clean_env
   source clean_env/bin/activate
   pip install spacy langdetect
   ```
- تجنب تثبيت التبعيات غير الضرورية مثل `cupy` ما لم تكن مطلوبة.

### 4. **النهج الموصى به**
نظرًا لأن البرنامج النصي الخاص بك مخصص للترجمة ومن المرجح أنه لا يحتاج إلى تسريع بوحدة معالجة الرسومات، فمن المرجح أن يكون **الخيار 2 (تعطيل الاعتماد على CuPy)** أو **الخيار 4 (استخدام مكتبة ترجمة بديلة)** هو أسرع حل. إذا كنت بحاجة إلى `spacy` لمهام أخرى، فإن **الخيار 1 (العودة إلى إصدار Python 3.12)** هو الأكثر موثوقية، حيث أن مشكلات التوافق مع Python 3.13 قد تستمر مع `cupy` والتبعيات الخاصة به.

### 5. **ملاحظات إضافية**
- تأكد من أن `requirements.txt` أو قائمة التبعيات الخاصة بك تحدد الإصدارات بشكل صريح لتجنب جلب تحديثات غير متوافقة.
- إذا كنت تستخدم نموذج `spacy` معين (مثلًا لاكتشاف اللغة)، فتأكد من تثبيته:
  ```bash
  python -m spacy download en_core_web_sm
  ```
- إذا كان نموذج `mistral-medium` جزءًا من واجهة برمجة تطبيقات (API) خارجية أو خدمة (مثل واجهة برمجة تطبيقات xAI)، فتحقق من إمكانية الوصول إليه وتكوينه بشكل صحيح. للحصول على تفاصيل واجهة برمجة تطبيقات xAI، تحقق من:
  [xAI API](https://x.ai/api)

### 6. **الاختبار**
بعد تطبيق أحد الحلول المذكورة أعلاه، أعد تشغيل البرنامج النصي الخاص بك:
```bash
python scripts/translation/translate_client.py "Hello world" --target zh --model mistral-medium --original-lang en
```
إذا كان لا يزال فاشلاً، شارك رسالة الخطأ الجديدة أو محتويات `translate_client.py` و `translate_utils.py` لمزيد من التصحيح.

أعلمني إذا كنت بحاجة إلى مساعدة في تنفيذ أي من هذه الخطوات أو إذا واجهت أخطاء جديدة!