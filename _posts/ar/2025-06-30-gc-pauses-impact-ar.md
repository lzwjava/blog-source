---
audio: false
generated: true
lang: ar
layout: post
title: 'وقفات المهمة العامة: كلاودفلير مقابل تيدبي'
translated: true
type: note
---

نعم، يمكن أن تؤثر توقفات جامع المهمات (GC) في لغة Go على كل من خدمات Cloudflare وقاعدة بيانات TiDB، حيث يعتمد كليهما بشكل كبير على Go في بنيتهما التحتية. ومع ذلك، تختلف طبيعة وتأثير هذه التوقفات وكيفية التخفيف منها.

إليك التحليل:

**جامع المهمات في Go وخصائصه:**

* **جامع المهمات من نوع Mark-Sweep:** تستخدم Go جامع مهمات متزامن من النوع mark-sweep ثلاثي الألوان. هذا يعني أن معظم عمل GC (وضع علامة على الكائنات النشطة) يحدث بشكل متزامن مع تنفيذ التطبيق.
* **توقفات Stop-the-World (STW):** على الرغم من كونها متزامنة، لا تزال GC في Go تتطلب توقفات قصيرة "للعالم بأكمله" (STW). تحدث هذه التوقفات في مراحل محددة (مثل إعداد "وضع العلامة" الأولي والمراحل النهائية "إنهاء وضع العلامة" و"إنهاء المسح") حيث يتم إيقاف goroutines التطبيق لضمان اتساق الذاكرة. الهدف من مهندسي وقت تشغيل Go هو تقصير مدة توقفات STW هذه، عادةً ما يحافظون عليها في نطاق الميكروثانية.
* **العوامل المؤثرة على GC:** تتأثر تكرارية ومدة توقفات GC بـ:
    * **معدل التخصيص:** مدى سرعة تخصيص التطبيق للذاكرة الجديدة.
    * **حجم الكومة:** إجمالي مقدار الذاكرة التي يديرها وقت تشغيل Go.
    * **`GOGC`:** معامل يتحكم في النسبة المئوية المستهدفة لجمع المهمات (القيمة الافتراضية 100%). تشير قيمة `GOGC` الأقل إلى حدوث عمليات GC بشكل متكرر أكثر.
    * **`GOMEMLIMIT`:** معامل جديد (Go 1.19+) يحدد حدًا أعلى لحجم الكومة المستهدف، مما يساعد في منع حالات نفاد الذاكرة (OOMs) وإدارة الذاكرة بشكل أكثر قابلية للتنبؤ.

**التأثير على Cloudflare:**

تستخدم Cloudflare لغة Go على نطاق واسع في العديد من خدماتها الحرجة، بما في ذلك بنية تحتية لنظام أسماء النطاقات (DNS)، ومعالجة SSL، واختبار الحمل، والمزيد. بالنسبة لنظام عالي الأداء ومنخفض الكمون مثل Cloudflare، حتى التوقفات التي تستغرق ميكروثانية يمكن أن تكون مهمة.

* **الخدمات الحساسة للكمون:** الخدمات التي تتعامل مع معدلات طلبات عالية (مثل DNS أو التوجيه الوكيل) حساسة جدًا لارتفاعات الكمون. يمكن أن تساهم توقفات GC، حتى لو كانت قصيرة، في هذه الارتفاعات، مما يؤثر على تجربة المستخدم.
* **التطبيقات كثيفة الاستخدام للذاكرة:** قد تكون بعض خدمات Cloudflare كثيفة الاستخدام للذاكرة، مما يؤدي إلى دورات GC أكثر تكرارًا إذا لم يتم ضبطها بشكل صحيح.
* **التخفيف في Cloudflare:** يعمل مهندسو Cloudflare بنشاط على:
    * **ضبط `GOGC` و `GOMEMLIMIT`:** يجربون هذه المعاملات لتحقيق التوازن بين استخدام الذاكرة وتكرارية GC.
    * **تحليل الأداء وتحسين الكود:** تحديد وتقليل عمليات تخصيص الذاكرة غير الضرورية في كود Go الخاص بهم.
    * **تحسينات الأداء المستندة إلى التحليل (PGO):** حققت Cloudflare توفيرًا كبيرًا في وحدة المعالجة المركزية (ومن المحتمل تقليل ضغط GC) من خلال الاستفادة من ميزة PGO في Go.
    * **اعتبارات معمارية:** تصميم خدمات تكون قادرة على الصمود ضد التوقفات القصيرة، ربما من خلال وجود redundancy كاف أو عن طريق معالجة الطلبات بطريقة تقلل من تأثير توقف goroutine واحد.

**التأثير على قاعدة بيانات TiDB:**

TiDB هي قاعدة بيانات SQL موزعة تم بناؤها بواسطة PingCAP، حيث أن طبقة SQL الخاصة بها (`tidb-server`) مكتوبة بشكل أساسي بلغة Go. كقاعدة بيانات، لديها خصائص أداء ومتطلبات مختلفة مقارنة بخدمة وكيل.

* **GC خاص بقاعدة البيانات:** لدى TiDB آليات جمع مهمات خاصة بها لبيانات MVCC (التحكم في التزامن متعدد الإصدارات) (تنظيف إصدارات البيانات القديمة في TiKV، محرك التخزين الخاص بها). هذا يختلف عن GC وقت تشغيل Go، على الرغم من أن "منسق" TiDB (المكتوب بلغة Go) يبدأ هذه العملية ويديرها.
* **GC وقت تشغيل Go في TiDB:** يؤثر GC في Go *فعليًا* على TiDB لأن `tidb-server` يعالج طلبات SQL، ويدير الذاكرة لخطط الاستعلام والنتائج وبيانات وقت التشغيل الأخرى.
    * **تذبذب الكمون:** يمكن أن تؤدي توقفات STW المتكررة إلى ارتفاعات في الكمون أثناء تنفيذ الاستعلام، مما يؤثر على استجابة قاعدة البيانات.
    * **عبء وحدة المعالجة المركزية:** يستهلك نشاط GC موارد وحدة المعالجة المركزية، والتي كان من الممكن استخدامها لمعالجة الاستعلامات.
    * **تشغيل GC التكيفي:** تقوم TiDB بتشغيل GC في Go بشكل استباقي عندما يصل استخدام الذاكرة إلى حد معين (قابل للتكوين عبر `tidb_server_memory_limit` و `tidb_server_memory_limit_gc_trigger`). كما تستخدم إستراتيجية تكيفية لـ `tidb_server_memory_limit_gc_trigger` لتجنب عمليات GC المفرطة التكرار.
* **المراقبة والضبط:** توفر PingCAP أدوات مراقبة شاملة (مثل TiDB Runtime Dashboard) لمراقبة سلوك GC في Go (تكرارية GC، المدة، كمون STW، وقت وحدة المعالجة المركزية المستغرق في GC) وتسمح للمستخدمين بتكوين `GOGC` و `GOMEMLIMIT` لتحسين الأداء.
* **الجهود المستمرة:** يواصل مهندسو PingCAP العمل على تحسين إدارة ذاكرة Go في TiDB وسلوك GC لتقليل تأثيره على الأداء والاستقرار.

**باختصار:**

كل من Cloudflare و TiDB، بصفهما أنظمة عالية الأداء تعتمدان على Go، معرضان لتأثيرات توقفات GC في Go. بينما تم تحسين GC في Go للحصول على فترات STW قصيرة، على نطاق واسع، يمكن أن تساهم هذه التوقفات في ارتفاعات الكمون وعبء وحدة المعالجة المركزية. تراقب كلتا الشركتين وتضبطان وتحسنان تطبيقاتهما وبناهما التحتية الخاصة بـ Go للتخفيف من هذه الآثار، مستفيدتين من معاملات وقت تشغيل Go وتصميماتهما المعمارية الخاصة.