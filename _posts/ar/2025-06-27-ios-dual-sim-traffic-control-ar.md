---
audio: false
generated: true
lang: ar
layout: post
title: إدارة توجيه حركة المرور لشريحتي اتصال على iOS مع مراعاة الجدار الناري العظيم
translated: true
type: note
---

يوفر iOS واجهات برمجة تطبيقات تتيح لك إدارة وفصل حركة المرور على الشبكة لخطط بيانات خلوية مختلفة عند استخدام وظيفة Dual SIM، ولكن هناك قيود، والتحكم المباشر في توجيه حركة مرور محددة إلى بطاقات SIM محددة بناءً على قيود الجدار الناري العظيم في الصين (GFW) غير مدعوم أصلاً على مستوى تفصيلي. ومع ذلك، باستخدام مزيج من واجهات برمجة تطبيقات iOS، والتكوين اليدوي، والأدوات الخارجية المحتملة، يمكنك تحقيق قدر من الفصل للتعامل مع حركة المرور بشكل مختلف لبطاقة SIM من ماكو وبطاقة China Telecom. أدناه، سأوضح واجهات برمجة التطبيقات ذات الصلة، والتكوينات، والاعتبارات، بما في ذلك كيفية معالجة التحديات المتعلقة بـ GFW.

### واجهات برمجة تطبيقات iOS الرئيسية والميزات لإدارة Dual SIM وحركة المرور

1. **إطار عمل CoreTelephony**:
   - **الغرض**: يوفر الوصول إلى المعلومات ذات الصلة بالشبكة الخلوية والتكوين لأجهزة Dual SIM.
   - **الفئات الرئيسية**:
     - `CTCellularPlanProvisioning`: يسمح لك بإضافة أو إدارة خطط الخدمة الخلوية (مثل eSIM أو بطاقة SIM فعلية).
     - `CTTelephonyNetworkInfo`: يوفر معلومات حول خطط الخدمة الخلوية المتاحة وخصائصها، مثل اسم الشركة المزودة للخدمة، ورمز الدولة النقال (MCC)، ورمز الشبكة النقالة (MNC).
     - `CTCellularData`: يراقب استخدام بيانات الشبكة الخلوية وحالة الشبكة (مثل ما إذا كانت بيانات الشبكة الخلوية ممكّنة).
   - **القيود**: يسمح لك CoreTelephony بالاستعلام عن خطط الخدمة الخلوية وإدارتها ولكنه لا يوفر تحكمًا مباشرًا في توجيه حركة مرور تطبيق معين إلى بطاقة SIM محددة. يمكنك اكتشاف بطاقة SIM النشطة للبيانات ولكن لا يمكنك تعيين حركة مرور محددة (مثل لتطبيق أو وجهة معينة) برمجيًا إلى بطاقة SIM على مستوى واجهة برمجة التطبيقات.

2. **إطار عمل NetworkExtension**:
   - **الغرض**: يمكّن من التكوين المتقدم للشبكة، مثل إنشاء شبكات VPN مخصصة أو إدارة قواعد حركة مرور الشبكة.
   - **الميزات الرئيسية**:
     - **NEVPNManager**: يسمح لك بتكوين وإدارة اتصالات VPN، والتي يمكن استخدامها لتوجيه حركة المرور عبر خادم معين لتجاوز قيود GFW.
     - **NEPacketTunnelProvider**: لإنشاء أنفاق VPN مخصصة، والتي يمكن تكوينها لتوجيه حركة مرور محددة عبر بطاقة SIM من ماكو لتجنب قيود GFW.
   - **حالة الاستخدام لـ GFW**: من خلال إعداد VPN على بطاقة SIM من ماكو (والتي لا تخضع لرقابة GFW، حيث أن شبكات ماكو مستقلة)، يمكنك توجيه حركة المرور عبر خادم خارج الصين القارية للوصول إلى خدمات محظورة مثل Google أو WhatsApp أو YouTube.
   - **القيود**: عادةً ما يتم تطبيق تكوينات VPN على مستوى النظام، وليس لكل بطاقة SIM. ستحتاج إلى التبديل يدويًا لبطاقة SIM النشطة للبيانات أو استخدام حل VPN مخصص لتوجيه حركة المرور بشكل انتقائي.

3. **تكوين Dual SIM (المعتمد على الإعدادات)**:
   - يدعم iOS Dual SIM Dual Standby (DSDS) على أجهزة iPhone المتوافقة (مثل iPhone XS أو XR أو الأحدث المشتراة في مناطق مثل ماكو أو هونغ كونغ، والتي تدعم Dual SIM ببطاقتي nano-SIM أو eSIM). هذا يسمح لك بـ:
     - تعيين بطاقة SIM افتراضية للبيانات الخلوية (الإعدادات > خلوية > بيانات الخلوية).
     - تمكين "السماح بتبديل بيانات الخلوية" للتبديل تلقائيًا بين بطاقات SIM بناءً على التغطية أو التوفر (الإعدادات > خلوية > بيانات الخلوية > السماح بتبديل بيانات الخلوية).
     - تسمية بطاقات SIM (مثال: "بطاقة SIM من ماكو" للوصول غير المقيد، "China Telecom" للخدمات المحلية) وتحديد يدويًا أي بطاقة SIM تتعامل مع البيانات لمهام محددة.
   - **فصل حركة المرور يدويًا**: يمكنك التبديل يدويًا لبطاقة SIM النشطة للبيانات في الإعدادات لتوجيه جميع حركة المرور الخلوية إما عبر بطاقة SIM من ماكو (لتجاوز GFW) أو عبر بطاقة SIM من China Telecom (للخدمات المحلية الخاضعة لـ GFW). ومع ذلك، لا يوفر iOS واجهة برمجة تطبيقات لتوجيه حركة المرور ديناميكيًا إلى بطاقة SIM محددة بناءً على التطبيق أو الوجهة دون تدخل المستخدم.

4. **VPN لكل تطبيق (NetworkExtension)**:
   - يدعم iOS تكوينات VPN لكل تطبيق عبر فئات `NEAppProxyProvider` أو `NEAppRule` في إطار عمل NetworkExtension، تُستخدم عادةً في إعدادات المؤسسات (مثل Managed App Configurations).
   - **حالة الاستخدام**: يمكنك تكوين VPN لكل تطبيق لتوجيه حركة المرور من تطبيقات محددة (مثل YouTube أو Google) عبر نفق VPN باستخدام اتصال بيانات بطاقة SIM من ماكو لتجاوز قيود GFW، بينما تستخدم التطبيقات الأخرى بطاقة SIM من China Telecom للخدمات المحلية.
   - **المتطلبات**: هذا يتطلب تطبيق VPN مخصص أو حل إدارة جهاز محمول (MDM) للمؤسسات، وهو معقد التنفيذ للمطورين الأفراد. بالإضافة إلى ذلك، ستحتاج إلى التأكد من تعيين بطاقة SIM من ماكو كبطاقة SIM نشطة للبيانات عند استخدام VPN.

5. **URLSession والشبكات المخصصة**:
   - تتيح واجهة برمجة تطبيقات `URLSession` تكوين طلبات الشبكة بواجهات خلوية محددة باستخدام `allowsCellularAccess` أو عن طريق الربط بواجهة شبكة محددة.
   - **حالة الاستخدام**: يمكنك برمجيًا تعطيل الوصول الخلوي لطلبات معينة (إجبارها على استخدام Wi-Fi أو واجهة أخرى) أو استخدام VPN لتوجيه حركة المرور. ومع ذلك، لا يتم دعم ربط طلبات محددة بواجهة خلوية لبطاقة SIM معينة مباشرة؛ ستحتاج إلى الاعتماد على إعداد بطاقة SIM النشطة للبيانات في النظام.
   - **الحل البديل**: اجمع بين `URLSession` و VPN مُكون لاستخدام بيانات بطاقة SIM من ماكو لتوجيه حركة المرور إلى خوادم خارج الصين.

### التعامل مع قيود GFW باستخدام Dual SIMs

يحظر الجدار الناري العظيم في الصين (GFW) الوصول إلى العديد من المواقع والخدمات الأجنبية (مثل Google أو YouTube أو WhatsApp) عند استخدام شركات الاتصالات الصينية القارية مثل China Telecom، حيث يتم توجيه حركة مرورها عبر البنية التحتية الصينية التي تخضع للرقابة. في المقابل، تقوم بطاقة SIM من ماكو (مثل من CTM أو Three Macao) بتوجيه حركة المرور عبر شبكات ماكو المستقلة، والتي لا تخضع لرقابة GFW (باستثناء China Telecom Macao، التي تفرض قيود GFW). إليك كيف يمكنك الاستفادة من هذا باستخدام بطاقة SIM من ماكو وبطاقة SIM من China Telecom:

1. **بطاقة SIM من ماكو للوصول غير المقيد**:
   - استخدم بطاقة SIM من ماكو كخطة البيانات الخلوية الافتراضية للتطبيقات أو الخدمات المحظورة بواسطة GFW (مثل Google أو YouTube).
   - **التكوين**:
     - انتقل إلى الإعدادات > خلوية > بيانات الخلوية وحدد بطاقة SIM من ماكو.
     - تأكد من تمكين التجوال البيانات لبطاقة SIM من ماكو عند التواجد في الصين القارية، حيث ستقوم بتوجيه حركة المرور عبر شبكة ماكو، متجاوزةً GFW.
     - اختياريًا، قم بتكوين VPN (باستخدام `NEVPNManager` على سبيل المثال) لتأمين حركة المرور بشكل أكبر، على الرغم من أن بطاقة SIM من ماكو لا تحتاج عادةً إلى VPN للوصول إلى الخدمات المحظورة.
   - **دعم واجهة برمجة التطبيقات**: استخدم `CTTelephonyNetworkInfo` لتأكيد أن بطاقة SIM من ماكو نشطة للبيانات (خاصية `dataServiceIdentifier`) ومراقبة حالتها.

2. **بطاقة SIM من China Telecom للخدمات المحلية**:
   - استخدم بطاقة SIM من China Telecom للتطبيقات والخدمات المحلية (مثل WeChat أو Alipay) التي تتطلب رقم هاتف صيني أو مُحسّنة للشبكات القارية.
   - **التكوين**:
     - بدّل يدويًا إلى بطاقة SIM من China Telecom في الإعدادات > خلوية > بيانات الخلوية عند الوصول إلى الخدمات المحلية.
     - كن على علم بأن حركة المرور على هذه البطاقة SIM ستخضع لقيود GFW، مما يمنع الوصول إلى العديد من المواقع الأجنبية ما لم يتم استخدام VPN.
   - **دعم واجهة برمجة التطبيقات**: استخدم `CTCellularData` لمراقبة استخدام بيانات الشبكة الخلوية والتأكد من أن بطاقة SIM الصحيحة نشطة. يمكنك أيضًا استخدام `NEVPNManager` لتكوين VPN لتطبيقات محددة لتجاوز GFW على بطاقة SIM من China Telecom، على الرغم من أن موثوقية VPN في الصين غير متسقة بسبب الحظر النشط.

3. **سير العمل العملي لفصل حركة المرور**:
   - **التبديل اليدوي**: للبساطة، قم بتبديل بطاقة SIM النشطة للبيانات في الإعدادات بناءً على المهمة (مثل بطاقة SIM من ماكو للتطبيقات الدولية، وبطاقة SIM من China Telecom للتطبيقات المحلية). هذا هو النهج الأكثر مباشرة ولكنه يتطلب تدخل المستخدم.
   - **VPN لبطاقة SIM من China Telecom**: إذا كنت بحاجة إلى الوصول إلى الخدمات المحظورة أثناء استخدام بطاقة SIM من China Telecom، فقم بتكوين VPN باستخدام `NEVPNManager`. لاحظ أن العديد من شبكات VPN (مثل ExpressVPN أو NordVPN) قد تكون غير موثوقة في الصين بسبب حظر GFW، لذا اختبر مقدمي خدمات مثل Astrill أو الحلول المخصصة مسبقًا. تقدم بعض مقدمي خدمات eSIM (مثل Holafly أو ByteSIM) شبكات VPN مدمجة يمكن تفعيلها لتجاوز القيود.
   - **VPN لكل تطبيق**: للاستخدام المتقدم، قم بتطوير تطبيق مخصص باستخدام `NEAppProxyProvider` لتوجيه حركة مرور تطبيق معين عبر VPN عندما تكون بطاقة SIM من China Telecom نشطة، بينما تسمح للتطبيقات الأخرى باستخدام بطاقة SIM من ماكو مباشرة.
   - **قيود الأتمتة**: لا يوفر iOS واجهة برمجة تطبيقات للتبديل البرمجي لبطاقة SIM النشطة للبيانات بناءً على التطبيق أو عنوان URL الوجهة. ستحتاج إلى الاعتماد على التبديل اليدوي لبطاقة SIM من قبل المستخدم أو استخدام VPN لإدارة توجيه حركة المرور.

### خطوات تنفيذ فصل حركة المرور

1. **إعداد Dual SIM**:
   - تأكد من أن جهاز iPhone الخاص بك يدعم Dual SIM (مثل iPhone XS أو الأحدث مع iOS 12.1 أو الأحدث).
   - أدخل بطاقة SIM من ماكو وبطاقة SIM من China Telecom (أو قم بتكوين eSIM لأحدهما).
   - انتقل إلى الإعدادات > خلوية، وقم بتسمية الخطط (مثال: "ماكو" و "China Telecom")، وقم بتعيين بطاقة SIM الافتراضية للبيانات (مثال: ماكو للوصول غير المقيد).

2. **تكوين إعدادات بيانات الخلوية**:
   - عطّل "السماح بتبديل بيانات الخلوية" لمنع التبديل التلقائي لبطاقات SIM، مما يمنحك تحكمًا يدويًا في بطاقة SIM المستخدمة للبيانات (الإعدادات > خلوية > بيانات الخلوية > السماح بتبديل بيانات الخلوية).
   - استخدم `CTTelephonyNetworkInfo` للتحقق برمجيًا من بطاقة SIM النشطة للبيانات في تطبيقك.

3. **تنفيذ VPN لتجاوز GFW**:
   - لبطاقة SIM من China Telecom، قم بتكوين VPN باستخدام `NEVPNManager` أو تطبيق VPN تابع لجهة خارجية (مثل Astrill أو VPN المدمج في Holafly) لتجاوز قيود GFW.
   - لبطاقة SIM من ماكو، قد لا تكون VPN ضرورية، حيث يتم توجيه حركة مرورها خارج البنية التحتية الصينية التي تخضع للرقابة.

4. **مراقبة وإدارة حركة المرور**:
   - استخدم `CTCellularData` لمراقبة استخدام بيانات الشبكة الخلوية والتأكد من استخدام بطاقة SIM الصحيحة.
   - للتوجيه المتقدم، استكشف `NEPacketTunnelProvider` لإنشاء VPN مخصصة تقوم بتوجيه حركة المرور بشكل انتقائي بناءً على التطبيق أو الوجهة، على الرغم من أن هذا يتطلب جهدًا تطويريًا كبيرًا.

5. **الاختبار والتحسين**:
   - اختبر الاتصال في الصين القارية باستخدام كلتا بطاقتي SIM للتأكد من أن بطاقة SIM من ماكو تتجاوز GFW كما هو متوقع وأن بطاقة SIM من China Telecom تعمل مع الخدمات المحلية.
   - تحقق من أداء VPN على بطاقة SIM من China Telecom، حيث أن GFW يحظر بنشاط العديد من بروتوكولات VPN.

### القيود والتحديات

- **لا توجد واجهة برمجة تطبيقات أصلية للتوجيه الديناميكي لبطاقة SIM**: لا يوفر iOS واجهة برمجة تطبيقات لتوجيه حركة المرور ديناميكيًا إلى بطاقة SIM محددة بناءً على التطبيق أو عنوان URL أو الوجهة. يجب عليك التبديل يدويًا لبطاقة SIM النشطة للبيانات أو استخدام VPN لإدارة حركة المرور.
- **حظر GFW لشبكات VPN**: يحظر GFW بنشاط العديد من بروتوكولات VPN (مثل IPsec أو PPTP)، وحتى شبكات VPN القائمة على SSL قد تكون محدودة السرعة إذا تم اكتشافها. غالبًا ما تكون بطاقة SIM من ماكو أكثر موثوقية لتجاوز GFW بدون VPN.
- **قيود بطاقة SIM من China Telecom**: قد يكون لشبكة China Telecom القائمة على CDMA مشاكل توافق مع بعض الهواتف الأجنبية، على الرغم من أن شبكتها LTE/5G أكثر توافقًا على نطاق واسع. بالإضافة إلى ذلك، تخضع حركة مرورها لرقابة GFW، مما يتطلب VPN للخدمات المحظورة.
- **التسجيل بالاسم الحقيقي**: قد تتطلب كل من بطاقة SIM من ماكو و China Telecom التسجيل بالاسم الحقيقي (مثل تفاصيل جواز السفر)، مما قد يعقّب الإعداد.
- **الأداء**: قد يؤدي التجوال على بطاقة SIM من ماكو في الصين القارية إلى سرعات أبطأ مقارنة ببطاقة SIM محلية من China Telecom، خاصة في المناطق الريفية.

### التوصيات

- **الاستراتيجية الأساسية**: استخدم بطاقة SIM من ماكو كخطة البيانات الخلوية الافتراضية للوصول إلى الخدمات المحظورة، حيث تتجاوز GFW بشكل طبيعي عن طريق توجيه حركة المرور عبر شبكات ماكو غير الخاضعة للرقابة. انتقل إلى بطاقة SIM من China Telecom للتطبيقات المحلية مثل WeChat أو Alipay التي تتطلب رقمًا صينيًا أو مُحسّنة للشبكات القارية.
- **VPN كنسخة احتياطية**: لبطاقة SIM من China Telecom، استخدم موفر VPN موثوق (مثل Astrill، أو eSIMs مع VPN مدمج مثل Holafly أو ByteSIM) للوصول إلى الخدمات المحظورة. قم بتثبيت VPN مسبقًا واختباره قبل الدخول إلى الصين، حيث قد يكون تنزيل تطبيقات VPN في الصين مقيدًا.
- **جهد التطوير**: إذا كنت تقوم ببناء تطبيق، فاستخدم `NetworkExtension` لتنفيذ VPN مخصصة لتوجيه حركة المرور الانتقائية، ولكن لاحظ أن هذا معقد وقد يتطلب أذونات على مستوى المؤسسة. بالنسبة لمعظم المستخدمين، يكون التبديل اليدوي لبطاقة SIM مع VPN كافياً.
- **الإعداد قبل السفر**: قم بشراء وتفعيل كلتا بطاقتي SIM (أو eSIMs) قبل الوصول إلى الصين، حيث قد تقيد السياسات المحلية شراء eSIMs في الصين القارية. على سبيل المثال، يسمح مقدمون مثل Nomad أو Holafly بالشراء المسبق وتفعيل eSIMs مع تجاوز GFW مدمج.

### مثال على snippet كود

أدناه مثال أساسي لاستخدام `CTTelephonyNetworkInfo` للتحقق من خطة الخدمة الخلوية النشطة و `NEVPNManager` لتكوين VPN لبطاقة SIM من China Telecom:

```swift
import CoreTelephony
import NetworkExtension

// التحقق من خطة الخدمة الخلوية النشطة
func checkActiveCellularPlan() {
    let networkInfo = CTTelephonyNetworkInfo()
    if let dataService = networkInfo.serviceCurrentRadioAccessTechnology {
        for (serviceIdentifier, rat) in dataService {
            print("Service: \(serviceIdentifier), Radio Access Technology: \(rat)")
            // تحديد بطاقة SIM النشطة (مثال: ماكو أو China Telecom)
        }
    }
}

// تكوين VPN لبطاقة SIM من China Telecom
func setupVPN() {
    let vpnManager = NEVPNManager.shared()
    vpnManager.loadFromPreferences { error in
        if let error = error {
            print("Failed to load VPN preferences: \(error)")
            return
        }
        
        let vpnProtocol = NEVPNProtocolIKEv2()
        vpnProtocol.serverAddress = "vpn.example.com" // استبدل بخادم VPN الخاص بك
        vpnProtocol.remoteIdentifier = "vpn.example.com"
        vpnProtocol.authenticationMethod = .certificate // قم بالتكوين كما هو مطلوب
        
        vpnManager.protocolConfiguration = vpnProtocol
        vpnManager.isEnabled = true
        
        vpnManager.saveToPreferences { error in
            if let error = error {
                print("Failed to save VPN preferences: \(error)")
            } else {
                print("VPN configured successfully")
            }
        }
    }
}
```

### الخلاصة

بينما لا تقدم iOS واجهة برمجة تطبيقات أصلية لتوجيه حركة المرور ديناميكيًا إلى بطاقات SIM محددة بناءً على التطبيق أو الوجهة، يمكنك تحقيق فصل حركة المرور عن طريق:
1. استخدام بطاقة SIM من ماكو للوصول غير المقيد لتجاوز GFW بدون VPN.
2. استخدام بطاقة SIM من China Telecom للخدمات المحلية، مقترنة بـ VPN (مكون عبر `NEVPNManager` أو تطبيق تابع لجهة خارجية) للوصول إلى الخدمات المحظورة.
3. التبديل يدويًا لبطاقة SIM النشطة للبيانات في الإعدادات لمهام مختلفة.
4. اختياريًا، تطوير حل VPN مخصص مع `NetworkExtension` لتوجيه حركة المرور لكل تطبيق، على الرغم من أن هذا معقد.

للنهج الأبسط، اعتمد على بطاقة SIM من ماكو للخدمات المحظورة بواسطة GFW وانتقل إلى بطاقة SIM من China Telecom للاحتياجات المحلية، مع التثبيت المسبق لـ VPN موثوق للأخيرة. دائمًا اختبر التكوينات قبل السفر إلى الصين، حيث يمكن أن تتغير سياسات GFW وموثوقية VPN بسرعة.

إذا كنت بحاجة إلى مزيد من التوضيح أو المساعدة في تنفيذ واجهات برمجة تطبيقات محددة، دعني أعلم!