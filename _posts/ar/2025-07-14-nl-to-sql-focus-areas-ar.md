---
audio: false
generated: true
lang: ar
layout: post
title: بناء أنظمة دقيقة وآمنة للغة الطبيعية إلى إس كيو إل
translated: true
type: note
---

### المجالات الرئيسية للتركيز عند بناء نظام NL-to-SQL

يتضمن بناء نظام للترجمة من اللغة الطبيعية إلى SQL تحويل استفسارات المستخدم باللغة اليومية إلى عبارات SQL قابلة للتنفيذ، غالبًا باستخدام نماذج الذكاء الاصطناعي مثل النماذج اللغوية الكبيرة (LLMs) (مثل متغيرات GPT أو نماذج متخصصة مثل تلك من Hugging Face). بناءً على مخطط PostgreSQL والاستعلام المثال المقدمين، إليك المجالات الرئيسية التي يجب التركيز عليها:

#### 1. **الدقة وفهم المخطط**
   - **الوعي بالمخطط**: قدم دائمًا مخطط قاعدة البيانات الكامل (الجداول، الأعمدة، أنواع البيانات، العلاقات) في الموجه (prompt) الموجه للذكاء الاصطناعي. هذا يساعد النموذج على إنشاء SQL صحيح. في حالتك، ركز على أعمدة مثل `first_name`، `created_at`، `date_of_birth`، و`last_login` لتجنب الهلوسة (مثل اختراع حقول غير موجودة).
   - **معالجة الغموض**: اللغة الطبيعية غامضة — على سبيل المثال، "حوالي اليوم من الشهر الماضي" يمكن أن تعني ±1 يوم، ولكن قم بتوضيح ذلك عبر الموجهات لتفسير المصطلحات الضبابية (مثل تفسير "الأسبوع الأخير" على أنه 7 أيام). استخدم أمثلة في الموجهات لتوجيه التفسيرات.
   - **أنواع البيانات والدوال**: ركز على بناء الجملة المحدد لـ PostgreSQL، مثل استخدام `AGE()` للتواريخ، و`ILIKE` للسلاسل غير الحساسة لحالة الأحرف، والتحويل الصحيح للنوع (مثل `CAST(created_at AS DATE)` في مثالك). درب النموذج أو اضبطه بدقة على اختلافات لهجات SQL.
   - **الحالات المتطرفة**: تعامل مع الاستعلامات المعقدة مثل الـ joins (إذا كانت هناك جداول متعددة)، والتجميعات (مثل COUNT, SUM)، أو الاستعلامات الفرعية. اختبر الاستعلامات التي تتضمن حقولاً حساسة مثل `password_hash` أو `account_balance`.

#### 2. **الأداء والتحسين**
   - أنشئ SQL فعالاً: شجع النموذج على استخدام الفهارس (مثل الفهرس على `created_at` أو `first_name`)، وحدد النتائج (أضف `LIMIT` افتراضيًا)، وتجنب فحص الجدول بالكامل.
   - قابلية التوسع: لمجموعات البيانات الكبيرة، قم بدمج أدوات تحسين الاستعلامات أو تحقق من صحة SQL المُنشأ مقابل خطة التنفيذ (explain plan).

#### 3. **معالجة الأخطاء والتحقق**
   - اتحلل وتحقق من صحة SQL المُنشأ قبل التنفيذ (على سبيل المثال، باستخدام مكتبة محلل SQL مثل `sqlparse` في Python).
   - قدم استجابات احتياطية: إذا كان الاستعلام غير واضح، فاطلب من المستخدم التوضيح بدلاً من إنشاء SQL غير صالح.

#### 4. **الأمان والسلامة**
   - **منع حقن SQL**: يأتي الخطر من تنفيذ SQL المُنشأ. لا تقم مطلقًا بربط إدخال المستخدم مباشرة في سلاسل SQL. بدلاً من ذلك:
     - استخدم **استعلامات معلمة** أو عبارات مُعدة مسبقًا عند التنفيذ (على سبيل المثال، في Python باستخدام `psycopg2`: `cursor.execute("SELECT * FROM users WHERE first_name = %s", (name,))`).
     - أرشد الذكاء الاصطناعي لإنشاء SQL يحتوي على عناصر نائبة (مثل `WHERE first_name ILIKE %s`) واربط القيم بشكل منفصل.
     - نظف مدخلات اللغة الطبيعية: قم بمعالجة مسبقة لاستفسارات المستخدم لإزالة الأنماط الضارة (على سبيل المثال، استخدام regex لاكتشاف كلمات SQL رئيسية مثل "DROP" أو ";").
     - اقتصر على القراءة فقط: قصر الذكاء الاصطناعي على إنشاء استعلامات SELECT فقط — امنع DDL (مثل CREATE/DROP) أو DML (مثل INSERT/UPDATE) عبر تعليمات الموجه مثل "قم بإنشاء عبارات SELECT فقط؛ لا تقم بتعديل البيانات."
   - **التحكم في الوصول إلى البيانات**:
     - **أمان مستوى الصف (RLS)**: في PostgreSQL، قم بتمكين سياسات RLS على الجداول (مثال: `ALTER TABLE users ENABLE ROW LEVEL SECURITY; CREATE POLICY user_policy ON users USING (role = current_user);`). يضمن هذا أن تعيد الاستعلامات فقط الصفوف التي يملك المستخدم صلاحية الوصول إليها.
     - **وجهات النظر والأدوار**: أنشئ وجهات نظر مقيدة (مثال: `CREATE VIEW safe_users AS SELECT id, username, first_name FROM users;`) وامنح الوصول عبر أدوار قاعدة البيانات. يجب على الذكاء الاصطناعي الاستعلام من وجهات النظر بدلاً من الجداول الأساسية.
     - **طبقة API**: غلف النظام في واجهة برمجة تطبيقات (API) (مثل استخدام FastAPI) تقوم بمصادقة المستخدمين وتطبيق ضوابط الوصول (مثل رموز JWT لتحديد أدوار المستخدمين).
     - **التنفيذ في بيئة معزولة**: شغل الاستعلامات في قاعدة بيانات نسخة متماثلة للقراءة فقط أو في بيئة معزولة (مثل Docker) لعزلها عن بيانات الإنتاج.
     - **تدقيق السجلات**: سجل جميع استعلامات SQL المُنشأة والعمليات المنفذة للرصد.
   - **خصوصية البيانات**: تجنب عرض الأعمدة الحساسة (مثل `password_hash`، `email`) من خلال وضعها في القائمة السوداء في الموجهات: "لا تختار الحقول الحساسة مثل password_hash، email إلا إذا كانت مطلوبة صراحةً ومصرحًا بها."
   - **تحديد معدل الاستخدام والحصص**: امنع إساءة الاستخدام عن طريق تحديد عدد الاستعلامات لكل مستخدم/جلسة.

#### 5. **هندسة الموجهات للتحويل المضبوط**
   - تعتمد جودة NL-to-SQL بشكل كبير على كيفية توجيهك للذكاء الاصطناعي. استخدم الموجهات المنظمة التي تحتوي على هذه العناصر:
     - **قالب الموجه النظامي**:
       ```
       أنت مولد SQL خبير لـ PostgreSQL. بالنظر إلى المخطط أداه واستعلام باللغة الطبيعية، قم بإنشاء استعلام SELECT آمن ودقيق.

       المخطط:
       [أدخل المخطط الكامل هنا، مثال: CREATE TABLE users (...)]

       القواعد:
       - قم بإنشاء عبارات SELECT فقط. لا تقم بإنشاء INSERT, UPDATE, DELETE, أو DDL.
       - استخدم عناصر نائبة معلمة (مثل %s) للقيم المقدمة من المستخدم لمنع الحقن.
       - تعامل مع التواريخ باستخدام دوال PostgreSQL مثل AGE(), CURRENT_DATE, INTERVAL.
       - للمصطلحات الغامضة (مثل "حوالي الشهر الماضي"), فسرها كـ [قاعدة محددة، مثال: ±1 يوم من نفس اليوم من الشهر الماضي].
       - حدد النتائج إلى 100 صف ما لم يُحدد خلاف ذلك.
       - إذا تضمن الاستعلام العمر، احسبه اعتبارًا من السنة الحالية أو سنة محددة (مثال: EXTRACT(YEAR FROM AGE(CURRENT_DATE, date_of_birth)) = 20).
       - لا تختار أعمدة حساسة مثل password_hash, email.
       - إذا كان الاستعلام غير واضح، رد بـ "Clarify: [سؤال]".

       استعلام المستخدم: [استبحث باللغة الطبيعية]
       ```
     - **أمثلة في الموجهات**: ضمّن 2-3 أمثلة توضيحية، مثل الاستعلام المُقدم و SQL المُنشأ، لتوجيه النموذج.
     - **سلسلة التفكير**: أرشد النموذج للتفكير خطوة بخطوة: "أولاً، حدد عوامل التصفية الرئيسية. ثانيًا، ارسم خريطة للأعمدة. ثالثًا، ابني بند WHERE."
     - **الضبط الدقيق**: إذا كنت تستخدم نموذجًا مخصصًا، فاضبطه بدقة على مجموعات بيانات مثل Spider أو WikiSQL، مع تعزيزها بأمثلة محددة لمخططك.
     - **الاختبار**: قم بالتقييم باستخدام مقاييس مثل دقة التنفيذ (هل يعمل دون أخطاء؟) والمطابقة الدلالية (هل يعيد النتائج المتوقعة؟).

#### تحسينات محتملة لاستعلامك المثال
على الرغم من أن هذا ليس السؤال الرئيسي، فإن SQL المُنشأ لديك يحتوي على بعض العناصر الجيدة ولكن يمكن أن يكون أكثر أمانًا/دقة:
- استخدم المعلمات: غيّر إلى `WHERE first_name ILIKE %s` واربط القيمة 'andy'.
- العمر "اعتبارًا من 2025": استخدم `EXTRACT(YEAR FROM AGE('2025-12-31'::date, date_of_birth)) = 20` للتثبيت على نهاية سنة محددة.
- أضف `ORDER BY last_login DESC LIMIT 10;` للأمان.

يتطلب تنفيذ هذا بشكل آمن وجود طبقة خلفية (backend) (على سبيل المثال، عدم تنفيذ SQL مباشرة من ناتج الذكاء الاصطناعي). ابدأ صغيرًا باستخدام سكريبت يستخدم مكتبة LLM (مثل LangChain لسلاسل NL-to-SQL).

إذا كنت بحاجة إلى أمثلة برمجية أو مساعدة في أجزاء محددة (مثل تنفيذ بلغة Python)، قدم المزيد من التفاصيل!

**المراجع**  
[PostgreSQL Documentation: Row-Level Security](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)  
[LangChain NL-to-SQL Tutorial](https://python.langchain.com/docs/tutorials/sql_qa/)  
[Preventing SQL Injection in Python](https://realpython.com/prevent-python-sql-injection/)