---
audio: false
generated: true
lang: ar
layout: post
title: محول نظام حماية الطفل
translated: true
type: note
---

```scheme
;; محول CPS بسيط يقوم بتحسين استدعاء الذيل بشكل صحيح ولا
;; يكرر السياقات لعبارات if.
;; المؤلف: Yin Wang (yw21@cs.indiana.edu)
(load "pmatch.scm") ; يقوم بتحميل مكتبة مطابقة الأنماط لـ Scheme، مما يسهل التعامل مع هياكل العبارات المختلفة.

(define cps
  (lambda (exp)
    (letrec
        ([trivial? (lambda (x) (memq x '(zero? add1 sub1)))] ; يتحقق مما إذا كان الرمز المعطى أحد العوامل البدائية: zero?، add1، sub1. يتم التعامل معها بشكل خاص في التحويل.
         [id (lambda (v) v)] ; دالة الهوية، تُستخدم كاستمرارية أولية للعبارة الأساسية.
         [ctx0 (lambda (v) `(k ,v))]      ; سياق الذيل. ينشئ استمرارية تطبق ببساطة الاستمرارية الحالية 'k' على القيمة 'v'. تُستخدم عندما يكون الاستدعاء الحالي في موضع الذيل.
         [fv (let ([n -1]) ; ينشئ مولّدًا لأسماء متغيرات جديدة.
               (lambda ()
                 (set! n (+ 1 n))
                 (string->symbol (string-append "v" (number->string n)))))]
         [cps1
          (lambda (exp ctx) ; الدالة الأساسية العودية التي تقوم بتحويل CPS. تأخذ عبارة 'exp' واستمرارية 'ctx' كوسيطات. تمثل الاستمرارية ما يجب فعله بنتيجة تقييم 'exp'.
            (pmatch exp ; يستخدم مطابقة الأنماط لتحليل هيكل العبارة.
              [,x (guard (not (pair? x))) (ctx x)] ; الحالة الأساسية: إذا كانت العبارة 'x' ليست زوجًا (أي أنها قيمة حرفية أو متغير)، فهذا يعني أنها قيمة بالفعل. طبق الاستمرارية الحالية 'ctx' على هذه القيمة.

              [(if ,test ,conseq ,alt) ; تطابق عبارة 'if' مع اختبار، نتيجة، وبديل.
               (cps1 test ; حوّل العبارة 'test' بشكل عودي.
                     (lambda (t) ; الاستمرارية لعبارة 'test'. تأخذ نتيجة الاختبار (والتي ستكون قيمة منطقية) كـ 't'.
                       (cond
                        [(memq ctx (list ctx0 id)) ; إذا كان السياق الحالي 'ctx' هو إما سياق الذيل 'ctx0' أو سياق الهوية الأولي 'id'، فهذا يعني أن عبارة 'if' نفسها في موضع الذيل.
                         `(if ,t ,(cps1 conseq ctx) ,(cps1 alt ctx))] ; في هذه الحالة، تبقى عبارة 'if' عبارة 'if' في الكود المحول لـ CPS. يتم تحويل النتيجة والبديل باستخدام نفس السياق 'ctx'. هذا يتجنب تكرار السياقات.
                        [else ; إذا كان السياق الحالي ليس سياق ذيل، فهذا يعني أن نتيجة عبارة 'if' تحتاج إلى تمريرها إلى بعض الحسابات الإضافية.
                         (let ([u (fv)]) ; أنشئ اسم متغير جديد 'u' لحفظ نتيجة عبارة 'if'.
                           `(let ([k (lambda (,u) ,(ctx u))]) ; أنشئ استمرارية جديدة 'k' تأخذ النتيجة 'u' وتطبق السياق الأصلي 'ctx' عليها.
                              (if ,t ,(cps1 conseq ctx0) ,(cps1 alt ctx0))))])))] ; يتم تغليف عبارة 'if' في 'let' يقدم الاستمرارية الجديدة 'k'. يتم تحويل النتيجة والبديل باستخدام سياق الذيل 'ctx0'، حيث سيتم تمرير نتائجهما فورًا إلى 'k'.

              [(lambda (,x) ,body) ; تطابق عبارة lambda مع وسيط واحد 'x' وجسم.
               (ctx `(lambda (,x k) ,(cps1 body ctx0)))] ; يتم تحويل عبارة lambda إلى عبارة lambda جديدة تأخذ وسيطًا إضافيًا 'k' (الاستمرارية). يتم تحويل جسم الـ lambda الأصلية باستخدام سياق الذيل 'ctx0'، حيث سيتم تمرير نتيجتها إلى هذه الاست