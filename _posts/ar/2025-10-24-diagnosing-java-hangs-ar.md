---
audio: false
generated: true
image: false
lang: ar
layout: post
model: x-ai/grok-4-fast
title: تشخيص توقف تطبيقات جافا باستخدام jstack
translated: true
type: note
---

### استخدام jstack لتشخيص توقف التطبيقات الجافا أو تعليقها

jstack هو أداة سطر أوامر مضمنة في JDK تقوم بإنشاء تفريغ الخيوط (thread dumps) لآلة جافا الافتراضية (JVM) قيد التشغيل. يلتقط تفريغ الخيوط حالة جميع الخيوط في لحظة معينة، وهو أمر بالغ الأهمية لتحديد أسباب التوقف، مثل حالات التعادل (deadlocks)، أو الحلقات اللانهائية، أو عمليات الإدخال/الإخراج (I/O) المتعثرة، أو العمليات المكثفة لوحدة المعالجة المركزية (CPU). إنه مفيد بشكل خاص على أنظمة Linux/Unix أو في البيئات متعددة المنصات.

#### خطوات استخدام jstack:
1.  **تحديد معرّف عملية جافا (PID):**
    - قم بتشغيل `jps` (وهو أيضًا جزء من JDK) لسرد جميع عمليات جافا:
      ```
      jps -l
      ```
      سيعطي هذا نتيجة مثل `12345 MyApp.jar`. لاحظ معرّف العملية (PID) (مثل 12345).
    - بدلاً من ذلك، يمكنك استخدام أوامر نظام التشغيل مثل `ps aux | grep java` على Linux/macOS.

2.  **إنشاء تفريغ الخيوط:**
    - قم بتشغيل jstack مع معرّف العملية لإخراج التفريغ إلى ملف:
      ```
      jstack <PID> > thread-dump.txt
      ```
      - استبدل `<PID>` بمعرف العملية الخاص بك.
      - للحصول على تفريغ أكثر تفصيلاً (بما في ذلك الأقفال)، استخدم `jstack -l <PID> > thread-dump.txt`.
      - إذا لم تستجب آلة JVM للإشارات، استخدم `jhsdb jstack --pid <PID>` (متوفر في JDK 8+).

3.  **التقاط عدة تفريغات للتحليل:**
    - غالبًا ما يتطلب التوقف المقارنة عبر الزمن. خذ 3-5 تفريغات على فترات زمنية تتراوح بين 10-30 ثانية:
      ```
      jstack <PID> > dump1.txt
      sleep 10
      jstack <PID> > dump2.txt
      sleep 10
      jstack <PID> > dump3.txt
      ```
    - يمكنك أتمتة هذا في سكريبت حلقة إذا لزم الأمر (مثل استخدام سكريبت bash).

4.  **تحليل التفريغ:**
    - افتح ملف النص في محرر أو بيئة تطوير متكاملة (IDE).
    - ابحث عن:
      - **حالات الخيوط (Thread States):** ركز على الخيوط في حالة `RUNNABLE` (نشط)، أو `BLOCKED` (في انتظار قفل، احتمال تعادل)، أو `WAITING` (انتظار خامل)، أو `TIMED_WAITING`.
      - **حالات التعادل (Deadlocks):** ابحث عن كلمة "deadlock" أو استخدم أدوات مثل `jstack -l` التي تعلّم عليها.
      - **تتبّع المكدس (Stack Traces):** حدد الأنماط المتكررة أو الخيوط العالقة في طرق محددة (مثل حلقة لا نهائية).
      - **الإطارات الأصلية (Native Frames):** إذا كانت الخيوط عالقة في كود أصلي (native code)، فقد يشير ذلك إلى مشاكل في JNI أو تعليقات على مستوى نظام التشغيل.
    - أدوات للتحليل الأعمق: VisualVM، أو Eclipse MAT، أو محللات عبر الإنترنت مثل fastThread.io. على سبيل المثال، في VisualVM، قم بتحميل ملف التفريغ تحت علامة التبويب "Thread" لتصور الأقفال والحالات.

إذا لم تستجب آلة JVM (على سبيل المثال، لا يوجد إخراج من `kill -3 <PID>` على Unix)، فقد يكون التعلق على مستوى نظام التشغيل — فكر في إنشاء تفريغ كامل للنواة (core dump) عبر `gcore <PID>`.

### استخدام ProcDump لتشخيص توقف العمليات أو تعليقها

ProcDump هي أداة مجانية من Sysinternals لنظام Windows تقوم بإنشاء تفريغ للذاكرة أو وحدة المعالجة المركزية للعمليات. إنها رائعة لالتقاط لقطات من العمليات المتعثرة في أي تطبيق (بما في ذلك جافا)، خاصة عندما تكون العملية لا تستجيب. استخدمها لتفريغ الذاكرة الكامل لتحليله بأدوات مثل WinDbg أو Visual Studio.

#### خطوات استخدام ProcDump:
1.  **التنزيل والإعداد:**
    - احصل على ProcDump من موقع Microsoft Sysinternals (procdump.exe).
    - شغّل موجه الأوامر (Command Prompt) كمسؤول (Administrator).
    - انتقل إلى المجلد الذي يحتوي على procdump.exe.

2.  **تحديد العملية:**
    - استخدم "إدارة المهام" (Task Manager) أو `tasklist | findstr <process-name>` للحصول على معرّف العملية (PID) أو اسم الصورة (image name) (مثل `java.exe`).

3.  **التقاط تفريغ لعملية متعثرة:**
    - لتفريغ الذاكرة الكامل الفوري (مفيد للعمليات العالقة):
      ```
      procdump -ma <process-name-or-PID>
      ```
      - `-ma`: تفريغ ذاكرة كامل (يشمل جميع الخيوط والكومة heap).
      - مثال: `procdump -ma java.exe` أو `procdump -ma 12345`.
    - للكشف التلقائي عن التوقف (يُشغّل عند عدم الاستجابة):
      ```
      procdump -h <process-name-or-PID> -o
      ```
      - `-h`: يراقب حالات التوقف (عملية لا تستجيب لرسائل النوافذ لأكثر من 5 ثوانٍ؛ للخدمات التي لا تحتوي على نوافذ، استخدم عتبات وحدة المعالجة المركزية مثل `-h 80` لاستخدام 80% من وحدة المعالجة المركزية).
      - `-o`: الكتابة فوق التفريغات الموجودة.
      - للخدمات: اجمع مع `-e` للاستثناءات أو راقب وحدة المعالجة المركزية: `procdump -c 80 -h <service-exe>`.
    - خذ عدة تفريغات: أضف `-n 3` لـ 3 تفريغات على فترات (مثل `-t 10` لتأخير 10 ثوانٍ):
      ```
      procdump -ma -n 3 -t 10 <PID>
      ```

4.  **تحليل التفريغ:**
    - يتم حفظ التفريغات كملفات `.dmp` في الدليل الحالي.
    - افتحها في WinDbg (مجاني من Microsoft) أو مصحح أخطاء Visual Studio.
    - الأوامر الرئيسية في WinDbg:
      - `!threads`: إدراج الخيوط وحالاتها (ابحث عن المعلقة/المنتظرة).
      - `~<thread-id>s`: انتقل إلى خيط معين واستخدم `k` للحصول على تتبع المكدس.
      - `!analyze -v`: التحليل التلقائي للبحث عن التوقف/حالات التعادل.
    - للتحليل المحدد لجافا، قم بتحميل التفريغ في Eclipse MAT أو استخدم `jhat` على تفريغ الكومة (heap dump) (إذا تم التقاطه بعلم `-mh`).

يعمل ProcDump بشكل جيد مع العمليات غير التفاعلية مثل الخدمات؛ إذا كان التعلق مرتبطًا بوحدة المعالجة المركزية، استخدم `-c` للتشغيل عند ارتفاع استخدامها.

### نصائح عامة لكلا الأداتين
-   **السلامة:** يمكن أن تكون التفريغات كبيرة الحجم (غيغابايت للذاكرة الكاملة)； تأكد من وجود مساحة كافية على القرص.
-   **الجمع بين الأدوات:** لجافا على Windows، استخدم jstack أولاً (أخف وزنًا)، ثم ProcDump للحصول على رؤية أعمق على مستوى نظام التشغيل.
-   **الوقاية:** قم بتمكين أعلام JVM مثل `-XX:+PrintGCDetails` للتسجيل، أو استخدم وكلاء مثل JFR لتحليل الأداء.
-   إذا لم تظهر التفريغات مشكلة واضحة، تحقق من موارد النظام (وحدة المعالجة المركزية، الذاكرة، الإدخال/الإخراج) بأدوات مثل `top` أو "مراقب الأداء" (Performance Monitor).

[دليل استكشاف أخطاء جافا من Oracle](https://docs.oracle.com/en/java/javase/17/troubleshoot/troubleshoot-process-hangs-and-loops.html)  
[أخذ تفريغ لعملية متعثرة باستخدام ProcDump](https://www.poppastring.com/blog/taking-a-hang-dump-or-crash-dump-with-procdump)  
[تحليل تفريغ الخيوط في جافا](https://www.baeldung.com/java-analyze-thread-dumps)  
[استخدام ProcDump لحالات التوقف](https://learn.microsoft.com/en-us/sysinternals/downloads/procdump)