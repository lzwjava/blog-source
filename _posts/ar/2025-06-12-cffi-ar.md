---
audio: false
generated: true
lang: ar
layout: post
title: مكتبة cffi في بايثون
translated: true
type: note
---

عند تشغيل سكريبت بايثون `fetch.py` باستخدام الأمر `python scripts/supabase/fetch.py`، واجهت الخطأ التالي:

```
ModuleNotFoundError: No module named '_cffi_backend'
```

يشير هذا الخطأ، بالإضافة إلى panic لغة Rust والتتبع اللاحق، إلى أن مفسر بايثون لا يمكنه العثور على الوحدة `_cffi_backend`، وهي مكون حاسم لمكتبة `cffi`. مكتبة `cffi` هي تبعية لحزمة `cryptography`، التي تستخدم بدورها من قبل عميل `supabase` في سكريبتك. أدناه، سأشرح المشكلة وأقدم حلاً خطوة بخطوة لحلها.

---

### ما سبب الخطأ؟

وحدة `_cffi_backend` هي جزء من مكتبة `cffi`، التي تمكن بايثون من التواصل مع كود C. تعتمد مكتبة `cryptography`، وهي تبعية لكل من `jwt` و `supabase`، على `cffi` لتنفيذ العمليات التشفيرية. يظهر التتبع أن الخطأ ينشأ عندما تحاول `cryptography` استيراد روابط Rust:

```
File "/usr/lib/python3/dist-packages/cryptography/hazmat/_oid.py", line 9, in <module>
    from cryptography.hazmat.bindings._rust import (
        ObjectIdentifier as ObjectIdentifier,
    )
pyo3_runtime.PanicException: Python API call failed```

يشير `ModuleNotFoundError` الخاص بـ `_cffi_backend` إلى أن `cffi` إما غير مثبتة، أو لم يتم بناؤها بشكل صحيح، أو غير متوافقة مع بيئة بايثون الخاصة بك. هذا يؤدي إلى فشل في روابط Rust، مسبباً الـ panic وإيقاف التنفيذ.

---

### كيفية إصلاح المشكلة

اتبع هذه الخطوات لحل الخطأ وجعل سكريبت Supabase يعمل:

#### 1. **التحقق من تثبيت مكتبة `cffi` وتثبيتها**
من المحتمل أن مكتبة `cffi` مفقودة أو مثبتة بشكل غير صحيح. تحقق من وجودها وقم بتثبيتها إذا لزم الأمر.

- **تحقق مما إذا كانت `cffi` مثبتة:**
  ```bash
  pip show cffi
  ```
  سيعرض هذا الأمر معلومات عن حزمة `cffi` إذا كانت مثبتة في بيئة بايثون الحالية.

- **قم بتثبيت أو إعادة تثبيت `cffi`:**
  إذا لم تكن `cffi` مثبتة أو إذا كان هناك احتمال أنها تالفة، قم بتشغيل:
  ```bash
  pip install cffi
  ```
  لضمان تثبيت نظيف، يمكنك إلغاء تثبيتها وإعادة تثبيتها:
  ```bash
  pip uninstall cffi
  pip install cffi
  ```

#### 2. **تثبيت تبعيات النظام**
تتطلب مكتبة `cffi` تبعيات محددة على مستوى النظام لبناء backend الخاص بها (`_cffi_backend`). على نظام Ubuntu (استنادًا إلى موجهك `lzwjava@lzwjava-XiaoXin-14-IAH8`)، قم بتثبيت حزمة `libffi-dev`:

```bash
sudo apt-get update
sudo apt-get install libffi-dev
```

توفر هذه الحزمة ملفات التطوير لـ `libffi`، التي تحتاجها `cffi` لتجميع backend الخاص بها.

#### 3. **التحقق من إصدار بايثون والبيئة**
يظهر التتبع مسارات مثل `/home/lzwjava/.local/lib/python3.13/site-packages/` و `/usr/lib/python3/dist-packages/`، مما يشير إلى أنك تستخدم Python 3.13 وربما لديك تثبيتات متعددة لبايثون.

- **تأكد من أنك تستهدف إصدار بايثون الصحيح:**
  قم بتشغيل سكريبتك بإصدار بايثون محدد لتجنب التعارضات:
  ```bash
  python3.13 scripts/supabase/fetch.py
  ```
  استخدم نفس إصدار بايثون لتثبيت الحزم:
  ```bash
  python3.13 -m pip install cffi
  ```

- **فكر في استخدام بيئة افتراضية:**
  لتجنب التعارضات بين الحزم المثبتة على مستوى النظام وتلك المثبتة للمستخدم، قم بإعداد بيئة افتراضية:
  ```bash
  python3.13 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
  ثم قم بتشغيل سكريبتك:
  ```bash
  python scripts/supabase/fetch.py
  ```

#### 4. **إعادة تثبيت الحزم ذات الصلة**
يعتمد عميل `supabase` على `cryptography` و `jwt`، وكلاهما يعتمد على `cffi`. تضمن إعادة تثبيت هذه الحزم توافقها مع بيئتك:

```bash
pip uninstall cryptography jwt supabase
pip install cryptography jwt supabase
```

#### 5. **التحقق من توافق Python 3.13**
إصدار Python 3.13 هو إصدار أحدث، وقد لا يتم اختبار بعض الحزم (مثل `cryptography`) بشكل كامل معه بعد. إذا استمرت المشاكل، ففكر في التبديل إلى إصدار أكثر استقرارًا مثل Python 3.11:

- تثبيت Python 3.11 (على Ubuntu):
  ```bash
  sudo apt-get install python3.11 python3.11-dev python3.11-venv
  ```
- إنشاء بيئة افتراضية باستخدام Python 3.11:
  ```bash
  python3.11 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
- قم بتشغيل سكريبتك مرة أخرى.

#### 6. **تصحيح الأخطاء المستمرة**
إذا استمر الخطأ، قم بجمع المزيد من التفاصيل:
- قم بالتشغيل مع Rust backtrace للحصول على سياق إضافي:
  ```bash
  RUST_BACKTRACE=1 python scripts/supabase/fetch.py
  ```
- تحقق من `PYTHONPATH` الخاص بك للبحث عن تعارضات:
  ```bash
  echo $PYTHONPATH
  ```
  إذا كان مضبوطًا، تأكد من أنه لا يتعارض مع مواقع الحزم.

---

### لماذا يجب أن ينجح هذا؟

ينشأ الخطأ من مكتبة `cffi` مفقودة أو غير مهيأة بشكل صحيح، مما يعطل قدرة حزمة `cryptography` على تحميل روابط Rust الخاصة بها. من خلال التأكد من تثبيت `cffi`، وتلبية تبعيات النظام، وكون بيئة بايثون الخاصة بك متسقة، يجب أن تصبح وحدة `_cffi_backend` متاحة، مما يسمح لسكريبتك بالعمل بنجاح.

---

### الخطوات النهائية
بعد تطبيق هذه الإصلاحات، اختبر سكريبتك مرة أخرى:
```bash
python scripts/supabase/fetch.py
```

إذا ما زلت تواجه مشاكل، شارك رسالة الخطأ المحدثة، ويمكننا تحسين الحل further. Happy coding!