---
audio: false
generated: true
lang: ar
layout: post
title: تخصيص عداد أداء نواة إكس إن يو
translated: true
type: note
---

الكود C الذي قدمته هو عرض لاستخدام **مرافق `kperf` و `kpc` (عدادات أداء النواة) الخاصة بـ XNU** على نظامي macOS وiOS، والمصممة **لتحليل أداء النظام والتطبيقات على مستوى منخفض**.

إليك تحليلًا لما يفعله الكود:

*   **الوصول إلى عداد الأداء:** يتفاعل مباشرة مع وحدات مراقبة الأداء (PMUs) في النواة لجمع مقاييس أداء مفصلة (مثل الدورات، التعليمات، أخطاء الفرع) على مستوى دقيق جدًا. يُستخدم هذا عادةً لتحليل الأداء والتحسين بشكل متعمق.
*   **الأطر الخاصة:** يعكس هندسة ويستخدم دوال من **الأطر الخاصة** في macOS/iOS:
    *   `kperf.framework`: يواجه واجهات للتحكم في تحليل الأداء على مستوى النواة، بما في ذلك بدء/إيقاف أخذ العينات، إعداد المؤقتات، والتصفية حسب معرف العملية أو المهمة.
    *   `kperfdata.framework`: يُستخدم للوصول إلى قاعدة بيانات عداد مراقبة الأداء (PMC) الخاصة بوحدة المعالجة المركزية (الملفات `.plist` الموجودة في `/usr/share/kpep/`) وتفسيرها. تحدد قاعدة البيانات هذه أحداث الأداء المحددة المتاحة على معماريات وحدة المعالجة المركزية المختلفة (Intel، Apple Silicon).
*   **التكامل مع Kdebug:** يتكامل مع آلية تتبع `kdebug` لجمع بيانات الأداء المُعيّنة. `kdebug` هو نظام تسجيل على مستوى النواة يسمح بتسجيل الأحداث بأداء عالٍ.
*   **وضعي العرض:**
    *   **العرض 1 (دالة `main`): تحليل دالة في الخيط الحالي.** يقيس هذا الوضع عدادات الأداء specifically لدالة C محددة (`profile_func`) يتم تنفيذها داخل العملية الحالية. يأخذ لقطة "قبل" و"بعد" للعدادات لحساب الفرق.
    *   **العرض 2 (دالة `main2`): تحليل عملية محددة (أو جميع الخيوط).** يُعد هذا الوضع أخذ عينات أداء مستمرة لـ `target_pid` محدد (أو للنظام بأكمله إذا كانت `target_pid` هي -1) على مدى `total_profile_time`. يستخدم مؤقتات `kperf` و `kdebug` لجمع بيانات عداد الأداء الدورية للهدف.
*   **الأولوية المطلوبة:** يتحقق الكود بشكل صريح من امتيازات الجذر لأن التفاعل المباشر مع عدادات أداء النواة و `kperf` يتطلب أذونات مرتفعة.
*   **خصوصيات معمارية وحدة المعالجة المركزية:** يقر الكود بمعماريات وحدة المعالجة المركزية المختلفة (Intel، ARM64) وقواعد بيانات عدادات مراقبة الأداء (PMC) الخاصة بكل منها. يحاول العثور على أحداث أداء مناسبة عبر هذه المعماريات.

**في الجوهر، يوفر هذا الكود أداة منخفضة المستوى للمطورين ومسؤولي النظام ل:**

*   **فهم سلوك وحدة المعالجة المركزية:** الحصول على رؤى حول كيفية تنفيذ وحدة المعالجة المركزية للكود، بما في ذلك إنتاجية التعليمات، استخدام ذاكرة التخزين المؤقت، دقة توقع الفرع، والمزيد.
*   **تحديد اختناقات الأداء:** تحديد الدوال أو أقسام الكود المحددة التي تستهلك معظم الموارد أو تظهر سلوكًا غير فعال.
*   **التحقق من التحسينات:** قياس تأثير تغييرات الكود على مقاييس الأداء.
*   **تصحيح مشكلات الأداء:** تحليل خصائص الأداء على مستوى النظام أو لعملية محددة.