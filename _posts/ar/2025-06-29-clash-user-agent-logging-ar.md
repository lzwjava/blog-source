---
audio: false
generated: true
lang: ar
layout: post
title: تسجيل وكيل المستخدم في بروكسي كلاش
translated: true
type: note
---

يبدو أنك تشير إلى **Clash**، وهو أداة بروكسي قائمة على القواعد، وتريد تكوينها لطباعة أو تسجيل **User-Agent** لطلبات HTTP الخاصة بها. استنادًا إلى المعلومات المتاحة، لا تحتوي Clash (أو نواتها، التي يشار إليها غالبًا باسم `clash-core`) على ميزة مدمجة لطباعة User-Agent للطلبات الصادرة بطريقة مباشرة. ومع ذلك، يمكنك تحقيق ذلك من خلال الاستفادة من خيارات تكوين Clash، أو الأدوات الخارجية، أو طرق التصحيح. فيما يلي دليل خطوة بخطوة لمساعدتك في تسجيل أو فحص User-Agent للطلبات التي تتم عبر Clash.

---

### فهم السياق
- **Clash** هي أداة بروكسي توجه حركة المرور بناءً على القواعد وتدعم بروتوكولات مثل HTTP، وSOCKS5، وShadowsocks، وV2Ray، والمزيد. تعمل على طبقات الشبكة والتطبيقات.
- **User-Agent** هو رأس HTTP يُضبط عادةً بواسطة تطبيق العميل (مثل المتصفح أو أداة مثل `curl`) الذي يقوم بالطلب، وليس بواسطة Clash نفسها. تعمل Clash، كبروكسي، على تمرير هذه الطلبات وقد لا تقوم بشكل أساسي بتسجيل أو تعديل User-Agent إلا إذا تم تكوينها بشكل صريح للقيام بذلك.
- لطباعة User-Agent، تحتاج إما إلى:
  1. تكوين Clash لتسجيل رؤوس HTTP (بما في ذلك User-Agent) لأغراض التصحيح.
  2. استخدام أداة خارجية (مثل مصحح أخطاء البروكسي أو أداة التقاط حركة الشبكة) لفحص الطلبات.
  3. تعديل تكوين Clash لإضافة رؤوس مخصصة أو استخدام سكريبت لتسجيلها.

نظرًا لأن Clash نفسها لا تحتوي على تكوين مباشر لتسجيل رؤوس User-Agent، قد تحتاج إلى الجمع بين Clash وأدوات أخرى أو استخدام تكوينات محددة. فيما يلي الطرق لتحقيق ذلك.

---

### الطريقة 1: تمكين التسجيل التفصيلي في Clash وفحص السجلات
يمكن لـ Clash تسجيل الطلبات بمستويات مختلفة، لكنها لا تقوم بشكل أصلي بتسجيل رؤوس HTTP مثل User-Agent إلا إذا تم تكوينها بشكل صريح أو استخدامها مع أداة يمكنها فحص حركة المرور. يمكنك تمكين التسجيل التفصيلي واستخدام أداة لالتقاط User-Agent.

#### الخطوات:
1. **تعيين مستوى سجل Clash إلى التصحيح (Debug)**:
   - قم بتحرير ملف تكوين Clash (`config.yaml`، الموجود عادةً في `~/.config/clash/config.yaml` أو دليل مخصص محدد بعلامة `-d`).
   - عيّن `log-level` إلى `debug` لالتقاط معلومات مفصلة حول الطلبات:
     ```yaml
     log-level: debug
     ```
   - احفظ التكوين وأعد تشغيل Clash:
     ```bash
     clash -d ~/.config/clash
     ```
   - ستقوم Clash الآن بتسجيل معلومات أكثر تفصيلاً إلى `STDOUT` أو ملف سجل محدد. ومع ذلك، قد لا يتضمن هذا رأس User-Agent مباشرة، حيث تركز Clash على تفاصيل التوجيه والاتصال.

2. **فحص السجلات**:
   - افحص مخرجات السجلات في الطرفية أو ملف السجل (إذا تم تكوينه). ابحث عن تفاصيل طلب HTTP، لكن لاحظ أن التسجيل الافتراضي لـ Clash قد لا يتضمن رؤوس HTTP كاملة مثل User-Agent.
   - إذا لم ترَ معلومات User-Agent، انتقل إلى استخدام بروكسي تصحيح (انظر الطريقة 2) أو أداة التقاط شبكة (الطريقة 3).

3. **اختياري: استخدام لوحة تحكم Clash**:
   - توفر Clash لوحة تحكم قائمة على الويب (مثل YACD على `https://yacd.haishan.me/` أو لوحة التحكم الرسمية على `https://clash.razord.top/`) لمراقبة الاتصالات والسجلات.
   - قم بتكوين `external-controller` و `external-ui` في ملف `config.yaml` الخاص بك لتمكين لوحة التحكم:
     ```yaml
     external-controller: 127.0.0.1:9090
     external-ui: folder
     ```
   - قم بالوصول إلى لوحة التحكم عبر `http://127.0.0.1:9090/ui` وتحقق من علامة التبويب "Logs" أو "Connections". قد يظهر هذا تفاصيل الاتصال ولكن من غير المرجح أن يعرض User-Agent مباشرة.

#### القيود:
- تركز سجلات تصحيح أخطاء Clash على قرارات التوجيه والبروكسي، وليس رؤوس HTTP الكاملة. لالتقاط User-Agent، تحتاج إلى اعتراض حركة مرور HTTP، الأمر الذي يتطلب أدوات إضافية.

---

### الطريقة 2: استخدام بروكسي تصحيح لالتقاط User-Agent
نظرًا لأن Clash نفسها لا تقوم بتسجيل رؤوس HTTP مثل User-Agent مباشرة، يمكنك توجيه حركة مرور Clash عبر بروكسي تصحيح مثل **mitmproxy**، أو **Charles Proxy**، أو **Fiddler**. يمكن لهذه الأدوات اعتراض وعرض طلب HTTP الكامل، بما في ذلك User-Agent.

#### الخطوات:
1. **تثبيت mitmproxy**:
   - قم بتثبيت `mitmproxy`، وهي أداة مفتوحة المصدر شائعة لاعتراض حركة مرور HTTP/HTTPS:
     ```bash
     sudo apt install mitmproxy  # On Debian/Ubuntu
     brew install mitmproxy      # On macOS
     ```
   - بدلاً من ذلك، استخدم أداة بروكسي أخرى مثل Charles أو Fiddler.

2. **تكوين Clash لتوجيه حركة المرور عبر mitmproxy**:
   - بشكل افتراضي، تعمل Clash كبروكسي HTTP/SOCKS5. يمكنك ربطها بـ `mitmproxy` عن طريق تعيين `mitmproxy` كبروكسي upstream.
   - قم بتحرير `config.yaml` الخاص بـ Clash لتضمين بروكسي HTTP يشير إلى `mitmproxy`:
     ```yaml
     proxies:
       - name: mitmproxy
         type: http
         server: 127.0.0.1
         port: 8080  # منفذ mitmproxy الافتراضي
     proxy-groups:
       - name: Proxy
         type: select
         proxies:
           - mitmproxy
     ```
   - احفظ التكوين وأعد تشغيل Clash.

3. **بدء تشغيل mitmproxy**:
   - شغّل `mitmproxy` للاستماع على المنفذ 8080:
     ```bash
     mitmproxy
     ```
   - سيعرض `mitmproxy` جميع طلبات HTTP التي تمر عبره، بما في ذلك رأس User-Agent.

4. **إرسال طلب اختبار**:
   - استخدم عميلاً (مثل `curl`، أو متصفح، أو أداة أخرى) مُكونًا لاستخدام Clash كبروكسي.
   - مثال باستخدام `curl`:
     ```bash
     curl --proxy http://127.0.0.1:7890 http://example.com
     ```
   - في `mitmproxy`، سترى طلب HTTP الكامل، بما في ذلك User-Agent (مثل `curl/8.0.1` أو User-Agent المتصفح).

5. **فحص User-Agent**:
   - في واجهة `mitmproxy`، انتقل عبر الطلبات الملتقطة. سيكون رأس User-Agent مرئيًا في تفاصيل الطلب.
   - يمكنك أيضًا حفظ السجلات في ملف لمزيد من التحليل:
     ```bash
     mitmproxy -w mitmproxy.log
     ```

#### ملاحظات:
- إذا كنت تستخدم HTTPS، فأنت بحاجة إلى تثبيت وتوثيق شهادة CA الخاصة بـ `mitmproxy` على جهاز العميل لفك تشفير حركة مرور HTTPS. اتبع التعليمات الموجودة في `http://mitm.clash/cert.crt` أو وثائق `mitmproxy`.
- تتطلب هذه الطريقة ربط البروكسيات (العميل → Clash → mitmproxy → الوجهة)، مما قد يزيد من زمن الوصول قليلاً ولكنه يسمح بفحص كامل للرؤوس.

---

### الطريقة 3: استخدام أداة التقاط شبكة لالتقاط User-Agent
إذا كنت تفضل عدم ربط البروكسيات، يمكنك استخدام أداة التقاط شبكة مثل **Wireshark** لالتقاط وفحص حركة مرور HTTP التي تمر عبر Clash.

#### الخطوات:
1. **تثبيت Wireshark**:
   - قم بتنزيل وتثبيت Wireshark من [wireshark.org](https://www.wireshark.org/).
   - على Linux:
     ```bash
     sudo apt install wireshark
     ```
   - على macOS:
     ```bash
     brew install wireshark
     ```

2. **بدء تشغيل Clash**:
   - تأكد من أن Clash يعمل بتكوينك المطلوب (مثل بروكسي HTTP على المنفذ 7890):
     ```bash
     clash -d ~/.config/clash
     ```

3. **التقاط حركة المرور في Wireshark**:
   - افتح Wireshark وحدد واجهة الشبكة التي يستخدمها Clash (مثل `eth0`، أو `wlan0`، أو `lo` لحركة المرور المحلية).
   - طبق عامل تصفية لالتقاط حركة مرور HTTP:
     ```
     http
     ```
   - بدلاً من ذلك، قم بتصفية حسب منفذ بروكسي HTTP الخاص بـ Clash (مثل 7890):
     ```
     tcp.port == 7890
     ```

4. **إرسال طلب اختبار**:
   - استخدم عميلاً مُكونًا لاستخدام Clash كبروكسي:
     ```bash
     curl --proxy http://127.0.0.1:7890 http://example.com
     ```

5. **فحص User-Agent**:
   - في Wireshark، ابحث عن طلبات HTTP (مثل `GET / HTTP/1.1`). انقر نقرًا مزدوجًا فوق حزمة لعرض تفاصيلها.
   - قم بتوسيع قسم "Hypertext Transfer Protocol" للعثور على رأس `User-Agent` (مثل `User-Agent: curl/8.0.1`).

#### ملاحظات:
- بالنسبة لحركة مرور HTTPS، لا يمكن لـ Wireshark فك تشفير User-Agent ما لم يكن لديك المفتاح الخاص للخادم أو除非 استخدمت أداة مثل `mitmproxy` لفك تشفير حركة المرور.
- هذه الطريقة أكثر تعقيدًا وتتطلب الإلمام بتحليل حزم الشبكة.

---

### الطريقة 4: تعديل تكوين Clash لحقن أو تسجيل الرؤوس المخصصة
يدعم Clash رؤوس HTTP مخصصة في تكوينه لأنواع بروكسي معينة (مثل HTTP أو VMess). يمكنك تكوين Clash لحقن User-Agent محدد أو استخدام سكريبت لتسجيل الرؤوس. ومع ذلك، فإن هذا أقل مباشرة لتسجيل User-Agent لجميع الطلبات.

#### الخطوات:
1. **إضافة رأس User-Agent مخصص**:
   - إذا كنت تريد فرض User-Agent محدد للاختبار، فقم بتعديل قسم `proxies` في `config.yaml` لتضمين رأس مخصص:
     ```yaml
     proxies:
       - name: my-http-proxy
         type: http
         server: proxy.example.com
         port: 8080
         header:
           User-Agent:
             - "MyCustomUserAgent/1.0"
     ```
   - يضبط هذا User-Agent مخصص للطلبات المرسلة عبر هذا البروكسي. ومع ذلك، فإنه يتجاوز User-Agent الأصلي للعميل، وهو ما قد لا يكون ما تريده إذا كنت تحاول تسجيل User-Agent الخاص بالعميل.

2. **استخدام قواعد السكريبت لتسجيل الرؤوس**:
   - يدعم Clash القواعد القائمة على السكريبت باستخدام محركات مثل `expr` أو `starlark` (). يمكنك كتابة سكريبت لتسجيل أو معالجة الرؤوس، بما في ذلك User-Agent.[](https://pkg.go.dev/github.com/yaling888/clash)
   - مثال على التكوين:
     ```yaml
     script:
       engine: starlark
       code: |
         def match(req):
           print("User-Agent:", req.headers["User-Agent"])
           return "Proxy"  # التوجيه إلى مجموعة بروكسي
     ```
   - يتطلب هذا كتابة سكريبت مخصص، وهو أمر متقدم وقد لا يكون مدعومًا بالكامل في جميع إصدارات Clash. تحقق من وثائق Clash لدعم السكريبت.

3. **التحقق باستخدام mitmproxy أو Wireshark**:
   - بعد حقن User-Agent مخصص، استخدم الطريقة 2 أو الطريقة 3 لتأكيد أن User-Agent يتم إرساله كما هو متوقع.

#### القيود:
- يؤدي حقن User-Agent مخصص إلى تجاوز User-Agent الخاص بالعميل، لذلك يكون هذا مفيدًا فقط لاختبار User-Agents محددة.
- التسجيل القائم على السكريبت تجريبي وقد لا يكون متاحًا في جميع إصدارات Clash.

---

### الطريقة 5: استخدام وضع MITM في Clash لتسجيل الرؤوس
يدعم Clash وضع **Man-in-the-Middle (MITM)** الذي يمكنه اعتراض وتسجيل حركة مرور HTTPS، بما في ذلك رؤوس مثل User-Agent.

#### الخطوات:
1. **تمكين MITM في Clash**:
   - قم بتحرير `config.yaml` لتمكين بروكسي MITM:
     ```yaml
     mitm-port: 7894
     mitm:
       hosts:
         - "*.example.com"
     ```
   - يقوم هذا بتكوين Clash لاعتراض حركة مرور HTTPS للنطاقات المحددة.

2. **تثبيت شهادة CA الخاصة بـ Clash**:
   - تقوم Clash بإنشاء شهادة CA لـ MITM. قم بالوصول إلى `http://mitm.clash/cert.crt` في متصفح لتنزيلها وتثبيتها.
   - قم بتوثيق الشهادة على جهاز العميل الخاص بك للسماح لـ Clash بفك تشفير حركة مرور HTTPS.

3. **فحص السجلات**:
   - مع تمكين MITM، قد تقوم Clash بتسجيل معلومات طلب أكثر تفصيلاً، بما في ذلك الرؤوس. تحقق من السجلات في الطرفية أو لوحة التحكم.
   - إذا لم يتم تسجيل الرؤوس، فاستخدم `mitmproxy` (الطريقة 2) لالتقاط حركة المرور التي تم فك تشفيرها.

#### ملاحظات:
- يتطلب وضع MITM الثقة في شهادة CA على جميع أجهزة العميل، وهو ما قد لا يكون عمليًا لجميع حالات الاستخدام.
- هذه الطريقة هي الأفضل لحركة مرور HTTPS ولكنها تتطلب إعدادًا إضافيًا.

---

### التوصيات
- **الطريقة المفضلة**: استخدم **الطريقة 2 (mitmproxy)** للحصول على أسهل وأكثر الطرق موثوقية لالتقاط وتسجيل User-Agent للطلبات. إنها مفتوحة المصدر، مدعومة على نطاق واسع، ومصممة لتصحيح أخطاء HTTP.
- **البديل**: استخدم **الطريقة 3 (Wireshark)** إذا كنت مرتاحًا لتحليل حزم الشبكة ولا تريد ربط البروكسيات.
- **للمستخدمين المتقدمين**: جرب **الطريقة 4 (الرؤوس أو السكريبتات المخصصة)** إذا كنت بحاجة إلى معالجة أو تسجيل الرؤوس برمجيًا داخل Clash.

---

### ملاحظات إضافية
- **وثائق Clash**: راجع وثائق Clash الرسمية (,) للحصول على تفاصيل التكوين. يوفر مستودع GitHub (`https://github.com/Dreamacro/clash`) والويكي (`https://en.clash.wiki`) إرشادات مفصلة.[](https://en.clash.wiki/)[](https://en.clash.wiki/configuration/getting-started.html)
- **User-Agent من جانب العميل**: يتم تعيين User-Agent بواسطة العميل (مثل المتصفح، أو `curl`، أو التطبيق)، وليس بواسطة Clash. تأكد من أن عميلك يرسل User-Agent المتوقع. على سبيل المثال:
  - يستخدم `curl` `curl/<version>` افتراضيًا.
  - تستخدم المتصفحات سلاسل User-Agent الخاصة بها (مثل `Mozilla/5.0 ...`).
- **الاختبار**: اختبر دائمًا بطلب HTTP بسيط (مثل `curl --proxy http://127.0.0.1:7890 http://example.com`) للتحقق من الإعداد.
- **الأمان**: عند استخدام MITM أو بروكسيات التصحيح، تأكد من أنك تثق في شهادات CA والأدوات لتجنب المخاطر الأمنية.

إذا كنت بحاجة إلى مزيد من التوضيح أو المساعدة بتكوينات محددة، يرجى تقديم المزيد من التفاصيل حول إعدادك (مثل إصدار Clash، نظام التشغيل، أو نوع البروكسي المحدد)، ويمكنني تخصيص التعليمات بشكل أكبر!