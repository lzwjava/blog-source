---
audio: false
generated: true
image: false
lang: ar
layout: post
model: x-ai/grok-code-fast-1
title: دليل واجهة بايثون سي CFFI
translated: true
type: note
---

### ما هو CFFI؟
CFFI (واجهة الدوال الخارجية لـ C) هي مكتبة بايثون لاستدعاء دوال C من كود بايثون. وهي متوافقة مع كل من CPython وPyPy، وتوفر بديلاً أكثر أمانًا وقابلية للنقل لمكتبات مثل ctypes. وهي تدعم وضعين رئيسيين: ABI (استدعاء مكتبات مشتركة موجودة) وAPI (تجميع كود C مضمنًا).

### التثبيت
قم بتثبيت CFFI باستخدام pip:
```bash
pip install cffi
```
يتطلب CFFI مترجم لغة C (مثل GCC على لينكس، أو Visual Studio على ويندوز) لبناء الوحدات النمطية.

### مثال أساسي للاستخدام
إليك دليلًا خطوة بخطوة لحالة استخدام بسيطة: استدعاء دالة C تقوم بجمع عددين صحيحين باستخدام وضع API (موصى به للكود الجديد).

1. **استيراد وإعداد FFI**:
   ```python
   from cffi import FFI
   ffibuilder = FFI()
   ```

2. **تحديد تعريفات C**:
   حدد تواقيع دوال C في سلسلة نصية:
   ```python
   ffibuilder.cdef("""
       int add(int a, int b);
   """)
   ```

3. **توفير كود المصدر لـ C**:
   قم بتضمين التنفيذ بلغة C:
   ```python
   ffibuilder.set_source("_example",
       """
       int add(int a, int b) {
           return a + b;
       }
       """)
   ```

4. **تجميع الوحدة النمطية**:
   شغل هذا السكريبت مرة واحدة لبناء امتداد C:
   ```python
   if __name__ == "__main__":
       ffibuilder.compile(verbose=True)
   ```
   يولد هذا وحدة نمطية مجمعة (مثل `_example.cpython-39-x86_64-linux-gnu.so`).

5. **استخدام الوحدة النمطية المجمعة**:
   في كود بايثون الخاص بك، قم باستيراد واستدعاء الدالة:
   ```python
   from _example import lib
   result = lib.add(5, 3)
   print(result)  # الناتج: 8
   ```

### المفاهيم الأساسية
- **كائن FFI**: الواجهة الرئيسية، يتم إنشاؤها باستخدام `FFI()`. استخدم `cdef()` للتعريفات و `set_source()` للكود.
- **التعريفات**: تخبر بايثون عن أنواع C، والهياكل (structs)، والدوال، إلخ. يجب أن تطابق السلاسل النصية تركيب C تمامًا.
- **تحويل النوع**: يقوم CFFI بالتعامل مع الأنواع الأساسية (int، float، المؤشرات) تلقائيًا. استخدم المصفوفات، أو الهياكل، أو وظائف الاسترجاع (callbacks) للتعقيد.
- **معالجة الأخطاء**: تحدث استثناءات مثل `CDefError` للتعريفات غير الصالحة لـ C. يمكن التحقق من أخطاء وقت تشغيل C (عبر `errno`) باستخدام `ffi.errno`.
- **إدارة الذاكرة**: استخدم `ffi.new()` لهياكل/مصفوفات C، وتأكد من التحرير المناسب لتجنب تسريبات الذاكرة.

### الأوضاع: ABI مقابل API
- **وضع ABI** (للمكتبات الموجودة): قم بتحميل مكتبة مشتركة (مثل `ffi.dlopen("mylib.so")`) واستدع الدوال مباشرة. مثال:
  ```python
  from cffi import FFI
  ffi = FFI()
  ffi.cdef("int add(int a, int b);")
  lib = ffi.dlopen("/path/to/libmylib.so")
  result = lib.add(5, 3)
  ```
  هذا أسرع للمكتبات المبنية مسبقًا ولكنه أقل قابلية للنقل—أنت تحتاج إلى النسخة الثنائية المطابقة تمامًا.

- **وضع API** (موصى به): قم بتجميع كود C مضمنًا، كما في المثال أعلاه. إنه أكثر أمانًا، ويحسن الأداء بشكل أفضل، ويعمل عبر المنصات.

### الميزات المتقدمة
- **الهياكل والإتحادات**: حدد أنواع معقدة، مثل `cdef("struct Point { int x, y; }")`.
- **المصفوفات والمؤشرات**: استخدم `ffi.new("int[10]")` للمصفوفات أو `ffi.cast("int*", ptr)` للتحويلات.
- **وظائف الاسترجاع**: مرر دوال بايثون إلى C باستخدام `ffi.callback()`.
- **التكامل مع الحزم**: العديد من المكتبات (مثل cryptography، NumPy) تستخدم CFFI للأداء.
- **نصائح للأداء**: التجميع يستغرق وقتًا؛ استخدم البناء في المكان (inplace builds) أو حزم cffi للتوزيع. تجنب التحولات الثقيفة بين بايثون وC في الحلقات.

للحصول على الوثائق الكاملة، راجع [وثائق CFFI الرسمية](https://cffi.readthedocs.io/). هذا يغطي الأساسيات—جرب الأمثلة لتتكيف مع احتياجاتك. إذا كان لديك حالة استخدام محددة، قدم المزيد من التفاصيل للحصول على نصيحة مخصصة.