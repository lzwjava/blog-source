---
audio: false
generated: true
lang: ar
layout: post
title: كيف يعمل دوكر
translated: true
type: note
---

دعنا نتعمق في كيفية عمل Docker، مع التركيز على استخدامه لنظام الملفات في Linux وكيف يعزل التطبيقات عن بعضها البعض.

---

### ما هو Docker، في جوهره؟
Docker هو منصة تتيح لك تجميع وتوزيع وتشغيل التطبيقات داخل بيئات خفيفة الوزومعزولة تسمى **الحاويات**. على عكس الأجهزة الافتراضية (VMs)، التي تتضمن نظام تشغيل كاملًا، تشارك حاويات Docker نواة نظام التشغيل المضيف وتستخدم ميزاته لتوفير العزل والكفاءة.

---

### كيف يعمل Docker
يستفيد Docker من عدة ميزات في نواة Linux لإنشاء وإدارة الحاويات:
1. **النطاقات الاسمية (Namespaces)** - من أجل العزل.
2. **مجموعات التحكم (cgroups)** - من أجل إدارة الموارد.
3. **أنظمة الملفات الموحدة (Union Filesystems)** - من أجل التخزين الفعال والطبقات.

إليك كيف تتجمع هذه القطع معًا:

---

#### 1. النطاقات الاسمية في Linux: آلية العزل
تقوم النطاقات الاسمية بإنشاء "وجهات نظر" معزولة لموارد النظام، مما يضمن أن العمليات في حاوية واحدة لا تتداخل مع تلك الموجودة في حاوية أخرى. تشمل النطاقات الاسمية الرئيسية التي يستخدمها Docker:

- **نطاق معرف العملية (PID Namespace)**: لكل حاوية مساحة معرف عملية خاصة بها. معرف العملية 1 داخل الحاوية معزول عن معرف العملية 1 في المضيف (عادةً `init` أو `systemd`).
- **نطاق الشبكة (Network Namespace)**: تحصل الحاويات على مكدس شبكة خاص بها (عنوان IP، المنافذ، جداول التوجيه). هذا هو السبب في أن حاويتين يمكنهما الاستماع على المنفذ 8080 دون تعارض.
- **نطاق التركيب (Mount Namespace)**: لكل حاوية وجهة نظر خاصة بها لنظام الملفات، معزولة عن المضيف والحاويات الأخرى.
- **نطاق UTS (UTS Namespace)**: يمكن أن يكون للحاويات اسم مضيف واسم نطاق خاصين بها.
- **نطاق الاتصال بين العمليات (IPC Namespace)**: يعزل الاتصال بين العمليات (مثل الذاكرة المشتركة، قوائم انتظار الرسائل).
- **نطاق المستخدم (User Namespace)** (اختياري): يقوم بتعيين مستخدمي الحاوية لمستخدمي المضيف، مما يعزز الأمان.

**مثال**: إذا قمت بتشغيل `ps` داخل حاوية، فسترى فقط العمليات داخل نطاق معرف العملية لتلك الحاوية، وليس عمليات المضيف.

---

#### 2. مجموعات التحكم (cgroups): حدود الموارد
تحد مجموعات التحكم من استخدام الموارد (وحدة المعالجة المركزية، الذاكرة، إدخال/إخراج القرص، إلخ) وتراقبها لكل حاوية. هذا يمنع حاوية واحدة من احتكار جميع موارد النظام وتجويع الحاويات الأخرى.

- **كيف يعمل**: يقوم Docker بتعيين مجموعة تحكم (cgroup) لكل حاوية. يمكنك تعيين حدود مثل:
  ```bash
  docker run --memory="512m" --cpus="0.5" myapp
  ```
  هذا يقتصر الحاوية على 512 ميغابايت من ذاكرة الوصول العشوائي ونصف نواة معالجة مركزية.

- **العزل**: بينما تعزل النطاقات الاسمية الرؤية، تعزل مجموعات التحكم استهلاك الموارد.

---

#### 3. أنظمة الملفات الموحدة: التخزين الطبقي
يستخدم Docker **نظام ملفات موحد** (مثل OverlayFS, AUFS) لإدارة صور الحاويات وأنظمة الملفات الخاصة بها بكفاءة. هذه هي الطريقة التي يرتبط بها بنظام الملفات في Linux:

- **طبقات الصورة**: يتم بناء صورة Docker من طبقات متراصة للقراءة فقط. تمثل كل طبقة مجموعة من التغييرات (مثل تثبيت حزمة، نسخ الملفات) محددة في ملف `Dockerfile` الخاص بك.
  - مثال: `FROM openjdk:17` هي طبقة واحدة، `COPY app.jar` تضيف طبقة أخرى.
  - يتم تخزين الطبقات في ذاكرة التخزين المؤقت وإعادة استخدامها، مما يوفر مساحة القرص ويسرع عمليات البناء.

- **نظام ملفات الحاوية**: عند تشغيل حاوية، يضيف Docker طبقة رقيقة قابلة للكتابة فوق طبقات الصورة للقراءة فقط. هذه تسمى آلية **النسخ عند الكتابة (CoW)**:
  - عمليات القراءة تأتي من طبقات الصورة.
  - عمليات الكتابة (مثل ملفات السجل، البيانات المؤقتة) تذهب إلى الطبقة القابلة للكتابة.
  - إذا تم تعديل ملف في طبقة سفلية، يتم نسخه أولاً إلى الطبقة القابلة للكتابة (ومن هنا جاءت تسمية "النسخ عند الكتابة").

- **العزل**: تحصل كل حاوية على طبقتها القابلة للكتابة الخاصة، لذا فإن التغييرات في حاوية واحدة لا تؤثر على الأخرى، حتى لو كانتا تشتركان في نفس الصورة الأساسية.

- **على القرص**: على المضيف، يتم تخزين هذه الطبقات في `/var/lib/docker` (مثل `/var/lib/docker/overlay2` لـ OverlayFS). لا تتفاعل مع هذا مباشرة—فـ Docker هو من يديره.

---

### كيف يتم عزل التطبيقات عن بعضها البعض
إليك كيف تعمل المكونات المذكورة أعلاه معًا لعزل التطبيقات:

1. **عزل العمليات (نطاق معرف العملية PID)**:
   - تشغل كل حاوية تطبيقها كشجرة عمليات مستقلة، غير مدركة للحاويات الأخرى أو المضيف.

2. **عزل الشبكة (نطاق الشبكة Network Namespace)**:
   - للحاويات واجهات شبكة منفصلة. تقوم الشبكة "الجسرية" الافتراضية لـ Docker بتعيين عنوان IP فريد لكل حاوية، ويتولى NAT معالجة الاتصال الخارجي.
   - مثال: يمكن لتطبيقي Spring Boot ربط المنفذ 8080 داخل حاوياتهما دون تعارض.

3. **عزل نظام الملفات (نطاق التركيب Mount Namespace + نظام الملفات الموحد UnionFS)**:
   - ترى كل حاوية نظام الملفات الخاص بها فقط، المبني من طبقات الصورة بالإضافة إلى طبقتها القابلة للكتابة.
   - إذا كتبت الحاوية A في `/tmp`، فإن الحاوية B لا تراه.

4. **عزل الموارد (مجموعات التحكم cgroups)**:
   - لا يمكن لتطبيق واحد أن يستنفد وحدة المعالجة المركزية أو الذاكرة الخاصة بالمضيف ويتسبب في تعطل تطبيق آخر.

5. **النواة المشتركة**:
   - تشارك الحاويات نواة Linux الخاصة بالمضيف، لكن النطاقات الاسمية تضمن ألا تتداخل مع بعضها البعض. يتم تصفية استدعاءات النظام أو إعادة توجيهها حسب الحاجة.

---

### سير العمل المبسط
1. **البناء**: تقوم بإنشاء صورة باستخدام `Dockerfile`، تحدد فيها التطبيق والتبعيات الخاصة به. يقوم Docker بتجميعها في طبقات باستخدام نظام ملفات موحد.
2. **التشغيل**: يقوم Docker بإنشاء حاوية عن طريق:
   - إعداد النطاقات الاسمية للعزل.
   - تخصيص مجموعات التحكم (cgroups) لحدود الموارد.
   - تركيب طبقات الصورة بالإضافة إلى طبقة قابلة للكتابة.
   - بدء تشغيل تطبيقك كنقطة الدخول (مثل `java -jar app.jar`).
3. **التنظيف**: عندما تتوقف الحاوية، يتم التخلص من الطبقة القابلة للكتابة (ما لم يتم حفظها كصورة جديدة باستخدام `docker commit`).

---

### لماذا Linux؟
يعتمد Docker على ميزات نواة Linux (النطاقات الاسمية، مجموعات التحكم، أنظمة الملفات الموحدة) المدمجة بعمق في كيفية عملها. على أنظمة macOS أو Windows، يشغل Docker جهازًا افتراضيًا خفيف الوزن لـ Linux (عبر HyperKit أو WSL2) لتوفير هذه الإمكانيات، ثم يقوم بتعيينها على نظام التشغيل المضيف.

---

### تشبيه بصري
فكر في حاويات Docker كشقق في مبنى:
- **النطاقات الاسمية (Namespaces)**: الجدران والأبواب تفصل بين السكان.
- **مجموعات التحكم (Cgroups)**: يحد المالك من الماء أو الكهرباء لكل وحدة.
- **نظام الملفات الموحد (UnionFS)**: تشارك جميع الشقق مخططًا أساسيًا مشتركًا (طبقات الصورة)، لكن يمكن لكل مستأثر تزيين مساحته (الطبقة القابلة للكتابة).

---

هل هذا يوضح كيفية عمل Docker وكيف يعزل التطبيقات؟ دعني أعرف إذا كنت تريد التعمق أكثر في أي جزء!