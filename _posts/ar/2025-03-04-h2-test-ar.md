---
audio: false
generated: true
lang: ar
layout: post
title: استخدام قاعدة البيانات H2 للاختبار
translated: true
---

لاستخدام قاعدة البيانات H2 في مشروع Spring، خاصة لأغراض الاختبار، تحتاج إلى دمج هذه قاعدة البيانات الخفيفة في الذاكرة في تطبيق Spring الخاص بك. قاعدة البيانات H2 مثالية للاختبار لأنها تعمل في الذاكرة، سريعة، ويمكن أن يتم إعدادها وتدميرها بسهولة دون حفظ البيانات على القرص. أدناه، سأشرح كيفية دمج H2 في مشروع Spring الخاص بك، مع افتراض أنك تستخدم Spring Boot (إعداد شائع لمشاريع Spring)، وأوضح الإشارة إلى `com.h2database.h2` التي تشير إلى التبعية Maven بدلاً من اسم حزمة أو اسم فئة (فئة السائق الفعلية هي `org.h2.Driver`).

---

### الخطوة 1: إضافة التبعية H2
لاستخدام H2 في مشروع Spring، يجب عليك تضمين التبعية في ملف البناء الخاص بك. نظرًا لأنك ذكرت `com.h2database.h2`، فهذا يتوافق مع الإحداثيات Maven للعنصر H2. إليك كيفية إضافة التبعية:

#### لمaven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **ملاحظة**: `<scope>test</scope>` يضمن أن H2 متاحة فقط خلال مرحلة الاختبار، مما يناسب التركيز على الاختبار.

#### لمبنيات (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

إذا كنت تستخدم Spring Boot و قد أضفت البدائل مثل `spring-boot-starter-data-jpa` أو `spring-boot-starter-jdbc`، فإن إدارة التبعيات Spring Boot ستجلب تلقائيًا نسخة متوافقة من H2 عندما تقوم بتكوين مصدر بيانات H2 للاختبار. في هذه الحالات، إضافة التبعية H2 بشكل صريح هو اختياري إلا إذا كنت تحتاج إلى نسخة محددة.

---

### الخطوة 2: تكوين H2 كمنبع بيانات للاختبار
في مشروع Spring Boot، تقوم بتكوين قاعدة البيانات عبر الخصائص، عادةً في `application.properties` أو `application.yml`. للاختبار، ضع هذه الإعدادات في `src/test/resources` لتغلب على الإعدادات الرئيسية للتطبيق.

#### الإعداد في `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **شرح**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: يحدد قاعدة بيانات H2 في الذاكرة باسم `testdb`. كلمة `mem` تضمن أن البيانات يتم تخزينها في الذاكرة.
  - `spring.datasource.driverClassName=org.h2.Driver`: فئة السائق JDBC لـ H2 (ليس `com.h2database.h2`، والتي قد تكون خطأ أو سوء فهم مع العنصر Maven).
  - `spring.datasource.username=sa`: اسم المستخدم الافتراضي لـ H2.
  - `spring.datasource.password=`: كلمة المرور الافتراضية فارغة.

#### الإعداد الأدنى مع التكوين التلقائي:
إذا كنت تستخدم Spring Boot مع `spring-boot-starter-data-jpa` أو `spring-boot-starter-jdbc` و H2 على مسار التصنيف، يمكن لـ Spring Boot أن يقوم بتكوين قاعدة بيانات H2 المضمنة دون خصائص صريحة. إنه يولد اسم قاعدة بيانات عشوائيًا (مثل `jdbc:h2:mem:<random-uuid>`). ومع ذلك، تحديد الخصائص أعلاه يمنحك التحكم في اسم قاعدة البيانات والإعدادات.

---

### الخطوة 3: استخدام H2 في الاختبارات
يوفر Spring Boot علامات الاختبار لتسهيل اختبار قاعدة البيانات مع H2. الطريقة تعتمد على ما إذا كنت تاختبر مستودعات البيانات (اختبارات مشابهة للوحدات) أو كامل مكدس التطبيق (اختبارات التكامل).

#### الخيار 1: اختبار مستودعات البيانات مع `@DataJpaTest`
لاختبار مستودعات Spring Data JPA، استخدم علامة `@DataJpaTest`. إنه يحدد تلقائيًا قاعدة بيانات H2 في الذاكرة، يجرى فحص الفئات `@Entity` ويضع المستودعات.

**مثال**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // مع افتراض أن البيانات تم تحميلها (مثلًا من خلال data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **الفوائد**:
  - H2 يتم إعداده تلقائيًا.
  - الاختبارات هي معاملات وتعود إلى الخلف بشكل افتراضي، مما يضمن حالة قاعدة البيانات النظيفة لكل اختبار.

#### الخيار 2: اختبار التكامل مع `@SpringBootTest`
لاختبارات التكامل الكاملة (مثل اختبار الموجهات، الخدمات، والمستودعات معًا)، استخدم `@SpringBootTest`. قم بتكوين H2 عبر الخصائص الخاصة بالاختبار.

**مثال**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // اختبار منطق الخدمة التي تتفاعل مع قاعدة البيانات
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **الإعداد**: استخدم `application.properties` في `src/test/resources` كما هو موضح أعلاه لضمان استخدام H2 بدلاً من قاعدة البيانات الإنتاجية.

#### طرق الإعداد البديلة:
- **استخدام `@TestPropertySource`**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **استخدام الملفات**:
  - إنشاء `src/test/resources/application-test.properties` مع الإعدادات H2.
  - أضف علامة `@ActiveProfiles("test")` على الاختبار.

---

### الخطوة 4: تهيئة بيانات الاختبار (اختياري)
لملء قاعدة بيانات H2 بالبيانات الاختبارية:

- **استخدام `schema.sql` و `data.sql`**:
  - ضع هذه الملفات في `src/test/resources`.
  - Spring Boot ينفذ `schema.sql` لإنشاء الجداول و `data.sql` لإدراج البيانات عندما يبدأ قاعدة البيانات المضمنة.
  - مثال `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **استخدام `@Sql`**:
  - تنفيذ مخططات SQL محددة قبل أو بعد طرق الاختبار.
  - مثال:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // منطق الاختبار
    }
    ```

---

### الخطوة 5: ضمان عزل الاختبارات (اختياري)
لمنع طرق الاختبار من التدخل مع بعضها البعض:
- استخدم `@Transactional` على فئات الاختبار أو الطرق. مع `@DataJpaTest`، يتم تمكين هذا بشكل افتراضي، ويعيد التغييرات إلى الخلف بعد كل اختبار. بالنسبة لـ `@SpringBootTest`، أضفها بشكل صريح إذا لزم الأمر:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- هذا يضمن أن كل اختبار يبدأ بوضع قاعدة البيانات المستقر.

---

### الخطوة 6: تقليد قاعدة بيانات الإنتاج (اختياري)
إذا كانت قاعدة بيانات الإنتاج مختلفة (مثل MySQL، PostgreSQL)، قم بتكوين H2 لتقليدها باستخدام أوضاع التوافق:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- أوضاع الدعم تشمل `MySQL`، `PostgreSQL`، إلخ، مما يجعل ه2 SQL و السلوك متوافقًا مع قاعدة بيانات الإنتاج الخاصة بك.

---

### الخطوة 7: تصحيح الأخطاء مع واجهة H2 (اختياري)
للمشاهدة قاعدة البيانات أثناء الاختبارات:
- تمكين واجهة H2:
  ```properties
  spring.h2.console.enabled=true
  ```
- الوصول إليها في `http://localhost:<port>/h2-console` إذا كنت تعمل على خادم ويب (مثلًا مع `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- هذا مفيد للتصحيح ولكن أقل شيوعًا في عمليات الاختبار الآلية.

---

### ملاحظات رئيسية
- **سائق H2**: فئة السائق الصحيحة هي `org.h2.Driver`، وليس `com.h2database.h2`. الأخير يشير إلى `groupId:artifactId` Maven.
- **ميزة Spring Boot**: التكوين التلقائي يسهل إعداد H2، خاصة للاختبار.
- **طبيعة الذاكرة**: البيانات H2 تتلف عندما يتوقف JVM، مما يجعلها مثالية للاختبارات المفرطة.

بالتتبع لهذه الخطوات، يمكنك استخدام قاعدة البيانات H2 في مشروع Spring الخاص بك للاختبار، مستفيدًا من سرعتها و بساطتها لتأكيد طبقة البيانات أو كامل مكدس التطبيق.