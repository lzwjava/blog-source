---
audio: false
generated: true
lang: ar
layout: post
title: استخدام قاعدة بيانات H2 للاختبار
translated: true
type: note
---

لاستخدام قاعدة بيانات H2 في مشروع Spring، خاصة لأغراض الاختبار، تحتاج إلى دمج قاعدة البيانات الخفيفة هذه التي تعمل في الذاكرة داخل تطبيق Spring. تعتبر قاعدة بيانات H2 مثالية للاختبار لأنها تعمل في الذاكرة، وسريعة، ويمكن إعدادها وإيقافها بسهولة دون الحاجة إلى حفظ البيانات على القرص. أدناه، سأشرح كيفية دمج H2 في مشروع Spring الخاص بك، بافتراض أنك تستخدم Spring Boot (إعداد شائع لمشاريع Spring)، وسأوضح الإشارة إلى `com.h2database.h2`، والتي تشير على الأرجح إلى تبعية Maven وليس اسم حزمة أو فئة (فئة السائق هي في الواقع `org.h2.Driver`).

---

### الخطوة 1: إضافة تبعية H2
لاستخدام H2 في مشروع Spring الخاص بك، يجب عليك تضمين تبعيتها في ملف البناء. بما أنك ذكرت `com.h2database.h2`، فإن هذا يتوافق مع إحداثيات Maven لقطعة H2 database. إليك كيفية إضافتها:

#### بالنسبة لـ Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **ملاحظة**: يضمن `<scope>test</scope>` أن H2 متاحة فقط خلال مرحلة الاختبار، مما يناسب تركيزك على الاختبار.

#### بالنسبة لـ Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

إذا كنت تستخدم Spring Boot وقمت بتضمين محفزات البدء مثل `spring-boot-starter-data-jpa` أو `spring-boot-starter-jdbc`، فإن إدارة التبعيات في Spring Boot ستسحب تلقائيًا إصدار H2 متوافق عند تكوين مصدر بيانات H2 للاختبار. في مثل هذه الحالات، تكون إضافة تبعية H2 صراحةً اختيارية ما لم تكن بحاجة إلى إصدار محدد.

---

### الخطوة 2: تكوين H2 كمصدر البيانات للاختبار
في مشروع Spring Boot، تقوم بتكوين قاعدة البيانات عبر الخصائص، عادةً في `application.properties` أو `application.yml`. للاختبار، ضع هذه التكوينات في `src/test/resources` لتجاوز إعدادات التطبيق الرئيسية.

#### التكوين في `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **شرح**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: يحدد قاعدة بيانات H2 في الذاكرة باسم `testdb`. تضمن الكلمة الأساسية `mem` تخزين البيانات في ذاكرة الوصول العشوائي.
  - `spring.datasource.driverClassName=org.h2.Driver`: فئة سائق JDBC لـ H2 (وليس `com.h2database.h2`، والذي يُرجح أنه خطأ مطبعي أو خلط مع قطعة Maven).
  - `spring.datasource.username=sa`: اسم المستخدم الافتراضي لـ H2.
  - `spring.datasource.password=`: كلمة المرور الافتراضية الفارغة.

#### التكوين الأدنى مع التكوين التلقائي:
إذا كنت تستخدم Spring Boot مع `spring-boot-starter-data-jpa` أو `spring-boot-starter-jdbc` وكان H2 موجودًا في classpath، فيمكن لـ Spring Boot تكوين قاعدة بيانات H2 مضمنة تلقائيًا دون خصائص صريحة. يقوم بإنشاء اسم قاعدة بيانات عشوائي (مثل `jdbc:h2:mem:<random-uuid>`). ومع ذلك، فإن تحديد الخصائص المذكورة أعلاه يمنحك التحكم في اسم قاعدة البيانات والإعدادات.

---

### الخطوة 3: استخدام H2 في الاختبارات
توفر Spring Boot شروحات اختبار لتبسيط اختبار قاعدة البيانات باستخدام H2. يعتمد النهج على ما إذا كنت تختبر المستودعات (اختبارات تشبه الوحدة) أو مجموعة التطبيق الكاملة (اختبارات التكامل).

#### الخيار 1: اختبار المستودعات باستخدام `@DataJpaTest`
لاختبار مستودعات Spring Data JPA، استخدم شرح `@DataJpaTest`. يقوم تلقائيًا بتكوين قاعدة بيانات H2 في الذاكرة، ومسح ضوئي للفئات ذات `@Entity`، وإعداد المستودعات.

**مثال**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // بافتراض تحميل البيانات (عبر data.sql مثلاً)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **المزايا**:
  - يتم إعداد H2 تلقائيًا.
  - الاختبارات تكون معاملاتية ويتم التراجع عنها افتراضيًا، مما يضمن حالة قاعدة بيانات نظيفة لكل اختبار.

#### الخيار 2: اختبار التكامل باستخدام `@SpringBootTest`
لاختبارات التكامل الشاملة (مثل اختبار المتحكمات والخدمات والمستودعات معًا)، استخدم `@SpringBootTest`. قم بتكوين H2 عبر خصائص محددة للاختبار.

**مثال**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // اختيار منطق الخدمة الذي يتفاعل مع قاعدة البيانات
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **التكوين**: استخدم `application.properties` في `src/test/resources` كما هو موضح سابقًا لضمان استخدام H2 بدلاً من قاعدة بيانات الإنتاج.

#### طرق تكوين بديلة:
- **باستخدام `@TestPropertySource`**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **باستخدام Profiles**:
  - أنشئ `src/test/resources/application-test.properties` بتكوين H2.
  - علّق الاختبار بـ `@ActiveProfiles("test")`.

---

### الخطوة 4: تهيئة بيانات الاختبار (اختياري)
لملء قاعدة بيانات H2 ببيانات اختبار:

- **باستخدام `schema.sql` و `data.sql`**:
  - ضع هذه الملفات في `src/test/resources`.
  - ينفذ Spring Boot `schema.sql` لإنشاء الجداول و `data.sql` لإدخال البيانات عند بدء تشغيل قاعدة البيانات المضمنة.
  - مثال `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **باستخدام `@Sql`**:
  - نفذ نصوص SQL محددة قبل أو بعد طرق الاختبار.
  - مثال:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // منطق الاختبار
    }
    ```

---

### الخطوة 5: ضمان عزل الاختبار (اختياري)
لمنع طرق الاختبار من التداخل مع بعضها البعض:
- استخدم `@Transactional` على فئات الاختبار أو طرقها. مع `@DataJpaTest`، يكون هذا مفعلًا افتراضيًا، حيث يتم التراجع عن التغييرات بعد كل اختبار. بالنسبة لـ `@SpringBootTest`، أضفه صراحةً إذا لزم الأمر:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- يضمن هذا أن يبدأ كل اختبار بحالة قاعدة بيانات متسقة.

---

### الخطوة 6: محاكاة قاعدة بيانات الإنتاج (اختياري)
إذا اختلفت قاعدة بيانات الإنتاج الخاصة بك (مثل MySQL أو PostgreSQL)، فقم بتكوين H2 لمحاكاتها باستخدام أوضاع التوافق:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- تشمل الأوضاع المدعومة `MySQL` و `PostgreSQL` وغيرها، مما يحاذي بناء جملة SQL وسلوك H2 مع قاعدة بيانات الإنتاج الخاصة بك.

---

### الخطوة 7: التصحيح باستخدام H2 Console (اختياري)
لتفقد قاعدة البيانات أثناء الاختبارات:
- مكّن H2 console:
  ```properties
  spring.h2.console.enabled=true
  ```
- قم بالوصول إليه عبر `http://localhost:<port>/h2-console` إذا كنت تشغل خادم ويب (مثل `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- هذا مفيد للتصحيح ولكنه أقل شيوعًا في عمليات التشغيل الآلي للاختبارات.

---

### ملاحظات رئيسية
- **سائق H2**: فئة السائق الصحيحة هي `org.h2.Driver`، وليس `com.h2database.h2`. يشير الأخير إلى `groupId:artifactId` في Maven.
- **ميزة Spring Boot**: يبسط التكوين التلقائي إعداد H2، خاصة للاختبار.
- **طبيعة العمل في الذاكرة**: يتم فقدان بيانات H2 عند توقف JVM، مما يجعلها مثالية لتشغيل الاختبارات المعزولة.

باتباع هذه الخطوات، يمكنك استخدام قاعدة بيانات H2 بفعالية في مشروع Spring الخاص بك للاختبار، والاستفادة من سرعتها وبساطتها للتحقق من طبقة البيانات الخاصة بك أو مجموعة التطبيق الكاملة.