---
audio: false
generated: true
image: false
lang: ar
layout: post
model: x-ai/grok-code-fast-1
title: قتل العملية على المنفذ باستخدام Psutil
translated: true
type: note
---

### استخدام psutil للكشف عن وإنهاء عملية على منفذ معين (Windows)

Psutil هي مكتبة بايثون متعددة المنصات لاسترداد معلومات حول العمليات قيد التشغيل واستخدام النظام. يمكنك استخدامها للعثور على العمليات التي تستمع على منفذ معين (مثل تحديد ما إذا كان شيء مثل خادم npm للتطوير يعمل على ذلك المنفذ) ثم إنهاء العملية. هذا يعمل على Windows، لكن ضع في اعتبارك:

- **الأذونات**: على Windows، يتطلب إنهاء العمليات غالبًا امتيازات إدارية (قم بتشغيل نص البايثون الخاص بك كمسؤول). قد يؤدي الفشل في القيام بذلك إلى إثارة استثناء `AccessDenied`.
- **كشف المنفذ**: سنركز على اتصالات TCP مع النوع "inet" (الذي يغطي IPv4 و IPv6). هذا شائع لخوادم الويب مثل تلك التي يبدأها `npm run dev` أو ما شابه.
- **الافتراضات**: نفترض أنك تريد التحقق من منفذ استماع (خادم) (مثل شيء مرتب محليًا). إذا كنت تقصد اتصالات صادرة إلى منفذ، فإن النهج يختلف قليلاً — دعني أعلم للتوضيح.

#### الخطوة 1: تثبيت psutil
إذا لم تقم بذلك بالفعل:
```bash
pip install psutil
```

#### الخطوة 2: نموذج كود للكشف والإنهاء
إليك نص بايثون كامل. يحدد وظيفة للعثور على PID الخاص بالعملية التي تستمع على منفذ معين (باستخدام `kind='inet'` كما حددت)، ثم ينهيها. على Windows، يُفضل استخدام `terminate()` بدلاً من `kill()` لأنه يسمح بالإغلاق المهذب (ما يعادل SIGTERM على Unix).

```python
import psutil
import time  # For optional delay

def get_pid_listening_on_port(port, kind='inet'):
    """
    يمسح اتصالات الشباب للعمليات التي تستمع على المنفذ المحدد.
    يُرجع قائمة بـ PIDs (عادةً واحدة، ولكن يمكن أن تكون متعددة إذا كانت نادرة).
    """
    pids = []
    for conn in psutil.net_connections(kind=kind):
        # تحقق مما إذا كان اتصال استماع (status='LISTEN') وأن منفذ العنوان المحلي يتطابق
        if conn.status == 'LISTEN' and conn.laddr and conn.laddr.port == port:
            if conn.pid:
                pids.append(conn.pid)
    return pids

def kill_process_on_port(port, kind='inet'):
    """
    يجد وينهي العملية التي تستمع على المنفذ المحدد.
    إذا كانت هناك عمليات متعددة، ينهي الكل (مع تحذير).
    """
    pids = get_pid_listening_on_port(port, kind)
    if not pids:
        print(f"لم يتم العثور على أي عملية تستمع على المنفذ {port}.")
        return
    
    for pid in pids:
        try:
            proc = psutil.Process(pid)
            print(f"جاري إنهاء العملية {proc.name()} (PID {pid}) على المنفذ {port}...")
            # استخدم terminate() للإغلاق المهذب؛ يرسل إشارة تشبه SIGTERM
            proc.terminate()
            # اختياري: انتظر قليلاً وأجبر القتل إذا لم يخرج
            gone, still_alive = psutil.wait_procs([proc], timeout=3)
            if still_alive:
                print(f"جاري الإنهاء القسري لـ PID {pid}...")
                still_alive[0].kill()
        except psutil.AccessDenied:
            print(f"تم الرفض: لا يمكن إنهاء PID {pid}. قم بالتشغيل كمسؤول؟")
        except psutil.NoSuchProcess:
            print(f"العملية {pid} لم تعد موجودة.")

# مثال للاستخدام: استبدل 3000 بالمنفذ المستهدف (مثلاً، خوادم npm للتطوير غالباً ما تستخدم 3000)
if __name__ == "__main__":
    kill_process_on_port(3000)  # اضبط النوع إذا لزم الأمر (مثلاً 'inet4' لـ IPv4 فقط)
```

#### الشروحات الرئيسية
- **`psutil.net_connections(kind='inet')`**: يسترجع اتصالات الشبكة من النوع 'inet' (يشمل IPv4 و IPv6). كل اتصال هو namedtuple يحتوي على حقول مثل:
  - `laddr`: العنوان المحلي (مثلاً ('0.0.0.0', 8080) – IP والمنفذ).
  - `status`: 'LISTEN' للخوادم التي تنتظر اتصالات.
  - `pid`: معرّف العملية للمالك.
  - نرشح للحصول على `status == 'LISTEN'` للعثور على الخوادم (مثل منفذ تطوير npm)، وليس اتصالات العميل.
- **استرداد PID**: النص يحصل مباشرة على PID من مجموعة الاتصال. إذا كنت تريد الكشف فقط دون إنهاء، استخدم `get_pid_listening_on_port(port)` والتي تُرجع PID(s).
- **إنهاء العملية**:
  - `psutil.Process(pid).terminate()`: يرسل إشارة إنهاء. على Windows، هذا يشبه CTRL+C.
  - إذا لم يخرج، نقوم بشكل اختياري بالإنهاء القسري باستخدام `kill()` (ما يعادل SIGKILL).
  - `wait_procs()` في Psutil تنتظر حتى تموت العملية.
- **تحديد نوع inet**: 'inet' يشمل كل من IPv4 و IPv6. إذا كنت تعلم أنها IPv4، غيّر إلى `kind='inet4'`. هذا الاسم يتناول طلبك "نوع inet" مباشرة.
- **ملاحظات خاصة بـ Windows**:
  - Psutil يتعامل مع داخليات Windows جيدًا، ولكن معلومات الشبكة قد تتطلب امتيازات مرتفعة في بعض الحالات.
  - للمنافذ تحت 1024 (مميزة)، فقط خدمات النظام يمكنها الربط، ولكن الكشف يجب أن يعمل仍然.
- **معالجة الأخطاء**: تمت إضافة فحوصات أساسية لعدم وجود عملية أو مشاكل في الوصول.
- **الاختبار**: شغّل شيئًا مثل `npm run dev` لشغل المنفذ 3000، ثم شغّل هذا النص.

إذا كان هذا لا يتطابق مع احتياجك الدقيق (مثلاً، إذا كان "npm run port" يعني شيئًا آخر أو كنت تريد اكتشاف اتصالات غير مستمعة)، قدم المزيد من التفاصيل للتحسين! من أجل السلامة/الأمان، تأكد من أنك تقتل فقط العمليات المقصودة.