---
audio: false
generated: true
image: false
lang: ar
layout: post
model: x-ai/grok-code-fast-1
title: شرح كود دمج واتساب
translated: true
type: note
---

فيما يلي شرح مفصل لمقتطف كود PHP المقدم. سأقوم بتفصيله خطوة بخطوة، مع التركيز على ما يفعله الكود، وهيكله، و**كيفية تفاعله مع WeChat**. يبدو أن هذا الكود جزء من تطبيق ويب يعتمد على CodeIgniter (إطار عمل PHP)، وتحديدًا فئة تحكم تسمى `Wechat` تندمج مع نظام WeChat. تم تصميمه لخدمة من المحتمل أن تتضمن البث المباشر، ومصادقة المستخدم، والمدفوعات، والإشعارات (على سبيل المثال، منصة مثل تطبيق البث المباشر).

سأفترض أنك على دراية بـ PHP الأساسي وCodeIgniter (مثل أدوات التحميل، والنماذج، والمكتبات). إذا لم تكن كذلك، فإن الكود يستخدم اصطلاحات CodeIgniter: وحدات التحكم تتعامل مع طلبات HTTP، والنماذج تتفاعل مع قاعدة البيانات، والمكتبات تغلف واجهات برمجة التطبيقات الخارجية. يعتمد الكود أيضًا على ثوابت خارجية (مثل `WECHAT_APP_ID`، `WECHAT_APP_SECRET`)، ومفاتيح (مثل `KEY_URL`)، ورموز أخطاء (مثل `ERROR_GET_ACCESS_TOKEN`)، والتي لم يتم تعريفها هنا ولكنها على الأرجح موجودة في ملف إعدادات.

### 1. **الهيكل العام والغرض**
   - **نظرة عامة على الفئة**: `Wechat` تمتد من `BaseController` (على الأرجح فئة أساسية مخصصة). تقوم بتحميل النماذج (مثل `SnsUserDao` لبيانات تسجيل الدخول عبر الوسائط الاجتماعية، `UserDao` لإدارة المستخدمين) والمكتبات (مثل `JSSDK` لـ WeChat JS SDK، `WxPay` للمدفوعات، `WXBizDataCrypt` لفك تشفير بيانات البرنامج المصغّر).
   - **التبعيات والمكتبات**:
     - `JSSDK`: يغلف WeChat JavaScript SDK للتفاعلات على الويب (مثل المشاركة، المدفوعات).
     - `WeChatPlatform`: على الأرجح كود مخصص لإرسال رسائل WeChat أو المقابض.
     - `WxPay` / `WxPayCallback`: يتعامل مع WeChat Pay (مثل المدفوعات والإشعارات).
     - `WXBizDataCrypt`: مكتبة WeChat الرسمية لفك تشفير البيانات المشفرة من البرامج المصغرة.
     - نماذج مثل `WxDao`، `WxSessionDao` تدير بيانات مخصصة لـ WeChat في قاعدة البيانات (مثل الجلسات، الاشتراكات).
   - **الغرض الرئيسي**: يقوم وحدة التحكم هذه بالربط بين التطبيق وواجهات برمجة تطبيقات WeChat للمصادقة (OAuth)، والمدفوعات، ومعالجة الرسائل/الأحداث (مثل الردود على الدردشات)، وإدارة الاشتراكات، وميزات التطبيق. إنه ليس نصًا قائمًا بذاته بل يستجيب لطلبات HTTP GET/POST من واجهة تطبيقك الأمامية أو من خوادم WeChat.
   - **ملاحظات الأمان**: يستخدم تواقيع SHA1 للتحقق (مثل في `checkSignature()`) ويشفر البيانات الحساسة (على سبيل المثال، عبر فك تشفير AES لـ WeChat في البرامج المصغرة). يتجنب حقن SQL مع عبارات مُعدّة مسبقًا (مفترضة في النماذج) ويعطل تحميل كيانات XML للأمان.

### 2. **كيفية التفاعل مع WeChat**
   يتفاعل الكود مع WeChat بعدة طرق، primarily من خلال **استدعاءات API** (طلبات صادرة إلى خوادم WeChat) و **الويب هوكس** (طلبات واردة من WeChat). تقدم WeChat واجهات برمجة تطبيقات للحسابات العامة، وتطبيقات الويب، والتطبيقات، والبرامج المصغرة. تتبع التفاعلات تدفقات OAuth الخاصة بـ WeChat، وبروتوكولات الدفع، ومعايير المراسلة.

   - **آليات التفاعل الرئيسية**:
     - **الطلبات الصادرة**: يستخدم HTTP GET/POST إلى واجهات برمجة تطبيقات WeChat (عبر طرق `JSSDK` مثل `httpGetAccessToken()` أو `wechatHttpGet()`). تسترد هذه البيانات مثل رموز الوصول، معلومات المستخدم، أو تولد رموز QR.
     - **الويب هوكس الواردة**: يرسل WeChat طلبات POST إلى تطبيقك (على سبيل المثال، إلى نقطة النهاية `/callback`) للرسائل، والأحداث (مثل اشتراك المستخدم في حسابك العام)، أو إشعارات الدفع. يقوم تطبيقك بالمعالجة والرد بـ XML (مثل الردود التلقائية).
     - **المصادقة**: تعتمد على بيانات اعتماد التطبيق (`WECHAT_APP_ID`, `WECHAT_APP_SECRET`, `WECHAT_TOKEN`) للوصول إلى API. تحقق من الطلبات عبر التواقيع لمنع انتحال الهوية.
     - **المنصات المدعومة**: تدعم حسابات WeChat العامة (مثل للويب)، تطبيق WeChat، برامج WeChat المصغرة (مثل للتطبيقات الأصلية)، و OAuth على الويب. تعين المستخدمين عبر المنصات عبر `unionId` (معرف WeChat فريد).

   الآن، دعنا نشرح الطرق/مجموعات الطرق الرئيسية، مجمعة حسب الوظيفة، مع أمثلة على تفاعلات WeChat.

#### **أ. التهيئة والأدوات المشتركة**
   - **المنشئ (`__construct`)**: يحمل المكتبات والنماذج. يُعدّ `JSSDK` ببيانات اعتماد تطبيق WeChat الخاص بك. لا يوجد تفاعل مباشر مع WeChat هنا—إنه تحضير لاستدعاءات API.
   - **التحقق من التوقيع (`checkSignature`)**: يتحقق من صحة الطلبات الواردة من WeChat (مثل في `callback_get`). يدمج `timestamp`، `nonce`، و `WECHAT_TOKEN` الخاص بك في تجزئة SHA1. إذا تطابقت مع `signature` الخاصة بـ WeChat، يكون الطلب أصليًا. يؤمّن هذا الويب هوكس.
   - **تحويل البيانات**: `xmlToArray()` و `arrayToXml()`: يتواصل WeChat بـ XML. يحول XML الوارد (مثل الرسائل) إلى مصفوفات والاستجابات الصادرة (مثل الردود) مرة أخرى إلى XML.
   - **التفاعل مع WeChat**: يضمن أن جميع تفاعلات نقاط النهاية/الويب هوكس يتم التحقق منها. تقوم بتكوين عنوان URL في وحدة تحكم مطور WeChat (مثل `yourdomain.com/wechat/callback`) لاستقبال هذه الطلبات المؤمّنة.

#### **ب. OAuth ومصادقة/تسجيل دخول المستخدم**
   تتعامل هذه الطرق مع تسجيل دخول المستخدم عبر WeChat OAuth، واسترداد ملفات المستخدمين الشخصية، وربط الحسابات. يقوم WeChat OAuth بإعادة توجيه المستخدمين إلى WeChat للموافقة، ثم العودة إلى تطبيقك مع `code` تقوم بتبادله بالرموز.

   - **التدفق العام**:
     - ينقر المستخدم على "تسجيل الدخول باستخدام WeChat" → يتم إعادة توجيهه إلى WeChat → يرسل WeChat `code` إلى تطبيقك → يبادل تطبيقك `code` بـ `access_token` ومعلومات المستخدم → إنشاء/تسجيل دخول المستخدم في قاعدة البيانات الخاصة بك.
     - يستخدم `unionId` لربط المستخدمين عبر منصات WeChat (مثل الويب والبرنامج المصغّر).

   - **`sign_get()`**: يولد حزمة توقيع لـ WeChat JS SDK على صفحات الويب الخاصة بك. يسمح بميزات مثل المشاركة أو الموقع. *تفاعل WeChat*: لا يوجد استدعاء API مباشر؛ يحسب التوقيع باستخدام سر التطبيق. يستخدم JS SDK هذا للتحقق من صفحتك وتمكين ميزات WeChat.
   
   - **`oauth_get()`**: يتعامل مع OAuth الكامل لـ WeChat على الويب. يبادل `code` برمز وصول، يسترد معلومات المستخدم، ويسجل دخول المستخدم أو يسجله. يربط بـ `unionId` إذا لزم الأمر. *تفاعل WeChat*: استدعاءات API إلى `/sns/oauth2/access_token` (الحصول على الرمز) و `/sns/userinfo` (الحصول على الملف الشخصي). إذا كان المستخدم جديدًا، يضيفه إلى قاعدة البيانات؛ يسجل دخول المستخدمين الحاليين.

   - **`silentOauth_get()`**: OAuth صامت (بدون نافذة منبثقة). يحصل على الرمز لكنه يتخطى معلومات المستخدم التفصيلية. يتحقق من الاشتراكات. *تفاعل WeChat*: نفس استدعاءات API المذكورة أعلاه، ولكن بدون `/userinfo`. يستخدم `/sns/auth` للتحقق من تسجيل دخول المستخدم السابق.

   - **`webOauth_get()`**: OAuth للمنصة المفتوحة (للمواقع الإلكترونية). يسترد `unionId` ويسجل الدخول إذا كان مربوطًا. *تفاعل WeChat*: يستخدم واجهات برمجة تطبيقات المنصة المفتوحة (مختلفة عن واجهات برمجة تطبيقات الحساب العام).

   - **`bind_get()`**: يربط مستخدمًا مسجل الدخول بـ WeChat. يبادل `code` بالرمز ويربط المستخدم عبر `unionId`. *تفاعل WeChat*: OAuth على مستوى التطبيق (`/sns/oauth2/accesstoken`)، ثم الربط في قاعدة البيانات.

   - **`appOauth_get()`**: لتطبيق WeChat (وليس البرنامج المصغّر). يتحقق مما إذا كان المستخدم موجودًا عبر `unionId`؛ إذا لم يكن كذلك، يُعدّ للتسجيل. *تفاعل WeChat*: تدفق OAuth لتطبيق الجوال مع واجهات برمجة تطبيقات مثل `/sns/userinfo`.

   - **مخصص للبرنامج المصغّر (`login_post()` و `registerByApp_post()`)**: يتعامل مع تسجيل الدخول/التسجيل لبرامج WeChat المصغرة (التطبيقات الأصلية).
     - `login_post()`: يبادل `code` الخاص ببرنامج WeChat المصغّر بـ `session_key` (مفتاح مؤقت). يخزن في Redis (عبر `WxSessionDao`). *تفاعل WeChat*: يستدعي API `/jscode2session`.
     - `registerByApp_post()`: يفك تشفير بيانات المستخدم باستخدام `WXBizDataCrypt` (فك تشفير AES). يتحقق من التوقيع، يسجل/يسجل دخول المستخدم عبر `unionId`. *تفاعل WeChat*: يفك تشفير البيانات المرسلة مشفرة من WeChat؛ لا يوجد استدعاء API صادر إذا كانت البيانات صالحة.

   - **ملاحظات التفاعل**: OAuth هي الطريقة الأساسية التي "تحدد" بها WeChat المستخدمين. يجب أن يكون تطبيقك مسجلاً في وحدة تحكم WeChat (حساب عام، تطبيق، أو برنامج مصغّر) للحصول على المعرفات/الأسرار. يتم التعامل مع الأخطاء (مثل الرموز غير الصالحة) عبر استجابات الفشل.

#### **ج. معالجة المدفوعات**
   - **`wxpayNotify_post()`**: يعالج إشعارات WeChat Pay (مثل تأكيدات الدفع). يمررها إلى `WxPayCallback` للمعالجة. *تفاعل WeChat*: ويب هوك من خوادم دفع WeChat (POST إلى `/wxpayNotify`). لا حاجة للرد؛ فقط يسجل النتائج.
   - **ملاحظات التفاعل**: يتطلب إعداد تاجر في WeChat Pay. يتعامل مع المعاملات بأمان—لا تقم بتشغيل المدفوعات من هنا؛ هذا مجرد تأكيد.

#### **د. معالجة الرسائل والأحداث (الويب هوكس)**
   تتعامل هذه مع الرسائل/الأحداث الواردة من خوادم WeChat، المرسلة كطلبات POST إلى `/callback`.

   - **`callback_get()`**: يتحقق من WeChat أثناء الإعداد. يردد `echostr` إذا كان صالحًا (فحص تطوير لمرة واحدة). *تفاعل WeChat*: GET وارد مع توقيع للتحقق.

   - **`callback_post()`**: معالج الويب هوك الرئيسي للرسائل/الأحداث (مثل قيام المستخدمين بإرسال رسائل إلى حسابك العام، الاشتراك، أو مسح رموز QR).
     - يحلل إدخال XML إلى مصفوفة.
     - يتعامل مع الرسائل النصية (مثل البحث عن البثوث المباشرة، كلمات إلغاء الاشتراك)، الاشتراكات (رسائل الترحيب)، إلغاء الاشتراكات، مسح/مشاهد QR (مثل للأحداث المباشرة أو الحزم الحمراء).
     - يرد بـ XML (مثل النص أو الرسائل المخصصة عبر `WeChatPlatform`).
     - يسجل الأحداث (مثل إلغاء الاشتراكات) في قاعدة البيانات.
     - *تفاعل WeChat*: يستقبل XML من WeChat (مثل `<xml><MsgType>text</MsgType>...</xml>`). يرد بـ XML خلال 5 ثوانٍ. لا توجد واجهات برمجة تطبيقات صادرة هنا—إنه سلبي.

   - **ملاحظات التفاعل**: أحداث مثل `EVENT_SUBSCRIBE` تُطلق منطقًا مخصصًا (مثل تحديث اشتراكات قاعدة البيانات، إرسال رسائل ترحيب بها روابط). ترمز رموز QR JSON للمشاهد (مثل صفحات الترويج).

#### **هـ. ميزات أخرى**
   - **`isSubscribe_get()` و `fixAllSubscribe_get()`**: يتحقق مما إذا كان المستخدم يتابع حسابك العام عبر WeChat API. يُصلح حالة اشتراك جميع المستخدمين بشكل مجمع. *تفاعل WeChat*: يستدعي API `/cgi-bin/user/info` مع openId.
   
   - **القائمة/المراسلة**: `menu_get()`, `createMenu_get()`, `addNews_get()`, `sendMassMsg_get()`: إدارة قوائم الحساب العام، إنشاء/إرسال مقالات، وإرسال رسائل جماعية. *تفاعل WeChat*: واجهات برمجة تطبيقات مثل `/cgi-bin/menu/get`, `/cgi-bin/menu/create`، إلخ.
   
   - **`uploadImg_get()`**: يرفع الصور للمقالات. *تفاعل WeChat*: واجهة برمجة تطبيقات الرفع.
   
   - **`qrcode_get()`**: يولد رموز QR للمشاهد (مثل روابط الترويج). *تفاعل WeChat*: يستدعي `/cgi-bin/qrcode/create`.
   
   - **`group_get()`**: يُرجع عنوان URL لصورة ثابتة (يبدو غير مرتبط بـ WeChat).

### 3. **الأنماط والتدفقات الشائعة**
   - **معالجة النجاح/الفشل**: يستخدم `succeed()` و `failure()` (على الأرجح من `BaseController`) للرد. يسجل الأخطاء/المعلومات لتصحيح الأخطاء.
   - **التكامل مع قاعدة البيانات**: النماذج (مثل `UserDao`، `SnsUserDao`) تتعامل مع إنشاء المستخدم، والربط، والاشتراكات. تدعم cross-platform عبر `unionId`.
   - **الأخطاء والحالات الطارئة**: يتعامل مع فشل API (مثل الرموز غير الصالحة)، مشاكل SQL، وأخطاء التشفير. تستخدم تدفقات البرنامج المصغّر مفاتيح الجلسة (المخزنة لفترة وجيزة) للأمان.
   - **الأداء/الأمان**: يقوم بتحديثات قاعدة البيانات الدفعية (مثل في `fixAllSubscribe_get`). يعتمد على حدود معدل WeChat وفحوصات التوقيع.

### 4. **كيفية استخدام/نشر هذا**
   - في تطبيق CodeIgniter، توجه المسارات إلى هذه الطرق (مثل `GET /wechat/oauth` تستدعي `oauth_get()`).
   - قم بتكوين WeChat: حدد عناوين URL / IPs في وحدة تحكم مطور WeChat.