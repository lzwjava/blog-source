---
audio: false
date: 2025-09-11
generated: true
image: false
lang: ar
layout: post
model: mistralai/mistral-medium-3.1
title: تنفيذ خادم الوكيل لبايثون كوبايلوت
translated: true
type: note
---

هذا السكريبت البايثون هو **خادم وكيل محلي** يتفاعل مع **GitHub Copilot** لتوليد إكمالات الشيفرة. فهو يحاكي سلوك الإضافة الرسمية لـ GitHub Copilot (مثل تلك الخاصة بـ Neovim) من خلال التعامل مع المصادقة وإعادة توجيه الطلبات إلى واجهة برمجة تطبيقات Copilot.

---

### **المكونات الرئيسية وسير العمل**
1.  **المصادقة (`setup()` و `get_token()`)**
    *   تستخدم **تدفق جهاز OAuth** للمصادقة مع GitHub.
    *   تطلب **كود جهاز** و **كود مستخدم** من GitHub.
    *   تطلب من المستخدم زيارة عنوان URL (`verification_uri`) وإدخال `user_code`.
    *   تتابع GitHub بشكل متكرر حتى يتم استلام **رمز وصول**.
    *   تحفظ الرمز المميز في `.copilot_token` لاستخدامه في المستقبل.
    *   تستبدل رمز الوصول بـ **رمز جلسة Copilot** (مطلوب لاستدعاءات API).

2.  **تحديث الرمز المميز (`token_thread()`)**
    *   يعمل في خلفية الخيط التنفيذي.
    *   يقوم بتحديث رمز Copilot كل **25 دقيقة** (نظرًا لأن الرموز تنتهي صلاحيتها).

3.  **التفاعل مع واجهة برمجة تطبيقات Copilot (`copilot()`)**
    *   يرسل **موجه** (مقتطف شيفرة) إلى واجهة برمجة تطبيقات Copilot.
    *   يُرجع الإكمالات المُولدة في **وضع التدفق** (سطرًا بسطر).
    *   يتعامل مع الأخطاء (مثل الرموز المميزة غير الصالحة/المنتهية الصلاحية).

4.  **خادم HTTP (`HTTPRequestHandler`)**
    *   يستمع لـ **طلبات POST** (على سبيل المثال، من محرر نصوص محلي).
    *   يستخرج `prompt` و `language` من الطلب.
    *   يستدعي `copilot()` ويرجع الإكمال كنص عادي.

5.  **الوظيفة الرئيسية (`main()`)**
    *   يبدأ **خيط تحديث الرمز المميز**.
    *   يُطلق **خادم HTTP** على منفذ محدد (افتراضيًا: `8080`).

---

### **كيف يعمل خطوة بخطوة**
1.  **أول تشغيل (عند عدم وجود رمز مميز)**
    *   يستدعي السكريبت `setup()` لإجراء المصادقة عبر OAuth.
    *   يزور المستخدم GitHub، يدخل الرمز، ويوافق على منح الوصول.
    *   يحفظ السكريبت رمز الوصول في `.copilot_token`.

2.  **التشغيل اللاحق (عند وجود الرمز المميز)**
    *   يقرأ السكريبت `.copilot_token` ويجلب رمز جلسة Copilot.
    *   إذا انتهت صلاحية الرمز المميز، يتم تحديثه تلقائيًا.

3.  **معالجة الطلبات**
    *   يرسل محرر نصوص محلي (مثل Neovim) **طلب POST** يحتوي على مقتطف شيفرة.
    *   يُوجه السكريبت الموجه إلى واجهة برمجة تطبيقات Copilot.
    *   يتم إرجاع الإكمال إلى المحرر.

4.  **إدارة الرمز المميز**
    *   يقوم خيط في الخلفية بتحديث الرمز المميز كل **25 دقيقة** لتجنب انتهاء صلاحيته.

---

### **سبب وجود هذا السكريبت**
*   **يتجاوز الإضافات الرسمية**: بعض المحررات (مثل Neovim) تفتقر إلى دعم Copilot الرسمي. يعمل هذا السكريبت كجسر.
*   **وكيل محلي**: يتجنب حدود معدل الطلبات من خلال إدارة الرموز المميزة محليًا.
*   **التخصيص**: يمكن تعديله للعمل مع محررات أو واجهات برمجة تطبيقات مختلفة.

---

### **الاعتبارات الأمنية والأخلاقية**
*   **معرف العميل الثابت**: يستخدم السكريبت `client_id` الرسمي لـ GitHub Copilot (`Iv1.b507a08c87ecfe98`)، مما قد ينتهك شروط الخدمة لـ GitHub إذا تم استخدامه خارج الإضافات المعتمدة.
*   **تخزين الرمز المميز**: يتم تخزين رمز الوصول كنص عادي (`.copilot_token`)، مما يمثل خطرًا أمنيًا.
*   **حدود معدل الطلبات**: الطلبات المتكررة قد تؤدي إلى تشغيل كشف إساءة الاستخدام من قبل GitHub.

---
### **كيفية الاستخدام**
1.  شغّل السكريبت:
    ```sh
    python copilot_proxy.py [PORT]
    ```
    (المنفذ الافتراضي: `8080`)

2.  اضبط محررك لإرسال الطلبات إلى `http://localhost:8080` بحمولة JSON مثل:
    ```json
    {
      "prompt": "def hello_world():",
      "language": "python"
    }
    ```

3.  سيقوم السكريبت بإرجاع إكمال Copilot.

---
### **تحسينات محتملة**
*   **معالجة أفضل للأخطاء**: إعادة محاولة الطلبات الفاشلة، التعامل مع مشاكل الشبكة.
*   **تخزين آمن للرموز المميزة**: استخدام تخزين مشفر أو متغيرات البيئة.
*   **ملف إعدادات**: السماح بتخصيص `client_id`، `port`، إلخ.
*   **التسجيل**: إضافة سجلات التصحيح لاستكشاف الأخطاء وإصلاحها.

---
### **بدائل**
*   استخدام **إضافات Copilot الرسمية** (VS Code، JetBrains، إلخ).
*   تجربة **بدائل مفتوحة المصدر** مثل **Codeium** أو **Tabby**.

هذا السكريبت هو حل بديل ذكي ولكن يجب استخدامه بحذر due due to potential ToS violations.