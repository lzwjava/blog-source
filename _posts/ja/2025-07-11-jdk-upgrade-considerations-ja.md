---
audio: false
generated: true
lang: ja
layout: post
title: レガシーコードベースの新しいJDKへのアップグレード
translated: true
type: note
---

大規模なコードベース（数万行）を JDK 8 および Spring 5.2.2 から、JDK 11、17、21 などの新しい JDK にアップグレードするには、特に IBM DB2 JCC ドライバーの使用、Spring への依存度の高さ、WebSphere Liberty へのデプロイを考慮して、混乱を最小限に抑えるよう注意深く計画する必要があります。以下では、互換性、潜在的な破壊的変更、移行手順、および推奨事項を含む主要な考慮事項を概説します。Spring もアップグレード可能とのことなので、それが必要または有益であるシナリオについてもカバーします。

### JDK アップグレードに関する一般的な考慮事項
- **下位互換性と破壊的変更**: Java は強力な下位互換性を目指していますが、JDK 8 からのアップグレードでは、コードに影響を与える可能性のある変更が導入されています：
  - **削除/非推奨 API**: JDK 9 以降では、`sun.misc.Unsafe` や一部の `sun.*` パッケージなどの内部 API が削除されました。コード（または依存関係）がこれらを使用している場合、代替手段（例：サードパーティライブラリの `Unsafe` 代替手段や Java の `VarHandle`）が必要になります。
  - **モジュールシステム (JDK 9 からの JPMS)**: 内部 API をカプセル化し、「不正なアクセス」エラーを引き起こす可能性があります。一時的に `--add-opens` または `--add-exports` フラグを使用しますが、モジュール性のためにリファクタリングすることを目指してください。
  - **ガベージコレクションの変更**: デフォルトの GC は JDK 9 で Parallel から G1 に移行し、以降のバージョン（例：11 以降の Shenandoah や ZGC）でさらに調整されました。メモリ集約的な部分でのパフォーマンス影響をテストしてください。
  - **その他の変更**: 強力なカプセル化、アプレット/ブラウザプラグインサポートの削除、セキュリティマネージャーの更新（17 で非推奨、21 で削除）、レコード（14 以降）、シールドクラス（17）、仮想スレッド（21）などの言語機能。これらはほとんど追加的ですが、リフレクションを多用している場合はコードの調整が必要になる可能性があります。
  - 8 から 11 へ: 中程度の変更（例：JAXB など、Java EE モジュールが 9 で削除されたため、依存関係として追加する必要がある）。
  - 11 から 17 へ: 混乱は少なく、主にパターンマッチングの改善などの機能強化。
  - 17 から 21 へ: 破壊的変更は最小限。主に switch のパターンマッチング（21）などの新機能で、大きな削除はない。
- **段階的な移行**: 直接 21 にジャンプしないでください。問題を分離するために、段階的に（例：8 → 11 → 17 → 21）アップグレードしてください。OpenRewrite や jdeps などのツールを使用して非互換性をスキャンします。
- **テストとツーリング**:
  - 新しい JDK で包括的なテスト（単体、結合、負荷）を実行します。Maven/Gradle プラグイン（例：`maven-enforcer-plugin`）などのツールは互換性を強制できます。
  - ビルドツールを更新: Maven/Gradle が新しい JDK をサポートしていることを確認します（ほとんどの場合サポートされていますが、Surefire などのプラグインを確認してください）。
  - マルチバージョンテスト: Docker または CI/CD（例：GitHub Actions）を使用して、複数の JDK に対してテストします。
- **依存関係とライブラリ**: すべてのサードパーティライブラリの互換性をスキャンします。`mvn dependency:tree` や OWASP Dependency-Check などのツールを使用します。
- **パフォーマンスとセキュリティ**: 新しい JDK は、より優れたパフォーマンス（例：17 以降での高速な起動）、セキュリティ修正、および長期サポート（LTS: 11 は 2026 年まで、17 は 2029 年まで、21 は 2031 年以降まで）を提供します。
- **大規模コードベースへの労力**: Spring を多用している場合、Spring が管理するコンポーネント（例：Bean、AOP）に焦点を当てます。リファクタリングに時間を割り当てます（例：メジャーバージョンジャンプごとに 1～2 週間、コードサイズに応じてスケーリング）。

### ターゲット JDK 別の具体的な考慮事項
#### JDK 11 へのアップグレード
- **利点**: LTS で安定性が高く、JDK 8 に近いため変更が少ない。サポート終了が近づいている（2026年）が、まだ広くサポートされている。
- **欠点**: 仮想スレッド（21）や改善された GC（17 以降）などの最新機能を逃す。
- **Spring 互換性**: Spring 5.2.2 は JDK 11 で動作しますが、JDK 11/17 のサポートとバグ修正を改善するために Spring 5.3.x（5.x ラインの最新）にアップグレードしてください。Spring の主要な変更は必要ありません。
- **DB2 JCC ドライバー**: 最近のドライバーバージョン（例：4.x+）と互換性があります。一部の古いドライバーは OpenJDK 11 で問題があったため、最新版（例：IBM のサイトから）に更新し、接続をテストしてください。
- **WebSphere Liberty**: 完全にサポートされています（Liberty は JDK 8/11/17/21 で動作します）。
- **JDK 8 からの主な変更点**:
  - 削除されたモジュール（例：JAXB 用の `javax.xml.bind:jaxb-api`）の依存関係を追加します。
  - 不正なリフレクティブアクセス（古いライブラリで一般的）を修正します。
  - 移行方法: ビルドファイル（例：Maven の `<java.version>11</java.version>`）を更新し、再コンパイルしてテストを実行します。Oracle の JDK 11 移行ガイドを使用してステップバイステップで確認します。
- **労力**: 低から中程度。内部 API を使用していない場合、コード変更は最小限。

#### JDK 17 へのアップグレード
- **利点**: 現在の LTS で採用が進んでいる。テキストブロック、レコード、拡張 switch などの機能を含む。11 よりも優れたパフォーマンス。
- **欠点**: SecurityManager が非推奨（使用している場合は削除を計画）。一部のライブラリは更新が必要な可能性がある。
- **Spring 互換性**: Spring 5.3.x は JDK 17 を完全にサポートします（LTS リリースでテスト済み）。最適な互換性のために 5.2.2 から 5.3.x にアップグレードしてください。Spring 自体に破壊的変更はありません。
- **DB2 JCC ドライバー**: 最近のバージョン（例：DB2 11.5 用 JCC 4.29+）で明示的にサポートされています。IBM のドキュメントは JDK 17 ランタイムサポートを確認しています。SQLJ の拡張機能についてテストしてください。
- **WebSphere Liberty**: 完全にサポートされています。
- **JDK 11 からの主な変更点**:
  - カプセル化がより厳格に。非推奨機能に関する警告が増加。
  - 新しい API（例：HTTP/2 クライアント用の `java.net.http`）はコードを近代化できますが必須ではありません。
  - 移行方法: JDK 11 の後、ビルドで 17 に切り替えます。移行ガイドを使用して、アプレット/Corba の削除（もしあれば）を確認します。
- **労力**: 中程度。JDK 11 移行を基盤とする。

#### JDK 21 へのアップグレード
- **利点**: 最新の LTS で、最先端の機能（例：並行処理のための仮想スレッド、シーケンスコレクション）を備える。将来性に最も優れる。
- **欠点**: Spring のアップグレードが必要（下記参照）。非常に古いライブラリで潜在的な問題が発生する可能性がある。
- **Spring 互換性**: Spring 5.x は JDK 21 を正式にサポートしていません（最大は JDK 17）。Spring 6.1+（これは JDK 17+ ベースラインを必要とする）にアップグレードする必要があります。これは大きな変更です：
  - **Jakarta EE 移行**: Spring 6 は Java EE (javax.*) から Jakarta EE 9+ (jakarta.*) に切り替わります。インポート（例：`javax.servlet` → `jakarta.servlet`）を変更し、設定を更新し、EE 関連のコード（例：JPA、Servlet、JMS）をリファクタリングします。
  - **破壊的変更**: 非推奨 API（例：古いトランザクションマネージャー）の削除。AOT コンパイルサポート。Hibernate（6.1+ へ）などの依存関係の更新が必要。
  - **移行ガイド**: Spring の公式ガイドに従います。まず Spring 5.3.x に更新し、次に 6.0/6.1 に更新します。自動化された javax → jakarta 交換のために OpenRewrite レシピなどのツールを使用します。大規模なコードベースの場合、これは数百の変更を含む可能性があります。モジュールごとにテストしてください。
  - Spring Boot（Spring の使用から推測）を使用している場合、Boot 3.x は Spring 6 および JDK 17+ に合わせています。
- **DB2 JCC ドライバー**: JDK 17 サポートとの下位互換性により互換性があります。最新のドライバー（例：4.32+）に更新し、確認してください。
- **WebSphere Liberty**: 完全にサポートされています（JDK 24 まで）。
- **JDK 17 からの主な変更点**:
  - SecurityManager が削除されました。使用している場合は、代替手段に置き換えてください。
  - 文字列テンプレート（プレビュー）などの新機能は既存のコードを破壊しません。
  - 移行方法: まず JDK 17 を基盤とし、その後切り替えます。17 と 21 の間に意図的な大きな破壊的変更はありません。
- **労力**: Spring をアップグレードする場合は高く、それ以外の場合は 17 と同様。

### プロジェクト固有の追加考慮事項
- **IBM DB2 JCC ライブラリ**: ドライバーバージョンが DB2 リリース（例：DB2 11.5 の場合、JCC 4.29+ を使用）と一致していることを確認します。JDBC 接続、SQLJ、およびカスタムクエリをテストします。新しい JDK は文字セットやタイムゾーンの問題を露呈する可能性があります。
- **WebSphere Liberty デプロイメント**: ブロッカーはありません。Liberty は JDK に対して柔軟です。モジュールの問題に対して JVM 引数（例：`--add-opens`）のために server.xml を必要に応じて更新します。早期にデプロイメントをテストしてください。
- **大規模コードベースと Spring の使用**: モジュール単位のアップグレード（例：コアサービスを最初にアップグレード）を優先します。Spring が深く統合されている場合（例：MVC、Data、Security）、5.2.2 で非推奨の機能を監査します。Spring のアップグレードは、より優れた AOT とオブザーバビリティをもたらしますが、コストが追加されます。
- **リスクと軽減策**: 非互換性によるダウンタイム。ロールバック計画で軽減します。商用の DB2/Liberty を使用している場合、ベンダーサポートに予算を割り当てます。
- **コスト**: 時間（完全な移行に数週間から数ヶ月）、潜在的なライセンス（例：Oracle などの商用 JDK）、および新機能に関するトレーニング。

### 推奨事項
- **推奨パス**: Spring 5.3.x を維持/アップグレードしながら、JDK 11 または 17 から始めてください。コードベースに対するリスクが低くなります。その機能（例：仮想スレッド）が必要で、Spring 6 へのアップグレード（Jakarta 変更により多大な労力がかかる可能性がある）を行う意思がある場合にのみ 21 に進んでください。
- **次のステップ**:
  1. jdeps/jlink でコードをスキャンし、問題を特定します。
  2. 移行テスト用のブランチを設定します。
  3. 公式ガイドを参照します: Oracle JDK 移行ガイド、Spring バージョン Wiki、IBM DB2 JDBC ダウンロード、Liberty Java サポート。
  4. Spring を 6 にアップグレードする場合は、Jakarta 変更に関する移行ガイドに従います。

より詳細な情報（例：特定の Spring モジュールや DB2 バージョン）を提供していただければ、さらに詳細を詰めることができます。