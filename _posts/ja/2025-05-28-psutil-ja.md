---
audio: false
generated: true
lang: ja
layout: post
title: TCP接続用Pythonスクリプト
translated: true
type: note
---

PowerShellコマンド `Get-NetTCPConnection -LocalPort 80` は、指定されたローカルポート（この場合はポート80）を使用しているWindowsシステム上のTCP接続に関する情報を取得します。Pythonで同様の機能を実現するには、ネットワーク接続を含むシステム詳細へのクロスプラットフォームアクセスを提供する `psutil` ライブラリを使用できます。

以下は、PowerShellコマンドと同様に、特定のローカルポート（例：ポート80）でフィルタリングされたTCP接続をリストするPythonスクリプトです：

```python
import psutil

def get_tcp_connections_by_port(local_port):
    # すべてのネットワーク接続を取得
    connections = psutil.net_connections(kind='tcp')
    
    # ローカルポートで接続をフィルタリング
    matching_connections = [
        conn for conn in connections
        if conn.laddr.port == local_port and conn.status == 'LISTEN'
    ]
    
    # 一致する接続の詳細を表示
    if not matching_connections:
        print(f"ポート {local_port} でリッスンしているTCP接続は見つかりませんでした")
        return
    
    print(f"ポート {local_port} でリッスンしているTCP接続:")
    print("PID\tローカルアドレス\tリモートアドレス\tステータス")
    print("-" * 50)
    
    for conn in matching_connections:
        local_addr = f"{conn.laddr.ip}:{conn.laddr.port}" if conn.laddr else "N/A"
        remote_addr = f"{conn.raddr.ip}:{conn.raddr.port}" if conn.raddr else "N/A"
        pid = conn.pid if conn.pid is not None else "N/A"
        status = conn.status if conn.status else "N/A"
        print(f"{pid}\t{local_addr}\t{remote_addr}\t{status}")

if __name__ == "__main__":
    target_port = 80  # フィルタリングするポートを指定（例：80）
    get_tcp_connections_by_port(target_port)
```

### 説明：
1. **`psutil`のインストール**：
   - ネットワーク接続の詳細にアクセスするには `psutil` ライブラリが必要です。以下を使用してインストールします：
     ```bash
     pip install psutil
     ```

2. **スクリプトの詳細**：
   - `psutil.net_connections(kind='tcp')` はすべてのTCP接続を取得します。
   - スクリプトは、ローカルポートが指定された `local_port`（例：80）と一致し、ステータスが `LISTEN` である接続をフィルタリングします（リッスンポートに対する `Get-NetTCPConnection` の動作を模倣するため）。
   - 一致する各接続について、以下を表示します：
     - **PID**：接続を使用しているアプリケーションのプロセスID。
     - **ローカルアドレス**：ローカルIPとポート。
     - **リモートアドレス**：リモートIPとポート（該当する場合。接続されていない場合は"N/A"）。
     - **ステータス**：接続ステータス（例："LISTEN"）。

3. **出力**：
   - 出力は `Get-NetTCPConnection` の表形式の出力に似せてフォーマットされ、PID、ローカルアドレス、リモートアドレス、ステータスを表示します。

### 出力例：
Webサーバー（例：ApacheやNginx）がポート80でリッスンしている場合、出力は以下のようになります：
```
ポート 80 でリッスンしているTCP接続:
PID     ローカルアドレス         リモートアドレス        ステータス
--------------------------------------------------
1234    0.0.0.0:80             N/A                   LISTEN
```

ポート80でリッスンしているプロセスがない場合：
```
ポート 80 でリッスンしているTCP接続は見つかりませんでした
```

### 注意点：
- **クロスプラットフォーム**：`psutil` ライブラリはWindows、Linux、macOSで動作しますが、`Get-NetTCPConnection` はWindows専用です。
- **権限**：一部のシステム（例：LinuxやmacOS）では、特定の接続詳細にアクセスするためにroot/管理者権限が必要な場合があります。
- **フィルタリング**：スクリプトは `Get-NetTCPConnection -LocalPort 80` の典型的な使用例に一致させるために `LISTEN` 接続をフィルタリングします。フィルターを変更して（例：`conn.status == 'LISTEN'` 条件を削除する）、`ESTABLISHED` のような他の接続状態を含めることができます。
- **追加情報**：PIDが利用可能な場合は `psutil.Process(conn.pid).name()` を使用して、プロセス名などの詳細を含めるようにスクリプトを拡張できます。

このスクリプトは、PowerShellコマンドと同等の機能と出力を提供するPython版です。追加機能が必要な場合や特定の要件がある場合は、お知らせください！