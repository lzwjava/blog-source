---
audio: false
generated: true
lang: ja
layout: post
title: VisualVM による Java アプリケーションのプロファイリング
translated: true
type: note
---

**VisualVM**を使用してJavaアプリケーションを監視・プロファイリングする方法について、明確で簡潔なガイドを紹介します。VisualVMはJDKに含まれる無料の強力なツールで、Javaアプリケーションのパフォーマンス、メモリ使用量、スレッドアクティビティを分析するのに役立ちます。

---

### ステップ1: VisualVMのインストールと起動
- **VisualVMがインストールされているか確認**: VisualVMは通常、JDK（バージョン6 update 7以降）に同梱されています。JDKインストール先の`bin`ディレクトリ（例: Windowsでは`jdk/bin/visualvm.exe`）を確認してください。
- **必要に応じてダウンロード**: 同梱されていない場合は、[VisualVM公式サイト](https://visualvm.github.io/)からダウンロードしてください。
- **VisualVMの起動**: `visualvm`実行ファイルを実行します。起動すると、ローカルマシンで現在実行中のJavaプロセスの一覧が表示されます。

---

### ステップ2: Javaアプリケーションへの接続
- **ローカルアプリケーション**: VisualVMはマシン上で実行中のJavaプロセスを自動検出します。監視したいプロセスをダブルクリックして接続します。
- **リモートアプリケーション**: 別のマシン上のJavaプロセスを監視するには:
  1. リモートJVMをJMX有効で起動します（例: JVM引数に`-Dcom.sun.management.jmxremote`を追加）。
  2. VisualVMで、左ペインの**Remote**を右クリックし、**Add Remote Host**を選択して、リモートマシンの詳細情報を入力します。
  3. 接続後、監視するリモートプロセスを選択します。

---

### ステップ3: アプリケーションパフォーマンスの監視
接続後、**Overview**タブにはプロセスIDやJVM引数などの基本情報が表示されます。リアルタイムのパフォーマンスデータを見るには**Monitor**タブに切り替えます:
- **CPU使用率**: アプリケーションのCPU使用量を追跡します。
- **メモリ使用量**: ヒープおよびメタスペースの消費量を時間経過とともに表示します。
- **スレッド**: アクティブなスレッドの数を表示します。
- **ガベージコレクション**: GCアクティビティを監視します。

これらのグラフは、アプリケーションの健全性を高レベルで把握するのに役立ちます。

---

### ステップ4: CPUとメモリ使用量のプロファイリング
より詳細な分析には、**Profiler**タブを使用します:
- **CPUプロファイリング**: CPU時間を最も消費しているメソッドを特定します。
  1. **Profiler**タブに移動し、**CPU**をクリックします。
  2. **Start**をクリックしてプロファイリングを開始します。
  3. 分析したいワークロードを生成するようにアプリケーションを使用します。
  4. **Stop**をクリックし、結果を確認して最も遅いメソッドを特定します。
- **メモリプロファイリング**: オブジェクトの割り当てを追跡し、メモリリークを検出します。
  1. **Profiler**タブで、**Memory**をクリックします。
  2. **Start**をクリックし、アプリケーションを使用した後、**Stop**をクリックします。
  3. オブジェクト数とサイズの結果を確認し、潜在的なメモリ問題を発見します。

**注意**: プロファイリングはオーバーヘッドを伴うため、本番環境ではなく、開発またはテスト環境で使用してください。

---

### ステップ5: ヒープダンプとスレッドダンプの分析
- **ヒープダンプ**: 詳細な分析のためにメモリスナップショットを取得します。
  1. **Monitor**タブで、**Heap Dump**をクリックします。
  2. ダンプを**Classes**または**Instances**ビューで探索し、オブジェクトの割り当てを確認します。
  3. メモリリークを示唆する可能性のある異常なパターン（例: 多すぎるオブジェクト）を探します。
- **スレッドダンプ**: デッドロックなどのスレッド問題を診断します。
  1. **Threads**タブで、**Thread Dump**をクリックします。
  2. スレッドの状態（例: RUNNABLE, WAITING）を確認して問題を特定します。

---

### ステップ6: 追加機能の探索
- **サンプラー**: **Sampler**タブにあり、フルのプロファイリングよりもオーバーヘッドが少ない、軽量なCPUおよびメモリ分析を提供します。
- **Visual GC**: **Tools > Plugins**からVisual GCプラグインをインストールして、ガベージコレクションの動作を可視化します。
- **MBeans**: **MBeans**タブを使用して、カスタムメトリクスのためのJMXビーンを表示および管理します。

---

### ベストプラクティス
- **本番環境でのプロファイリングは避ける**: プロファイリングはアプリケーションを遅くするため、開発またはテスト環境に限定してください。
- **シンプルに始める**: プロファイリングの前に、まず**Monitor**タブを使用してベースラインを取得します。
- **特定の問題にターゲットを絞る**: オーバーヘッドを最小限に抑えるために、問題が疑われる領域にプロファイリングを集中させます。
- **GCデータを確認する**: ガベージコレクションの統計を分析してメモリ使用量を最適化します。

---

### トラブルシューティング
- **アプリケーションが表示されない**: 互換性のあるJVMで実行されていること、およびVisualVMがアクセス権限を持っていることを確認してください。
- **リモート接続の問題**: リモートJVMがJMX用に設定されていること、およびネットワーク設定（ファイアウォールなど）が接続を許可していることを確認してください。
- **パフォーマンスへの影響**: プロファイリングが遅すぎる場合は、より軽量なオプションである**Sampler**に切り替えてください。

---

VisualVMは、Javaアプリケーションを理解し最適化するための優れたツールです。これらの手順に従って、パフォーマンスの監視、ボトルネックのプロファイリング、問題の効果的な診断を行ってください。詳細については、[VisualVM公式ドキュメント](https://visualvm.github.io/documentation.html)を参照してください。