---
audio: false
generated: true
lang: ja
layout: post
title: Windowsバッチファイルの書き方
translated: true
type: note
---

Windows バッチファイル（.bat または .cmd）は、Windows コマンド プロンプト（cmd.exe）によって実行される一連のコマンドを含むスクリプトファイルです。バッチファイルは、繰り返しタスクの自動化、システム操作の管理、またはプログラムの実行に使用されます。以下は、Windows バッチファイルの作成に関する包括的な紹介で、その目的、構文、一般的なコマンド、およびベストプラクティスをカバーしています。

### バッチファイルとは？
バッチファイルは、.bat または .cmd 拡張子を持つプレーンテキストファイルで、Windows コマンド プロンプトによって解釈されるコマンドを含みます。実行されると、コマンドは順次実行され、ファイル管理、システム構成、ソフトウェアインストールなどのタスクを自動化できます。

### バッチファイルを使用する理由
- **自動化**: 単一のスクリプトで複数のコマンドを実行します。
- **簡潔さ**: 高度なプログラミング知識は不要です。
- **システム管理**: バックアップ、ユーザー管理、環境設定などのタスクを実行します。
- **互換性**: コマンド プロンプトを搭載するすべての Windows バージョンで動作します。

### バッチファイルの作成方法
1. **スクリプトの記述**: テキストエディタ（Notepad、VS Code など）を使用してコマンドを記述します。
2. **正しい拡張子で保存**: ファイルを .bat または .cmd 拡張子で保存します（例: `script.bat`）。
3. **実行**: ファイルをダブルクリックするか、コマンド プロンプト経由で実行します。

### 基本構文と構造
- **コマンド**: バッチファイルは、コマンド プロンプトのコマンド（例: `dir`、`copy`、`del`）およびバッチ固有のコマンド（例: `echo`、`set`、`goto`）を使用します。
- **コメント**: `REM` または `::` を使用して、明確にするためのコメントを追加します。
- **大文字と小文字の区別なし**: コマンドと変数は大文字と小文字を区別しません。
- **行単位の実行**: `if`、`for`、`goto` などのフロー制御コマンドで制御されない限り、コマンドは行ごとに実行されます。

### 一般的なコマンドと機能
#### 1. **基本コマンド**
- `ECHO`: コマンドのエコーを制御するか、テキストを表示します。
  - 例: `ECHO Hello, World!` は "Hello, World!" を表示します。
  - `ECHO OFF`: 実行中のコマンド表示を抑制します。
- `CLS`: コマンド プロンプトの画面をクリアします。
- `PAUSE`: 実行を一時停止し、ユーザー入力を待機します。
- `EXIT`: スクリプトまたはコマンド プロンプト セッションを終了します。

#### 2. **変数**
- **変数の設定**: `SET` を使用して変数を作成または変更します。
  - 例: `SET MY_VAR=Hello` は変数 `MY_VAR` を作成します。
- **変数の使用**: `%変数名%` で参照します。
  - 例: `ECHO %MY_VAR%` は "Hello" を表示します。
- **環境変数**: `%PATH%`、`%USERNAME%`、`%DATE%` などの組み込み変数。

#### 3. **入力と出力**
- **ユーザー入力**: `SET /P` を使用して入力プロンプトを表示します。
  - 例: `SET /P NAME=Enter your name: ` はユーザー入力を `NAME` に保存します。
- **出力のリダイレクト**: `>` を使用して出力をファイルに書き込むか、`>>` で追加します。
  - 例: `DIR > filelist.txt` はディレクトリ一覧を `filelist.txt` に保存します。

#### 4. **条件文**
- `IF` を使用して条件に基づいてコマンドを実行します。
  - 構文: `IF 条件 コマンド [ELSE コマンド]`
  - 例: `IF "%NAME%"=="Admin" ECHO Welcome, Admin! ELSE ECHO Access denied.`

#### 5. **ループ**
- **FOR ループ**: ファイル、ディレクトリ、または値に対して反復処理を行います。
  - 例: `FOR %i IN (*.txt) DO ECHO %i` はすべての .txt ファイルをリストします。
  - 注: バッチファイル内では、変数に `%i` の代わりに `%%i` を使用します。
- **WHILE 風ループ**: `GOTO` と `IF` でシミュレートします。

#### 6. **サブルーチンとラベル**
- **ラベル**: `:ラベル` を使用してコードのセクションをマークします。
- **GOTO**: ラベルが付いたセクションにジャンプします。
  - 例: `GOTO :EOF` はファイルの終わりにジャンプします。
- **CALL**: 別のバッチファイルまたはサブルーチンを呼び出します。
  - 例: `CALL :mySubroutine` はラベル付きサブルーチンを実行します。

#### 7. **エラー処理**
- `%ERRORLEVEL%` でコマンドの成功を確認します。
  - 例: `IF %ERRORLEVEL% NEQ 0 ECHO Command failed.`

### ベストプラクティス
- **`ECHO OFF` の使用**: コマンド出力を非表示にして煩雑さを軽減します。
- **コメントの追加**: `REM` または `::` を使用してコードを文書化します。
- **段階的なテスト**: 小さなセクションを実行してデバッグします。
- **エラー処理**: 失敗に対して `%ERRORLEVEL%` をチェックします。
- **パスに引用符を使用**: スペースを処理するためにファイルパスを引用符で囲みます（例: `"C:\Program Files\"`）。
- **予約名の回避**: `CON`、`NUL`、`PRN` などの名前をファイルや変数に使用しないでください。
- **`@` を使用した非表示**: 個々のコマンドのエコーを抑制するためにコマンドの前に `@` を付けます（例: `@ECHO OFF`）。

### バッチファイルの例
以下は、一般的な機能（ユーザー入力のプロンプト表示、ディレクトリの作成、出力のログ記録）を示すサンプルバッチファイルです。

```batch
@echo off
REM ディレクトリを作成し、アクションをログに記録するサンプルバッチファイル
ECHO スクリプトを開始しています...

:: ディレクトリ名の入力プロンプト
SET /P DIRNAME=ディレクトリ名を入力してください: 

:: 入力が空かどうかを確認
IF "%DIRNAME%"=="" (
    ECHO エラー: ディレクトリ名が指定されていません。
    PAUSE
    EXIT /B 1
)

:: ディレクトリを作成し、結果をログに記録
MKDIR "%DIRNAME%"
IF %ERRORLEVEL%==0 (
    ECHO ディレクトリ "%DIRNAME%" が正常に作成されました。
    ECHO %DATE% %TIME%: ディレクトリ "%DIRNAME%" を作成しました >> log.txt
) ELSE (
    ECHO ディレクトリ "%DIRNAME%" の作成に失敗しました。
    ECHO %DATE% %TIME%: ディレクトリ "%DIRNAME%" の作成に失敗しました >> log.txt
)

PAUSE
ECHO 完了しました。
EXIT /B
```

### バッチファイルの実行方法
- 上記のコードを `sample.bat` として保存します。
- ダブルクリックするか、コマンド プロンプト経由で実行します（`cmd.exe /c sample.bat`）。

### 高度なヒント
- **遅延環境変数展開**: ループ内で更新される変数には `SETLOCAL EnableDelayedExpansion` を使用します（例: `%VAR%` の代わりに `!VAR!`）。
- **エラーレベル**: 特定の終了コードに対して `IF ERRORLEVEL n` でコマンドをテストします。
- **外部ツール**: `PowerShell` や `curl` などのツールを統合して高度な機能を実現します。
- **セキュリティ**: 悪意のあるコードを防ぐために、信頼できないソースからのバッチファイルの実行を避けてください。

### 制限事項
- **複雑さ**: 複雑なタスクについては、バッチファイルは PowerShell や Python よりも機能が劣ります。
- **エラー処理**: 現代のスクリプト言語と比較して限られています。
- **クロスプラットフォーム**: バッチファイルは Windows 固有です。

### リソース
- **公式ドキュメント**: Microsoft のコマンド プロンプトリファレンス（cmd.exe の `help` コマンド）。
- **チュートリアル**: SS64.com などのウェブサイトで詳細なコマンドリファレンスを提供しています。
- **コミュニティ**: X や Stack Overflow などのフォーラムでバッチファイルの例を検索します。

この紹介は、バッチファイルを作成するための基礎を提供します。簡単なスクリプトで練習し、コマンド プロンプトの `help` でコマンドを探求してスキルを拡張してください。