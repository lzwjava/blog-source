---
audio: false
generated: true
image: false
lang: ja
layout: post
model: x-ai/grok-4-fast
title: インターネットルーティングの仕組み
translated: true
type: note
---

はい、あなたの理解されている大まかな流れはまさにその通りです。コンピュータがIPアドレス（weibo.com の 106.63.15.9 など）を取得すると、ローカルネットワーク、ルーター、ISPのインフラを経由し、インターネット上の相互接続されたルーターを（「レイヤー by レイヤーで」）経由して、ターゲットサーバーに到達するまでの接続を開始します。これはすべて、TCP/IPプロトコルスタックによって自動的に処理され、URLを入力したり `ping` コマンドを実行したりする以外に手動で行うことはありません。

以下、ステップバイステップで分解し、あなたの `ping` と `traceroute` の出力を文脈に結びつけて説明します。あなたのセットアップ（ルーター背後でWi-Fi/イーサネットに接続されたMac）を想定し、実践的で内部で何が起こっているかに焦点を当てて説明します。

### 1. **DNS解決 (IPアドレスの取得)**
   - 接続前に、コンピュータはまずドメイン名（例: "weibo.com"）をDNSを介してIPアドレスに変換します。これは、OSのDNSリゾルバが公開DNSサーバー（Googleの 8.8.8.8 など）にクエリを送信することで行われます。
   - あなたの場合、`ping weibo.com` はこの解決を自動的に行い、IPv4アドレスが 106.63.15.9 であることを確認しています。（注: 127.0.0.1:7890 のようなローカルプロキシは通常HTTP/HTTPSトラフィックを扱いますが、`ping` は生のIP/ICMPを使用するため、プロキシをバイパスします。）
   - DNSが失敗すると、接続は行われません—ここですべてが停止します。

### 2. **コンピュータによるパケットの準備 (ローカル側)**
   - IPアドレスを取得すると、あなたのMacはTCP/IPレイヤーを使用して**パケット**（データの塊）を構築します：
     - **アプリケーション層**: コマンドやアプリ（例: ブラウザや `ping`）がデータを要求します。`Ping` はICMP "echo request"（簡単な「ねえ、そこにいる？」というメッセージ）を送信します。
     - **トランスポート層**: TCP/UDPヘッダー（信頼性/ポート番号用）またはpingの場合はICMPを追加します。あなたのpingはICMPを使用し、56バイトのデータ + ヘッダー = 64バイトパケットです。
     - **ネットワーク層 (IP)**: 送信元（あなたのローカルIP、例 192.168.1.x）と宛先（106.63.15.9）の情報を含むIPヘッダーで包みます。ここでルーティングの決定が始まります。
     - **リンク層 (イーサネット/Wi-Fi)**: ローカルネットワークでのホップのためにMACアドレスを追加します。あなたのコンピュータはARPを使用してルーターのMACアドレスを見つけます。
     - **物理層**: ケーブル/Wi-Fiを介して電気信号に変換します。
   - あなたのコンピュータは、106.63.15.9 に直接到達できない（あなたのローカル 192.168.1.0/24 サブネット上にない）ことを認識しているため、パケットを**デフォルトゲートウェイ**—あなたのルーター 192.168.1.1—に送信します。

### 3. **ローカルホップ: コンピュータ → ルーター**
   - これは最初の（そして最も速い）ステップで、あなたの `traceroute` 出力に示されています：
     ```
     1  192.168.1.1 (192.168.1.1) 26.903 ms 3.150 ms 3.161 ms
     ```
     - `Traceroute` （経路をマッピングするためにTTLを増やしながらパケットを送信する）は、このホップが往復で約3-27msかかることを確認しています。
     - あなたのルーターはパケットを受信し、ローカルのイーサネットヘッダーを取り除き、次のホップ用に再カプセル化します。それはそのルーティングテーブルを使用して、インターネット方向（WAN/ISP接続経由）に転送します。
     - プロキシはこれに影響しません—あなたのローカルプロキシ（ポート7890）はアプリケーションレベルのトラフィック（ウェブブラウジングなど）専用であり、生のIPルーティングには影響しません。

### 4. **ルーター → ISP → インターネットバックボーン (「レイヤー by レイヤー」ルーティング)**
   - あなたのルーターはISPに接続し（例: PPPoE、DHCP、またはモデム経由）、パケットをISPのエッジルーターに引き渡します。これには、あなたのルーターでのNATが関与する可能性があり、あなたのプライベートIP（192.168.1.x）をISPによって割り当てられたパブリックIPと交換します。
   - ここからは、インターネットを横断する**ルーター**の連鎖です：
     - **ISPルーター**: あなたのISP（例: Comcast または China Telecom）は、そのコアネットワークを通じてパケットをルーティングします。各ルーターはTTLをデクリメントし（あなたのtracerouteでは64から始まります）、BGPテーブルに基づいて転送します—これは基本的に、106.63.15.9 への最適なパスのグローバルマップです。
     - **ISP間/バックボーンホップ**: パケットはISP間の「ピアリングポイント」（例: 海底ケーブル、光ファイバー経由）を横断します。地理的位置に依存して、合計5〜20ホップになる可能性があります。Weibo.comのIP（106.63.15.9）は中国にあるので、あなたの位置（プロキシから推測してUS/EU）からは、太平洋横断ルートを経由することになります。
     - 各ホップは、ルーターがIPヘッダーを検査し、次のゲートウェイを決定し、転送することを意味します。単一のデバイスが完全なパスを知っているわけではありません—分散されています。
   - あなたの `traceroute` は途中で切れています（おそらく ^Z で中断された）ですが、完全に実行すると、以下のような行がさらに10〜15行表示されるでしょう：
     ```
     2  [ISP router IP] 10 ms ...
     3  [ISP core] 15 ms ...
     ...
     15  106.63.15.9  40 ms ...
     ```
     - 時間は合算されます: あなたのpingは合計約40msのRTTを示しているので、サーバーへの片道は約20msです。

### 5. **ターゲットサーバーの受信と応答**
   - パケットはWeiboのサーバー（または 106.63.15.9 のロードバランサー）に到着します。それはプロセスを逆にたどります: pingの場合はICMP echo replyで、ウェブ接続の場合はTCP SYN-ACKで応答します。
   - 応答は、多くの場合同じ経路（ただし常に同じとは限らない—インターネットルーティングは非対称です）をたどって戻ってきます。
   - あなたの `ping` は成功を確認しています: TTL=52 は約12ホップ（64-52=12）を意味し、40msのレイテンシは中国-アメリカ間の往復時間と一致します。

### なぜ「魔法のように」感じるのか (そして一般的な落とし穴)
- **自動化**: あなたのOS/カーネルがネットワークスタック（例: `ifconfig` や `ip route` でルートを表示）を通じてこれらすべてを処理します。デバッグしない限り、手動設定は不要です。
- **あなたのプロキシ**: それはping/tracerouteには透過的ですが、weibo.comへのブラウザトラフィックを傍受し、127.0.0.1:7890 を経由するようにルーティングします（おそらくVPN/検閲回避用）。生のトラフィックをテストする場合は `unset HTTP_PROXY HTTPS_PROXY` で無効にできます。
- **失敗した場合**: ファイアウォール、MTUの不一致、またはルートのブラックホール化がパケットをドロップする可能性があります。`tcpdump` や Wireshark のようなツールを使用すると、これをローカルでスニフできます。
- **セキュリティ注意**: IPアドレスは変更される可能性があり（DNS TTL）、HTTPSはこれに暗号化を追加します（TCP接続後のTLSハンドシェイク）。

要するに、はい—コンピュータ → ルーター → ISP → グローバルなルーターメッシュ → サーバーです。これはIPルーティング上に構築された見事な分散システムです。完全なtracerouteを共有したり、特定の部分（例: ウェブのためのTCPハンドシェイク）について深く掘り下げたい場合は、お知らせください！

[TCP/IP Illustrated (ネットワーキングの基礎に関する書籍)](https://www.oreilly.com/library/view/tcp-ip-illustrated-volume/0201633469/)
[Tracerouteの仕組み (Cloudflareの説明)](https://www.cloudflare.com/learning/network-layer/what-is-traceroute/)