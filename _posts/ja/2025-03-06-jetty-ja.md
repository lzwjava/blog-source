---
audio: false
generated: true
lang: ja
layout: post
title: ジェティを用いたWebサーバーの組み込み
translated: true
type: note
---

Javaプロジェクトで`org.eclipse.jetty`を使用するには、通常、Jettyライブラリを活用して軽量なWebサーバーやサーブレットコンテナをアプリケーション内に組み込みます。Eclipse FoundationによってメンテナンスされているJettyはオープンソースプロジェクトで、Webコンテンツの提供、HTTPリクエストの処理、サーブレットやWebアプリケーションのような機能のサポートを可能にします。以下は、Mavenをビルドツールとして使用して、Javaアプリケーションで基本的なWebサーバーをセットアップするために`org.eclipse.jetty`を使い始めるためのステップバイステップガイドです。

---

### **ステップ 1: プロジェクトにJettyの依存関係を追加する**
Jettyを使用するには、そのライブラリをプロジェクトに含める必要があります。Mavenを使用している場合は、必要な依存関係を`pom.xml`ファイルに追加します。サーブレットサポートを備えた基本的なWebサーバー設定には、`jetty-server`と`jetty-servlet`を含めます。以下に例を示します：

```xml
<project>
    <dependencies>
        <!-- Jetty Server -->
        <dependency>
            <groupId>org.eclipse.jetty</groupId>
            <artifactId>jetty-server</artifactId>
            <version>9.4.31.v20200723</version>
        </dependency>
        <!-- Jetty Servlet Support -->
        <dependency>
            <groupId>org.eclipse.jetty</groupId>
            <artifactId>jetty-servlet</artifactId>
            <version>9.4.31.v20200723</version>
        </dependency>
        <!-- Servlet API (オプション、推移的に含まれることが多い) -->
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>3.1.0</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>
</project>
```

- **`jetty-server`**: HTTPリクエストを処理するためのコアサーバー機能を提供します。
- **`jetty-servlet`**: サーブレットのサポートを追加し、Java Servlet APIの使用を可能にします。
- **`javax.servlet-api`**: サーブレットインターフェースを定義します。明確にするためにここでは明示的に含めていますが、`jetty-servlet`によって推移的に取り込まれることが多いです。

**注意**: 最新のJettyバージョンについては[Maven Central Repository](https://mvnrepository.com/artifact/org.eclipse.jetty)を確認し、`<version>`タグを適宜更新してください。

---

### **ステップ 2: シンプルなJettyサーバーを作成する**
`org.eclipse.jetty.server`パッケージの`Server`クラスのインスタンスを作成することで、プログラム的にJettyを使用できます。以下に、静的レスポンス用の基本的なハンドラーを使用する方法と、動的コンテンツ用にサーブレットを使用する方法という2つの一般的なアプローチを示します。

#### **オプション 1: 基本的なハンドラーを使用する**
この例は、すべてのリクエストに「Hello, World!」で応答するサーバーをセットアップします。

```java
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.server.Request;
import org.eclipse.jetty.server.handler.AbstractHandler;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class SimpleJettyServer {
    public static void main(String[] args) throws Exception {
        // ポート8080でリッスンするサーバーインスタンスを作成
        Server server = new Server(8080);

        // リクエストを処理するハンドラーを設定
        server.setHandler(new AbstractHandler() {
            @Override
            public void handle(String target, Request baseRequest, HttpServletRequest request, HttpServletResponse response)
                    throws IOException {
                // レスポンスプロパティを設定
                response.setContentType("text/plain");
                response.setStatus(HttpServletResponse.SC_OK);
                response.getWriter().println("Hello, World!");

                // リクエストを処理済みとしてマーク
                baseRequest.setHandled(true);
            }
        });

        // サーバーを起動
        server.start();
        server.join(); // 停止されるまでサーバーを実行し続ける
    }
}
```

- **`Server server = new Server(8080)`**: ポート8080でJettyサーバーを作成します。
- **`AbstractHandler`**: `handle`メソッドでリクエストの処理方法を定義するシンプルなハンドラーです。
- **`baseRequest.setHandled(true)`**: このハンドラーがリクエストを処理したことを示し、それ以上の処理を防ぎます。

このコードを実行し、ブラウザで`http://localhost:8080/`にアクセスすると「Hello, World!」が表示されます。

#### **オプション 2: サーブレットを使用する**
より複雑なアプリケーションでは、`ServletContextHandler`でサーブレットを使用できます。

```java
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.servlet.ServletContextHandler;
import org.eclipse.jetty.servlet.ServletHolder;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class ServletJettyServer {
    public static void main(String[] args) throws Exception {
        // ポート8080でサーバーインスタンスを作成
        Server server = new Server(8080);

        // サーブレットコンテキストハンドラーを作成
        ServletContextHandler context = new ServletContextHandler();
        context.setContextPath("/"); // ルートコンテキストパス

        // サーバーのハンドラーを設定
        server.setHandler(context);

        // リクエストを処理するサーブレットを追加
        context.addServlet(new ServletHolder(new HelloServlet()), "/*");

        // サーバーを起動
        server.start();
        server.join();
    }
}

// シンプルなサーブレットを定義
class HelloServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws IOException {
        response.setContentType("text/plain");
        response.setStatus(HttpServletResponse.SC_OK);
        response.getWriter().println("Hello from Jetty Servlet!");
    }
}
```

- **`ServletContextHandler`**: サーブレットコンテキストとマッピングを管理します。
- **`context.addServlet`**: `HelloServlet`を登録してすべてのリクエスト(`/*`)を処理します。
- **`doGet`**: GETリクエストに対するサーブレットの動作を定義します。

このコードを実行し、`http://localhost:8080/`にアクセスすると「Hello from Jetty Servlet!」が表示されます。

---

### **ステップ 3: コンパイルと実行**
1. プロジェクトがMavenでセットアップされていることを確認します（例: 依存関係をダウンロードするために`mvn compile`を実行）。
2. Javaクラスをコンパイルして実行します（例: `java SimpleJettyServer`、またはIDEの実行機能を使用）。
3. ブラウザで`http://localhost:8080/`にアクセスするか、`curl`のようなツールを使用してサーバーをテストします。

---

### **追加のユースケース**
- **WARファイルのデプロイ**: `WebAppContext`を使用してWebアプリケーションアーカイブ（WAR）ファイルまたはディレクトリをデプロイします：
  ```java
  import org.eclipse.jetty.server.Server;
  import org.eclipse.jetty.webapp.WebAppContext;

  public class WarJettyServer {
      public static void main(String[] args) throws Exception {
          Server server = new Server(8080);
          WebAppContext webapp = new WebAppContext();
          webapp.setContextPath("/");
          webapp.setWar("path/to/your.war"); // WARファイルへのパス
          server.setHandler(webapp);
          server.start();
          server.join();
      }
  }
  ```
  この機能には、`pom.xml`に`jetty-webapp`依存関係を追加してください。

- **Jettyの設定**: ポート、スレッドプール、HTTPSなどの設定をプログラム的に、またはXML設定ファイルで調整します（高度なセットアップについてはJettyのドキュメントを参照してください）。

---

### **主なポイント**
- **インポート**: 必要に応じて`org.eclipse.jetty.server`、`org.eclipse.jetty.servlet`などのクラスをインポートして使用します。
- **柔軟性**: Jettyは、静的コンテンツの提供、サーブレットの処理、WARファイルのデプロイ、さらには追加モジュールによるWebSocketsやHTTP/2のサポートも可能です。
- **ドキュメント**: 詳細については、[公式Jettyドキュメント](https://www.eclipse.org/jetty/documentation/)を参照してください。

これらの手順に従うことで、特定のニーズに合わせてJavaアプリケーションにWebサーバーを組み込むために`org.eclipse.jetty`を効果的に使用できます！