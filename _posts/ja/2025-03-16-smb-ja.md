---
audio: false
generated: true
lang: ja
layout: post
title: Ubuntuでメディア共有用SMBサーバーを構築する
translated: true
type: note
---

以下は、メディアファイルを提供するためにUbuntu上でSMB（Server Message Block）サーバーをセットアップするステップバイステップガイドです。SMBはネットワーク経由でファイルを共有できるプロトコルで、コンピュータ、テレビ、モバイルデバイスなどにメディアを提供するのに理想的です。LinuxでSMB機能を提供するソフトウェアであるSambaを使用し、メディアファイルを含むディレクトリを共有するように設定します。

---

### ステップ1: Sambaのインストール
まず、UbuntuシステムにSambaをインストールする必要があります。ターミナルを開き、以下のコマンドを実行します。

```bash
sudo apt update
sudo apt install samba
```

- `sudo apt update` は、最新バージョンを確実に取得するためにパッケージリストを更新します。
- `sudo apt install samba` は、必要なツールとサービスを含むSambaパッケージをインストールします。

---

### ステップ2: Samba設定ファイルのバックアップ
変更を加える前に、デフォルトのSamba設定ファイルをバックアップすることをお勧めします。以下を実行します。

```bash
sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.backup
```

これにより、後で変更を元に戻す必要が生じた場合に備えて、元のファイル（`smb.conf.backup`）のコピーが作成されます。

---

### ステップ3: メディア共有の設定
Sambaの設定ファイルは `/etc/samba/smb.conf` にあります。このファイルを編集して、メディアファイルの共有を定義します。この例では、メディアファイルが `/home/user/media` に保存されていると仮定します（`user` は実際のユーザー名に置き換えてください）。

1.  `nano`などのテキストエディタで設定ファイルを開きます。
    ```bash
    sudo nano /etc/samba/smb.conf
    ```

2.  ファイルの最後までスクロールし、以下のセクションを追加します。
    ```ini
    [media]
        path = /home/user/media
        browseable = yes
        read only = yes
        guest ok = yes
    ```

3.  保存して終了します。
    - `nano`では、`Ctrl+O`を押し、`Enter`で保存、`Ctrl+X`で終了します。

#### 設定の説明:
- `[media]`: ネットワークをブラウズするユーザーに表示される共有の名前。
- `path = /home/user/media`: 共有したいディレクトリ（メディアフォルダの場所に合わせて調整してください）。
- `browseable = yes`: ネットワークのブラウズ時に共有を表示します。
- `read only = yes`: ユーザーがファイルを変更または削除するのを防ぎます（メディア提供に理想的）。
- `guest ok = yes`: ユーザー名やパスワードなしでのアクセスを許可し、メディアアクセスをシンプルに保ちます。

---

### ステップ4: 設定の検証
設定に構文エラーがないことを確認するために、以下を実行します。

```bash
testparm
```

このコマンドは `smb.conf` ファイルをチェックし、読み込まれたサービスを表示します。エラーがなければ、次に進んで問題ありません。

---

### ステップ5: Sambaサービスの再起動
Sambaは2つのサービスを実行します: `smbd`（ファイル共有を処理）と `nmbd`（ネットワーク検出を処理）。変更を適用するためにこれらを再起動します。

```bash
sudo systemctl restart smbd
sudo systemctl restart nmbd
```

これらのサービスが起動時に自動的に開始されるようにするには（通常はデフォルトで有効）、以下を実行できます。

```bash
sudo systemctl enable smbd
sudo systemctl enable nmbd
```

---

### ステップ6: ファイルパーミッションの調整
ゲストアクセスを機能させるには、メディアディレクトリとそのファイルが誰でも読み取り可能でなければなりません。適切なパーミッションを設定します。

```bash
sudo chmod -R 755 /home/user/media
```

- `755` は、所有者がフルパーミッション（読み取り、書き込み、実行）を持ち、他のユーザーは読み取りと実行パーミッション（ファイルにアクセスして一覧表示するために必要）を持つことを意味します。
- `-R` は、変更をすべてのファイルとサブディレクトリに再帰的に適用します。

---

### ステップ7: ファイアウォールの設定
Ubuntuのファイアウォール（UFW）がアクティブな場合、SMBトラフィックを許可する必要があります。まず、ファイアウォールのステータスを確認します。

```bash
sudo ufw status
```

アクティブな場合は、必要なポートを開きます。

```bash
sudo ufw allow 139/tcp
sudo ufw allow 445/tcp
sudo ufw allow 137/udp
sudo ufw allow 138/udp
```

- ポート139と445（TCP）は、SMBファイル共有に使用されます。
- ポート137と138（UDP）は、ネットワーク検出のために `nmbd` によって使用されます。

ファイアウォールをリロードして変更を適用します。

```bash
sudo ufw reload
```

ファイアウォールが非アクティブな場合は、このステップをスキップできます。

---

### ステップ8: SMB共有のテスト
SMBサーバーは現在実行中のはずです。テストするには:

1.  UbuntuマシンのIPアドレスを調べます。
    ```bash
    ip addr show
    ```
    ネットワークインターフェース（`eth0` や `wlan0` など）の下にあるIPアドレス（例: `192.168.1.100`）を探します。

2.  ネットワーク上の別のデバイス（例: Windows PC）から:
    - ファイルエクスプローラーを開き、`\\<ubuntuのIPアドレス>\media`（例: `\\192.168.1.100\media`）と入力します。
    - メディアファイルが表示されるはずです。ゲストアクセスが有効になっているため、ログインは不要です。

---

### トラブルシューティングのヒント
問題が発生した場合:
- **Sambaログを確認**: ログは `/var/log/samba/` にあります（例: `log.smbd` や `log.nmbd`）。`cat` や `tail` を使用して表示します。
    ```bash
    sudo tail -f /var/log/samba/log.smbd
    ```
- **ローカルでテスト**: `smbclient` を使用してUbuntuマシン上の共有を一覧表示します。
    ```bash
    smbclient -L localhost
    ```
    または共有に接続します。
    ```bash
    smbclient //localhost/media -N
    ```
    （`-N` はゲストアクセスのためにパスワードプロンプトをスキップします。）

---

### コマンドのまとめ
完全なシーケンスは以下の通りです。

```bash
sudo apt update
sudo apt install samba
sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.backup
sudo nano /etc/samba/smb.conf  # [media]セクションを追加
testparm
sudo systemctl restart smbd
sudo systemctl restart nmbd
sudo chmod -R 755 /home/user/media
sudo ufw allow 139/tcp
sudo ufw allow 445/tcp
sudo ufw allow 137/udp
sudo ufw allow 138/udp
sudo ufw reload
```

SMBサーバーは、`/home/user/media` からメディアファイルを提供するようにセットアップされました！IPアドレスと共有名（`\\<IPアドレス>\media`）を使用して、ネットワーク上の任意のデバイスからアクセスできます。