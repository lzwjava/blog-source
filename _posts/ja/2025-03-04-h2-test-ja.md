---
audio: false
generated: true
lang: ja
layout: post
title: H2データベースをテストに使用する
translated: true
---

Spring プロジェクトで H2 データベースを使用するには、特にテスト目的で、この軽量なインメモリデータベースを Spring アプリケーションに統合する必要があります。H2 データベースは、メモリ上で実行され、高速で、ディスクにデータを保存せずに簡単に設定および削除できるため、テストに適しています。以下に、Spring Boot（Spring プロジェクトの一般的な設定）を使用していると仮定して、H2 を Spring プロジェクトに組み込む方法を説明します。また、`com.h2database.h2` の参照についても明確にします。これは、Maven 依存関係ではなく、パッケージ名やクラス名を指すものではなく、実際のドライバークラスは `org.h2.Driver` です。

---

### ステップ 1: H2 依存関係を追加する
Spring プロジェクトで H2 を使用するには、ビルドファイルにその依存関係を含める必要があります。`com.h2database.h2` を指定したため、これは H2 データベースアーティファクトの Maven 座標と一致します。以下に、その追加方法を示します。

#### Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **注意**: `<scope>test</scope>` は、H2 がテストフェーズ中のみ利用可能であることを保証します。これは、テストに焦点を当てるのに適しています。

#### Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

Spring Boot を使用し、`spring-boot-starter-data-jpa` や `spring-boot-starter-jdbc` などのスターターを含めている場合、Spring Boot の依存関係管理は、H2 データソースをテスト用に構成するときに、互換性のある H2 バージョンを自動的に取り込みます。この場合、特定のバージョンが必要でない限り、明示的に H2 依存関係を追加する必要はありません。

---

### ステップ 2: テスト用のデータソースとして H2 を構成する
Spring Boot プロジェクトでは、プロパティを通じてデータベースを構成します。通常、`application.properties` または `application.yml` で行います。テスト用の構成は、`src/test/resources` に配置して、メインアプリケーション設定を上書きします。

#### `src/test/resources/application.properties` の構成:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **説明**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: `testdb` という名前のインメモリ H2 データベースを指定します。`mem` キーワードは、データが RAM に保存されることを保証します。
  - `spring.datasource.driverClassName=org.h2.Driver`: H2 の JDBC ドライバークラスです（`com.h2database.h2` は、Maven アーティファクトの `groupId:artifactId` との混同かタイポです）。
  - `spring.datasource.username=sa`: デフォルトの H2 ユーザー名。
  - `spring.datasource.password=`: デフォルトの空のパスワード。

#### 自動構成による最小限の構成:
Spring Boot を使用し、`spring-boot-starter-data-jpa` または `spring-boot-starter-jdbc` を使用し、H2 がクラスパスにある場合、Spring Boot は明示的なプロパティなしで埋め込み H2 データベースを自動構成できます。ランダムなデータベース名（例: `jdbc:h2:mem:<random-uuid>`）を生成しますが、上記のプロパティを指定することで、データベース名と設定を制御できます。

---

### ステップ 3: テストで H2 を使用する
Spring Boot は、H2 を使用したデータベーステストを簡素化するためのテストアノテーションを提供します。アプローチは、リポジトリ（ユニットテストのようなテスト）をテストするか、フルアプリケーションスタック（統合テスト）をテストするかに依存します。

#### オプション 1: `@DataJpaTest` を使用してリポジトリをテストする
Spring Data JPA リポジトリをテストするには、`@DataJpaTest` アノテーションを使用します。これにより、インメモリ H2 データベースが自動的に構成され、`@Entity` クラスがスキャンされ、リポジトリが設定されます。

**例**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // データが読み込まれていると仮定（例: data.sql を通じて）
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **メリット**:
  - H2 が自動的に設定されます。
  - テストはトランザクションであり、デフォルトでロールバックされるため、各テストのデータベース状態がクリーンになります。

#### オプション 2: `@SpringBootTest` を使用して統合テストを行う
フルスタック統合テスト（例: コントローラ、サービス、リポジトリのテスト）を行うには、`@SpringBootTest` を使用します。テスト固有のプロパティを通じて H2 を構成します。

**例**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // データベースと相互作用するサービスロジックをテスト
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **構成**: 上記のように、`src/test/resources` にある `application.properties` を使用して、H2 がプロダクションデータベースの代わりに使用されることを確認します。

#### 代替の構成方法:
- **`@TestPropertySource` を使用**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **プロファイルを使用**:
  - `src/test/resources/application-test.properties` に H2 構成を作成します。
  - テストに `@ActiveProfiles("test")` アノテーションを付けます。

---

### ステップ 4: テストデータの初期化（オプション）
H2 データベースにテストデータを入力するには:

- **`schema.sql` と `data.sql` を使用**:
  - これらのファイルを `src/test/resources` に配置します。
  - Spring Boot は、埋め込みデータベースが開始するときに、`schema.sql` を実行してテーブルを作成し、`data.sql` を実行してデータを挿入します。
  - 例 `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **`@Sql` を使用**:
  - テストメソッドの前にまたは後に特定の SQL スクリプトを実行します。
  - 例:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // テストロジック
    }
    ```

---

### ステップ 5: テストの分離を確保する（オプション）
テストメソッドがお互いに干渉しないようにするには:
- テストクラスまたはメソッドに `@Transactional` を使用します。`@DataJpaTest` を使用すると、デフォルトで有効になり、各テスト後に変更をロールバックします。`@SpringBootTest` の場合は、必要に応じて明示的に追加します:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- これにより、各テストが一貫したデータベース状態から開始されます。

---

### ステップ 6: プロダクションデータベースをエミュレートする（オプション）
プロダクションデータベースが異なる場合（例: MySQL、PostgreSQL）、互換モードを使用して H2 をエミュレートします:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- サポートされているモードには `MySQL`、`PostgreSQL` などがあり、H2 の SQL 文法と動作をプロダクションデータベースに合わせます。

---

### ステップ 7: H2 コンソールを使用してデバッグする（オプション）
テスト中にデータベースを検査するには:
- H2 コンソールを有効にします:
  ```properties
  spring.h2.console.enabled=true
  ```
- Web サーバーを実行している場合（例: `@SpringBootTest(webEnvironment = RANDOM_PORT)`）、`http://localhost:<port>/h2-console` でアクセスできます。
- これは、デバッグに役立ちますが、自動化されたテスト実行では一般的ではありません。

---

### 主要なポイント
- **H2 ドライバー**: 正しいドライバークラスは `org.h2.Driver` であり、`com.h2database.h2` は Maven の `groupId:artifactId` を指します。
- **Spring Boot の利点**: 自動構成により、特にテスト用の H2 設定が簡単になります。
- **インメモリの性質**: H2 のデータは JVM が停止すると失われるため、分離されたテスト実行に適しています。

これらの手順に従うことで、Spring プロジェクトで H2 データベースをテストに使用し、データ層またはフルアプリケーションスタックの検証にその速さと簡単さを活用できます。