---
audio: false
generated: true
lang: ja
layout: post
title: テストにおけるH2データベースの使用
translated: true
type: note
---

SpringプロジェクトでH2データベースを使用するには、特にテスト目的で、この軽量なインメモリデータベースをSpringアプリケーションに統合する必要があります。H2データベースは、メモリ内で動作し、高速で、データをディスクに永続化せずに簡単にセットアップおよび破棄できるため、テストに最適です。以下では、Spring Boot（Springプロジェクトで一般的なセットアップ）を使用していることを想定し、H2をSpringプロジェクトに組み込む方法を説明します。また、`com.h2database.h2`という参照は、パッケージやクラス名ではなく、Maven依存関係を指している可能性が高いこと（実際のドライバークラスは`org.h2.Driver`です）を明確にします。

---

### ステップ1: H2依存関係の追加
SpringプロジェクトでH2を使用するには、ビルドファイルにその依存関係を含める必要があります。`com.h2database.h2`とあるのは、H2データベースアーティファクトのMaven座標と一致します。追加方法は以下の通りです。

#### Mavenの場合（`pom.xml`）:
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **注記**: `<scope>test</scope>`により、H2はテストフェーズでのみ利用可能になり、テストに焦点を当てた場合に適しています。

#### Gradleの場合（`build.gradle`）:
```gradle
testImplementation 'com.h2database:h2'
```

Spring Bootを使用していて、`spring-boot-starter-data-jpa`や`spring-boot-starter-jdbc`などのスターターを含めている場合、Spring Bootの依存関係管理は、テスト用にH2データソースを構成すると、互換性のあるH2バージョンを自動的に取り込みます。そのような場合、特定のバージョンが必要でない限り、明示的にH2依存関係を追加する必要はありません。

---

### ステップ2: テスト用データソースとしてH2を構成する
Spring Bootプロジェクトでは、データベースはプロパティ（通常は`application.properties`または`application.yml`）で構成します。テスト用には、これらの構成を`src/test/resources`に配置して、メインアプリケーションの設定を上書きします。

#### `src/test/resources/application.properties`での構成:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **説明**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: `testdb`という名前のインメモリH2データベースを指定します。`mem`キーワードにより、データはRAMに保存されます。
  - `spring.datasource.driverClassName=org.h2.Driver`: H2のJDBCドライバークラス（`com.h2database.h2`は、タイポまたはMavenアーティファクトとの混同の可能性があります）。
  - `spring.datasource.username=sa`: デフォルトのH2ユーザー名。
  - `spring.datasource.password=`: デフォルトの空のパスワード。

#### 自動構成による最小構成:
`spring-boot-starter-data-jpa`や`spring-boot-starter-jdbc`を使用するSpring Bootで、H2がクラスパス上にある場合、Spring Bootは明示的なプロパティなしで組み込みH2データベースを自動構成できます。これはランダムなデータベース名（例: `jdbc:h2:mem:<random-uuid>`）を生成します。ただし、上記のプロパティを指定すると、データベース名と設定を制御できます。

---

### ステップ3: テストでのH2の使用
Spring Bootは、H2を使用したデータベーステストを簡素化するテスト注釈を提供します。このアプローチは、リポジトリ（単体テストのようなもの）をテストするか、フルアプリケーションスタック（統合テスト）をテストするかによって異なります。

#### オプション1: `@DataJpaTest`によるリポジトリのテスト
Spring Data JPAリポジトリをテストするには、`@DataJpaTest`注釈を使用します。これは、インメモリH2データベースを自動的に構成し、`@Entity`クラスをスキャンし、リポジトリを設定します。

**例**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // データがロードされていると仮定（例: data.sql経由）
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **利点**:
  - H2が自動的にセットアップされます。
  - テストはデフォルトでトランザクショナルであり、ロールバックするため、テストごとにクリーンなデータベース状態が保証されます。

#### オプション2: `@SpringBootTest`による統合テスト
フルスタックの統合テスト（例: コントローラー、サービス、リポジトリを一緒にテスト）には、`@SpringBootTest`を使用します。テスト固有のプロパティを介してH2を構成します。

**例**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // データベースと相互作用するサービスロジックをテスト
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **構成**: 前述の`src/test/resources`の`application.properties`を使用して、本番データベースではなくH2が使用されるようにします。

#### 代替構成方法:
- **`@TestPropertySource`の使用**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **プロファイルの使用**:
  - H2構成で`src/test/resources/application-test.properties`を作成します。
  - テストに`@ActiveProfiles("test")`を注釈します。

---

### ステップ4: テストデータの初期化（オプション）
H2データベースにテストデータを投入するには:

- **`schema.sql`と`data.sql`の使用**:
  - これらのファイルを`src/test/resources`に配置します。
  - Spring Bootは、組み込みデータベースが起動すると、`schema.sql`を実行してテーブルを作成し、`data.sql`を実行してデータを挿入します。
  - `data.sql`の例:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **`@Sql`の使用**:
  - テストメソッドの前後に特定のSQLスクリプトを実行します。
  - 例:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // テストロジック
    }
    ```

---

### ステップ5: テストの分離を確保する（オプション）
テストメソッドが互いに干渉しないようにするには:
- テストクラスまたはメソッドに`@Transactional`を使用します。`@DataJpaTest`では、これがデフォルトで有効になり、各テスト後に変更がロールバックされます。`@SpringBootTest`では、必要に応じて明示的に追加します:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- これにより、各テストが一貫したデータベース状態で開始されます。

---

### ステップ6: 本番データベースのエミュレート（オプション）
本番データベース（例: MySQL、PostgreSQL）が異なる場合、互換モードを使用してH2を構成します:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- サポートされるモードには`MySQL`、`PostgreSQL`などがあり、H2のSQL構文と動作を本番データベースに合わせます。

---

### ステップ7: H2コンソールを使用したデバッグ（オプション）
テスト中のデータベースを検査するには:
- H2コンソールを有効にします:
  ```properties
  spring.h2.console.enabled=true
  ```
- Webサーバーが実行されている場合（例: `@SpringBootTest(webEnvironment = RANDOM_PORT)`）、`http://localhost:<port>/h2-console`でアクセスします。
- これはデバッグに役立ちますが、自動化されたテスト実行ではあまり一般的ではありません。

---

### 主な注意点
- **H2ドライバー**: 正しいドライバークラスは`org.h2.Driver`であり、`com.h2database.h2`ではありません。後者はMavenの`groupId:artifactId`を指します。
- **Spring Bootの利点**: 自動構成により、特にテスト用のH2セットアップが簡素化されます。
- **インメモリ特性**: H2のデータはJVM停止時に失われるため、分離されたテスト実行に理想的です。

これらの手順に従うことで、SpringプロジェクトでH2データベースをテストに効果的に使用し、その速度とシンプルさを活用してデータ層またはフルアプリケーションスタックを検証できます。