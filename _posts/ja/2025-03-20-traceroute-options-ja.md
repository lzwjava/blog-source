---
audio: false
generated: true
lang: ja
layout: post
title: トレースルートオプション
translated: true
type: note
---

Tracerouteはネットワークパスの診断に強力なツールであり、基本的な使用方法は簡単ですが、動作をカスタマイズする高度なオプションも提供しています。以下では、一般的なオプションと、実用的な例に焦点を当てた高度なtracerouteの使用方法を説明します。正確なオプションはオペレーティングシステムによって異なりますが（例: Windowsは`tracert`、Linux/macOSは`traceroute`を使用）、最も広く適用可能なものをカバーします。

### 基本的な使用方法
- **Linux/macOS**: `traceroute [宛先]`
  - 例: `traceroute google.com`
- **Windows**: `tracert [宛先]`
  - 例: `tracert google.com`

これにより、自分とターゲット間のホップ（ルーター）と、各ホップの往復時間（RTT）が表示されます。

---

### 一般的なTracerouteオプション
以下は、Unix系システム（Linux/macOS）の`traceroute`コマンドにおける主なオプションの概要です。Windowsの`tracert`はオプションが少ないですが、いくつかの概念は共通しています。

1. **`-n` (DNSルックアップをしない)**  
   - IPアドレスからホスト名への解決をスキップし、処理を高速化して生のIPを表示します。
   - 使用例: `traceroute -n google.com`
   - 理由: DNS解決が遅い場合や、IPアドレスのみに関心がある場合に便利です。

2. **`-m [最大ホップ数]` (最大ホップ数を設定)**  
   - tracerouteが諦める前にチェックするホップ数を制限します（デフォルトは多くの場合30）。
   - 使用例: `traceroute -m 15 google.com`
   - 理由: ターゲットが到達不能または遠すぎる場合の無限の実行を防ぎます。

3. **`-q [クエリ数]` (ホップごとのクエリ数)**  
   - ホップごとに送信するパケット数を設定します（デフォルトは3）。各クエリはレイテンシ値を表示します。
   - 使用例: `traceroute -q 1 google.com`
   - 理由: 出力の煩雑さを減らすか、トレースを高速化します。より信頼性の高いレイテンシデータを得るために増やすこともあります。

4. **`-w [待機時間]` (ホップごとの待機時間)**  
   - 応答を待つ時間（秒単位）を設定し、それを超えるとホップがタイムアウトとしてマークされます。
   - 使用例: `traceroute -w 2 google.com`
   - 理由: 遅いネットワークに対応するか、高速なネットワークでの遅延を減らします。

5. **`-p [ポート]` (ポート指定、UDPモード)**  
   - UDPベースのtracerouteの宛先ポートを設定します（デフォルトは多くの場合33434+）。
   - 使用例: `traceroute -p 53 google.com`
   - 理由: 特定のサービス（例: ポート53のDNS）をターゲットにするか、ICMPをブロックするフィルターを回避します。

6. **`-I` (UDPの代わりにICMPを使用)**  
   - UDP（多くのシステムでのデフォルト）からICMP Echo Requestパケットに切り替えます。
   - 使用例: `traceroute -I google.com`
   - 理由: 一部のネットワークはUDPをブロックしますがICMPは許可するため、可視性が向上します。

7. **`-T` (TCPモード)**  
   - UDPやICMPの代わりにTCPパケット（多くの場合SYNパケット）を使用します。
   - 使用例: `traceroute -T -p 80 google.com`
   - 理由: ICMP/UDPをブロックするファイアウォールを回避します。Webサーバー（ポート80 = HTTP）へのトレースに最適です。

8. **`-f [最初のTTL]` (特定のTTLから開始)**  
   - 初期TTL値を設定し、それ以前のホップをスキップします。
   - 使用例: `traceroute -f 5 google.com`
   - 理由: ローカルネットワークを超えた特定の経路部分に焦点を当てます。

9. **`-g [ゲートウェイ]` (Loose Source Routing)**  
   - （ネットワークがサポートしていれば）指定されたゲートウェイ経由でパケットを強制します。
   - 使用例: `traceroute -g 192.168.1.1 google.com`
   - 理由: 特定の経路をテストするか、デフォルトのルーティングをバイパスします。

10. **`-4` または `-6` (IPv4またはIPv6を強制)**  
    - tracerouteをIPv4またはIPv6に制限します。
    - 使用例: `traceroute -6 google.com`
    - 理由: 特定のプロトコルをテストしていることを保証し、デュアルスタックネットワークで有用です。

---

### Windows `tracert` オプション
Windowsのオプションは少ないですが、主なものは以下の通りです:
- **`-d`**: DNSルックアップをしない（`-n`と同様）。
- **`-h [最大ホップ数]`**: 最大ホップ数（`-m`と同様）。
- **`-w [タイムアウト]`**: 待機時間（ミリ秒単位）（`-w`と同様）。
- 例: `tracert -d -h 20 google.com`

---

### 高度な使用例
以下は、特定の目的のためにオプションを組み合わせる方法です:

1. **遅い接続を診断する**  
   - 目的: レイテンシが急上昇する場所を特定する。
   - コマンド: `traceroute -I -q 5 -w 1 google.com`
   - 理由: 信頼性のためにICMP、より良いレイテンシ統計のために5回のクエリ、迅速な移動のために1秒のタイムアウト。

2. **ファイアウォール制限を回避する**  
   - 目的: ICMPフィルターによってブロックされているWebサーバーへのトレース。
   - コマンド: `traceroute -T -p 443 google.com`
   - 理由: ポート443（HTTPS）でのTCPは正当なトラフィックを模倣し、ファイアウォールを通ることが多いため。

3. **ISP以降をテストする**  
   - 目的: ローカルホップをスキップして外部ルーティングに焦点を当てる。
   - コマンド: `traceroute -f 3 -m 10 google.com`
   - 理由: ホップ3（ルーター/ISP以降）から開始し、合計10ホップに制限。

4. **IPv4とIPv6のパスを比較する**  
   - 目的: プロトコルの選択がルーティングに影響するか確認する。
   - コマンド:
     - `traceroute -4 google.com`
     - `traceroute -6 google.com`
   - 理由: ネットワークパスやパフォーマンスの差異を特定します。

5. **スクリプト用の高速でサイレントなトレース**  
   - 目的: 自動化のための迅速な出力。
   - コマンド: `traceroute -n -q 1 -w 1 google.com > output.txt`
   - 理由: DNSルックアップなし、1回のクエリ、短いタイムアウト、ファイルへのリダイレクト。

---

### 高度な使用のためのヒント
- **他のツールとの組み合わせ**: より深い洞察を得るために、tracerouteを`ping`（レイテンシ用）や`mtr`（リアルタイムtraceroute）と組み合わせます。
- **ネットワークコンテキストの理解**: ファイアウォール、NAT、VPNはホップを不明瞭に（アスタリスク`*`を表示）することがあります。プロトコル（ICMP/TCP）を調整して対応します。
- **ルート権限**: Unixシステムでは、一部のオプション（例: TCPモード）は生ソケットアクセスに`sudo`が必要な場合があります: `sudo traceroute -T google.com`。

Tracerouteの強力さはその柔軟性にあります。オプションを調整することで、特定のネットワーク問題のトラブルシューティング、制限の回避、またはルーティング動作の詳細な分析に合わせてカスタマイズできます。特定のシナリオについてさらに深く掘り下げたい場合は、お知らせください！