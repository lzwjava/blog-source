---
audio: false
generated: true
image: false
lang: ja
layout: post
model: x-ai/grok-code-fast-1
title: CodeIgniterキャッシュシステムの概要
translated: true
type: note
---

### CodeIgniterのキャッシュライブラリ概要

CodeIgniterの`CI_Cache`クラスは、様々なバックエンド（メモリ内、ファイルベース、外部サービスなど）でデータを保存・取得するための統一インターフェースを提供する柔軟なキャッシュシステムです。このクラスは`CI_Driver_Library`を継承しており、ドライバを動的に読み込みます。キャッシュ操作を抽象化することで、開発者はアプリケーションコードを変更することなく、設定を通じてバックエンドを簡単に切り替えることができます。すべてのメソッドはアクティブな「アダプター」（ドライバクラス）に委譲され、信頼性のためにフォールバックサポートを備えています。

このシステムは、パフォーマンス、移植性、フォールトトレランスを重視しています。例えば、他のドライバが失敗した場合には「ダミー」（no-op）ドライバにデフォルト設定され、キャッシュの問題によってアプリケーションがクラッシュしないことが保証されます。

### サポートされているキャッシュドライバとアダプター

このクラスは、`$valid_drivers`で定義されたいくつかのドライバをサポートしています：
- **apc**: メモリ内ストレージにPHPのAPC（Alternative PHP Cache）を使用（高速、組み込み）。
- **dummy**: 何も行わないプレースホルダー（常にTRUEまたはFALSEを返す）。開発/テスト用のフォールバックとして使用。
- **file**: データをシリアライズ化されたファイルとしてディレクトリ（`$_cache_path`で指定）に保存。低トラフィックサイトに適しています。
- **memcached**: 分散型メモリ内キャッシングのためのMemcachedサービスへのインターフェース（高性能、スケーラブル）。
- **redis**: pub/subやアトミック操作などの機能を備えた、別のメモリ内キーバリューストアであるRedisへのインターフェース。
- **wincache**: IIS向けのWindows専用（Microsoft WinCacheを使用）。

各ドライバは、`get()`、`save()`などのメソッドを実装する独立したクラス（例：`CI_Cache_memcached`）です。このライブラリは、コンストラクタに渡される`$config['adapter']`配列に基づいてドライバを動的に読み込みます。

### 初期化と設定

- **コンストラクタ**: `adapter`（プライマリドライバ）、`backup`（フォールバックドライバ）、`key_prefix`（名前空間/分離のためすべてのキャッシュキーに前置される文字列）などのキーを持つ`$config`配列を受け取ります。
  - 設定例: `array('adapter' => 'redis', 'backup' => 'file', 'key_prefix' => 'myapp_')`。
- **フォールバックロジック**: 初期化後、`is_supported($driver)`（必要なPHP拡張機能やサービスのテストを行うドライバの`is_supported()`メソッドを呼び出す）を使用して、プライマリアダプターがサポートされているかどうかをチェックします。
  - プライマリが失敗した場合、バックアップドライバに切り替えます。両方が失敗した場合、エラーをログに記録し（`log_message()`経由）、「ダミー」にデフォルト設定します。
  - これにより、キャッシュが常に動作するアダプターを持ち、クラッシュを防ぎます。

`$_cache_path`はファイルベースのドライバ用に設定されますが、ここでは初期化されません。おそらくファイルドライバクラスで処理されます。

### 主要メソッドとその動作

メソッドは、一意のスコープのためにIDに`key_prefix`を前置し（例：`'myapp_user123'`）、アクティブなアダプターに委譲します。すべての操作は、成功/失敗時にブール値、配列、または混合データを返します。

- **get($id)**: IDによってキャッシュされたデータを取得します。
  - 例: `$data = $cache->get('user_profile');` —アダプターの`get()`メソッドを呼び出します。
  - キーが存在し、期限切れでない場合、データを返します。それ以外の場合はFALSEを返します。
  - ここでは直接的なTTLの強制はありません。ドライバによって処理されます（例：RedisやMemcachedは内部でTTLを強制します）。

- **save($id, $data, $ttl = 60, $raw = FALSE)**: 生存時間（TTL）を秒単位で指定してデータを保存します。
  - 例: `$cache->save('user_profile', $profile_data, 3600);` —1時間の有効期限で保存します。
  - `$raw`フラグ（デフォルトはfalse）は、データがシリアライズされているかどうかを示します。必要に応じてドライバがシリアライズを処理します（例：配列/オブジェクトが文字列になります）。
  - 成功時にTRUEを返し、条件付きロジックを容易にします（例：保存が失敗した場合にデータを生成してキャッシュする）。

- **delete($id)**: 特定のキャッシュアイテムを削除します。
  - 例: `$cache->delete('user_profile');` —恒久的な削除。

- **increment($id, $offset = 1)** および **decrement($id, $offset = 1)**: 数値に対するアトミック操作（カウンターに有用）。
  - 例: `$new_counter = $cache->increment('hits', 5);` —ドライバがサポートする場合、5だけインクリメントします（例：Redis/Memcachedはアトミック。ファイルベースはシミュレートする場合があります）。
  - すべてのドライバがraw/inc/decをサポートするわけではありません（ダミーは常に失敗）。新しい値またはFALSEを返します。

- **clean()**: 現在のドライバのすべてのキャッシュデータをクリアします。
  - 例: `$cache->clean();` —更新後のフラッシュに有用。
  - 「user」タイプは、システムキャッシュではなくユーザー固有のデータを対象とします。

- **cache_info($type = 'user')**: キャッシュに関するメタデータ（例：サーバーステータス、キー数、ファイルパス）を返します。
  - 例: `$info = $cache->cache_info();` —ドライバからの詳細の配列。

- **get_metadata($id)**: 特定のキャッシュアイテムに関する詳細（例：有効期限、サイズ）を取得します。
  - 例: `$meta = $cache->get_metadata('key');` —デバッグや最適化に役立ちます。

- **is_supported($driver)**: ドライバの可用性をチェックします（繰り返しのチェックを避けるために静的`$support`配列を使用して結果をキャッシュします）。

### 追加の仕組み

- **キープリフィックス**: すべてのIDに自動的に適用されます（例：アプリケーションの分離やマルチテナンシーのため）。環境間でのキー衝突を防ぐために設定で有効にされます。
- **ロギング**: デバッグ/エラーメッセージ（例：フォールバック）に`log_message()`を使用し、CodeIgniterのロギングシステムと統合します。
- **柔軟性とフォールトトレランス**: バックエンドを抽象化することで、ファイルキャッシング（安価、ローカル）からRedis（高速、分散）への切り替えを最小限の変更で行えます。ダミーフォールバックは、キャッシュの失敗がアプリケーションを停止させないことを意味します。メソッドは単にFALSEを返し、コードを続行させます（例：代わりにDBからフェッチする）。
- **パフォーマンスに関する注意**: APC/Redisなどのドライバはメモリ内（高速アクセス、サブミリ秒）です。ファイルベースはディスクI/Oのため遅くなります。TTLは、稀なドライバ固有のエッジケースを除き、一般的にドライバによって遵守されます。

この設計により、CodeIgniterのキャッシングはモジュール化され信頼性が高くなっています。特定のドライバの詳細については、ドライバファイル（例：`Cache_memcached.php`）を確認してください。このコードは古いバージョン（約2.0-3.x）からのものであるため、バージョン固有のニュアンスについては常に公式のCodeIgniterドキュメントを参照してください。特定のメソッドやドライバについてさらに深く掘り下げることができます！