---
audio: false
generated: true
lang: ja
layout: post
title: DiscordのRustパフォーマンス向上
translated: true
type: note
---

DiscordがRustを採用した背景には、Goベースの「Read States」サービス（チャネル間でのユーザーメッセージ既読状態を追跡するサービス）におけるパフォーマンスのボトルネックがありました。Rustへの移行により、レイテンシーが大幅に改善され、ガベージコレクションに起因するスパイクが解消され、Rustのメモリ管理と並行性における強みが示されました。詳細は以下の通りです：

---

### **DiscordがRustに移行した理由**
1. **Goのガベージコレクション(GC)問題**  
   - DiscordのGoサービスは、約2分ごとにレイテンシースパイクが発生していました。これは、Goの保守的で非世代別のGCが、*最小限のガベージ生成であっても、数百万のオブジェクトを含むLRUキャッシュ全体をスキャンしなければならなかった*ためです。
   - GoのGCの調整（例：キャッシュサイズの変更）は、スパイクの解消に失敗するか、99パーセンタイルレイテンシーを悪化させていました。

2. **Rustのメモリ管理**  
   - Rustの所有権モデルでは、LRUキャッシュからエビクトされると*即座にメモリが解放される*ため、GCによる一時停止を回避できます。この決定論的アプローチにより、レイテンシースパイクが解消されました。
   - ランタイムのGCオーバーヘッドがないため、高負荷時（秒間数十万更新）でも一貫したパフォーマンスを発揮しました。

3. **パフォーマンス最適化**  
   - 単純なRust実装でもGoのパフォーマンスに匹敵しました。さらに最適化（例：`HashMap`の代わりに`BTreeMap`を使用、メモリコピーの削減）を行うことで、*CPU使用率を70%削減*し、平均応答時間をマイクロ秒単位に短縮しました。

4. **エコシステムと非同期サポート**  
   - Discordは早期にRustのナイトリー版の非同期機能（後に安定化）を採用し、GCのトレードオフなしで効率的なネットワークサービスを実現しました。

---

### **移行の結果**
- **レイテンシー**：2分ごとのGCスパイクが解消され、サブミリ秒の応答時間を達成。
- **リソース効率**：CPUおよびメモリ使用量が削減され、パフォーマンスの低下なしにキャッシュ容量を800万のRead Statesにスケール可能に。
- **信頼性**：Rustのコンパイル時安全性チェックにより、ランタイムバグが減少。

---

### **DiscordにとってのRustの利点**
1. **パフォーマンス**  
   - 予測可能な低レイテンシーは、リアルタイムサービスに理想的。
   - 細かいメモリ制御により、GC依存言語を凌駕。

2. **安全性**  
   - 所有権モデルにより、メモリリーク、ヌルポインタ、データ競合を防止。
   - 手動での同期なしで並行性の安全性を確保。

3. **モダンなツーリング**  
   - Cargo（パッケージマネージャ）と豊富なジェネリクスにより、Goと比較してボイラープレートが減少。

4. **エコシステムの成長**  
   - アップグレード（例：Tokio非同期ランタイム）により、追加コストなしでパフォーマンス向上を享受。

---

### **欠点と課題**
1. **学習曲線**  
   - Rustの所有権とライフタイムは、初期学習コストがかかる。

2. **初期の非同期機能の制限**  
   - 不安定なナイトリー機能への初期依存は、メンテナンス上のリスクをもたらした。

3. **小規模なエコシステム**  
   - GoやC++と比較してライブラリ数は少ないが、急速に成長中。

---

### **主な要点**
DiscordのRust成功事例は、*GCの一時停止が許容されない、レイテンシーに敏感で大規模なサービス*におけるRustの適合性を浮き彫りにしています。移行にはRustの急峻な学習曲線の克服が必要でしたが、その見返りとして、**より高速なパフォーマンス、低いリソース使用量、少ないランタイムエラー**が得られました。長期的な保守性とパフォーマンスを優先するチームにとって、RustはGoのようなGC依存言語に対する説得力のある利点を提供します。

より深い技術的洞察については、Discordの[オリジナルのブログ投稿](https://discord.com/blog/why-discord-is-switching-from-go-to-rust)を参照してください。