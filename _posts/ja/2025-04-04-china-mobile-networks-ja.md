---
audio: false
generated: true
lang: ja
layout: post
title: 中国のモバイルネットワークでGit操作が失敗する理由
translated: true
type: note
---

これは中国の特定のモバイルネットワーク、特に特定のポートとプロトコルに依存するGitのようなサービスを使用する際によくある問題です。以下に、その理由と解決方法を説明します：

**中国のモバイルネットワークでGit操作が失敗する理由：**

* **ポートブロッキング/スロットリング：**
    * 中国のモバイルネットワーク事業者は、特にGitで使用される非標準ポート（SSHポート22など）に対して、トラフィックシェイピングやポートブロッキングを実施することがあります。これはネットワーク帯域幅の管理やセキュリティ上の理由で行われることが多いです。
    * ポート22が完全にブロックされていなくても、大幅にスロットリングされ、接続が非常に遅くなったりタイムアウトしたりして、Git操作が「固まった」ように見えることがあります。
* **DNSの問題：**
    * GitHubやGoogleのようなウェブサイトにはアクセスできても、Git操作は特定のホスト名（例：`github.com`）をDNSを通じて解決することに依存しています。DNS解決が遅いか信頼性に欠ける場合、Gitがハングする原因となります。
* **パケット損失/レイテンシ：**
    * モバイルネットワーク、特にホットスポットとして使用される場合、有線接続と比べてレイテンシとパケット損失が高くなる可能性があります。これにより、Gitで使用されるSSH接続が中断され、失敗することがあります。
* **ファイアウォールの干渉：**
    * 中国の「Great Firewall」は、明示的にブロックされていなくてもSSH接続を干渉する可能性があります。ファイアウォールのディープパケットインスペクションが接続の不安定性を引き起こすことがあります。
* **MTUの問題：**
    * Maximum Transmission Unit (MTU) の問題はデータ転送に問題を引き起こす可能性があり、モバイルネットワークは有線ネットワークよりも小さいMTU値を持つことがあります。

**中国のモバイルネットワークでのGit Push/Pull問題を解決する方法：**

1.  **SSHの代わりにHTTPSを使用する：**
    * Git over HTTPSはポート443を使用し、これは通常ウェブトラフィック用に開放されています。これが最も信頼性の高い回避策です。
    * GitリモートをHTTPSに変更するには：
        * ターミナルを開きます。
        * Gitリポジトリに移動します。
        * 以下のコマンドを実行します（`your_username` と `your_repository` はあなたのGitHubの詳細に置き換えてください）：
            ```bash
            git remote set-url origin https://github.com/your_username/your_repository.git
            ```
    * ユーザー名とパスワードを入力する必要がある場合は、git credential helperを使用するか、Personal Access Tokenを使用できます。
2.  **VPNを使用する：**
    * 信頼性の高いVPNはネットワーク制限を回避し、より安定した接続を提供できます。
    * Git操作を試みる前に、中国国外のVPNサーバーに接続します。
    * VPNも不安定性和速度の問題が発生する可能性があることに注意してください。
3.  **SSHポートを設定する（SSHが必要な場合）：**
    * SSHを使用する必要がある場合は、ブロックされる可能性が低い別のポート（例：443）を使用するようにGitを設定してみてください。
    * `~/.ssh/config` ファイルを編集します：
        ```
        Host github.com
            Hostname ssh.github.com
            Port 443
            User git
        ```
    * 次に、git remote url を ssh.github.com を使用するように変更します：
        ```bash
        git remote set-url origin git@ssh.github.com:your_username/your_repository.git
        ```
4.  **MTU設定を確認する：**
    * MTUの問題が疑われる場合は、MTUサイズを小さくしてみてください。
    * macOSでは、`networksetup` コマンドを使用してMTUを調整できます。
    * ただし、MTUの変更は一般的により高度なトラブルシューティングのステップであり、注意して行う必要があります。
5.  **DNS設定を確認する：**
    * Google DNS (8.8.8.8 と 8.8.4.4) や Cloudflare DNS (1.1.1.1 と 1.0.0.1) などのパブリックDNSサーバーを使用してみてください。
    * macOSのネットワーク設定でDNS設定を構成できます。
6.  **Gitプロキシを使用する：**
    * プロキシサーバーにアクセスできる場合は、Gitがそれを使用するように設定できます。
    * `http.proxy` と `https.proxy` Git設定変数を設定します：
        ```bash
        git config --global http.proxy http://proxy_address:proxy_port
        git config --global https.proxy https://proxy_address:proxy_port
        ```
    * プロキシが認証を必要とする場合は、プロキシURLにユーザー名とパスワードを含めることができます。
7.  **Websocket経由のSSHを使用してみる：**
    * 一部のツールやサービスでは、SSHトラフィックをwebsocket経由でトンネリングすることができ、標準のSSHポートがブロックされている場合に役立ちます。
    * これはより高度な技術であり、Websocket経由のSSHをサポートするサーバーの設定が必要です。

**重要な考慮事項：**

* モバイルネットワークの状態は大きく異なる可能性があるため、ある場所やある時点で機能することが、別の場所や別の時点では機能しない可能性があります。
* モバイルネットワークプロバイダーの利用規約、およびVPNやその他の回避策の使用に関する潜在的な制限に注意してください。
* ほとんどのユーザーにとって、HTTPSが一般的に最善の解決策です。