---
audio: false
generated: true
image: false
lang: ja
layout: post
model: moonshotai/kimi-k2-thinking
title: マルチパスTCPプロトコル概要
translated: true
type: note
---

MPTCPは、単一の論理接続が複数の物理パスを同時に使用できるようにすることで、ネットワーク接続の動作方法を根本的に変えるトランスポート層プロトコル拡張です。以下に詳細を説明します：

## **1. 核となる問題：シングルパスの制限**

従来のTCPは各接続を5タプル（送信元IP、送信元ポート、宛先IP、宛先ポート、プロトコル）で定義される単一のネットワークパスに制限します。これにより、いくつかの重大な制限が生じます：

- **インターフェース集約の欠如**：Wi-Fiとセルラーの両方を持つデバイスは、一度に1つのインターフェースしか使用できない
- **単一障害点**：選択されたパスが混雑または障害発生すると、接続全体が切断される
- **最適ではないリソース利用**：1つのパスが問題を抱えている間、他の混雑していない代替パスはアイドル状態のまま
- **モビリティの中断**：ネットワーク間の移動（例：Wi-Fiから4G）では、すべての接続を再確立する必要がある

現代のデバイスは本質的にマルチホームです（スマートフォン、ラップトップ、サーバーは複数のネットワークインターフェースを持つ）が、TCPはこの多様性を活用できません。

## **2. MPTCPの仕組み：サブフローアーキテクチャ**

MPTCP（RFC 8684）は新しいプロトコルではなく、**後方互換性のあるTCPの拡張**です。これは、異なるパス上で独立したTCP接続である**サブフロー**を作成することで動作し、これらが集合して1つの論理MPTCP接続を形成します。

### 接続確立プロセス：

1. **初期ハンドシェイク**：クライアントとサーバーは、標準的なTCPの3ウェイハンドシェイク中にMPTCP機能をネゴシエートする
2. **パス発見**：ピアは使用可能な追加のIPアドレスを交換する
3. **サブフロー作成**：利用可能なインターフェース/パス上で追加のTCP接続が確立される
4. **データ分散**：**スケジューラ**がアプリケーションのバイトストリームをサブフロー間で分割する
5. **再構築**：受信側は接続レベルのシーケンス番号を使用して、複数のサブフローからのデータを元の順序に並べ替える

```
従来のTCP：アプリデータ → 単一TCPフロー → 1つのパス
MPTCP：アプリデータ → スケジューラ → 複数TCPサブフロー → 複数パス → 再構築
```

Linuxでは `ss -M` でこれを可視化でき、1つのMPTCP接続の下にグループ化されたサブフローが表示されます。

## **3. パフォーマンスのための主要メカニズム**

### **帯域幅集約**
MPTCPは利用可能なすべてのパスからのスループットを結合できます。9 Mbpsのフローは、異なるインターフェースにまたがる3つの3 Mbpsサブフローに分割され、すべてのネットワーク容量を効果的に利用します。これは、サーバー間に複数の物理リンクが存在するデータセンターで特に強力です。

### **インテリジェントなスケジューリング**
スケジューラは継続的に以下を監視します：
- パスレイテンシと輻輳
- パケット損失率
- 利用可能な帯域幅
- リンクコスト/優先度

これは各サブフロー経由で送信するデータ量を動的に調整し、遅いパスへの過負荷を防ぎながら、速いパスを完全に利用します。

### **結合輻輳制御**
MPTCPは特殊なアルゴリズム（LIA、OLIA、BALIAなど）を使用し、これらは以下を実現します：
- パス間で輻輳をバランスさせる
- 通常のTCPフローとの公平性を確保する
- 単一のMPTCP接続が他のトラフィックを飢餓状態にしないようにする
- 1つのパスが輻輳した場合に適切に対応する

## **4. メリット：回復力とスループット**

### **強化された回復力**
- **自動フェイルオーバー**：Wi-Fiが切断されても、セルラーサブフローがアプリケーション中断なしに接続を維持する
- **パス冗長性**：1つのパスでのパケット損失は接続を切断せず、トラフィックは正常なサブフローに再ルーティングされる
- **グレースフルな性能低下**：部分的なパス障害は帯域幅を減少させるが、切断を引き起こさない
- **回復時間**：シミュレーションでは、MPTCPがトラフィックを代替パスに迅速にシフトすることで中断を最小化することが示されている

### **改善されたスループット**
- **リソースプーリング**：利用可能なすべてのネットワークリソースを同時に利用する
- **輻輳回避**：混雑していない代替パスを使用してボトルネックを回避する
- **負荷分散**：単一のパスがボトルネックになるのを防ぐためにトラフィックを分散する

### **シームレスなモビリティ**
AppleはiOS 7以降、SiriにMPTCPを使用しており、Wi-Fiネットワークとセルラーネットワークの間を移動する際に音声リクエストが中断なく継続できるようにしています。インターフェースが利用可能になったり利用できなくなったりするにつれてサブフローが動的に追加・削除されるため、接続は持続します。

## **5. 実世界のユースケース**

- **モバイルデバイス**：ネットワーク間をシームレスに切り替えるスマートフォン
- **データセンター**：より高いスループットとフォールトトレランスのためにパス多様性を活用する
- **IoT/M2Mシステム**：マルチインターフェースデバイスでのリソース利用を最大化する
- **ハイブリッドネットワーク**：固定ブロードバンドとモバイルネットワークを組み合わせて高速なファイル転送を実現する
- **クラウドサービス**：高可用性を必要とするコンテンツデリバリネットワークおよびエンタープライズ環境

## **6. 実装と採用状況**

### **オペレーティングシステムのサポート**
- **Linux**：`mptcpd` デーモンによる完全なカーネルサポート（RHEL 9+、最新ディストリビューション）
- **iOS**：2013年以降、Siriおよび選択されたアプリで使用
- **Android**：最近のバージョンで部分的なサポート
- **Windows**：限定的なネイティブサポート

### **アプリケーション透過性**
アプリケーションは通常、**変更を必要としません** — OSのネットワークスタックが透過的にMPTCPを処理します。高度な機能にはマイナーなソケットオプションの変更のみが必要な場合があります。

### **導入状況**
MPTCPはまだ成熟段階にあります。Appleが内部で使用している一方、ほとんどのインターネットサービスはまだそれをサポートしていません。導入にはクライアントとサーバーの両方のサポートが必要ですが、通常のTCPへのフォールバックは自動的に行われます。

## **7. トレードオフと課題**

### **複雑さ**
- より複雑なプロトコル状態機械
- 限定的なミドルボックスサポート — 一部のファイアウォール/NATがMPTCPオプションをブロックする可能性がある
- ネットワークトラブルシューティングがより困難になる

### **セキュリティへの影響**
- **検査の盲点**：ファイアウォールやIPSシステムは分割されたフローの再構築に苦労し、セキュリティギャップを生み出す
- **トラフィックパターンの難読化**：これはプライバシーを向上させることができるが、セキュリティ監視を複雑にする
- **Cisco製品**：多くの検査機能はMPTCPをサポートしておらず、注意深い設定が必要

### **パフォーマンスの考慮事項**
- **パケット順序変更**：異なるパスレイテンシは順不同到着を引き起こし、適切に管理されない場合、パフォーマンスを損なう可能性がある
- **ヘッドオブラインブロッキング**：スケジューラがインテリジェントでない場合、遅いサブフローが全体の配信を遅延させる可能性がある
- **バッファ要件**：パケットを並べ替えるために受信側でより多くのバッファリングが必要

### **公平性**
MPTCPの結合輻輳制御は、共有リンク上のシングルパスTCPフローに対する公平性と、マルチパスの積極性を注意深くバランスさせなければなりません。

## **8. 類似技術との比較**

- **リンクボンディング/チーミング**：レイヤ2で動作し、通常は同じ媒体を必要とし、単一のTCP接続には役立たない
- **等コストマルチパス（ECMP）**：フローを分割するネットワーク層ルーティングだが、*単一*の接続を分割することはできない
- **SCTP**：マルチホーミングを持つ代替トランスポートプロトコルだが、採用が進まず、NATトラバーサルに問題がある

MPTCPの主な利点は、既存のTCPエコシステム内で動作しながら、真の**接続レベル**のマルチパシングを提供することです。

---

**結論**: MPTCPは、複数のネットワークリソースをインテリジェントにプールすることにより、硬直的なシングルパスTCPモデルを柔軟で回復力があり、パフォーマンス指向のアーキテクチャに変革します。成熟度とセキュリティに関する課題は残っていますが、現代のネットワークにおけるマルチホームエンドポイントを活用するための最も実用的なソリューションを表しています。