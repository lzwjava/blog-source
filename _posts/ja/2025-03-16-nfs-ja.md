---
audio: false
generated: true
lang: ja
layout: post
title: Ubuntuでメディア共有用NFSサーバーを構築する
translated: true
type: note
---

Ubuntuでメディアファイルを提供するNFS（Network File System）サーバーを設定するには、以下の詳細な手順に従ってください。このガイドでは、メディアファイル（例：動画、音楽）を含むディレクトリをネットワーク経由で安全かつ効率的に共有することを想定しています。

---

### ステップ 1: NFSサーバーソフトウェアのインストール
まず、UbuntuシステムにNFSサーバーパッケージをインストールする必要があります。

1. パッケージリストを更新して最新版を取得します：
   ```bash
   sudo apt update
   ```

2. NFSサーバー機能を提供する `nfs-kernel-server` パッケージをインストールします：
   ```bash
   sudo apt install nfs-kernel-server
   ```

これでNFSサーバーを実行するための必要なソフトウェアがインストールされます。

---

### ステップ 2: メディアディレクトリの作成と設定
メディアファイルを保存し、共有するためのディレクトリを作成して設定します。

1. メディアファイルを保持するディレクトリを作成します（例：`/media/share`）：
   ```bash
   sudo mkdir -p /media/share
   ```

2. 所有権を自分のユーザーアカウントに設定します（必要に応じて `$USER` を実際のユーザー名に置き換えてください）：
   ```bash
   sudo chown $USER:$USER /media/share
   ```

3. アクセスを許可するようにパーミッションを調整します。クライアントが主に読み取り専用で使用するメディアファイルの場合、以下を設定できます：
   - ディレクトリ: `755`（他のユーザーによる読み取りと実行）
   - ファイル: `644`（他のユーザーによる読み取り）
   ただし、細かい制御が必要ない場合は、簡単のために `755` を再帰的に適用します：
   ```bash
   sudo chmod -R 755 /media/share
   ```
   - **注意**: メディアファイルは実行可能である必要はありませんが、ファイルに対する `755` は、実行がクライアント側でローカルに発生するため、NFSの機能を妨げません。

4. メディアファイルを `/media/share` に配置します（例：動画や音楽をこのディレクトリにコピーします）。

---

### ステップ 3: NFSエクスポートの設定
NFSサーバーは `/etc/exports` ファイルを使用して、どのディレクトリを誰がアクセスできるかを定義します。

1. テキストエディタでexportsファイルを開きます：
   ```bash
   sudo nano /etc/exports
   ```

2. `/media/share` を共有するための行を追加します。構文は次のとおりです：
   ```
   /path/to/directory client(options)
   ```
   - **例 1**: 特定のクライアントIP（例: `192.168.1.100`）と読み書きアクセスで共有：
     ```
     /media/share 192.168.1.100(rw,sync,no_subtree_check)
     ```
   - **例 2**: サブネット上のすべてのデバイス（例: `192.168.1.0/24`）と読み取り専用アクセスで共有：
     ```
     /media/share 192.168.1.0/24(ro,sync,no_subtree_check)
     ```
   - **例 3**: 任意のデバイスと共有（安全性が低いため注意して使用）：
     ```
     /media/share *(rw,sync,no_subtree_check)
     ```

   **オプションの説明**:
   - `rw`: 読み書きアクセス（メディアストリーミングの場合、読み取り専用の場合は `ro` を使用）。
   - `sync`: 操作を確認する前にデータがディスクに書き込まれることを保証します（安全ですが遅い。クラッシュ時のデータ損失のリスクを伴うが、パフォーマンスのために `async` を使用可能）。
   - `no_subtree_check`: サブツリーのチェックを無効にしてパフォーマンスを向上させます（ほとんどの設定で推奨）。

3. ファイルを保存し（nanoでは `Ctrl+O`、次に `Enter`）、終了します（`Ctrl+X`）。

---

### ステップ 4: NFS設定の適用
exportsファイルを編集した後、NFSサーバーを更新して変更を反映させます。

1. 共有をエクスポートします：
   ```bash
   sudo exportfs -a
   ```

2. 設定を適用するためにNFSサーバーを再起動します：
   ```bash
   sudo systemctl restart nfs-kernel-server
   ```

3. サービスが実行中であることを確認します：
   ```bash
   sudo systemctl status nfs-kernel-server
   ```
   - 出力に "active (running)" と表示されていることを確認します。

4. エクスポートされたディレクトリを確認します：
   ```bash
   sudo exportfs -v
   ```
   - 指定したオプションで `/media/share` がリストされているはずです。

---

### ステップ 5: ファイアウォールの設定
NFSは特定のポートを使用するため、ファイアウォールがそれらへのトラフィックを許可していることを確認する必要があります。Ubuntuでは多くの場合UFW（Uncomplicated Firewall）を使用します。

1. **デフォルトのNFSポート**:
   - NFS: 2049 (TCP/UDP)
   - RPC: 111 (TCP/UDP)
   - その他のサービス（mountd, statd, lockd）: デフォルトでは動的ですが、静的ポートに設定できます。

2. 簡単にするために、動的設定を使用して必須のポートを許可します（静的ポートを設定しない場合）：
   ```bash
   sudo ufw allow 2049
   sudo ufw allow 111
   ```
   - **注意**: mountd、statd、lockdがランダムなポートを使用する場合、これですべてのNFSトラフィックをカバーできない可能性があります。

3. **オプション: より良い制御のための静的ポートの設定**（正確なファイアウォールルールに推奨）：
   - `/etc/default/nfs-kernel-server` を編集します：
     ```bash
     sudo nano /etc/default/nfs-kernel-server
     ```
     以下を追加または変更：
     ```
     RPCMOUNTDOPTS="-p 4001"
     ```
   - `/etc/default/nfs-common` を編集します：
     ```bash
     sudo nano /etc/default/nfs-common
     ```
     以下を追加または変更：
     ```
     STATDOPTS="-p 4002"
     ```
   - lockd用に `/etc/modprobe.d/nfs.conf` を作成します：
     ```bash
     sudo nano /etc/modprobe.d/nfs.conf
     ```
     以下を追加：
     ```
     options lockd nlm_udp_port=4003 nlm_tcp_port=4003
     ```
   - NFSサーバーを再起動します：
     ```bash
     sudo systemctl restart nfs-kernel-server
     ```

4. UFWで静的ポートを許可します：
   ```bash
   sudo ufw allow 2049/tcp
   sudo ufw allow 2049/udp
   sudo ufw allow 111/tcp
   sudo ufw allow 111/udp
   sudo ufw allow 4001/tcp
   sudo ufw allow 4001/udp
   sudo ufw allow 4002/tcp
   sudo ufw allow 4002/udp
   sudo ufw allow 4003/tcp
   sudo ufw allow 4003/udp
   ```

5. UFWがまだ有効でない場合は有効にします：
   ```bash
   sudo ufw enable
   ```

---

### ステップ 6: 設定の確認
NFSサーバーが正しく動作していることを確認します。

1. サーバーからエクスポートされた共有を確認します：
   ```bash
   showmount -e localhost
   ```
   - 正しいクライアント/オプションで `/media/share` がリストされているはずです。

2. リスニングポートを確認します：
   ```bash
   sudo ss -tuln | grep -E "2049|111|4001|4002|4003"
   ```
   - これらのポートが開いており、NFSサービスにバインドされていることを確認します。

---

### ステップ 7: クライアントからのテスト（オプション）
クライアントマシン（例：別のUbuntuシステム）で、共有のマウントをテストします：
```bash
sudo mount -t nfs <server_ip>:/media/share /mnt
```
- `<server_ip>` をNFSサーバーのIPアドレスに置き換えます。
- `/mnt` が存在することを確認します（必要に応じて `sudo mkdir /mnt` を実行）。
- `/mnt` にアクセスして、メディアファイルを表示および再生できることを確認します。

---

### メディアファイルに関する追加の注意点
- **読み取り専用アクセス**: クライアントがメディアをストリーミングするだけの場合は、`/etc/exports` で `ro` を使用して変更を防ぎます。
- **パーミッション**: メディアファイルがクライアントによって読み取り可能であることを確認します。サーバーとクライアント間のUID/GIDの不一致はアクセス問題を引き起こす可能性があります。必要に応じてファイルのパーミッションを調整するか、NFSオプション（上級者向け）で `all_squash` などを使用します。
- **パフォーマンス**: 大きなメディアファイルの場合、デフォルトの `sync` オプションは安全ですが遅いです。パフォーマンスが優先され、データ損失のリスクが許容できる場合は、`async` でテストします。
- **NFSバージョン**: UbuntuはデフォルトでNFSv4を使用します。これはメディア提供に適しています。古いクライアント（NFSv3）をサポートする場合を除き、通常は追加の設定は必要ありません。

---

### コマンドのまとめ
基本的な設定（静的ポートなし）のクイックリファレンスは以下のとおりです：
```bash
sudo apt update
sudo apt install nfs-kernel-server
sudo mkdir -p /media/share
sudo chown $USER:$USER /media/share
sudo chmod -R 755 /media/share
echo "/media/share *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo ufw allow 2049
sudo ufw allow 111
```

この設定により、Ubuntu NFSサーバーはネットワーク経由でメディアファイルを提供する準備が整います。セキュリティとネットワークの要件に基づいて、IPアドレス、パーミッション、ファイアウォールルールを調整してください。