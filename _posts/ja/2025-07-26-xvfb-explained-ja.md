---
audio: false
generated: true
lang: ja
layout: post
title: 'Xvfb: ヘッドレスX11ディスプレイサーバー'
translated: true
type: note
---

### Xvfbとは？

Xvfb（X Virtual Framebuffer）は、物理的なディスプレイやハードウェアグラフィックスアクセラレーションを必要とせずにグラフィカルアプリケーションを実行するX11ディスプレイサーバーです。本質的にはメモリ内にディスプレイをシミュレートする「ヘッドレス」Xサーバーであり、サーバー上やモニター・キーボード・マウスがない環境で、ブラウザやGUIテスト、レンダリングツールなど、グラフィカル環境を必要とするプログラムの実行を可能にします。

自動テスト（例：Seleniumを使ったWebスクレイピングやUIテスト）、CI/CDパイプライン、または画面に何も表示せずにX11ベースのアプリケーションをバックグラウンドで実行する必要があるあらゆるシナリオで一般的に使用されます。

### Xvfbの仕組み

1.  **仮想ディスプレイの作成**:
    - Xvfbを起動すると、RAM内に完全に存在する仮想ディスプレイ（例：`:99` や他のディスプレイ番号）を作成します。このディスプレイは、起動時に指定する解像度、色深度などのパラメータを持ちます。
    - コマンド例：`Xvfb :99 -screen 0 1024x768x24`（1024x768解像度、24ビットカラーの仮想ディスプレイを起動）。

2.  **グラフィカル操作の処理**:
    - Xvfbは、アプリケーションからのX11プロトコルリクエスト（ウィンドウの描画、画像のレンダリング、イベントの処理など）をインターセプトします。
    - 物理スクリーンへの出力の代わりに、すべての操作をメモリバッファ（「フレームバッファ」）内で実行します。このバッファは、ピクセルが書き込まれるが表示されることのない仮想スクリーンのように機能します。
    - 基本的なX11機能をサポートしますが、ハードウェアアクセラレーションがないため、ゲームなどの高性能グラフィックスには不向きです。単純なレンダリングやテストに適しています。

3.  **イベントシミュレーション**:
    - Xvfbは必要に応じて入力イベント（マウス/キーボードなど）をシミュレートできますが、通常、アプリケーションは実際のディスプレイ上で実行されているかのように動作します。
    - 出力は可視ではありませんが、検証のためにスクリーンショットをキャプチャしたり、フレームバッファをファイルにダンプしたりできます（`xwd` や ImageMagick の `import` などのツールを使用）。

4.  **ツールとの統合**:
    - pyvirtualdisplay（エラートレース内にあるもの）のようなライブラリは、コードからXvfbの開始/停止を容易にするためにXvfbをラップします。例えばPythonでは：
      ```python
      from pyvirtualdisplay import Display
      display = Display(visible=0, size=(1024, 768))
      display.start()
      # グラフィカルアプリケーションをここで実行
      display.stop()
      ```
    - これはバックグラウンドで実行され、アプリケーションは仮想サーバーを指すように `DISPLAY` 環境変数（例：`export DISPLAY=:99`）を設定します。

5.  **制限事項**:
    - 実際のハードウェアとの相互作用がないため、GPUサポートや直接のビデオ出力はありません。
    - 大きな解像度や長時間実行されるセッションではメモリ使用量が増加する可能性があります。
    - X.orgプロジェクトの一部であり、Linux/Unixシステムで利用可能です。macOSやWindowsにはネイティブではありません（ただし、Windows用にはXmingなどの代替手段があります）。

あなたが貼り付けたエラーについて：システムにXvfbがインストールされていないようです（'Xvfb' に対する `FileNotFoundError`）。macOS（あなたのHomebrewパスに基づく）では、`brew install --cask xvfb` または同様のコマンドでインストールできますが、PATHに含まれていることを確認してください。pyvirtualdisplayは、実行ファイルとして利用可能であることに依存しています。

[Xvfb Man Page](https://www.x.org/releases/X11R7.7/doc/man/man1/Xvfb.1.xhtml)  
[Wikipedia: Xvfb](https://en.wikipedia.org/wiki/Xvfb)  
[How to Use Xvfb for Headless Testing](https://www.browserstack.com/guide/what-is-xvfb)