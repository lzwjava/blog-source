---
audio: false
date: 2025-09-11
generated: true
image: false
lang: ja
layout: post
model: mistralai/mistral-medium-3.1
title: Python Copilot プロキシサーバーの実装
translated: true
type: note
---

このPythonスクリプトは、**GitHub Copilot**と連携してコード補完を生成する**ローカルプロキシサーバー**です。認証を処理し、CopilotのAPIにリクエストを転送することで、公式のGitHub Copilotプラグイン（Neovim用など）の動作を模倣します。

---

### **主要コンポーネントとワークフロー**
1. **認証 (`setup()` と `get_token()`)**
   - **OAuth Device Flow**を使用してGitHubで認証します。
   - GitHubから**デバイスコード**と**ユーザーコード**をリクエストします。
   - ユーザーにURL (`verification_uri`) にアクセスし、`user_code`を入力するよう求めます。
   - **アクセストークン**を受信するまでGitHubにポーリングします。
   - 将来の使用のためにトークンを `.copilot_token` に保存します。
   - アクセストークンを**Copilotセッショントークン**（API呼び出しに必要）と交換します。

2. **トークン更新 (`token_thread()`)**
   - バックグラウンドスレッドで実行されます。
   - **25分ごと**にCopilotトークンを更新します（トークンは期限切れになるため）。

3. **Copilot APIとの連携 (`copilot()`)**
   - **プロンプト**（コードスニペット）をCopilotのAPIに送信します。
   - **ストリーミングモード**（行ごと）で生成された補完を返します。
   - エラー（無効/期限切れトークンなど）を処理します。

4. **HTTPサーバー (`HTTPRequestHandler`)**
   - **POSTリクエスト**（ローカルエディタからのものなど）を待ち受けます。
   - リクエストから `prompt` と `language` を抽出します。
   - `copilot()` を呼び出し、補完をプレーンテキストで返します。

5. **メイン関数 (`main()`)**
   - **トークン更新スレッド**を開始します。
   - 指定されたポート（デフォルト: `8080`）で**HTTPサーバー**を起動します。

---

### **動作の仕組み（ステップバイステップ）**
1. **初回実行（トークンなし）**
   - スクリプトは `setup()` を呼び出し、OAuth経由で認証します。
   - ユーザーはGitHubにアクセスし、コードを入力してアクセスを許可します。
   - スクリプトはアクセストークンを `.copilot_token` に保存します。

2. **以降の実行（トークンが存在する）**
   - スクリプトは `.copilot_token` を読み取り、Copilotセッショントークンを取得します。
   - トークンの有効期限が切れた場合、自動的に更新されます。

3. **リクエストの処理**
   - ローカルエディタ（Neovimなど）がコードスニペットを含む**POSTリクエスト**を送信します。
   - スクリプトはプロンプトをCopilotのAPIに転送します。
   - 補完がエディタに返されます。

4. **トークン管理**
   - バックグラウンドスレッドが**25分ごと**にトークンを更新し、期限切れを防ぎます。

---

### **このスクリプトが存在する理由**
- **公式プラグインの回避**: 一部のエディタ（Neovimなど）は公式のCopilotサポートを欠いています。このスクリプトは橋渡し役として機能します。
- **ローカルプロキシ**: トークンをローカルで管理することでレート制限を回避します。
- **カスタマイズ**: 異なるエディタやAPIで動作するように