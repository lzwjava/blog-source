---
audio: false
generated: true
image: false
lang: ja
layout: post
title: 割り込みはクラウド推論をキャンセルしない
translated: true
type: note
---

Pythonスクリプトが`generate_images()`呼び出しを待機している間に（Ctrl-Cなどで）中断した場合、以下がおおよそ発生します：

1. **クライアント側の挙動**
   – Pythonプロセスを強制終了すると、基盤となるHTTP/gRPC接続が切断されます。
   – GenAIクライアントライブラリは通常、壊れたパイプや接続リセットを検知して例外を発生させます（スクリプト内で確認できます）。

2. **Google側での処理**
   – キャンセルする時点では、リクエストは既にGoogleの推論サービスに到達し、キューイングされている（または実行が開始されている）可能性があります。
   – ほとんどのクラウド推論エンドポイントは、クライアントが切断されただけで自動的に処理をキャンセル**しません**。結果を返すためのライブ接続がなくても、画像生成ジョブは完了まで実行され続け（GPU/TPUリソースを消費し、課金が発生します）。
   – ジョブが完了すると、生成された画像は破棄されます。長時間実行オペレーションやウェブフックを設定していない限り、コールバックはありません。

3. **Nginx（または他のプロキシ）の影響**
   – 推論サービスの前にNginxリバースプロキシがある場合、デフォルトの挙動はクライアント接続を監視することです。クライアントが中止すると、Nginxは上流の推論プロセスへの接続を閉じます（FIN/RSTを送信）。
   – 上流プロセスは、最終的にレスポンスを書き込もうとしたときに壊れたソケットを検知します。その時点でI/Oエラーをログに記録する可能性がありますが、重要な点は、要求した計算を巻き戻して停止するわけでは**ない**ことです。単にバイトを配信できないだけです。
   – Nginxの`proxy_ignore_client_abort`ディレクティブを調整できます。`on`に設定すると、クライアントが切断した後もNginxは上流接続を維持します（これにより、ログの完全な書き込みやその他のクリーンアップを完了できます）。

4. **スクリプトに関する重要なポイント**

   * **中断は「デプロイ解除」や**Googleサーバー上のモデルのキャンセルにはなりません。完全な推論に対して課金されます。
   * キャンセル可能な推論が必要な場合は、別のパターンを使用する必要があります。例えば：

     1. 非ブロッキングバッチまたは長時間実行オペレーションを送信し、
     2. そのステータスをポーリングするか、別のAPI呼び出しを介して明示的にキャンセルします。

要約すると：5秒でスクリプトを強制終了すると、ローカルの待機が停止しソケットが閉じられますが、Googleの推論はそのハードウェア上で完了まで実行され続けます（そしてNginxなどは、レスポンスの準備ができた時点でそれをどこにも返さずに破棄します）。