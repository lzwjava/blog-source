---
audio: false
generated: true
lang: ja
layout: post
title: NPMの設定
translated: true
---

### 主要ポイント
- NPMの設定には、プロキシとレジストリの設定を行うために`.npmrc`ファイルを編集することが一般的です。これは手動で行うか、コマンドを使用して行うことができます。
- プロキシ設定には、`proxy = http://user:password@proxy_server:port`という形式が必要で、特殊文字はURLエンコードする必要があります。
- レジストリはデフォルトで`registry = https://registry.npmjs.org/`に設定され、必要に応じてSSL検証を無効にすることができます。

### NPMの設定と`.npmrc`の使用
NPM（Node Package Manager）は、JavaScriptの依存関係を管理するためのツールであり、設定にはレジストリやプロキシなどの設定を含む`.npmrc`ファイルを使用します。

#### `.npmrc`とは何ですか？そしてどこにありますか？
`.npmrc`ファイルは、NPMの動作をカスタマイズするための設定ファイルです。以下のように存在します：
- **グローバル**: Unix系のシステムでは`~./.npmrc`、Windowsでは`%APPDATA%\npm\npmrc`（通常は`C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **プロジェクト固有**: プロジェクトのルートディレクトリに`./package/.npmrc`として存在します。ローカル設定はグローバル設定を上書きします。

#### プロキシとHTTPSプロキシの設定
プロキシの背後に作業するには、`.npmrc`に以下の行を追加します：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

`https_proxy`でもプロトコルとして`http://`を使用します。ユーザー名やパスワードに特殊文字（例：`\`、`@`）が含まれる場合は、URLエンコードします（例：`domain\user`は`domain%5Cuser`）。また、以下のコマンドを使用して設定することもできます：
- `npm config set proxy http://user:password@proxy_server:port`
- `npm config set https_proxy http://user:password@proxy_server:port`

#### レジストリの設定
レジストリは、NPMがパッケージを取得するために使用するURLであり、通常は以下のように設定されます：
- `registry = https://registry.npmjs.org/`

カスタムレジストリを使用する場合は、URLを置き換えます（例：会社のプライベートレジストリ）。設定は以下のように行います：
- `npm config set registry https://your_custom_registry.com/`

#### SSLと検証の処理
SSLの問題が発生した場合は、以下のように設定します：
- `.npmrc`に`strict-ssl = false`を追加してSSLエラーを無視しますが、これはセキュリティが低下します。設定は以下のように行います：
- `npm config set strict-ssl false`

#### 設定の使用と検証
`.npmrc`はテキストエディタで直接編集するか、`npm config set`コマンドを使用して設定します。検証は以下のように行います：
- `npm config list`で全設定をリスト表示。
- `npm config get proxy`で特定の設定を確認。
- `npm install --verbose`で詳細な出力を確認して問題をデバッグ。

例の`.npmrc`ファイルは以下のようになります：
```
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

### 調査ノート：`.npmrc`を使用してNPMを設定する包括的なガイド
このセクションでは、レジストリとプロキシの設定に焦点を当てて、NPMの設定に関する詳細な探求を行います。

#### `.npmrc`とその役割の紹介
`.npmrc`ファイルは、NPMのパッケージ管理の動作をカスタマイズするための重要な設定ファイルです。INI形式でキーと値のペアをサポートし、コメントはセミコロン（`;`）で始まります。以下のように存在します：
- **グローバルの場所**: Unix系のシステムでは`~./.npmrc`、Windowsでは`%APPDATA%\npm\npmrc`（通常は`C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **ローカルの場所**: プロジェクトのルートディレクトリに`./package/.npmrc`として存在します。ローカル設定はグローバル設定を上書きし、プロジェクト固有の設定を提供します。

この階層構造は柔軟性を提供し、開発者がユーザーレベルとプロジェクトレベルで設定を管理できるようにします。これは、複数のプロジェクトや共有システムがある環境で特に有用です。

#### プロキシ設定の詳細
プロキシの背後に作業するには、`.npmrc`に`proxy`と`https_proxy`を設定します。形式は以下の通りです：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

`https_proxy`はプロトコルとして`http://`を使用し、`https://`を使用しない点に注意してください。これは、プロキシサーバーが接続を処理し、プロキシ自身に対して暗号化しないためです。これは一般的な混乱の原因となりますが、ペイロードは目的地に対してSSL暗号化されます。

認証にはユーザー名とパスワードを含めますが、特殊文字が含まれる場合はURLエンコードが必要です：
- バックスラッシュ（`\`）は`%5C`。
- アットマーク（`@`）は`%40`。
- コロン（`:`）は`%3A`。

例えば、ユーザー名が`domain\user`でパスワードが`pass@word`の場合、`proxy = http://domain%5Cuser:pass%40word@proxy_server:8080`となります。このエンコードにより、NPMが適切に解析できます。

Windowsユーザー、特にActive Directoryを使用する企業環境では、バックスラッシュに関する問題が発生することがあります。いくつかの報告では、`.npmrc`で`domain\username`が読み取られると`domain/username`に変換されることが示されており、これにより認証に失敗する可能性があります。このような場合、NTLM認証プロキシサーバーやCntlmなどのツールを使用することが考えられますが、これらは`.npmrc`の直接設定の範囲外です。

#### レジストリ設定とSSLの考慮
レジストリ設定は、NPMがパッケージを取得するために使用するURLを定義し、デフォルトでは`https://registry.npmjs.org/`に設定されます。カスタムまたはプライベートレジストリを使用する場合は以下のように設定します：
- `registry = https://your_custom_registry.com/`

SSL検証に失敗した場合、特に自署名証明書を使用する企業プロキシの場合は、厳密なSSLを無効にすることができます：
- `strict-ssl = false`

ただし、これはセキュリティを低下させるため、証明書認証局を設定することを検討してください：
- `npm config -g set cafile [YOUR_CERTIFICATE_DIR]/[CERTIFICATE_NAME].crt`を使用して信頼できるCAファイルを指定します。

いくつかの開発者は、SSLを完全に避けるために`registry = http://registry.npmjs.org/`を使用することも検討していますが、これは特に本番環境ではセキュリティ上の理由から推奨されません。

#### `.npmrc`の使用：手動編集とコマンドライン
`.npmrc`は任意のテキストエディタで直接編集でき、各設定は新しい行に`key = value`の形式で記述します。コメントは`;`で始まります。例えば：
```
; コーポレートネットワーク用のプロキシ設定
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

代替として、便利なNPMコマンドを使用することもできます：
- プロキシの設定：`npm config set proxy http://user:password@proxy_server:port`
- レジストリの設定：`npm config set registry https://registry.npmjs.org/`
- 厳密なSSLの設定：`npm config set strict-ssl false`

これらのコマンドは、コンテキスト（グローバルまたはローカル）に基づいて適切な`.npmrc`ファイルを更新します。グローバルとローカルを切り替えるには、グローバルを設定するために`-g`を使用します（例：`npm config set -g proxy ...`）。

#### 検証とトラブルシューティング
設定を検証するには以下を使用します：
- `npm config list`で全設定をリスト表示し、有効値とデフォルト値を表示します。
- `npm config get proxy`で特定の設定を取得します。

トラブルシューティング、特にプロキシの背後にある場合は、以下を実行します：
- `npm install --verbose`で詳細なログを表示し、接続問題（例：`ECONNREFUSED`や`socket hang up`）を特定します。

設定が反映されない場合は、環境変数（`HTTP_PROXY`、`HTTPS_PROXY`）が`.npmrc`を上書きしているか確認してください。これらの変数はシステム全体で設定され、優先されるため、一貫性を保つ必要があります。

#### ベストプラクティスと追加の考慮事項
- **セキュリティ**: 本番環境では`strict-ssl = false`を避け、信頼できる証明書を設定します。
- **環境変数**: `NODE_ENV`や`HTTPS_PROXY`が`.npmrc`の設定を上書きすることを認識してください。これはCI/CDパイプラインで有用ですが、ローカルでは混乱を招くことがあります。
- **ログレベル**: デバッグ中に詳細な出力を得るために、`.npmrc`の`loglevel`を調整します（例：`loglevel = http`）。オプションは`silent`から`silly`までの7レベルです。
- **コーポレートプロキシ**: NTLMプロキシの場合は、Cntlmなどのツールを使用してローカルプロキシサーバーを設定し、`.npmrc`を`localhost:3128`に設定することで認証を簡素化します。

#### 設定例
以下は、プロキシとレジストリの一般的な`.npmrc`設定をまとめた表です：

| **設定**    | **説明**                              | **例**                                      |
|----------------|----------------------------------------------|--------------------------------------------------|
| proxy          | HTTPプロキシサーバーのURL                        | `proxy = http://user:password@proxy:8080`        |
| https_proxy    | HTTPSプロキシサーバーのURL                       | `https_proxy = http://user:password@proxy:8080`  |
| registry       | パッケージレジストリのURL                         | `registry = https://registry.npmjs.org/`         |
| strict-ssl     | SSL検証の有効/無効                      | `strict-ssl = false`                             |
| loglevel       | コンソール出力レベル（silentからsillyまで、7レベル） | `loglevel = http`                                |

この表は、特に`.npmrc`に新しい開発者にとっての参考になります。

#### 予期せぬ詳細：グローバル対ローカル設定の影響
予期せぬ点は、グローバル`.npmrc`設定がすべてのプロジェクトに影響を与える一方で、ローカル設定が特定のプロジェクトに対して上書きされることです。この層構造は、例えばグローバルプロキシが設定されているが、特定のプロジェクトが異なるレジストリを使用する場合に認証問題を引き起こす可能性があります。この階層構造を理解することは、複数のプロジェクトがある環境で重要です。

#### 結論
`.npmrc`を使用してプロキシとレジストリの設定を行うNPMの設定は、適切な形式とエンコード、SSLの考慮を持つことで簡単です。直接編集するかコマンドを使用し、`npm config list`で検証することで、特にプロキシがあるコーポレートネットワークでのスムーズなパッケージ管理が可能です。さらに詳しくは、[NPM CLI Config](https://docs.npmjs.com/cli-config)の公式ドキュメントを参照するか、[Configuring Your .nmprc](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)でベストプラクティスを探ることをお勧めします。

### 主要引用
- [NPM CLI Config Documentation](https://docs.npmjs.com/cli-config)
- [Configuring Your .nmprc for an Optimal Node.js Environment](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)
- [How to setup npm proxy settings behind proxy on Windows](https://gist.github.com/zillingen/5c4b8da657025c83ead59e1e547c7436)