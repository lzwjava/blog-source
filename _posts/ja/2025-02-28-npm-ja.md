---
audio: false
generated: true
lang: ja
layout: post
title: NPM設定
translated: true
type: note
---

### 主なポイント
- NPMの設定は、プロキシとレジストリ設定を手動またはコマンドで行うために `.npmrc` ファイルを編集する必要があると考えられます。
- 調査によると、プロキシ設定には `proxy = http://user:password@proxy_server:port` という形式が必要で、特殊文字はURLエンコードする必要があります。
- デフォルトではレジストリを `registry = https://registry.npmjs.org/` に設定し、必要に応じてSSL検証を無効にするオプションがあるという証拠が優勢です。

### NPMの設定と `.npmrc` の操作
NPM（Node Package Manager）はJavaScriptの依存関係を管理するツールであり、その設定にはレジストリやプロキシなどの設定のために `.npmrc` ファイルが頻繁に関与します。

#### `.npmrc` とは何か、そしてその場所は？
`.npmrc` ファイルはNPMの設定ファイルであり、その動作をカスタマイズできます。以下の場所に存在します：
- **グローバル**: Unix系システムでは `~./.npmrc`、Windowsでは `%APPDATA%\npm\npmrc`（通常は `C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **プロジェクトローカル**: プロジェクトのルートディレクトリにある `./package/.npmrc`。ローカル設定はグローバル設定を上書きします。

#### プロキシとHTTPSプロキシの設定
プロキシの背後で動作させるには、以下の行を `.npmrc` に追加します：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

`https_proxy` の場合でも、プロトコルとして `https://` ではなく `http://` を使用することに注意してください。ユーザー名やパスワードに特殊文字（例: `\`, `@`）が含まれる場合は、URLエンコードします（例: `domain\user` は `domain%5Cuser` になります）。これらはコマンドで設定することもできます：
- `npm config set proxy http://user:password@proxy_server:port`
- `npm config set https_proxy http://user:password@proxy_server:port`

#### レジストリの設定
レジストリはNPMがパッケージを取得するために使用するURLで、通常は以下のように設定されます：
- `registry = https://registry.npmjs.org/`

カスタムレジストリの場合は、URLを置き換えます（例: 会社のプライベートレジストリ）。以下のコマンドで設定します：
- `npm config set registry https://your_custom_registry.com/`

#### SSLと検証の取り扱い
SSLの問題が発生した場合は、以下を検討してください：
- `.npmrc` で `strict-ssl = false` を設定するとSSLエラーを無視しますが、これは安全性が低くなります。以下のコマンドで設定します：
- `npm config set strict-ssl false`

#### 設定の使用と検証
テキストエディタで直接 `.npmrc` を編集するか、`npm config set` コマンドを使用します。検証するには：
- すべての設定をリスト表示するには `npm config list`。
- 特定の設定を確認するには `npm config get proxy`。
- 詳細な出力で問題をデバッグするには `npm install --verbose`。

`.npmrc` ファイルの例は以下のようになります：
```
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

### サーベイノート: `.npmrc` を使用したNPM設定の包括的ガイド
このセクションでは、レジストリとプロキシ設定に焦点を当てた `.npmrc` ファイルを使用したNPMの設定について、追加の文脈と技術的詳細を加えて直接の回答を拡張し、詳細に探求します。

#### `.npmrc` とその役割の紹介
`.npmrc` ファイルはNPMの重要な設定ファイルであり、パッケージ管理の動作をカスタマイズできます。セミコロン (`;`) で始まるコメント付きのキーと値のペアのINI形式をサポートしています。グローバルまたはローカルに配置できます：
- **グローバルな場所**: Unix系システムでは `~./.npmrc`、Windowsでは `%APPDATA%\npm\npmrc`（通常は `C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **ローカルな場所**: プロジェクトのルートディレクトリ内の `./package/.npmrc`。ローカル設定はグローバル設定を上書きし、プロジェクト固有の設定を提供します。

この階層構造により柔軟性が確保され、開発者はユーザーレベルとプロジェクトレベルの両方で設定を管理できます。これは、複数のプロジェクトや共有システムがある環境で特に有用です。

#### 詳細なプロキシ設定
プロキシの背後で動作させるには、`.npmrc` で `proxy` と `https_proxy` の両方を設定する必要があります。形式は以下の通りです：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

特筆すべきは、`https_proxy` がプロトコルとして `https://` ではなく `http://` を使用することです。これは、プロキシサーバー自体への接続を暗号化するのではなく、プロキシサーバーが接続を処理するためです。これは混乱の一般的なポイントです。なぜなら、宛先へのペイロードはSSLで暗号化されたままであるからです。

認証にはユーザー名とパスワードを含めますが、特殊文字が含まれている場合はURLエンコードが不可欠です：
- バックスラッシュ (`\`) は `%5C` になります。
- アットマーク (`@`) は `%40` になります。
- コロン (`:`) は `%3A` になります。

例えば、ユーザー名が `domain\user` でパスワードが `pass@word` の場合、`proxy = http://domain%5Cuser:pass%40word@proxy_server:8080` のようになります。このエンコードにより、NPMによる適切な解析が保証されます。

特にActive Directoryを使用する企業環境のWindowsユーザーは、バックスラッシュに関連する問題に直面することがあります。一部の報告によると、`.npmrc` の `domain\username` が読み取り時に `domain/username` に変換され、認証失敗を引き起こす可能性があります。そのような場合、NTLM Authorization Proxy Server や Cntlm などのツールが役立つことがありますが、これらは直接の `.npmrc` 設定の範囲外です。

#### レジストリ設定とSSLに関する考慮事項
レジストリ設定は、NPMがパッケージを取得する場所を定義し、デフォルトは `https://registry.npmjs.org/` です。カスタムまたはプライベートレジストリの場合は、以下を設定します：
- `registry = https://your_custom_registry.com/`

SSL検証が失敗する場合（多くの場合、企業プロキシでの自己署名証明書が原因）、strict SSLを無効にできます：
- `strict-ssl = false`

ただし、これは証明書の検証をバイパスするため、セキュリティが低下します。代わりに、証明書機関を設定します：
- `npm config -g set cafile [YOUR_CERTIFICATE_DIR]/[CERTIFICATE_NAME].crt` を使用して、信頼されたCAファイルを指定します。

一部の開発者は、SSLを完全に回避するために `registry = http://registry.npmjs.org/` を選択しますが、特に本番環境ではセキュリティ上の理由から推奨されません。

#### `.npmrc` の使用：手動編集 vs コマンドライン
任意のテキストエディタで直接 `.npmrc` を編集でき、各設定が `key = value` の形式で新しい行にあることを確認します。コメントは `;` で始まります。例：
```
; 企業ネットワーク用プロキシ設定
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

あるいは、利便性のためにNPMコマンドを使用します：
- プロキシ設定: `npm config set proxy http://user:password@proxy_server:port`
- レジストリ設定: `npm config set registry https://registry.npmjs.org/`
- strict-ssl設定: `npm config set strict-ssl false`

これらのコマンドは、コンテキスト（グローバルまたはローカル）に基づいて適切な `.npmrc` ファイルを更新します。グローバルとローカルを切り替えるには、グローバルの場合は `-g` を使用します（例: `npm config set -g proxy ...`）。

#### 検証とトラブルシューティング
設定を検証するには、以下を使用します：
- `npm config list` ですべての設定をリスト表示し、有効な値とデフォルト値を表示します。
- `npm config get proxy` で特定の設定を取得します。

特にプロキシ環境でのトラブルシューティングには、以下を実行します：
- `npm install --verbose` を実行して詳細なログを表示し、`ECONNREFUSED` や `socket hang up` などの接続問題を特定するのに役立てます。

設定が有効にならない場合は、`.npmrc` を上書きする可能性のある環境変数（`HTTP_PROXY`, `HTTPS_PROXY`）を確認してください。これらはシステム全体で設定され、優先されることがあるため、一貫性を確保してください。

#### ベストプラクティスと追加の考慮事項
- **セキュリティ**: 本番環境では `strict-ssl = false` を避け、代わりに信頼された証明書を設定してください。
- **環境変数**: `NODE_ENV` や `HTTPS_PROXY` が `.npmrc` 設定を上書きする可能性があることに注意してください。CI/CDパイプラインでは有用ですが、ローカルでは混乱を招く可能性があります。
- **ログレベル**: デバッグ中により詳細な出力を得るために、`.npmrc` で `loglevel`（例: `loglevel = http`）を調整します。オプションは `silent` から `silly` まで（合計7レベル）あります。
- **企業プロキシ**: NTLMプロキシの場合、Cntlmなどのツールを検討し、ローカルプロキシサーバーをセットアップして、`.npmrc` が `localhost:3128` を指すように設定すると、認証が簡素化されます。

#### 設定例
以下は、プロキシとレジストリに関する一般的な `.npmrc` 設定をまとめた表で、例を示しています：

| **設定**       | **説明**                                      | **例**                                               |
|----------------|-----------------------------------------------|-----------------------------------------------------|
| proxy          | HTTPプロキシサーバーのURL                     | `proxy = http://user:password@proxy:8080`           |
| https_proxy    | HTTPSプロキシサーバーのURL                    | `https_proxy = http://user:password@proxy:8080`     |
| registry       | パッケージレジストリのURL                     | `registry = https://registry.npmjs.org/`            |
| strict-ssl     | SSL検証の有効/無効                            | `strict-ssl = false`                                |
| loglevel       | コンソール出力レベル（silent から silly、7レベル） | `loglevel = http`                                   |

この表は、特に `.npmrc` に慣れていない開発者にとって、クイックリファレンスとして役立ちます。

#### 予期しない詳細：グローバル設定とローカル設定への影響
予期しない側面は、グローバル `.npmrc` 設定がすべてのプロジェクトに影響を与えるのに対し、ローカル設定は特定のプロジェクトでそれを上書きできることです。この階層化は、例えば、グローバルプロキシが設定されているがローカルプロジェクトが異なるレジストリを使用している場合に、認証問題を引き起こす可能性があり、混乱を招くことがあります。この階層を理解することは、マルチプロジェクト環境において重要です。

#### 結論
プロキシとレジストリ設定のための `.npmrc` を介したNPMの設定は、適切な形式とエンコードおよびSSLに関する考慮事項があれば簡単です。直接編集するかコマンドを使用し、`npm config list` で検証することで、特にプロキシを持つ企業ネットワークでのスムーズなパッケージ管理が保証されます。さらなる読書には、公式ドキュメント [NPM CLI Config](https://docs.npmjs.com/cli-config) を参照するか、[Configuring Your .nmprc](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment) でベストプラクティスを探求してください。

### 主要な引用文献
- [NPM CLI Config Documentation](https://docs.npmjs.com/cli-config)
- [Configuring Your .nmprc for an Optimal Node.js Environment](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)
- [How to setup npm proxy settings behind proxy on Windows](https://gist.github.com/zillingen/5c4b8da657025c83ead59e1e547c7436)