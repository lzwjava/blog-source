---
audio: false
generated: true
lang: ja
layout: post
title: Spring BootでのFlywayによるデータベースマイグレーション
translated: true
type: note
---

以下は、Spring Boot アプリケーションでデータベーススキーマを管理するための Flyway の実践的なガイドです：

---

### Flyway とは？
Flyway はデータベースマイグレーションツールで、データベーススキーマをバージョン管理できます。SQL スクリプト（マイグレーション）を特定の順序で適用してデータベースを進化させるため、一貫性と自動化が重要な Spring Boot プロジェクトに最適です。

---

### ステップ 1: Flyway 依存関係の追加
まず、プロジェクトに Flyway を追加します。**Maven** を使用している場合は、`pom.xml` を更新してください：

```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

**Gradle** の場合は、`build.gradle` に以下を追加します：

```groovy
implementation 'org.flywaydb:flyway-core'
```

これにより、Flyway が Spring Boot アプリケーションに組み込まれます。

---

### ステップ 2: データベース接続の設定
Flyway は管理対象のデータベースを認識する必要があります。`application.properties`（または `application.yml`）でデータベース接続を定義します。例として PostgreSQL の場合：

```properties
spring.datasource.url=jdbc:postgresql://localhost:5432/mydb
spring.datasource.username=myuser
spring.datasource.password=mypassword
```

Spring Boot はこのデータソースを使用して Flyway を自動的に設定するため、追加の設定は不要です。

---

### ステップ 3: マイグレーションスクリプトの作成
Flyway はバージョン管理された SQL スクリプトを使用してデータベースを更新します。これらのスクリプトはデフォルトのディレクトリ `src/main/resources/db/migration` に配置します。各スクリプトは次の命名パターンに従う必要があります：`V<バージョン番号>__<説明>.sql`。バージョン番号によりマイグレーションが順序通りに実行されます。

例として、`V1__create_users_table.sql` というファイルを作成します：

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL
);
```

このファイルを `src/main/resources/db/migration` に保存します。

---

### ステップ 4: アプリケーションの実行
Spring Boot アプリケーションを起動します（例：`mvn spring-boot:run` または IDE から）。Flyway は以下を自動的に実行します：
- データベースのマイグレーション履歴をチェック。
- 保留中のマイグレーション（例：`V1__create_users_table.sql`）を順番に適用。

これは Spring Boot の統合により起動時に自動的に行われるため、手動での操作は不要です。

---

### ステップ 5: Flyway のカスタマイズ（オプション）
`application.properties` でプロパティを設定し、Flyway の動作を調整できます。一般的なオプションは以下の通りです：

```properties
spring.flyway.locations=classpath:db/migration  # スクリプトの検索場所
spring.flyway.baseline-on-migrate=true          # 既存データベースの処理
spring.flyway.enabled=true                      # Flyway の有効/無効切り替え
```

これらの設定により、プロジェクトの要件に合わせて Flyway をカスタマイズできます。

---

### 高度な機能
Flyway は基本的なマイグレーション以外にも以下の機能を提供します：
- **Java ベースのマイグレーション**: 複雑なロジックに対して Java でマイグレーションを記述。
- **繰り返し可能なマイグレーション**: 変更時に再実行されるスクリプト（例：ビュー）には `R__<説明>.sql` を使用。
- **アンドゥマイグレーション**: 変更をロールバック（Flyway Pro が必要）。

詳細については [Flyway ドキュメント](https://flywaydb.org/documentation/)を参照してください。

---

### まとめ
Spring Boot で Flyway を使用するには：
1. プロジェクトに Flyway 依存関係を追加。
2. `application.properties` でデータベース接続を設定。
3. `src/main/resources/db/migration` にバージョン管理された SQL スクリプトを作成。
4. アプリケーションを起動 — Flyway が自動的にマイグレーションを適用。

Flyway はバージョン管理と自動化によりデータベーススキーマ管理を簡素化し、Spring Boot の効率的な開発体験を完璧に補完します。