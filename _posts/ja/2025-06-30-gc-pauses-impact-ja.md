---
audio: false
generated: true
lang: ja
layout: post
title: クラウドフレア対TiDBのGo GC一時停止
translated: true
type: note
---

はい、Goのガベージコレクタ（GC）のポーズは、CloudflareのサービスとTiDBデータベースの両方に影響を与える可能性があります。どちらもそのアーキテクチャでGoを多用しているためです。しかし、これらのポーズの性質と影響、およびそれらを軽減する方法は異なります。

以下に詳細を示します：

**GoのGCとその特性：**

*   **マーク・スイープGC：** Goは並行処理を行う3色マーク・スイープ・ガベージコレクタを使用しています。これは、GC作業の大部分（生存中のオブジェクトのマーキング）がアプリケーションの実行と並行して行われることを意味します。
*   **Stop-the-World (STW) ポーズ：** 並行処理が可能ですが、GoのGCには依然として短い「stop-the-world」(STW) ポーズが必要です。これらのポーズは、特定のフェーズ（初期の「マーク」設定や最終的な「マーク終了」、「スイープ終了」フェーズなど）で発生し、メモリの一貫性を保証するためにアプリケーションのゴルーチンが停止します。Goランタイムエンジニアの目標は、これらのSTW時間をマイクロ秒単位に抑え、最小化することです。
*   **GCに影響を与える要因：** GCポーズの頻度と持続時間は、以下の要因によって影響を受けます：
    *   **割り当てレート：** アプリケーションが新しいメモリを割り当てる速度。
    *   **ヒープサイズ：** Goランタイムによって管理されるメモリの総量。
    *   **`GOGC`：** ガベージコレクションの目標パーセンテージを制御するパラメータ（デフォルトは100%）。`GOGC`を低く設定すると、GCがより頻繁に発生します。
    *   **`GOMEMLIMIT`：** 目標ヒープサイズの上限を設定する新しいパラメータ（Go 1.19以降）。これにより、OOM（メモリ不足）を防止し、メモリをより予測可能に管理することが容易になります。

**Cloudflareへの影響：**

Cloudflareは、DNSインフラストラクチャ、SSL処理、負荷テストなど、多くの重要なサービスでGoを広範に使用しています。Cloudflareのような高性能で低遅延のシステムでは、マイクロ秒単位のポーズでさえも重要です。

*   **遅延に敏感なサービス：** 高いリクエストレートを処理するサービス（DNSやプロキシなど）は、遅延のスパイクに非常に敏感です。GCポーズはたとえ短くても、これらのスパイクの一因となり、ユーザーエクスペリエンスに影響を与える可能性があります。
*   **メモリ集約型アプリケーション：** 一部のCloudflareサービスはメモリ集約型である可能性があり、適切に調整されない場合、より頻繁なGCサイクルを引き起こす可能性があります。
*   **Cloudflareでの軽減策：** Cloudflareのエンジニアは、以下の取り組みを積極的に行っています：
    *   **`GOGC`と`GOMEMLIMIT`の調整：** メモリ使用量とGC頻度のバランスを取るために、これらのパラメータを実験的に調整します。
    *   **プロファイリングとコードの最適化：** Goコード内の不要なメモリ割り当てを特定し、削減します。
    *   **Profile-Guided Optimizations (PGO)：** Cloudflareは、GoのPGO機能を活用することで、大幅なCPU節約（したがってGC負荷の軽減）を実現しています。
    *   **アーキテクチャ上の考慮事項：** 十分な冗長性を持たせるか、単一のゴルーチンのポーズの影響を最小限に抑える方法でリクエストを処理することにより、短いポーズに対して回復力のあるサービスを設計します。

**TiDBデータベースへの影響：**

TiDBはPingCAPによって構築された分散SQLデータベースであり、そのSQLレイヤー（`tidb-server`）は主にGoで書かれています。データベースとして、プロキシサービスとは異なるパフォーマンス特性と要件を持っています。

*   **データベース固有のGC：** TiDBは、MVCC（Multi-Version Concurrency Control）データ（ストレージエンジンであるTiKV内の古いデータバージョンのクリーンアップ）用に、独自のガベージコレクションメカニズムを持っています。これはGoのランタイムGCとは区別されますが、TiDBの「コーディネーター」（Goで書かれている）がこれを開始および管理します。
*   **TiDBにおけるGoランタイムGC：** Go GCは、`tidb-server`がSQLリクエストを処理し、クエリプランや結果、その他のランタイムデータ用のメモリを管理するため、TiDBに*影響を与えます*。
    *   **遅延ジッター：** 頻繁なSTWポーズは、クエリ実行における遅延スパイクを引き起こし、データベースの応答性に影響を与える可能性があります。
    *   **CPUオーバーヘッド：** GC活動はCPUリソースを消費し、そのリソースがクエリ処理に使用され得るものです。
    *   **適応的GCトリガー：** TiDBは、メモリ使用量が特定のしきい値に達したとき（`tidb_server_memory_limit`および`tidb_server_memory_limit_gc_trigger`で設定可能）に、Go GCを積極的にトリガーします。また、過度に頻繁なGCを避けるために、`tidb_server_memory_limit_gc_trigger`に対して適応戦略を使用しています。
*   **監視と調整：** PingCAPは、Go GCの動作（GC頻度、持続時間、STW遅延、GCに費やされたCPU時間）を監視し、ユーザーが`GOGC`と`GOMEMLIMIT`を設定してパフォーマンスを最適化できるようにするための広範な監視ツール（TiDB Runtime Dashboardなど）を提供しています。
*   **継続的な取り組み：** PingCAPのエンジニアは、パフォーマンスと安定性への影響を最小限に抑えるために、TiDBのGoメモリ管理とGC動作の最適化に継続的に取り組んでいます。

**まとめ：**

CloudflareとTiDBの両方は、Goに依存する高性能システムとして、GoのGCポーズの影響を受けやすいです。GoのGCは短いSTW時間に対して高度に最適化されていますが、大規模では、これらのポーズが遅延スパイクやCPUオーバーヘッドの一因となる可能性があります。両社は、Goのランタイムパラメータとそれぞれの固有のアーキテクチャ設計を活用して、これらの影響を軽減するために、Goアプリケーションとインフラストラクチャを積極的に監視、調整、最適化しています。