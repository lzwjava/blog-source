---
audio: false
generated: true
image: false
lang: ja
layout: post
model: x-ai/grok-code-fast-1
title: Gitガベージコレクション最適化の解説
translated: true
type: note
---

### Git GCの役割
Git GC（ガベージコレクション）は、リポジトリの最適化を行うメンテナンスコマンドです。不要なファイルを削除し、データを圧縮することで、ディスクスペースを節約しパフォーマンスを向上させます。この操作は、リポジトリの全履歴・オブジェクト・メタデータを格納する `.git` ディレクトリに対して実行されます。

主な処理内容：
- **到達不能オブジェクトの削除**：リベースやブランチ削除後に参照されなくなったコミット・ツリー・ブロブを削除します。これらは `.git/objects` 内の「ルーズオブジェクト」となり、GCによって整理されます。
- **オブジェクトの再パッキング**：個別に保存されているルーズオブジェクトを、効率的なパックファイル（`.git/objects/pack`）に圧縮します。デルタ圧縮技術により類似ファイル間の差分を保存することで、ディスク使用量を削減します。
- **参照の更新**：パック索引の再作成など、リポジトリの内部状態を更新して検索速度を向上させます。
- **関連ツールの実行**：処理の一部として `git prune`、`git repack`、`git rerere`（衝突解決の再利用）などのコマンドを自動実行します。

公式ドキュメント（`git gc --help`）によると、GCはリポジトリの「家事作業」と説明されています。例えば1万個のルーズオブジェクトがあるリポジトリは、パッキングにより数百MBから大幅に縮小され、デルタ圧縮がコード履歴内のファイルバージョン間の類似性を活用します。

### 内部動作の仕組み
1. **実行契機**：`git gc` による手動実行、またはGitが特定条件を検知した際の自動実行（後述）で起動します。処理負荷を考慮し、すべてのコマンドで実行されるわけではありません。
2. **処理フロー**：
   - ルーズオブジェクトとパックファイルの数を計測
   - 閾値（デフォルト約6,700個のルーズオブジェクトなど、`gc.auto` で設定可能）を超えた場合、積極的な再パッキングを実行
   - データ損失を防ぐため一時ファイル（`.git/objects/tmp_*`）を作成後、アトミックに置換
   - `git gc --auto` などの軽量モードでは、完全な再パッキングなしで削除のみ実行
3. **圧縮の詳細**：zlib圧縮を採用。再パッキング時にはベースオブジェクトからの差分（デルタ）としてオブジェクトを保存するため、進化するコードベースに効率的です（例：大規模コードベースで1行追加すると、ファイル全体ではなく小さなデルタが生成される）。

Gitのソースコード（GitHubで公開）では、信頼性を高めるためGCが削除・パッキングユーティリティのシェル呼び出しとして実装されています。

### 突然実行される理由
GCが「突然」動作するのは、リアルタイム処理ではなくパフォーマンスバランスを考慮した自動実行機制によるものです。主な要因：
- **閾値の到達**：頻繁なコミットやパッキング未実施のフェッチなどでルーズオブジェクトが蓄積されると、`git commit`、`git merge`、`push` などの操作後にGitが自動チェックを実行。`gc.auto` の閾値（デフォルト約6,700個）を超えるとGCが起動するため、集中作業後の実行が「突然」と感じられます。
- **定期削除スケジュール**：`gc.prune` 設定により古い参照を定期削除しますが、主要な自動GCはオブジェクト数に基づきます。
- **大規模操作**：大規模なリベースやクローン実行により、短時間で多数のルーズオブジェクトが生成されると発動します。
- **コマンド後フック**：ワークフローやツール（GitフックやIDEなど）が大きな変更後に `git gc` を呼び出す場合があります。

制御方法：`git config --global gc.auto 0` で自動GCを無効化（手動実行推奨）、または閾値を引き上げて実行頻度を低減可能。GC実行はリポジトリ肥大化防止に有効で、Linuxカーネルのような大規模リポジトリでも履歴管理に活用されています。問題が続く場合は `git count-objects -v` でルーズオブジェクトの状態を確認できます。