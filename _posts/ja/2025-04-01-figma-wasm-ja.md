---
audio: false
generated: true
lang: ja
layout: post
title: FigmaがWebAssemblyを活用
translated: true
type: note
---

FigmaはWebAssembly（Wasm）を活用してパフォーマンスを大幅に向上させており、このテクノロジーがWebベースのアプリケーションをどのように変革できるかを示す代表的な事例となっています。Figmaは本質的にブラウザ上で動作するコラボレーティブデザインツールであり、クリティカルでパフォーマンス集中型のタスクをネイティブに近い速度で実行するためにWebAssemblyを使用しています。その仕組みは以下の通りです：

Figmaのエンジンは、速度と効率性で知られるC++で構築されていますが、この言語はブラウザでネイティブサポートされていません。このギャップを埋めるため、FigmaはC/C++をWasmバイナリに変換するツールチェーンであるEmscriptenを使用して、C++コードベースをWebAssemblyにコンパイルします。これらの`.wasm`ファイルはブラウザに読み込まれ、複雑なベクターグラフィックスのレンダリング、大規模なデザインドキュメントの管理、複数ユーザー間でのリアルタイム更新の処理といった重い処理を担当します。

このアプローチによる大きな成果の一つが**ロード時間**です。Figmaは、以前使用していたasm.js（C++コードを実行するためのJavaScriptサブセット）と比較して、WebAssemblyへの切り替えによりロード時間を3倍以上短縮したと報告しています。WebAssemblyのバイナリ形式はJavaScriptよりもコンパクトで解析が高速であり、一度読み込まれるとブラウザはコンパイルされたマシンコードをキャッシュするため、以降のロードはさらに高速になります。これは、ユーザーが大規模なファイルを頻繁に扱い、即時の応答性を期待するFigmaにとって極めて重要です。

**レンダリングエンジン**は、WebAssemblyが真価を発揮するもう一つの重要な領域です。FigmaはGPUアクセラレーションされたグラフィックスにWebGLを使用していますが、これを駆動するロジック（曲線のレンダリング、マスキング、ブラー、ブレンドモードなど）はWasmにコンパイルされたC++コードによって管理されています。この設定により、ブラウザのHTMLレンダリングパイプラインをバイパスし、Figmaはパフォーマンスとプラットフォーム間の一貫性を細かく制御できます。これが、数千のレイヤーがあってもFigmaでのズームやパン操作が非常にスムーズに感じられる理由です。

**リアルタイムコラボレーション**も恩恵を受けています。Figmaのマルチプレイヤー機能は、Conflict-Free Replicated Data Types (CRDTs) に依存して、ユーザー間で変更を即座に同期します。CRDTロジック自体のすべてがWasmで実行されるわけではありませんが、C++で動作するエンジンがドキュメントの状態と更新を効率的に処理し、コラボレーティブな編集がシステムを遅滞させないようにしています。WebAssemblyの速度は、数十人の共同作業者があってもこのシームレスな体験を維持するのに役立っています。

ここではハイブリッドアーキテクチャが採用されています：コアエンジン（C++/Wasm）がドキュメントとキャンバスを管理し、ツールバーやメニューなどの周辺UIはJavaScript（現在はTypeScript + React）で構築されています。これら二者はブリッジを介して通信し、WasmはJavaScriptが呼び出せる関数をエクスポートし、その逆も行われます。この分業により、Figmaは最もパフォーマンスが重要な部分を最適化しつつ、計算集中型でないタスクについてはJavaScriptのWebネイティブな柔軟性を維持しています。

一つ注意点としては、Figmaはすべてのブラウザで一様にWebAssemblyを使用しているわけではありません。歴史的には、初期のChromeのバグ（例えば、変換されたWasmコードのキャッシングの欠如）のため、FirefoxではよりWasmに依存していましたが、現代の実装ではこの問題はほぼ解消されているでしょう。それでも、C++からWasmへのパイプラインはそのアーキテクチャの中心であり続けています。

要約すると、FigmaはWebAssemblyを使用して、デスクトップ級のパフォーマンスをブラウザにもたらし、そのC++コアを効率的なバイナリにコンパイルして、レンダリング、ドキュメント管理、リアルタイム同期を処理させています。これは、WasmがWebアプリケーションにJavaScriptの限界を超えた力を与えることを可能にする教科書的なケースです。技術的な詳細についてさらに掘り下げたり、他のツールと比較したりしたいですか？