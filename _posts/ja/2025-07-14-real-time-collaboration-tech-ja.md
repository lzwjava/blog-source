---
audio: false
generated: true
lang: ja
layout: post
title: Googleドキュメントのリアルタイム共同編集技術
translated: true
type: note
---

Google Docsは、複数のユーザーが同時にドキュメントを編集できるようにする高度な**リアルタイム共同編集アルゴリズム**を使用しています。この背後にあるコア技術は、**Operational Transformation (OT)** を基盤としており、後に一部のシステムでは**Conflict-Free Replicated Data Types (CRDTs)** の概念も取り入れられ進化しました。主な構成要素の内訳は以下の通りです：

### 1. **Operational Transformation (OT)**
   - **基本概念**: OTは、受信した操作を過去に適用された操作に対して変換（調整）することで競合を解決します。
   - **仕組み**:
     1. ユーザーが編集（例：テキストの挿入）を行うと、クライアントは**操作**（例：`insert("hello", pos=5)`）を生成します。
     2. その操作はサーバーに送信され、サーバーは他のユーザーからの同時編集に対して操作を**変換**し、一貫性を維持します。
     3. 全てのクライアントは、最終的な一貫性が保証される方法で操作を適用します。
   - **例**: ユーザーAが位置5に"abc"を挿入し、同時にユーザーBが位置5を削除した場合、OTはBの操作を位置8（Aの挿入後）を削除するように調整します。
   - **課題**: OTは変換を管理する中央サーバーを必要とするため、正確な実装が複雑になります。

### 2. **Conflict-Free Replicated Data Types (CRDTs)**
   - **基本概念**: CRDTは、常に収束するように設計されたデータ構造を用いて、中央サーバーなしで編集をマージできるようにします。
   - **仕組み**:
     1. 編集には（タイムスタンプやベクタークロックなどの）一意の識別子がタグ付けされます。
     2. システムは（可換性や結合性などの）数学的性質を用いて編集をマージします。
   - **OTに対する利点**:
     - 中央サーバーが不要（ピアツーピアで動作）。
     - オフライン編集に対してより堅牢。
   - **例**: 位置を数値で追跡する代わりに、CRDTは（例: "A" < "A1" < "B" のような）分数インデックスを使用して競合を回避する場合があります。

### 3. **Googleの実装 (Wave/OTハイブリッド)**
   - Google Docsは元々、古典的なOTを以下で拡張した**Google WaveのOTアルゴリズム**に基づいていました：
     - **集中型サーバー**: 全ての操作が正しく変換されることを保証。
     - **差分同期**: ネットワーク経由で送信されるデータを最小化。
   - 時間の経過とともに、Googleはおそらくオフラインサポートを向上させるために**CRDTに似た最適化**を組み込んだと考えられます。

### 4. **その他の主要技術**
   - **フロントエンド/バックエンド同期**: リアルタイム更新に**WebSockets/ロングポーリング**を使用。
   - **バージョンベクター/論理クロック**: 編集の因果関係を追跡。
   - **競合解決**: 2人のユーザーが同時に同じテキストを編集した場合、システムはOT/CRDTのルールによって競合を解決します。

### **比較: OT vs. CRDT**

| 特徴               | OT (Google Docs クラシック) | CRDT (例: Figma, Notion) |
|-----------------------|--------------------------|---------------------------|
| 中央サーバー必要性 | はい                      | いいえ (ピアツーピア可能) |
| オフラインサポート       | 限定的                  | 優れている                    |
| 複雑さ            | 高い (変換ロジック) | 高い (データ構造設計) |
| レイテンシ               | 低い (サーバー管理)     | 実装に依存 |

### **GoogleがOTを（CRDTの影響を受けつつ）使用すると思われる理由**
- OTはGoogle Docsのような**集中型**サービスに適しています。
- CRDTは（**Figma**や**Apple Notes**などの）分散型アプリで人気が高まっていますが、GoogleのインフラはOT向けに最適化されています。

### **さらに学ぶには**
- **OT論文**: [Operational Transformation in Real-Time Group Editors](https://dl.acm.org/doi/10.1145/146486.146487) (Cormack et al.)
- **CRDTs**: [A Comprehensive Study of CRDTs](https://arxiv.org/abs/1805.06358)
- **Google Wave Protocol**: [Wave Protocol](https://wave-protocol.google.com/)

特定の側面についてより深く知りたいですか？