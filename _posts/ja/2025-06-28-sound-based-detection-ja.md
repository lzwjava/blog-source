---
audio: false
generated: true
lang: ja
layout: post
title: 音響に基づくメイタグ洗濯機の検知
translated: true
type: note
---

Maytag MHW8630HW洗濯機の停止を検知するために音を使用することは、カメラベースのアプローチに代わる有効な方法です。洗濯機の近くに音センサーを設置することで、運転中に発生する騒音（モーター音、水流、ドラム回転音など）を監視し、音が止んだ時に洗濯サイクル終了を検知できます。以下では、以前のプロジェクトを音センサーを使用するように変更する方法を説明します。Telegram通知システムはそのままに、ハードウェア、アルゴリズム、コードの変更点に焦点を当てます。

---

### 技術スタック
#### ハードウェア
1. **Arduinoボード**:
   - **ESP32-CAM** (引き続き使用可能) – Wi-Fiを保持しTelegram連携が可能ですが、カメラは不要です。
   - 代替案: **ESP8266 NodeMCU** または **Arduino Uno** とESP8266モジュール (カメラが必要ない場合はよりシンプル)。
2. **音センサー**:
   - **KY-038 マイク音センサー** または類似品 – 手頃な価格で、アナログ出力により音レベルを検出します。
   - 代替案: **MAX9814 エレクトレットコンデンサーマイクアンプ** – 感度が高く、調整可能なゲインにより検出性能が向上します。
3. **電源**:
   - ESP32などのボード用の5V USB電源アダプターまたはバッテリーパック。
4. **取り付け**:
   - 音センサーを洗濯機の近く（例：側面や上面にテープで固定）に設置し、運転音を検出できるようにしますが、直接水がかかる場所は避けてください。
   - センサーとボードを保護するために小さなケースを使用します。
5. **Wi-Fiルーター**:
   - Telegram通知を送信するためのインターネット接続用。

#### ソフトウェア
- **Arduino IDE**: ESP32などのボードのプログラミング用。
- **ライブラリ**:
  - **Universal Arduino Telegram Bot Library** by Brian Lough – Telegram連携用。
  - **ArduinoJson** – Telegram API通信でのJSONデータ処理用。
- **Telegram Bot**: 前回と同様、BotFatherを使用してボットトークンとチャットIDを取得します。
- **プログラミング言語**: C++ (Arduinoスケッチ)。

---

### 音を用いた洗濯機状態検知アルゴリズム
音センサーは洗濯機が発生する騒音レベルを検出します。機械が稼働している間は一貫した音（モーター、水、ドラム音など）を発生します。停止すると、音レベルが大幅に低下します。アルゴリズムはこれらの音レベルを処理して機械の状態を判断します。

#### 検知アルゴリズム
1. **音サンプリング**:
   - 音センサーからのアナログ出力を継続的に読み取り、騒音レベルを測定します。
2. **信号処理**:
   - **平均化**: 一時的なノイズ（ドアのバタン音など）を平滑化するために、短いウィンドウ（例：1-2秒）で平均音レベルを計算します。
   - **閾値処理**: 平均音レベルを事前に定義した閾値と比較します。高いレベルは機械が稼働中、低いレベルは停止していることを示唆します。
3. **状態機械**:
   - 音レベルに基づいて機械の状態（ONまたはOFF）を追跡します。
   - 音レベルが数サイクルにわたって閾値を超えた場合、機械は稼働中と見なします。
   - 音レベルが閾値を下回り、設定期間（例：5分間）低い状態が続いた場合、洗濯サイクルが完了したと見なします。
4. **デバウンス**:
   - 誤通知を避けるため、静かな段階（浸漬やサイクル中の一時停止など）での誤検知を防ぐために遅延（例：5分）を実装します。
5. **通知**:
   - 機械の停止が確認されたら、Telegramメッセージ（例：「洗濯機が停止しました！服を干す時間です。」）を送信します。

#### 音検知を選ぶ理由
- 画像処理と比較して音検知はシンプルで、複雑なアルゴリズムや高い計算リソースを必要としません。
- カメラベースの検知と比較して、周囲光の変化の影響を受けにくいです。
- ただし、背景ノイズ（テレビの音など）の影響を受ける可能性があるため、設置場所と閾値の調整が重要です。

---

### 実装ガイド
#### ステップ 1: Telegram Botの設定
- 元のガイドと同じ手順に従います:
  - **@BotFather**を使用してボットを作成し、**ボットトークン**を取得します。
  - **@GetIDsBot**を使用するか、受信メッセージをチェックして**チャットID**を取得します。
  - 通知を受信するためにスマートフォンにTelegramが設定されていることを確認します。

#### ステップ 2: ハードウェアセットアップ
1. **音センサーの選択**:
   - **KY-038**: 音の強度に比例したアナログ出力（ESP32の10ビットADCでは0-1023）を提供します。デジタル出力もありますが、微妙な検出にはアナログが優れています。
   - **MAX9814**: 感度が高く、ポテンショメーターで調整可能なゲインを備えています。アナログピンに接続します。
2. **音センサーの接続**:
   - KY-038の場合:
     - **VCC** を 5V (またはボードに応じて3.3V) に接続。
     - **GND** を GNDに接続。
     - **アナログ出力 (A0)** を ESP32のアナログピン (例: GPIO 4) に接続。
   - MAX9814の場合:
     - 同様の接続ですが、最適な感度を得るためにオンボードのポテンショメーターでゲインを調整します。
3. **センサーの配置**:
   - センサーを洗濯機の近く（例：側面や上面）に配置し、モーターやドラムの音を検出できるようにします。水がかかる可能性のある場所は避けてください。
   - 洗濯サイクル中の音レベルを監視して配置をテストします（シリアルモニターを使用して値を記録）。
4. **ボードへの給電**:
   - ESP32などのボードに5V USB電源アダプターまたはバッテリーパックを接続します。
   - Wi-Fi通信には安定した電圧が必要なため、安定した電源を確保します。
5. **取り付け**:
   - センサーとボードを固定し、マイクが音を捕捉できるように露出させつつ保護するために、小さなケースまたはテープを使用します。

#### ステップ 3: ソフトウェアセットアップ
- **Arduino IDE**: 元のガイドで説明されているようにインストールします。
- **ESP32ボードサポート**: ボードマネージャー経由でESP32ボードパッケージを追加します（前回と同じURL）。
- **ライブラリ**:
  - 説明通りに **Universal Arduino Telegram Bot Library** と **ArduinoJson** をインストールします。
- **Wi-Fi**: ボードが2.4GHz Wi-Fiネットワークに接続できることを確認します。

#### ステップ 4: Arduinoコードの記述
以下は、ESP32（またはESP8266）用のサンプルArduinoスケッチで、音レベルを検出しTelegram通知を送信します。これは、GPIO 4に接続されたKY-038音センサーを想定しています。

```cpp
#include <WiFi.h>
#include <UniversalTelegramBot.h>
#include <ArduinoJson.h>

// Wi-Fi認証情報
#define WIFI_SSID "your_wifi_ssid"
#define WIFI_PASSWORD "your_wifi_password"

// Telegram Bot認証情報
#define BOT_TOKEN "your_bot_token"
#define CHAT_ID "your_chat_id"

// 音センサーピン
#define SOUND_PIN 4 // アナログ入力用 GPIO 4

// 音検知パラメータ
#define SOUND_THRESHOLD 300 // テストに基づいて調整 (0-1023)
#define SAMPLE_WINDOW 2000 // 平均化のための2秒
#define STOP_DELAY 300000 // 5分 (ミリ秒)

WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

bool machineRunning = false;
unsigned long lastOnTime = 0;

void setup() {
  Serial.begin(115200);

  // Wi-Fiに接続
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("WiFi connected");

  // Telegramクライアントの設定
  client.setInsecure(); // 簡略化のため; 本番環境では適切なSSLを検討

  // 音センサーピンの設定
  pinMode(SOUND_PIN, INPUT);
}

void loop() {
  // ウィンドウ期間中に音レベルをサンプリング
  unsigned long startMillis = millis();
  uint32_t totalSound = 0;
  uint16_t sampleCount = 0;

  while (millis() - startMillis < SAMPLE_WINDOW) {
    totalSound += analogRead(SOUND_PIN);
    sampleCount++;
    delay(10); // サンプル間の小さな遅延
  }

  float avgSound = sampleCount > 0 ? (float)totalSound / sampleCount : 0;
  Serial.print("Average sound level: ");
  Serial.println(avgSound);

  // 状態機械
  if (avgSound > SOUND_THRESHOLD) {
    if (!machineRunning) {
      machineRunning = true;
      Serial.println("Machine is ON");
    }
    lastOnTime = millis();
  } else {
    if (machineRunning && (millis() - lastOnTime > STOP_DELAY)) {
      machineRunning = false;
      Serial.println("Machine stopped");
      bot.sendMessage(CHAT_ID, "Washing machine stopped! Time to hang up clothes.", "");
    }
  }

  delay(10000); // 10秒ごとにチェック
}
```

#### ステップ 5: コードのカスタマイズ
1. **認証情報の更新**:
   - `your_wifi_ssid`, `your_wifi_password`, `your_bot_token`, `your_chat_id` を実際の値に置き換えます。
2. **`SOUND_THRESHOLD`の調整**:
   - 洗濯機を動かし、シリアルモニター (`Serial.println(analogRead(SOUND_PIN));`) で音レベルを監視します。
   - `SOUND_THRESHOLD`を、周囲ノイズより上で、機械の運転音より下の値（セットアップに応じて200-500など）に設定します。
3. **`SAMPLE_WINDOW`の調整**:
   - 2秒ウィンドウ (`2000` ms) は一時的なノイズを平滑化します。背景ノイズが誤検知を引き起こす場合は増やします。
4. **`STOP_DELAY`の調整**:
   - 浸漬などの静かな段階での誤通知を避けるために `300000` (5分) に設定します。

#### ステップ 6: テストとデプロイ
1. **コードのアップロード**:
   - USB-to-シリアルアダプターを介してESP32をコンピューターに接続します。
   - Arduino IDEで **ESP32 Wrover Module** (またはESP8266の場合は **NodeMCU**) を選択し、スケッチをアップロードします。
2. **システムのテスト**:
   - 洗濯機を起動し、シリアルモニターで音レベルと状態変化を監視します。
   - 機械が停止したときにTelegram通知が届くことを確認します。
3. **微調整**:
   - 誤検知/検知漏れが発生した場合は、`SOUND_THRESHOLD` または `STOP_DELAY` を調整します。
   - 信頼性を確保するために、さまざまな条件（背景ノイズがある場合など）でテストします。
4. **恒久的な設置**:
   - センサーとボードを機械近くのケースに固定し、マイクが露出しているが水から保護されていることを確認します。

---

### 音検知の利点
- **処理がシンプル**: 画像処理がないため、ESP32の計算負荷が軽減されます。
- **コスト効率**: KY-038などの音センサーは安価（多くの場合5ドル未満）です。
- **非侵襲的**: 機械のパネルライトに直接何も取り付ける必要がありません。

### 課題と対策
- **背景ノイズ**: 家庭内の騒音（テレビ、会話など）が干渉する可能性があります。対策:
  - センサーを機械のモーターやドラムの近くに配置します。
  - 周囲ノイズを無視するように `SOUND_THRESHOLD` を調整します。
  - 指向性マイクの使用やMAX9814のゲイン調整を行います。
- **静かな段階**: 一部の洗濯サイクルには一時停止（浸漬など）があります。`STOP_DELAY`により、長時間の無音後にのみ通知が送信されます。
- **水への曝露**: 洗濯機には水はねや湿気がある可能性があるため、センサーを耐水性ケースに入れます。

### オプションの拡張機能
- **周波数分析**: 背景ノイズが継続的な問題である場合、高速フーリエ変換(FFT)ライブラリ（`arduinoFFT`など）を使用して音の周波数（例：50-200 Hzのモーター音）を分析します。これにはより多くの処理能力が必要であり、最適化なしでは基本的なESP32では実行不可能な場合があります。
- **デュアルセンサー**: 信頼性を高めるために、音センサーと振動センサー（SW-420など）を組み合わせて冗長性を持たせます。両方が機械の停止を示した場合、検知の信頼度が高まります。
- **バッテリー駆動**: 携帯性のために、USBアダプターの代わりに充電式LiPoバッテリーと充電モジュール（TP4056など）を使用します。

---

### トラブルシューティング
- **音検知しない**: センサーの配線を確認し、シリアルモニターでテストし、センサーが機械の騒音源に近いことを確認します。
- **誤通知**: 背景ノイズやサイクルの一時停止を除去するために `STOP_DELAY` を増やすか、`SOUND_THRESHOLD` を調整します。
- **Wi-Fiの問題**: 2.4GHz Wi-Fiの認証情報と機械付近の信号強度を確認します。
- **Telegramメッセージが届かない**: ボットトークンとチャットIDを確認し、シリアルモニターでエラーをチェックします。

この音ベースのアプローチは、カメラベースの方法と比較して、さまざまな光条件下でよりシンプルかつ堅牢であるため、洗濯機モニターに理想的です。特定のステップ、センサーキャリブレーション、または追加機能の統合に関するヘルプが必要な場合はお知らせください！