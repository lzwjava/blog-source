---
audio: false
generated: true
lang: ja
layout: post
title: UbuntuでのSFTPサーバー構築
translated: true
type: note
---

UbuntuでSFTP（SSH File Transfer Protocol）サーバーをセットアップするのは簡単なプロセスで、SSH暗号化を使用してネットワーク経由で安全にファイルを転送できます。以下は、セットアップを支援する完全なステップバイステップガイドです。

---

### ステップ1: OpenSSHサーバーのインストール
SFTPはOpenSSHサーバーに依存しており、Ubuntuシステムにインストールする必要があります。

1. ターミナルを開き、パッケージリストを更新します：
   ```bash
   sudo apt update
   ```

2. OpenSSHサーバーをインストールします：
   ```bash
   sudo apt install openssh-server
   ```

3. SSHサービスが実行されているか確認します：
   ```bash
   sudo systemctl status ssh
   ```
   - 実行されていない場合は、起動します：
     ```bash
     sudo systemctl start ssh
     ```
   - 起動時に自動開始するように設定します：
     ```bash
     sudo systemctl enable ssh
     ```

---

### ステップ2: 専用SFTPユーザーの作成
セキュリティを向上させるために、SFTPアクセス用の特定のユーザーを作成します。

1. 新しいユーザー（例：`sftpuser`）を追加します：
   ```bash
   sudo adduser sftpuser
   ```
   - パスワードの設定や任意の詳細情報の入力のためにプロンプトに従います。

2. （オプション）このユーザーがSSH経由でシェルにアクセスできないようにします：
   ```bash
   sudo usermod -s /bin/false sftpuser
   ```

---

### ステップ3: SFTP用にSSHを設定
すべてのユーザーがホームディレクトリでSFTPを使用できるようにするか、特定のユーザーを特定のフォルダに制限できます。

#### オプション1: すべてのユーザーにSFTPを許可
すべてのユーザーがSFTP経由で自分のホームディレクトリにアクセスできるようにする場合、OpenSSHをインストールした後は追加の設定は必要ありません。ステップ5に進んでください。

#### オプション2: ユーザーを特定のディレクトリに制限
ユーザー（例：`sftpuser`）を特定のディレクトリに制限するには：

1. SSH設定ファイルを編集します：
   ```bash
   sudo nano /etc/ssh/sshd_config
   ```

2. ファイルの末尾に以下の行を追加します：
   ```ini
   Match User sftpuser
       ChrootDirectory /home/sftpuser
       ForceCommand internal-sftp
       AllowTcpForwarding no
       X11Forwarding no
   ```
   - ファイルを保存（`Ctrl+O`、次に`Enter`）して終了（`Ctrl+X`）します。

3. この設定は以下を行います：
   - `sftpuser`を`/home/sftpuser`に制限します。
   - SFTPのみの使用を強制します。
   - TCP転送などの追加機能を無効にします。

---

### ステップ4: ディレクトリ権限の設定
制限された設定（chroot）を機能させるために、権限を調整します：

1. chrootディレクトリをroot所有にします：
   ```bash
   sudo chown root:root /home/sftpuser
   ```

2. ユーザーが書き込み可能なサブディレクトリ（例：`uploads`）を作成します：
   ```bash
   sudo mkdir /home/sftpuser/uploads
   sudo chown sftpuser:sftpuser /home/sftpuser/uploads
   ```
   - ユーザーは`/home/sftpuser/uploads`にファイルをアップロードできるようになります。

---

### ステップ5: SSHサービスの再起動
変更を適用するためにSSHを再起動します：
```bash
sudo systemctl restart ssh
```

---

### ステップ6: SFTPサーバーのテスト
別のデバイスから接続してサーバーが機能することを確認します。

1. UbuntuマシンのIPアドレスを確認します：
   ```bash
   ip addr show
   ```
   - `192.168.1.100`のようなIPを探します。

2. 接続をテストします：
   - **ターミナルから（Linux/macOS）：**
     ```bash
     sftp sftpuser@<ubuntu-ip-address>
     ```
     - プロンプトが表示されたらパスワードを入力します。
   - **FileZillaを使用（任意のOS）：**
     - ホスト：`sftp://<ubuntu-ip-address>`
     - ユーザー名：`sftpuser`
     - パスワード：（設定したパスワード）
     - ポート：22

3. `uploads`フォルダにファイルをアップロードするか、ディレクトリの内容をリスト表示してみます。

---

### ステップ7: ファイアウォールの設定
Ubuntuのファイアウォール（UFW）を使用している場合、SFTPトラフィックを許可します：

1. ファイアウォールのステータスを確認します：
   ```bash
   sudo ufw status
   ```

2. SSH/SFTP（ポート22）を許可します：
   ```bash
   sudo ufw allow 22/tcp
   sudo ufw reload
   ```

---

### 完了！
SFTPサーバーの準備が整いました！ユーザーはSFTPクライアントを使用して安全に接続し、指定されたディレクトリにファイルを転送できます。`sftpuser`を制限した場合、彼らは`/home/sftpuser/uploads`（または設定した場所）のみにアクセスできます。安全なファイル転送をお楽しみください！