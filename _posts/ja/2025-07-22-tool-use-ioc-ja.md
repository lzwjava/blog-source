---
audio: false
generated: true
lang: ja
layout: post
title: AIツール活用の解説
translated: true
type: note
---

はい、あなたのAIチャットボットAPI（MistralやOpenAI、Anthropicなど）におけるツール使用と関数呼び出しの理解は正しいです。ステップバイステップで説明して理解を確認・明確化しましょう。これは確かに、意思決定の主体があなたのコードからAIモデルに移るという、制御の反転（IoC）の一種と言えます。

### 仕組み
1. **ツールの定義**:
   - 開発者であるあなたは、初期APIリクエストでカスタム「ツール」（実質的に関数定義）のリストを提供します。各ツールには、関数名、パラメータ（型と説明付き）、機能の詳細が含まれます。これは多くの場合、スキーマ（例: OpenAIのツールスキーマに基づくもの。Mistralもこれをサポート）を通じて、JSON形式で行われます。
   - 例: `location`パラメータを受け取り、現在の天気データを返す`get_weather`というツールを定義する。

2. **モデルの判断（制御の反転）**:
   - AIモデルはあなたのプロンプト/クエリを処理し、正確に応答するためにあなたが提供したツールの助けが必要かどうかを判断します。これがIoCの部分です：あなたのコードが直接関数を直線的に呼び出す代わりに、モデルが必要と判断した時にツール呼び出しを要求することで「制御を反転」させます。モデルがワークフローを調整しているようなものです。
   - ツールが不要な場合、モデルは直接応答を生成します。

3. **APIからのツール呼び出し応答**:
   - ツールが必要と判断された場合、APIは即座に最終回答を返しません。代わりに「ツール呼び出し」オブジェクトを含む応答を返します。これには以下が含まれます：
     - ツール/関数名
     - 引数（例: `{"location": "New York"}`のような値を持つJSON）
   - この時点で会話は一時停止され、モデルはあなたのアクションを待っています。

4. **ツールの実行（あなた側）**:
   - あなたのコードはこのツール呼び出し応答を受け取り、それを解析し、提供された引数で対応する関数/ツールを実行します。
   - あなたは実際のロジック（例: 天気APIの呼び出し、データベースへの問い合わせ、何らかの計算の実行）を処理します。
   - 重要な点は、モデル自身がツールを実行するわけではないことです。モデルは何を呼び出すべきかを指定するだけです。これにより、セキュリティと柔軟性が保たれます。

5. **結果の返送**:
   - ツールを実行した後、その結果（例: 「ツール応答」メッセージとして）を会話履歴に追加し、更新された履歴をモデルに渡すために再度APIリクエストを行います。
   - この結果は、モデルがそれを組み込めるように、システムメッセージやツール出力として構成されます。

6. **APIからの最終応答**:
   - モデルはツールの結果を受け取り、元のクエリと履歴と共に処理し、完全な最終応答を生成します。
   - 必要に応じて、（例: 複数ステップのタスクの場合）追加のツール呼び出しをループで要求するかもしれませんが、最終的にはそれ以上の呼び出しなしで回答を出力します。

### これが制御の反転である理由
- 従来のプログラミングでは、あなたのコードがフローを制御します：「もし条件Xなら、関数Yを呼び出す」
- ここでは、AIモデルが制御を握ります：モデルはクエリを分析し、「私はこれらの引数でYを呼び出す必要がある―結果を教えてくれ、そうすれば次に進む」と判断します。あなたのコードは反応的になり、要求された呼び出しを処理します。これにより、システムはより動的になり、モデルが複雑な推論ベースのワークフローを扱えるようになります。

### エッジケースとヒント
- **並列ツール呼び出し**: 一部のAPI（Mistralなど）は、クエリがそれを必要とする場合、1回の応答で複数のツールを呼び出すことをサポートしています。
- **エラーハンドリング**: ツール実行が失敗した場合、エラーメッセージを送り返すことができ、モデルは再試行したり調整したりする可能性があります。
- **チャット履歴**: コンテキストを維持するために、リクエスト間で完全な会話スレッドを常に維持してください。
- **互換性**: MistralのAPIはOpenAIのツールエンドポイントと同様の構造に従っているため、一方のコード例は少し手を加えるだけで他方でも動作することが多いです。

このパターンは、AIと実世界のアクション（例: 飛行機の予約、データの取得）を統合するエージェントやアプリを構築するのに強力です。これを実装する場合は、正確なスキーマの詳細についてMistralのドキュメントを確認してください。

[Mistral AI Documentation - Tools](https://docs.mistral.ai/capabilities/tool-calling/)