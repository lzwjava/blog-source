---
audio: false
generated: true
image: false
lang: ja
layout: post
model: x-ai/grok-4-fast
title: 効率的な範囲クエリデータ構造
translated: true
type: note
---

### セグメント木とフェニック木：概要

セグメント木とフェニック木（別名：Binary Indexed Tree）は、両方とも競技プログラミングやアルゴリズムにおいて、配列に対する範囲クエリや更新を効率的に処理するためのデータ構造です。これらは、範囲に対する合計クエリや一点更新のような操作を対数時間で可能にし、大規模なデータセットに対する単純な O(n) の手法よりもはるかに高速です。

#### セグメント木
**セグメント木**は、配列をセグメント（区間）に分割して表現する、二分木ベースの構造です。木の各ノードは配列の特定の範囲に対応します：
- 葉ノードは個々の要素を表します。
- 親ノードはその子ノードの範囲の結合（例えば、部分範囲の合計、最小値、最大値）を表します。
- 木は再帰的に構築され、通常、サイズ n の配列に対して高さは O(log n) です。

**主な操作:**
- **構築:** 木を構築するのに O(n) 時間。
- **更新:** 単一の要素を変更し、変更を木の上方向に伝播させる。O(log n)。
- **クエリ:** 関連するノードを走査して範囲に対する集計値（例：合計）を計算する。O(log n)。

**使用例:** 範囲合計/最小値/最大値クエリ、頻度カウント、あるいは任意の結合的な操作。より柔軟ですが、O(4n) の空間を使用します。

**簡単な例（範囲合計）:**
配列 [1, 3, 5, 7] を考えます。セグメント木は次のようになるかもしれません：
- 根: [1-7] の合計 = 16
- 左の子: [1-3] の合計 = 4
- 右の子: [5-7] の合計 = 12
- 以下同様に、葉まで続きます。

#### フェニック木
**フェニック木**（Peter Fenwick によって 1994 年に導入）は、プレフィックス和および同様の操作のための、よりコンパクトな配列ベースの構造です。ビット演算を効率的に利用して要素をインデックスし、累積和を巧妙な方法で追跡します：
- 各インデックスは、そのインデックスで終わる範囲の合計を格納します。
- 更新とクエリは、下位ビット操作（例：`index & -index` で最下位ビットを見つける）を使用します。

**主な操作:**
- **構築:** O(n log n)、または最適化して O(n)。
- **更新:** インデックス位置に値を加算/減算する。O(log n)。
- **クエリ:** インデックスまでのプレフィックス和を取得する。O(log n)。範囲和はプレフィックスの差分を介して計算。

**使用例:** セグメント木と同様ですが、1次元のプレフィックス和、順序統計量、または転倒数に最適化されています。O(n) の空間を使用するため、より軽量です。

**簡単な例（範囲合計）:**
配列 [1, 3, 5, 7] に対して、フェニック木の配列は [1, 4, 5, 16]（累積的な調整）のようになるかもしれません。範囲[1-3]の合計をクエリするには：prefix(3) - prefix(0) = 9。

#### 比較

| 観点          | セグメント木                  | フェニック木                  |
|---------------|-------------------------------|-------------------------------|
| **空間計算量** | O(4n)                         | O(n)                          |
| **構築時間**  | O(n)                          | O(n log n)                    |
| **柔軟性**    | 任意の範囲集計をサポート      | プレフィックス和/更新に最適   |
| **複雑さ**    | コードがやや多い              | 実装がより簡単                |

両者ともアルゴリズム（例：LeetCode や Codeforces）における定番です。実装する場合は、シンプルさからフェニック木から始めるのが良いでしょう！

より深く学ぶには：  
[Segment Tree Tutorial - GeeksforGeeks](https://www.geeksforgeeks.org/segment-tree-data-structure/)  
[Fenwick Tree Explained - CP-Algorithms](https://cp-algorithms.com/data_structures/fenwick.html)