---
audio: false
generated: true
lang: ja
layout: post
title: 浅いクローンでのGitプルとプッシュの使用
translated: true
type: note
---

はい、`--depth=20`を使用して限定された履歴でリポジトリをクローンした後も、`git pull`や`git push`を使用できます。ただし、いくつかの重要な考慮点があります：

### 1. **`--depth=20`の機能**
   - `--depth=20`オプションは*shallow clone*を作成し、デフォルトブランチ（または`--branch`を使用して指定したブランチ）から最新の20コミット（または指定した数）のみを取得します。
   - これによりダウンロードする履歴量が減り、クローンがより速く、サイズも小さくなりますが、リポジトリには完全なコミット履歴は含まれません。

### 2. **Shallow Cloneでの`git pull`の使用**
   - **はい、`git pull`を使用できます** - shallow cloneでリモートリポジトリから新しいコミットを取得してマージするために使用できます。
   - デフォルトでは、`git pull`は新しいコミットを取得し、shallow履歴を更新して、リモートブランチと一貫性を保ちます。
   - リモートブランチに新しいコミットが追加されると、`git pull`はそれらを取得し、ローカルリポジトリの履歴を拡張します（shallowの性質は維持されます）。

   **注意**：ブランチの履歴がshallow履歴よりも古いコミットに影響するように変更された場合（例：リモートでのforce pushやrebase）、問題が発生する可能性があります。そのような場合、競合を解決したり作業を続行したりするには、履歴を深化させる必要があります（`git fetch --deepen=<n>`や`git fetch --unshallow`を使用して完全な履歴を取得）。

### 3. **Shallow Cloneでの`git push`の使用**
   - **はい、`git push`を使用できます** - ローカルのコミットをリモートリポジトリにプッシュするために使用できます。
   - shallow cloneは、リモートが変更を受け入れる限り、新しいコミットを作成してリモートリポジトリにプッシュする能力を制限しません。
   - ただし、リモートリポジトリが完全な履歴に依存する操作（例：古いコミットを含むマージやリベース）を必要とする場合、プッシュを正常に完了するにはより多くの履歴を取得する必要があるかもしれません。

### 4. **Shallow Cloneの制限**
   - **限定された履歴**: `git log`、`git blame`、`git rebase`などの一部のGit操作は、古いコミットがローカルで利用できないため制限される可能性があります。
   - **マージとリベース**: shallow履歴の外側のコミットとマージまたはリベースする必要がある場合、`git fetch --deepen=<n>`や`git fetch --unshallow`を使用してより多くの履歴を取得する必要があるかもしれません。
   - **Force Push**: リモートブランチが書き換えられた場合（例：`git push --force`）、あなたのshallow cloneは変更を処理するのに十分なコンテキストを持っていない可能性があり、履歴を深化させるか再クローンが必要になります。

### 5. **Shallow Cloneを深化させる方法（必要な場合）**
   `git pull`や`git push`で限定された履歴が原因で問題が発生した場合、追加の履歴を取得できます：
   - **特定の数のコミットで深化**:
     ```bash
     git fetch --deepen=20
     ```
     これにより、さらに20コミット分の履歴が取得されます。
   - **完全な履歴を取得**:
     ```bash
     git fetch --unshallow
     ```
     これにより、shallow cloneが完全な履歴を持つフルクローンに変換されます。

### 6. **実用的なアドバイス**
   - `--depth=20`でのshallow cloneは、特に最近の変更のみを扱う場合や小さな更新を貢献する場合、ほとんどのワークフローで通常十分です。
   - 完全な履歴が必要になることが予想される場合（例：複雑なマージ、リベース、デバッグ）、`--depth`オプションなしで完全なリポジトリをクローンするか、後で必要に応じて履歴を深化させることを検討してください。
   - プッシュを試みる前に、リモートリポジトリ（例：`git@github.com:cisco/ChezScheme.git`）への書き込みアクセス権があることを常に確認してください。

### ワークフローの例
```bash
# 限定された履歴でクローン
git clone git@github.com:cisco/ChezScheme.git --depth=20
cd ChezScheme

# 変更を加えてコミット
git commit -m "私の変更"

# 最新の変更をプル
git pull origin main

# 変更をプッシュ
git push origin main
```

shallow cloneが原因で問題が発生した場合は、上記のように履歴を深化させてください。

### まとめ
はい、`--depth=20`で作成されたshallow cloneで`git pull`と`git push`を使用できます。ただし、shallow履歴が不十分な場合、特定の操作では追加の履歴を取得する必要があるかもしれません。制限に対処するには`git fetch --deepen`または`git fetch --unshallow`を使用してください。