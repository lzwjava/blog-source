---
audio: false
generated: true
lang: ja
layout: post
title: VisualVM完全ガイド：Javaプロファイリングとモニタリング
translated: true
type: note
---

# VisualVM 総合ガイド

VisualVM は強力なオープンソースの Java プロファイリングおよびモニタリングツールで、Java アプリケーションのパフォーマンス分析のためのグラフィカルインターフェースを提供します。Java Development Kit (JDK) に含まれており、パフォーマンス問題、メモリリーク、スレッド関連の問題の診断に特に有用です。このガイドでは、開発者とシステム管理者向けに、VisualVM の機能、セットアップ、使用方法、ベストプラクティスをカバーします。

## 目次
1. [VisualVM とは？](#visualvm-とは)
2. [VisualVM の主な機能](#visualvm-の主な機能)
3. [システム要件](#システム要件)
4. [VisualVM のインストール](#visualvm-のインストール)
5. [VisualVM の起動](#visualvm-の起動)
6. [Java アプリケーションへの接続](#java-アプリケーションへの接続)
7. [VisualVM を使用したモニタリングとプロファイリング](#visualvm-を使用したモニタリングとプロファイリング)
   - [概要タブ](#概要タブ)
   - [モニタータブ](#モニタータブ)
   - [スレッドタブ](#スレッドタブ)
   - [サンプラー](#サンプラー)
   - [プロファイラー](#プロファイラー)
   - [ヒープダンプ分析](#ヒープダンプ分析)
   - [スレッドダンプ分析](#スレッドダンプ分析)
   - [MBeans](#mbeans)
8. [リモートモニタリング](#リモートモニタリング)
9. [プラグインによる VisualVM の拡張](#プラグインによる-visualvm-の拡張)
10. [ベストプラクティス](#ベストプラクティス)
11. [一般的な問題のトラブルシューティング](#一般的な問題のトラブルシューティング)
12. [追加リソース](#追加リソース)

## VisualVM とは？

VisualVM は、複数の JDK ユーティリティ（`jstack`、`jmap`、`jconsole` など）を単一のユーザーフレンドリーなインターフェースに統合した Java ベースのツールです。開発者は Java アプリケーションをリアルタイムで監視し、CPU とメモリの使用状況をプロファイリングし、ヒープダンプを分析し、スレッドを管理することができます。VisualVM は、ローカルおよびリモートの Java アプリケーションにおけるパフォーマンスボトルネック、メモリリーク、スレッド問題の特定に特に価値があります。

元々 Sun Microsystems によって開発された VisualVM は、現在 Oracle JDK の一部であり、オープンソースプロジェクトとして積極的にメンテナンスされています。JDK 6 以降で実行される Java アプリケーションをサポートします。

## VisualVM の主な機能

- **リアルタイムモニタリング**: CPU 使用率、メモリ消費量、スレッドアクティビティ、ガベージコレクションを追跡します。
- **プロファイリング**: パフォーマンスボトルネックとメモリ割り当てパターンを特定するための CPU およびメモリプロファイリングを提供します。
- **ヒープダンプ分析**: メモリリークを診断するためにメモリ内容を検査できます。
- **スレッドダンプ分析**: スレッド状態の分析とデッドロックの検出を支援します。
- **MBean 管理**: アプリケーションの監視と管理のための Java Management Extensions (JMX) へのアクセスを提供します。
- **リモートモニタリング**: リモートマシンで実行されている Java アプリケーションの監視をサポートします。
- **拡張性**: 特定のフレームワークとの統合や追加のプロファイリングツールなど、機能を拡張するプラグインをサポートします。
- **軽量で使いやすい**: 最小限のセットアップで直感的なグラフィカルインターフェースを提供します。

## システム要件

VisualVM を使用するには、以下を確認してください：
- **オペレーティングシステム**: Windows、macOS、Linux、または JVM をサポートする OS。
- **Java バージョン**: JDK 6 以降（VisualVM は JDK 8 以降にバンドルされています）。
- **メモリ**: 軽量なモニタリングには少なくとも 512 MB の空き RAM。ヒープダンプ分析には 1 GB 以上。
- **ディスク容量**: VisualVM のインストールに約 50 MB。
- **権限**: 特定の機能（システムプロセスへのアクセスなど）には管理者権限が必要な場合があります。

## VisualVM のインストール

VisualVM は Oracle JDK 8 以降に含まれており、JDK インストールの `bin` ディレクトリ（`jvisualvm` 実行ファイル）にあります。あるいは、スタンドアロンアプリケーションとしてダウンロードすることもできます：

1. **JDK から**:
   - JDK 8 以降がインストールされている場合、VisualVM は `JAVA_HOME/bin` ディレクトリに `jvisualvm` として既に利用可能です。
   - `jvisualvm` 実行ファイルを実行してツールを起動します。

2. **スタンドアロン ダウンロード**:
   - [VisualVM ウェブサイト](https://visualvm.github.io/) にアクセスして最新のスタンドアロンバージョンをダウンロードします。
   - ZIP ファイルを任意のディレクトリに解凍します。
   - `visualvm` 実行ファイル（Windows では `visualvm.exe` など）を実行します。

3. **インストールの確認**:
   - `JRE_HOME` または `JAVA_HOME` 環境変数が互換性のある JDK/JRE を指していることを確認します。
   - VisualVM を起動してテストします。

## VisualVM の起動

VisualVM を起動するには：
- **Windows の場合**: JDK の `bin` フォルダまたはスタンドアロンインストールディレクトリにある `jvisualvm.exe` をダブルクリックします。
- **macOS/Linux の場合**: ターミナルで `bin` ディレクトリから `./jvisualvm` を実行します。
- VisualVM インターフェースが開き、左パネルにローカルの Java アプリケーションのリストが表示されます。

## Java アプリケーションへの接続

VisualVM はローカルおよびリモートの Java アプリケーションを監視できます。

### ローカルアプリケーション
- 起動時に、VisualVM はローカルマシンで実行されている Java アプリケーションを自動的に検出します。
- 左パネルのアプリケーションをダブルクリックして、そのモニタリングダッシュボードを開きます。
- アプリケーションがリストに表示されない場合は、互換性のある JVM で実行されていることを確認してください。

### リモートアプリケーション
リモート Java アプリケーションを監視するには：
1. JVM 引数を追加してリモートアプリケーションで JMX を有効にします（例: `-Dcom.sun.management.jmxremote`）。
2. VisualVM で、**ファイル > JMX 接続の追加** に移動します。
3. リモートホストの IP アドレスとポートを入力します（例: `hostname:port`）。
4. 認証が有効な場合は資格情報を提供します。
5. 接続してアプリケーションを監視します。

**注意**: 安全な接続の場合は、必要に応じて SSL と認証を設定してください（[リモートモニタリング](#リモートモニタリング) を参照）。

## VisualVM を使用したモニタリングとプロファイリング

VisualVM は、Java アプリケーションを分析するためのいくつかのタブとツールを提供します。以下は各機能の詳細な内訳です。

### 概要タブ
- アプリケーションに関する一般的な情報を表示します：
  - JVM 引数
  - システムプロパティ
  - アプリケーションクラスパス
  - PID（プロセス ID）
- アプリケーションの設定を確認するのに便利です。

### モニタータブ
- 以下のリアルタイムグラフを提供します：
  - **CPU 使用率**: アプリケーションとシステムの CPU 使用率を追跡します。
  - **ヒープメモリ**: ヒープ使用量（Eden、Old Gen、PermGen/Metaspace）とガベージコレクションアクティビティを監視します。
  - **クラス**: ロードされたクラスの数を表示します。
  - **スレッド**: ライブスレッドとデーモンスレッドの数を表示します。
- ガベージコレクションやヒープダンプを手動でトリガーできます。

### スレッドタブ
- 時間の経過に伴うスレッド状態（実行中、スリープ中、待機中など）を視覚化します。
- すべてのスレッドの現在の状態をキャプチャするスレッドダンプ機能を提供します。
- デッドロック、ブロックされたスレッド、過剰なスレッド使用の特定に役立ちます。

### サンプラー
- パフォーマンス分析のための軽量な CPU およびメモリサンプリングを提供します。
- **CPU サンプリング**:
  - メソッドレベルの実行時間をキャプチャします。
  - 最も CPU 時間を消費するホットメソッドを特定します。
- **メモリサンプリング**:
  - オブジェクトの割り当てとメモリ使用量を追跡します。
  - 過剰なメモリを消費するオブジェクトの特定に役立ちます。
- サンプリングはプロファイリングよりもオーバーヘッドが低いですが、詳細なデータは少なくなります。

### プロファイラー
- 詳細な CPU およびメモリプロファイリングを提供します。
- **CPU プロファイリング**:
  - メソッドの実行時間を測定します。
  - メソッドレベルでのパフォーマンスボトルネックを特定します。
- **メモリプロファイリング**:
  - オブジェクトの割り当てと参照を追跡します。
  - 予期せず永続するオブジェクトを特定することでメモリリークの検出を支援します。
- **注意**: プロファイリングはサンプリングよりもオーバーヘッドが高く、アプリケーションを遅くする可能性があります。

### ヒープダンプ分析
- ヒープダンプは、アプリケーションのメモリのスナップショットです。
- ヒープダンプを生成するには：
  1. **モニター** タブに移動します。
  2. **ヒープダンプ** をクリックします。
  3. ダンプを `.hprof` ファイルとして保存するか、VisualVM で直接分析します。
- 機能：
  - クラスインスタンス、サイズ、参照を表示します。
  - メモリ使用量の高いオブジェクトを特定します。
  - オブジェクト保持パスを分析してメモリリークを検出します。
- 高度なヒープクエリには **OQL (Object Query Language)** コンソールを使用します。

### スレッドダンプ分析
- 特定の時点でのすべてのスレッドの状態をキャプチャします。
- スレッドダンプを生成するには：
  1. **スレッド** タブに移動します。
  2. **スレッドダンプ** をクリックします。
  3. VisualVM でダンプを分析するか、外部ツール用にエクスポートします。
- 以下の診断に役立ちます：
  - デッドロック
  - ブロックされたスレッド
  - スレッド競合問題

### MBeans
- アプリケーションの管理と監視のための JMX MBeans にアクセスします。
- 機能：
  - MBean 属性の表示と変更。
  - MBean 操作の呼び出し。
  - MBean 通知の監視。
- カスタム JMX インストルメンテーションを持つアプリケーションに便利です。

## リモートモニタリング

リモート Java アプリケーションを監視するには：
1. **リモート JVM の設定**:
   - リモートアプリケーションに以下の JVM 引数を追加します：
     ```bash
     -Dcom.sun.management.jmxremote
     -Dcom.sun.management.jmxremote.port=<ポート>
     -Dcom.sun.management.jmxremote.ssl=false
     -Dcom.sun.management.jmxremote.authenticate=false
     ```
   - 安全な接続の場合は、SSL と認証を有効にします：
     ```bash
     -Dcom.sun.management.jmxremote.ssl=true
     -Dcom.sun.management.jmxremote.authenticate=true
     -Dcom.sun.management.jmxremote.password.file=<パスワードファイル>
     ```
2. **VisualVM の設定**:
   - リモートホストの IP とポートを使用して、VisualVM に JMX 接続を追加します。
   - 必要に応じて資格情報を提供します。
3. **ファイアウォール設定**:
   - リモートホストで JMX ポートが開いていることを確認します。
   - 必要に応じて安全なリモートアクセスのために SSH トンネリングを使用します：
     ```bash
     ssh -L <ローカルポート>:<リモートホスト>:<リモートポート> ユーザー@リモートホスト
     ```

## プラグインによる VisualVM の拡張

VisualVM は機能を強化するプラグインをサポートします：
1. **プラグインのインストール**:
   - **ツール > プラグイン** に移動します。
   - 利用可能なプラグイン（Visual GC、BTrace、JConsole プラグインなど）についてプラグインセンターを閲覧します。
   - インストールして VisualVM を再起動します。
2. **人気のプラグイン**:
   - **Visual GC**: ガベージコレクションアクティビティを視覚化します。
   - **BTrace**: Java アプリケーションの動的トレースを提供します。
   - **JConsole プラグイン**: JConsole 互換機能を追加します。
3. **カスタムプラグイン**:
   - VisualVM ウェブサイトまたはサードパーティソースからプラグインをダウンロードします。
   - プラグインファイルを `plugins` ディレクトリに配置し、VisualVM を再起動します。

## ベストプラクティス

- **サンプリングから開始**: パフォーマンスへの影響を最小限にするために、プロファイリングの前にサンプリングを使用します。
- **プロファイリング範囲の制限**: オーバーヘッドを減らすために、特定のパッケージやクラスをプロファイリングします。
- **定期的なヒープダンプ**: 長時間実行されるアプリケーションのメモリ傾向を追跡するために、定期的なヒープダンプをスケジュールします。
- **ガベージコレクションの監視**: Visual GC プラグインを使用して GC パフォーマンスを分析します。
- **安全なリモート接続**: リモートモニタリングには常に SSL と認証を使用します。
- **スナップショットの保存**: 後での分析や共同作業のためにヒープダンプとスレッドダンプを保存します。
- **高度な分析に OQL を使用**: 効率的なヒープダンプクエリのために OQL を学びます。
- **リソース使用量の監視**: 大きなヒープダンプに対して VisualVM が十分なメモリを持っていることを確認します。

## 一般的な問題のトラブルシューティング

- **アプリケーションが検出されない**:
  - アプリケーションが互換性のある JVM で実行されていることを確認します。
  - JVM が JMX 接続を許可するように設定されているか確認します。
- **プロファイリング中の高いオーバーヘッド**:
  - オーバーヘッドを低くするためにサンプリングに切り替えます。
  - 特定のクラスやメソッドをプロファイリングします。
- **リモートモニタリングの接続問題**:
  - JMX ポートとファイアウォール設定を確認します。
  - `telnet <ホスト> <ポート>` を使用して接続をテストします。
- **VisualVM での OutOfMemoryError**:
  - `visualvm.conf` ファイルを編集して VisualVM のヒープサイズを増やします：
    ```bash
    -J-Xmx<メモリサイズ>m
    ```
- **ヒープダンプ分析が遅い**:
  - より多くの RAM を搭載したマシンを使用します。
  - 分析範囲を減らすためにクラスをフィルタリングします。

## 追加リソース

- **公式ウェブサイト**: [visualvm.github.io](https://visualvm.github.io/)
- **ドキュメント**: [VisualVM ドキュメント](https://visualvm.github.io/documentation.html)
- **チュートリアル**:
  - Oracle の [VisualVM ガイド](https://www.oracle.com/java/technologies/visualvm.html)
  - [VisualVM を使用した Java パフォーマンスチューニング](https://www.baeldung.com/java-visualvm)
- **コミュニティ**:
  - [VisualVM GitHub Issues](https://github.com/visualvm/visualvm.github.io/issues)
  - [Stack Overflow VisualVM タグ](https://stackoverflow.com/questions/tagged/visualvm)