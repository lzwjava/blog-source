---
audio: false
generated: true
lang: ja
layout: post
title: コサイン類似度
translated: true
type: note
---

コサイン類似度は、高次元空間における2つのベクトルの類似性を測定するために機械学習で広く使用される指標です。自然言語処理（NLP）、情報検索、レコメンデーションシステムなどの分野で特に人気があり、ベクトルの大きさではなく向き（または角度）を捉える能力に優れています。この特性により、テキスト文書、ユーザー選好、埋め込みなどの比較において、ベクトルの長さよりも方向が重要な場合に堅牢な性能を発揮します。

### コサイン類似度とは？

コサイン類似度は、2つのベクトル間の角度の余弦を計算することで、それらの類似性を数値化します。数学的には次のように定義されます：

\\[
\text{コサイン類似度} = \cos(\theta) = \frac{A \cdot B}{\|A\| \|B\|}
\\]

ここで：
- \\( A \\) と \\( B \\) は2つのベクトル（例：文書、埋め込み、特徴セットを表す）。
- \\( A \cdot B \\) はベクトルの内積で、\\( \sum_{i=1}^n A_i B_i \\) として計算される。
- \\( \|A\| \\) と \\( \|B\| \\) は、それぞれベクトル \\( A \\) と \\( B \\) のユークリッドノルム（大きさ）で、\\( \sqrt{\sum_{i=1}^n A_i^2} \\) および \\( \sqrt{\sum_{i=1}^n B_i^2} \\) として計算される。
- \\( \theta \\) はベクトル間の角度。

結果の範囲は：
- **1**：ベクトルが同じ方向を向いている（角度 = 0°）。
- **0**：ベクトルが直交している（角度 = 90°）、類似性がないことを示す。
- **-1**：ベクトルが反対方向を向いている（角度 = 180°）、最大の非類似性を示す。

### 主な特性

1. **範囲**：コサイン類似度の値は-1から1の間に収まり、解釈が容易。
2. **大きさに依存しない**：ベクトルが大きさで正規化されるため、コサイン類似度は長さではなく方向に焦点を当てる。これは、異なる長さの文書や様々なスケールの埋め込みを比較する際に有用。
3. **非負の特徴**：多くのアプリケーション（例：単語頻度を持つテキストデータ）では、ベクトルの成分が非負であるため、類似度は通常0から1の範囲になる。
4. **計算効率**：内積とノルムの計算は単純明快であり、高次元データに対するコサイン類似度の計算は効率的。

### 機械学習での活用方法

コサイン類似度はその汎用性から、様々な機械学習タスクで応用されている：

1. **テキスト分析とNLP**：
   - **文書類似性**：クラスタリングや検索エンジンなどのタスクでは、文書はベクトル（例：TF-IDFやWord2Vec、GloVe、BERTなどの単語埋め込み）として表現される。コサイン類似度は、内容に基づいて2つの文書がどれだけ類似しているかを測定する。
   - **感情分析**：テキストスニペットの感情ベクトルを比較する。
   - **盗用検出**：テキストのベクトル表現を比較することで、テキスト間の類似性を特定する。

2. **レコメンデーションシステム**：
   - コサイン類似度は、ユーザーまたはアイテムのプロファイル（例：協調フィルタリングにおける）を比較するために使用される。例えば、評価や行動に基づいて2人のユーザーの選好がどれだけ類似しているかを測定できる。
   - アイテム（例：映画、商品）が特徴ベクトルとして表現されるコンテンツベースフィルタリングにおいて効果的。

3. **画像および音声処理**：
   - コンピュータビジョンでは、画像から抽出された特徴ベクトル（例：CNNから）を比較し、視覚的類似性を測定するためにコサイン類似度が使用される。
   - 音声処理では、スペクトログラムや音声クリップの埋め込みを比較するために使用される。

4. **クラスタリングと分類**：
   - クラスタリングアルゴリズム（例：テキストデータを用いたK-means）では、コサイン類似度が距離指標として機能し、類似したアイテムをグループ化する。
   - 分類タスクでは、入力ベクトルとクラスプロトタイプを比較するために使用される。

5. **異常検知**：
   - コサイン類似度は、データポイントと重心または期待されるパターンを比較することで、外れ値を特定できる。類似度が低い場合は異常の可能性を示唆する。

### 例：テキスト分析におけるコサイン類似度

2つの文書がTF-IDFベクトルとして表現されていると仮定する：
- 文書1： \\( A = [2, 1, 0, 3] \\) （例：4つの用語に対する単語頻度）。
- 文書2： \\( B = [1, 1, 1, 0] \\).

**ステップ1：内積の計算**：
\\[
A \cdot B = (2 \cdot 1) + (1 \cdot 1) + (0 \cdot 1) + (3 \cdot 0) = 2 + 1 + 0 + 0 = 3
\\]

**ステップ2：ノルムの計算**：
\\[
\|A\| = \sqrt{2^2 + 1^2 + 0^2 + 3^2} = \sqrt{4 + 1 + 0 + 9} = \sqrt{14} \approx 3.742
\\]
\\[
\|B\| = \sqrt{1^2 + 1^2 + 1^2 + 0^2} = \sqrt{1 + 1 + 1 + 0} = \sqrt{3} \approx 1.732
\\]

**ステップ3：コサイン類似度の計算**：
\\[
\cos(\theta) = \frac{A \cdot B}{\|A\| \|B\|} = \frac{3}{3.742 \cdot 1.732} \approx \frac{3}{6.483} \approx 0.462
\\]

コサイン類似度は約0.462であり、文書間に中程度の類似性があることを示している。

### コサイン類似度の利点

- **スケール不変性**：ベクトルの大きさの影響を受けないため、文書の長さが異なるテキストデータに理想的。
- **高次元データの扱い**：スパースで高次元の空間（例：数千の特徴を持つテキストデータ）において効果的。
- **直感的な解釈**：余弦の値が角度に直接関連し、類似性の明確な測定値を提供する。

### 限界

- **大きさを無視**：場合によっては、大きさの差が重要となる（例：絶対量を比較する場合）。
- **線形関係を仮定**：コサイン類似度は、類似性が角度距離によって最もよく捉えられると仮定しているが、常に成り立つとは限らない。
- **スパースデータへの感度**：非常にスパースなベクトルでは、多くの次元が内積にほとんど寄与しないため、コサイン類似度の識別力が低下する可能性がある。

### コサイン類似度 vs 他の指標

- **ユークリッド距離**：直線距離を測定し、大きさに敏感。絶対的な差よりも方向が重要な場合、コサインが好まれる。
- **ジャカード類似度**：集合（例：バイナリデータ）に使用され、ベクトルの向きではなく共有要素に焦点を当てる。
- **ピアソン相関**：線形相関を測定し、平均中心化データを考慮する。一方、コサイン類似度は生のベクトルに対して機能する。

### 実用的な実装

コサイン類似度は多くの機械学習ライブラリで実装されている：
- **Python**：`scikit-learn` は `sklearn.metrics.pairwise` に `cosine_similarity` を提供。
  ```python
  from sklearn.metrics.pairwise import cosine_similarity
  import numpy as np

  A = np.array([[2, 1, 0, 3]])
  B = np.array([[1, 1, 1, 0]])
  similarity = cosine_similarity(A, B)
  print(similarity)  # 出力: [[0.46225063]]
  ```
- **TensorFlow/PyTorch**：深層学習モデルにおける埋め込みの比較に使用。
- **Spark**：大規模分散類似性計算のために使用。

### 高度な応用

1. **単語埋め込み**：コサイン類似度は、単語や文の埋め込み（例：BERT、Sentence-BERT）を比較し、意味的類似性を測定するための標準となっている。
2. **グラフベースモデル**：グラフニューラルネットワークにおけるノード類似性に使用される。
3. **パーソナライズド検索**：Elasticsearchなどの検索エンジンは、クエリに対する関連性で文書をランク付けするためにコサイン類似度を使用する。

### 結論

コサイン類似度は、機械学習における類似性測定において強力で直感的、かつ計算効率の高い指標である。ベクトルの向きに焦点を当てる特性により、テキスト、埋め込み、レコメンデーションシステムなどに理想的だが、大きさが重要なタスクにはあまり適していない。その強みと限界を理解することで、実践者はNLPからコンピュータビジョンまで多様なアプリケーションに効果的に適用できる。特定のユースケースや実装についてさらに深く掘り下げたい場合は、お知らせください！