---
audio: false
generated: true
lang: ja
layout: post
title: IntelliJ IDEAにおける信頼できない証明書の処理
translated: true
type: note
---

IntelliJ IDEAの「信頼されていないサーバー証明書」ダイアログは、自己署名証明書やカスタムの企業証明書など、IDEのキーストアによって信頼されていないSSL証明書に遭遇した際に頻繁に表示されます。企業のキーストアを`/lib/cacerts`にインポート済みでもこのプロンプトが表示される場合、IntelliJがそのキーストアを使用していないか、追加の証明書がダイアログ表示の原因となっている可能性があります。以下はその対処法とプロンプトを停止させる方法です。

### オプション1: IntelliJに非信頼証明書を自動承認させる設定
このオプションを有効にすると、IntelliJは信頼されていない証明書に対するダイアログをスキップしますが、すべての証明書を承認するためセキュリティが低下し、中間者攻撃のリスクが生じる可能性があるため注意が必要です。

- **Windows/Linux**:
  1. `ファイル > 設定 > ツール > サーバー証明書`に移動します。
  2. **「信頼されていない証明書を自動的に承認」**のチェックボックスをオンにします。
  3. **適用**および**OK**をクリックします。
- **macOS**:
  1. `IntelliJ IDEA > 環境設定 > ツール > サーバー証明書`に移動します。
  2. **「信頼されていない証明書を自動的に承認」**をチェックします。
  3. **適用**および**OK**をクリックします。

**注意**: 信頼された隔離ネットワーク（例: エアギャップされた企業環境）でない限り、この設定は推奨されません。未検証の接続に対して脆弱性をもたらす可能性があります。

### オプション2: キーストア設定の確認と修正
企業のキーストアを`/lib/cacerts`にインポート済みの場合、IntelliJが正しく使用しているか確認してください。IntelliJが独自のトラストストアまたは誤ったcacertsファイルを参照している可能性があります。

1. **キーストアのパス確認**:
   - IntelliJは多くの場合、`~/.IntelliJIdea<バージョン>/system/tasks/cacerts`にある独自のトラストストア、または`<IntelliJ インストール先>/jbr/lib/security/cacerts`にあるJetBrains Runtime (JBR)のトラストストアを使用します。
   - IntelliJディレクトリ内の`/lib/cacerts`を変更した場合、使用しているIDEバージョンに対して正しいパスであることを確認してください。JetBrains Toolbox経由のインストールの場合、パスが異なる可能性があります（例: Windowsでは`~/AppData/Local/JetBrains/Toolbox/apps/IDEA-U/ch-0/<バージョン>/jbr/lib/security/cacerts`）。
   - `keytool`コマンドを使用して証明書がcacertsファイル内にあることを確認します:
     ```bash
     keytool -list -keystore <cacertsへのパス> -storepass changeit
     ```
     企業のCA証明書がリストに含まれていることを確認してください。

2. **IntelliJにカスタムキーストアを指定**:
   - 証明書が正しくインポートされているにも関わらずIntelliJがプロンプトを表示する場合、変更されたcacertsが使用されていない可能性があります。カスタムVMオプションを追加してトラストストアを指定します:
     1. `ヘルプ > カスタムVMオプションを編集`に移動します。
     2. 以下を追加します:
        ```
        -Djavax.net.ssl.trustStore=<cacertsへのパス>
        -Djavax.net.ssl.trustStorePassword=changeit
        ```
        `<cacertsへのパス>`は変更した`cacerts`ファイルへのフルパスに置き換えてください。
     3. IntelliJ IDEAを再起動します。

3. **証明書の再インポート**:
   - 証明書のインポートが不完全または不正だった場合、再インポートします:
     ```bash
     keytool -import -trustcacerts -file <証明書ファイル>.cer -alias <エイリアス> -keystore <cacertsへのパス> -storepass changeit
     ```
     `<証明書ファイル>.cer`は企業のCA証明書、`<cacertsへのパス>`は正しいcacertsファイルのパスに置き換えてください。

### オプション3: IntelliJのサーバー証明書設定経由での証明書追加
cacertsファイルを手動で変更する代わりに、IntelliJのUIを通じて証明書を追加できます。これにより内部のトラストストアに保存されます:

1. `ファイル > 設定 > ツール > サーバー証明書`（macOSでは`IntelliJ IDEA > 環境設定`）に移動します。
2. **"+"**ボタンをクリックして新しい証明書を追加します。
3. 企業のCA証明書ファイル（`.cer`または`.pem`形式）を参照してインポートします。
4. IntelliJを再起動し、証明書が認識されることを確認します。

### オプション4: プロキシまたはアンチウイルスの干渉確認
企業環境では、プロキシやアンチウイルスソフトウェア（例: Zscaler、Forcepoint）が中間者SSL検査を実行し、動的に新しい証明書を生成することがよくあります。これにより、証明書が頻繁に変更される場合（例: McAfee Endpoint Securityのような日次変更）、繰り返しプロンプトが表示される可能性があります。

- **プロキシ/アンチウイルスのCA証明書をインポート**:
  - プロキシまたはアンチウイルスソフトウェアからルートCA証明書を取得します（IT部門に問い合わせてください）。
  - `設定 > ツール > サーバー証明書`経由でIntelliJのトラストストアにインポートするか、上記の`keytool`コマンドを使用してcacertsファイルにインポートします。
- **SSL検査の無効化（可能な場合）**:
  - プロキシが許可する場合、IntelliJ関連のドメイン（例: `plugins.jetbrains.com`、`repo.maven.apache.org`）に対するSSL検査をバイパスするように設定します。

### オプション5: 問題のある証明書のデバッグと特定
問題が解決しない場合、どのサーバーまたは証明書がプロンプトの原因となっているかを特定します:

1. 詳細なSSLロギングを有効化:
   - `ヘルプ > カスタムVMオプションを編集`に移動し、以下を追加します:
     ```
     -Djavax.net.debug=ssl:handshake:verbose
     ```
   - IntelliJを再起動し、`idea.log`ファイル（`~/.IntelliJIdea<バージョン>/system/log/`に配置）内のSSLエラー（例: `PKIX path building failed`）を確認します。これにより問題のあるサーバーまたは証明書が表示されます。

2. 特定のプラグインまたは連携機能を確認:
   - Maven、Gradle、バージョン管理システム（例: Git、SVN）などのプラグインが、異なる証明書を使用するサーバーに接続する可能性があります。問題を切り分けるため、一時的にプラグインを無効化します。
   - Mavenの場合、`ファイル > 設定 > ビルド、実行、デプロイメント > ビルドツール > Maven > ランナー`で設定されたJDKが更新されたcacertsを使用していることを確認します。

### 追加の注意点
- **セキュリティ警告**: 信頼されていない証明書を自動承認することは便利ですが、隔離されていないネットワークでは危険です。信頼された環境でのみ使用してください。
- **システム時間の同期**: システムクロックが同期されていることを確認してください。不一致があると証明書の検証問題が発生する可能性があります。
- **JetBrains Runtime (JBR)**: IntelliJは独自のJBR上で動作し、システムのJavaトラストストアを使用しない場合があります。明示的に設定しない限り、システムの`$JAVA_HOME/lib/security/cacerts`への変更はIntelliJに影響しません。
- **持続的なプロンプト**: 証明書をインポート後もプロンプトが持続する場合、プラグインまたはサービス（例: JFrog、SonarQube）が異なるトラストストアを使用している可能性があります。プラグイン設定を確認するか、完全な証明書チェーンについてIT部門に問い合わせてください。

### 推奨アプローチ
1. まず**オプション3**（IntelliJのUI経由での証明書追加）を試してください。最も安全で簡単な方法です。
2. それでも失敗する場合、**オプション2**でキーストアのパスと設定を確認してください。
3. **オプション1**（自動承認）は信頼された環境での最終手段としてのみ使用してください。
4. プロキシまたはアンチウイルスが関与する場合、IT部門と協力して正しいCA証明書を取得・インポートしてください。

それでも問題が解決しない場合は、証明書の詳細（発行者、ドメインなど）や`idea.log`ファイルからのエラーメッセージを共有していただければ、さらに問題を絞り込むお手伝いができます。