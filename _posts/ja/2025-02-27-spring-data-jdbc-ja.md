---
audio: false
generated: true
lang: ja
layout: post
title: Spring Data JDBC
translated: true
type: note
---

Spring Data JDBCは、リレーショナルデータベースを扱うための軽量でアノテーションドリブンなアプローチを提供することで、Springアプリケーションにおけるデータベース連携を簡素化する強力なライブラリです。Spring Data JPAよりも制約が少なく、オブジェクトとデータベーステーブルのマッピングをよりシンプルで明示的な方法に焦点を当てています。以下に、その基本的な使用方法を説明します。

### 1. **プロジェクトのセットアップ**
始めるには、プロジェクトにSpring Data JDBCを含める必要があります。Mavenを使用している場合は、`pom.xml`に以下の依存関係を追加します：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jdbc</artifactId>
</dependency>
```

また、使用するデータベース（例：H2、MySQL、PostgreSQL）に対応するJDBCドライバも必要です。例えばH2の場合は：

```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>
```

Gradleを使用している場合は、以下のようになります：

```gradle
implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
runtimeOnly 'com.h2database:h2'
```

### 2. **データベースの設定**
`application.properties`または`application.yml`でデータベース接続を設定します。H2インメモリデータベースの場合、以下のようになります：

```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.h2.console.enabled=true
```

PostgreSQLのような実際のデータベースの場合は、URL、ユーザー名、パスワードを適宜調整してください。

### 3. **ドメインモデルの定義**
データベース内のテーブルを表現するシンプルなエンティティクラスを作成します。Spring Data JDBCでは、クラス名がテーブル名（デフォルトで小文字）に、フィールドがカラムにマッピングされる規約を使用します。

```java
import org.springframework.data.annotation.Id;

public class Person {
    @Id
    private Long id;
    private String firstName;
    private String lastName;

    // デフォルトコンストラクタ（Spring Data JDBCで必須）
    public Person() {}

    public Person(String firstName, String lastName) {
        this.firstName = firstName;
        this.lastName = lastName;
    }

    // ゲッターとセッター
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getFirstName() { return firstName; }
    public void setFirstName(String firstName) { this.firstName = firstName; }
    public String getLastName() { return lastName; }
    public void setLastName(String lastName) { this.lastName = lastName; }
}
```

- `@Id`は主キーをマークします。
- Spring Data JDBCは引数なしのコンストラクタを必要とします。
- テーブル名は上書きされない限り`person`になります。

### 4. **リポジトリの作成**
基本的なCRUD操作を処理するために、`CrudRepository`を拡張するインターフェースを定義します：

```java
import org.springframework.data.repository.CrudRepository;

public interface PersonRepository extends CrudRepository<Person, Long> {
}
```

以上です！実装は必要ありません。Spring Data JDBCが実行時に実装を生成します。

### 5. **リポジトリの使用**
リポジトリをサービスやコントローラーに注入して使用します：

```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class PersonService {
    private final PersonRepository repository;

    @Autowired
    public PersonService(PersonRepository repository) {
        this.repository = repository;
    }

    public void savePerson() {
        Person person = new Person("John", "Doe");
        repository.save(person);
        System.out.println("Saved person with ID: " + person.getId());
    }

    public void listPeople() {
        Iterable<Person> people = repository.findAll();
        people.forEach(p -> System.out.println(p.getFirstName() + " " + p.getLastName()));
    }
}
```

### 6. **アプリケーションの実行**
Spring Bootを使用している場合は、`@SpringBootApplication`を付けたメインクラスを作成して実行します：

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

Spring BootがデータソースとSpring Data JDBCを自動設定します。

### 7. **オプション：カスタムクエリ**
カスタムクエリが必要な場合は、リポジトリに`@Query`を付けたメソッドを追加できます：

```java
import org.springframework.data.jdbc.repository.query.Query;
import org.springframework.data.repository.CrudRepository;

public interface PersonRepository extends CrudRepository<Person, Long> {
    @Query("SELECT * FROM person WHERE first_name = :name")
    List<Person> findByFirstName(String name);
}
```

### 覚えておくべき重要なポイント
- **レイジーローディングなし：** JPAとは異なり、Spring Data JDBCはレイジーローディングをサポートしません。リレーションシップ（例：一対多）は、集約ルートを用いた明示的なモデリングが必要です。
- **集約ルート：** 各エンティティは集約の一部であり、ルートのみが直接保存または取得されます。
- **スキーマ作成：** Spring Data JDBCはテーブルを自動的に作成しません。スキーマを提供する必要があります（例：`src/main/resources`内の`schema.sql`を使用）：

```sql
CREATE TABLE person (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name VARCHAR(255),
    last_name VARCHAR(255)
);
```

### サンプルワークフロー
1. アプリを起動します。
2. `repository.save()`を使用して`Person`オブジェクトを保存します。
3. `repository.findById()`または`findAll()`で取得します。

以上が基本です！リレーションシップ、カスタムマッピング、または特定の内容についてさらに深く掘り下げたい場合は、目標に合わせて説明を調整します。ここまででどのように機能しているでしょうか？