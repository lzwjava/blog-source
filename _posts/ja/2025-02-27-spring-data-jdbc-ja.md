---
audio: true
lang: ja
layout: post
title: スプリングデータJDBC
translated: true
---

Spring Data JDBCは、Springアプリケーションでデータベースの操作を簡素化するための強力なライブラリです。Spring Data JPAよりも意見が少なく、リレーショナルデータベースとの作業に対して軽量でアノテーション駆動型のアプローチを提供します。以下に、その基本的な使用方法を説明します。

### 1. **プロジェクトのセットアップ**
まず、Spring Data JDBCをプロジェクトに含める必要があります。Mavenを使用している場合、`pom.xml`に以下の依存関係を追加します：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jdbc</artifactId>
</dependency>
```

また、データベース用のJDBCドライバー（例：H2、MySQL、PostgreSQL）も必要です。H2の場合は以下のようにします：

```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope>
</dependency>
```

Gradleを使用している場合、以下のようにします：

```gradle
implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
runtimeOnly 'com.h2database:h2'
```

### 2. **データベースの設定**
`application.properties`または`application.yml`でデータベース接続を設定します。H2のインメモリデータベースの場合、以下のように設定します：

```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.h2.console.enabled=true
```

実際のデータベース（例：PostgreSQL）の場合は、URL、ユーザー名、パスワードを適宜調整してください。

### 3. **ドメインモデルの定義**
データベースのテーブルを表す簡単なエンティティクラスを作成します。Spring Data JDBCでは、クラス名がテーブル名にマッピングされ（デフォルトでは小文字）、フィールドが列にマッピングされます。

```java
import org.springframework.data.annotation.Id;

public class Person {
    @Id
    private Long id;
    private String firstName;
    private String lastName;

    // デフォルトコンストラクタ（Spring Data JDBCで必要）
    public Person() {}

    public Person(String firstName, String lastName) {
        this.firstName = firstName;
        this.lastName = lastName;
    }

    // ゲッターとセッター
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getFirstName() { return firstName; }
    public void setFirstName(String firstName) { this.firstName = firstName; }
    public String getLastName() { return lastName; }
    public void setLastName(String lastName) { this.lastName = lastName; }
}
```

- `@Id`は主キーを示します。
- Spring Data JDBCは引数なしコンストラクタを期待します。
- テーブル名は`person`になります（上書きしない限り）。

### 4. **リポジトリの作成**
基本的なCRUD操作を処理するために、`CrudRepository`を拡張するインターフェースを定義します：

```java
import org.springframework.data.repository.CrudRepository;

public interface PersonRepository extends CrudRepository<Person, Long> {
}
```

これで完了です！実装はSpring Data JDBCがランタイム時に生成します。

### 5. **リポジトリの使用**
リポジトリをサービスまたはコントローラに注入し、使用します：

```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class PersonService {
    private final PersonRepository repository;

    @Autowired
    public PersonService(PersonRepository repository) {
        this.repository = repository;
    }

    public void savePerson() {
        Person person = new Person("John", "Doe");
        repository.save(person);
        System.out.println("Saved person with ID: " + person.getId());
    }

    public void listPeople() {
        Iterable<Person> people = repository.findAll();
        people.forEach(p -> System.out.println(p.getFirstName() + " " + p.getLastName()));
    }
}
```

### 6. **アプリケーションの実行**
Spring Bootを使用している場合、`@SpringBootApplication`を持つメインクラスを作成し、実行します：

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

Spring BootはデータソースとSpring Data JDBCを自動的に設定します。

### 7. **オプション：カスタムクエリ**
カスタムクエリが必要な場合、`@Query`を使用してリポジトリにメソッドを追加します：

```java
import org.springframework.data.jdbc.repository.query.Query;
import org.springframework.data.repository.CrudRepository;

public interface PersonRepository extends CrudRepository<Person, Long> {
    @Query("SELECT * FROM person WHERE first_name = :name")
    List<Person> findByFirstName(String name);
}
```

### 記憶に留めておくべきポイント
- **遅延読み込みなし**：JPAとは異なり、Spring Data JDBCは遅延読み込みをサポートしていません。関係（例：一対多）は明示的に集約ルートでモデリングする必要があります。
- **集約ルート**：各エンティティは集約の一部であり、ルートのみが直接保存または取得されます。
- **スキーマの作成**：Spring Data JDBCは自動的にテーブルを作成しません。スキーマを提供する必要があります（例：`src/main/resources`内の`schema.sql`）：

```sql
CREATE TABLE person (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name VARCHAR(255),
    last_name VARCHAR(255)
);
```

### 例のワークフロー
1. アプリケーションを起動します。
2. `repository.save()`を使用して`Person`オブジェクトを保存します。
3. `repository.findById()`または`findAll()`を使用して取得します。

これが基本です！関係、カスタムマッピング、または特定のものについてさらに深く知りたい場合は、目的を教えてください。