---
audio: false
generated: true
image: false
lang: hant
layout: post
model: x-ai/grok-4-fast
title: 事件驅動架構於卡夫卡的挑戰
translated: true
type: note
---

### 採用 Kafka 的事件驅動架構缺點

你說得沒錯——雖然像使用 Kafka 這樣的事件驅動系統提供了良好的解耦和可擴展性，但它們並非萬靈丹。這些系統會帶來實際挑戰，特別是在複雜性、測試和可靠性方面。對於小型應用程式或不熟悉此範式的團隊來說，可能會覺得有些大材小用。讓我們深入探討你提到的主要缺點，以及一些其他問題，並說明其原因和緩解方法（儘管無法完全消除）。

#### 1. **系統複雜度增加**
   - **原因？** 從直接的 API 呼叫轉向發佈/訂閱模式，意味著需要管理額外層級：主題、分區、結構描述、消費者群組、偏移量和代理。現在必須仔細設計事件結構描述（例如使用 Avro 或 Protobuf 以實現演進）、處理冪等性（避免重複處理），並確保服務之間的最終一致性。原本簡單的同步流程變成了具有潛在競爭條件或亂序事件的分散式數據管道。
   - **影響：** 除錯就像捉鬼——需要跨日誌追蹤事件，而不僅僅是請求 ID。團隊需要具備 Kafka 專業知識，增加了學習曲線。
   - **緩解：** 從小處著手（例如為關鍵事件使用單一主題），使用 Kafka Schema Registry 等工具進行結構描述管理，並透過監控（Prometheus + Grafana）可視化流程。但確實，這比 REST 有更多移動部件。

#### 2. **測試難度提高**
   - **原因？** 在同步設定中，你只需模擬幾個端點並進行單元/整合測試。使用事件時，必須模擬生產者/消費者、重播歷史事件，並處理異步時序（例如，如果消費者亂序處理事件該怎麼辦？）。端到端測試需要測試用 Kafka 實例，且因網絡延遲導致的不穩定測試很常見。
   - **影響：** 反饋循環變慢——無法直接「呼叫函數」。基於屬性的測試或事件溯源測試增加了開銷。
   - **緩解：** 在單元測試中使用嵌入式 Kafka（例如在 Spring Boot 或 Python 的 `kafka-python` 中），對結構描述進行合約測試，並使用 Debezium 等混沌工程工具進行重播。儘管如此，它仍比同步測試更脆弱。

#### 3. **事件遺失（或重複）的風險**
   - **原因？** Kafka 預設是持久的（複製日誌），但在以下情況下可能發生遺失：
     - 生產者使用「發後即忘」（至少一次傳遞）且未等待確認，而代理在持久化前崩潰。
     - 消費者過早提交偏移量，然後崩潰——事件從它們的角度來看「遺失」（儘管可重播）。
     - 網絡分區或配置錯誤的保留策略過早刪除舊事件。
     - 精確一次語義是可能的，但需要冪等消費者和事務生產者，且並非萬無一失。
   - **影響：** 數據完整性問題，如遺漏通知或不一致狀態。在高風險應用（金融、醫療）中，這是一場噩夢。
   - **緩解：** 配置冪等性（唯一事件 ID），對失敗事件使用死信佇列，並監控滯後/偏移量。但「有時」確實如此——邊緣情況依然存在。

#### 其他值得注意的缺點
- **最終一致性的困擾：** 沒有即時反饋——下游服務可能靜默失敗，導致僅在生產環境中出現的「海森堡錯誤」。除錯需要完整的事件追蹤（例如使用 Jaeger 或 Zipkin）。
- **運維開銷：** 運行 Kafka 集群意味著要處理 ZooKeeper（或新版本中的 KRaft）、擴展分區和平衡負載。雲端託管（Confluent Cloud、AWS MSK）的成本會增加。
- **簡單使用場景的過度開銷：** 如果你的應用流量低或服務少，異步優勢無法抵消設置成本。直接呼叫更簡單且原型開發更快。
- **結構描述演進的麻煩：** 更改事件格式？若沒有工具，向後/向前兼容性會很棘手，可能破壞消費者。

總之，這些權衡使得事件驅動架構非常適合大規模、具韌性的系統（如 Netflix 或 Uber），但對其他情況可能是潛在陷阱。如果你的設定簡單，請堅持使用同步編排（例如透過輕量級服務網格如 Istio）。權衡你的需求：高吞吐量和獨立性 vs. 簡單性和即時可見性。

如果你在特定項目中遇到這些問題，痛點是什麼——測試、運維還是其他？我可以幫忙集思廣益解決方案。

[Apache Kafka 文件：精確一次語義](https://kafka.apache.org/documentation/#semantics)  
[Martin Fowler：什麼是「最終一致性」？](https://martinfowler.com/articles/patterns-of-distributed-systems/eventual-consistency.html)  
[Confluent：測試事件驅動應用程式](https://www.confluent.io/blog/testing-event-driven-applications/)