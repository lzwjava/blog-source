---
audio: false
generated: true
lang: hant
layout: post
title: 配置 NPM
translated: true
---

### 主要要點
- 配置 NPM 似乎涉及編輯 `.npmrc` 文件來設置代理和註冊表設置，這可以手動完成或通過命令完成。
- 研究表明，代理設置需要格式 `proxy = http://user:password@proxy_server:port`，特殊字符需要 URL 編碼。
- 証據表明，應將註冊表設置為 `registry = https://registry.npmjs.org/` 作為預設值，如果需要，可以選擇禁用 SSL 驗證。

### 配置 NPM 並使用 `.npmrc`
NPM（Node Package Manager）是一個用於管理 JavaScript 依賴項的工具，配置它通常涉及 `.npmrc` 文件來設置註冊表和代理等設置。

#### 什麼是 `.npmrc` 以及它的位置？
`.npmrc` 文件是 NPM 的配置文件，允許自定義其行為。它可以是：
- **全局**：在 Unix 類系統上位於 `~./.npmrc`，在 Windows 上位於 `%APPDATA%\npm\npmrc`（通常是 `C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **專案本地**：位於專案根目錄的 `./package/.npmrc`。本地設置會覆蓋全局設置。

#### 設置代理和 HTTPS 代理
要在代理後工作，將這些行添加到 `.npmrc`：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

請注意，即使是 `https_proxy`，也要使用 `http://` 作為協議。如果您的用戶名或密碼包含特殊字符（例如 `\`，`@`），請對其進行 URL 編碼（例如，`domain\user` 變為 `domain%5Cuser`）。您也可以通過命令設置這些：
- `npm config set proxy http://user:password@proxy_server:port`
- `npm config set https_proxy http://user:password@proxy_server:port`

#### 設置註冊表
註冊表是 NPM 用來獲取包的 URL，通常設置為：
- `registry = https://registry.npmjs.org/`

對於自定義註冊表，請用您的 URL 替換（例如，公司的私有註冊表）。通過以下方式設置：
- `npm config set registry https://your_custom_registry.com/`

#### 處理 SSL 和驗證
如果您遇到 SSL 問題，請考慮：
- 在 `.npmrc` 中設置 `strict-ssl = false` 以忽略 SSL 錯誤，但這樣做不安全。通過以下方式設置：
- `npm config set strict-ssl false`

#### 使用和驗證配置
直接使用文本編輯器編輯 `.npmrc`，或者使用 `npm config set` 命令。要驗證：
- 使用 `npm config list` 列出所有設置。
- 使用 `npm config get proxy` 檢查特定設置。
- 使用 `npm install --verbose` 進行調試，以獲取詳細輸出。

示例 `.npmrc` 文件可能如下所示：
```
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

### 調查筆記：配置 NPM 使用 `.npmrc` 的全面指南
本節提供了配置 NPM 的詳細探討，重點介紹了 `.npmrc` 文件的註冊表和代理設置，並擴展了直接答案，提供了更多上下文和技術細節。

#### 介紹 `.npmrc` 及其作用
`.npmrc` 文件是 NPM 的關鍵配置文件，使得包管理行為可以自定義。它支持 INI 格式，具有鍵值對，其中註釋以分號（`;`）開頭。它可以全局或本地定位：
- **全局位置**：在 Unix 類系統上，位於 `~./.npmrc`；在 Windows 上，位於 `%APPDATA%\npm\npmrc`，通常是 `C:\Users\<username>\AppData\Roaming\npm\npmrc`。
- **本地位置**：在專案根目錄內作為 `./package/.npmrc`。本地設置會覆蓋全局設置，提供專案特定的配置。

這種層次結構提供了靈活性，使開發人員能夠在用戶和專案級別管理設置，這在具有多個專案或共享系統的環境中特別有用。

#### 詳細代理配置
在代理後工作需要在 `.npmrc` 中設置 `proxy` 和 `https_proxy`。格式如下：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

值得注意的是，`https_proxy` 使用 `http://` 作為協議，而不是 `https://`，因為代理服務器處理連接，而不是將其加密到代理本身。這是一個常見的混淆點，因為有效負載到目的地仍然是 SSL 加密的。

對於身份驗證，包括用戶名和密碼，但如果它們包含特殊字符，則需要 URL 編碼：
- 反斜杠（`\`）變為 `%5C`。
- 於符號（`@`）變為 `%40`。
- 冒號（`:`）變為 `%3A`。

例如，如果用戶名是 `domain\user` 且密碼是 `pass@word`，則為 `proxy = http://domain%5Cuser:pass%40word@proxy_server:8080`。這種編碼確保 NPM 正確解析。

Windows 用戶，特別是在使用 Active Directory 的企業環境中，可能會遇到反斜杠問題。一些報告指出，`.npmrc` 中的 `domain\username` 可能在讀取時轉換為 `domain/username`，可能導致身份驗證失敗。在這種情況下，可以使用 NTLM Authorization Proxy Server 或 Cntlm 等工具，儘管它們不在直接 `.npmrc` 配置之外。

#### 註冊表配置和 SSL 考量
註冊表設置定義了 NPM 获取包的位置，默認設置為 `https://registry.npmjs.org/`。對於自定義或私有註冊表，設置：
- `registry = https://your_custom_registry.com/`

如果 SSL 驗證失敗，通常是由於企業代理具有自簽證書，您可以禁用嚴格的 SSL：
- `strict-ssl = false`

然而，這會降低安全性，因為它繞過了證書驗證。或者，配置證書授權：
- 使用 `npm config -g set cafile [YOUR_CERTIFICATE_DIR]/[CERTIFICATE_NAME].crt` 指定受信任的 CA 文件。

一些開發人員選擇 `registry = http://registry.npmjs.org/` 以完全避免 SSL，但這在安全性方面不推薦，特別是在生產環境中。

#### 使用 `.npmrc`：手動編輯與命令行
您可以使用任何文本編輯器直接編輯 `.npmrc`，確保每個設置在新行上，格式為 `key = value`。註釋以 `;` 開頭，例如：
```
; 企業網絡的代理設置
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

或者，使用 NPM 命令方便：
- 設置代理：`npm config set proxy http://user:password@proxy_server:port`
- 設置註冊表：`npm config set registry https://registry.npmjs.org/`
- 設置 strict-ssl：`npm config set strict-ssl false`

這些命令根據上下文（全局或本地）更新相應的 `.npmrc` 文件。要在全局和本地之間切換，使用 `-g` 表示全局，例如 `npm config set -g proxy ...`。

#### 驗證和故障排除
要驗證配置，使用：
- `npm config list` 列出所有設置，顯示有效值和默認值。
- `npm config get proxy` 獲取特定設置。

對於故障排除，特別是在代理後，運行：
- `npm install --verbose` 以查看詳細日誌，這可以幫助識別連接問題，例如 `ECONNREFUSED` 或 `socket hang up`。

如果設置無效，請檢查環境變量（`HTTP_PROXY`，`HTTPS_PROXY`），這些可能會覆蓋 `.npmrc`。這些可以在系統範圍內設置並優先，因此請確保一致性。

#### 最佳實踐和其他考量
- **安全性**：在生產中避免 `strict-ssl = false`；相反，配置受信任的證書。
- **環境變量**：請注意 `NODE_ENV` 和 `HTTPS_PROXY` 可能會覆蓋 `.npmrc` 設置，這對於 CI/CD 管道很有用，但在本地可能會混淆。
- **日誌級別**：在 `.npmrc` 中調整 `loglevel`（例如 `loglevel = http`），以在調試期間獲取更詳細的輸出，選項範圍從 `silent` 到 `silly`（共 7 級）。
- **企業代理**：對於 NTLM 代理，考慮使用 Cntlm 等工具，設置本地代理服務器，並配置 `.npmrc` 指向 `localhost:3128`，簡化身份驗證。

#### 示例配置
以下是總結常見 `.npmrc` 設置的表格，並附有代理和註冊表的示例：

| **設置**    | **描述**                              | **示例**                                      |
|----------------|----------------------------------------------|--------------------------------------------------|
| proxy          | HTTP 代理服務器 URL                        | `proxy = http://user:password@proxy:8080`        |
| https_proxy    | HTTPS 代理服務器 URL                       | `https_proxy = http://user:password@proxy:8080`  |
| registry       | 包註冊表 URL                         | `registry = https://registry.npmjs.org/`         |
| strict-ssl     | 啟用/禁用 SSL 驗證              | `strict-ssl = false`                             |
| loglevel       | 控制台輸出級別（從 silent 到 silly，共 7 級） | `loglevel = http`                                |

這張表有助於快速參考，特別是對於新手開發人員。

#### 意外細節：全局與本地設置的影響
意外之處在於全局 `.npmrc` 設置會影響所有專案，而本地設置可以覆蓋特定專案。這種層次結構可能會導致混淆，例如，如果全局設置了代理，但本地專案使用不同的註冊表，可能會導致身份驗證問題。理解這種層次結構對於多專案環境至關重要。

#### 結論
通過 `.npmrc` 配置 NPM 的代理和註冊表設置非常簡單，只要格式正確並考慮編碼和 SSL。通過直接編輯或使用命令，並使用 `npm config list` 驗證，您可以確保平滑的包管理，特別是在具有代理的企業網絡中。有關進一步閱讀，請參閱官方文檔 [NPM CLI Config](https://docs.npmjs.com/cli-config) 或探索最佳實踐 [Configuring Your .nmprc](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)。

### 主要引用
- [NPM CLI Config 文檔](https://docs.npmjs.com/cli-config)
- [Configuring Your .nmprc for an Optimal Node.js Environment](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)
- [How to setup npm proxy settings behind proxy on Windows](https://gist.github.com/zillingen/5c4b8da657025c83ead59e1e547c7436)