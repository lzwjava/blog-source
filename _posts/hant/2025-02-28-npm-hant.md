---
audio: false
generated: true
lang: hant
layout: post
title: 配置 NPM
translated: true
type: note
---

### 重點摘要
- 配置 NPM 似乎需要編輯 `.npmrc` 檔案來設定代理伺服器和註冊表設定，這可以手動或透過指令完成。
- 研究顯示代理設定需使用格式 `proxy = http://user:password@proxy_server:port`，並對特殊字元進行 URL 編碼。
- 證據傾向於將註冊表預設設為 `registry = https://registry.npmjs.org/`，並在需要時可停用 SSL 驗證。

### 配置 NPM 與使用 `.npmrc`
NPM（Node Package Manager）是用於管理 JavaScript 相依關係的工具，配置時通常涉及使用 `.npmrc` 檔案來設定如註冊表和代理等選項。

#### 什麼是 `.npmrc` 及其位置？
`.npmrc` 是 NPM 的設定檔，允許自訂其行為。它可能位於：
- **全域**：在類 Unix 系統上位於 `~./.npmrc`，在 Windows 上則位於 `%APPDATA%\npm\npmrc`（通常為 `C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **專案本地**：位於專案根目錄的 `./package/.npmrc`。本地設定會覆蓋全域設定。

#### 設定代理與 HTTPS 代理
若要在代理伺服器後運作，請在 `.npmrc` 中加入以下行：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

請注意，即使是 `https_proxy`，也請使用 `http://` 作為通訊協定。如果使用者名稱或密碼包含特殊字元（例如 `\`、`@`），請對其進行 URL 編碼（例如 `domain\user` 變為 `domain%5Cuser`）。您也可以透過指令設定：
- `npm config set proxy http://user:password@proxy_server:port`
- `npm config set https_proxy http://user:password@proxy_server:port`

#### 設定註冊表
註冊表是 NPM 用於獲取套件的 URL，通常設為：
- `registry = https://registry.npmjs.org/`

對於自訂註冊表，請替換為您的 URL（例如公司的私有註冊表）。透過以下方式設定：
- `npm config set registry https://your_custom_registry.com/`

#### 處理 SSL 與驗證
如果遇到 SSL 問題，請考慮：
- 在 `.npmrc` 中設定 `strict-ssl = false` 以忽略 SSL 錯誤，但這會降低安全性。透過以下方式設定：
- `npm config set strict-ssl false`

#### 使用與驗證配置
直接使用文字編輯器編輯 `.npmrc`，或使用 `npm config set` 指令。驗證方式：
- 使用 `npm config list` 列出所有設定。
- 使用 `npm config get proxy` 檢查特定設定。
- 使用 `npm install --verbose` 進行除錯以獲取詳細輸出。

範例 `.npmrc` 檔案可能如下所示：
```
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

### 調查筆記：配置 NPM 與 `.npmrc` 的完整指南
本節詳細探討如何配置 NPM，重點關注使用 `.npmrc` 檔案進行註冊表和代理設定，並在直接答案的基礎上擴展了額外的上下文和技術細節。

#### `.npmrc` 簡介及其角色
`.npmrc` 是 NPM 的關鍵設定檔，允許自訂套件管理行為。它支援 INI 格式的鍵值對，註解以分號（`;`）開頭。它可能位於全域或本地：
- **全域位置**：在類 Unix 系統上位於 `~./.npmrc`；在 Windows 上則位於 `%APPDATA%\npm\npmrc`，通常為 `C:\Users\<username>\AppData\Roaming\npm\npmrc`。
- **本地位置**：在專案根目錄內作為 `./package/.npmrc`。本地設定會覆蓋全域設定，提供專案特定的配置。

這種層級結構確保了靈活性，允許開發人員在使用者層級和專案層級管理設定，這在具有多個專案或共享系統的環境中特別有用。

#### 詳細的代理配置
在代理伺服器後運作需要在 `.npmrc` 中設定 `proxy` 和 `https_proxy`。格式為：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

值得注意的是，`https_proxy` 使用 `http://` 作為通訊協定，而非 `https://`，這是因為代理伺服器處理的是連線本身，而不是對代理伺服器進行加密。這是一個常見的混淆點，因為傳送到目的地的 payload 仍然是 SSL 加密的。

對於身份驗證，請包含使用者名稱和密碼，但如果它們包含特殊字元，URL 編碼是必要的：
- 反斜線（`\`）變為 `%5C`。
- At 符號（`@`）變為 `%40`。
- 冒號（`:`）變為 `%3A`。

例如，如果使用者名稱為 `domain\user`，密碼為 `pass@word`，則應設為 `proxy = http://domain%5Cuser:pass%40word@proxy_server:8080`。這種編碼確保 NPM 能正確解析。

Windows 使用者，特別是在使用 Active Directory 的企業環境中，可能會遇到反斜線問題。有些報告指出，`.npmrc` 中的 `domain\username` 在讀取時可能轉換為 `domain/username`，可能導致身份驗證失敗。在這種情況下，使用如 NTLM Authorization Proxy Server 或 Cntlm 等工具可能有幫助，儘管這些超出了直接的 `.npmrc` 配置範圍。

#### 註冊表配置與 SSL 注意事項
註冊表設定定義了 NPM 從何處獲取套件，預設為 `https://registry.npmjs.org/`。對於自訂或私有註冊表，請設定：
- `registry = https://your_custom_registry.com/`

如果 SSL 驗證失敗（通常是由於企業代理使用自簽憑證），您可以停用嚴格 SSL：
- `strict-ssl = false`

然而，這會降低安全性，因為它繞過了憑證驗證。或者，配置憑證授權機構：
- 使用 `npm config -g set cafile [YOUR_CERTIFICATE_DIR]/[CERTIFICATE_NAME].crt` 來指定受信任的 CA 檔案。

有些開發人員選擇使用 `registry = http://registry.npmjs.org/` 來完全避免 SSL，但出於安全原因，特別是在生產環境中，不建議這樣做。

#### 使用 `.npmrc`：手動編輯 vs 指令行
您可以直接使用任何文字編輯器編輯 `.npmrc`，確保每個設定在新的一行，格式為 `key = value`。註解以 `;` 開頭，例如：
```
; 企業網路的代理設定
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

或者，為了方便，使用 NPM 指令：
- 設定代理：`npm config set proxy http://user:password@proxy_server:port`
- 設定註冊表：`npm config set registry https://registry.npmjs.org/`
- 設定 strict-ssl：`npm config set strict-ssl false`

這些指令會根據上下文（全域或本地）更新適當的 `.npmrc` 檔案。要在全域和本地之間切換，請使用 `-g` 表示全域，例如 `npm config set -g proxy ...`。

#### 驗證與疑難排解
要驗證配置，請使用：
- `npm config list` 列出所有設定，顯示有效值和預設值。
- `npm config get proxy` 檢索特定設定。

對於疑難排解，特別是在代理伺服器後，請執行：
- `npm install --verbose` 以查看詳細日誌，這有助於識別連線問題，例如 `ECONNREFUSED` 或 `socket hang up`。

如果設定未生效，請檢查可能覆蓋 `.npmrc` 的環境變數（`HTTP_PROXY`、`HTTPS_PROXY`）。這些變數可能在系統範圍內設定並優先，因此請確保一致性。

#### 最佳實踐與其他注意事項
- **安全性**：在生產環境中避免使用 `strict-ssl = false`；而是配置受信任的憑證。
- **環境變數**：注意 `NODE_ENV` 和 `HTTPS_PROXY` 可能覆蓋 `.npmrc` 設定，這在 CI/CD 管線中很有用，但在本地可能造成混淆。
- **日誌級別**：在 `.npmrc` 中調整 `loglevel`（例如 `loglevel = http`）以在除錯時獲得更多詳細輸出，選項範圍從 `silent` 到 `silly`（總共 7 個級別）。
- **企業代理**：對於 NTLM 代理，請考慮使用如 Cntlm 等工具，設定本地代理伺服器，並配置 `.npmrc` 指向 `localhost:3128`，以簡化身份驗證。

#### 範例配置
以下是總結代理和註冊表常見 `.npmrc` 設定的表格，並附有範例：

| **設定**    | **描述**                              | **範例**                                      |
|----------------|----------------------------------------------|--------------------------------------------------|
| proxy          | HTTP 代理伺服器 URL                        | `proxy = http://user:password@proxy:8080`        |
| https_proxy    | HTTPS 代理伺服器 URL                       | `https_proxy = http://user:password@proxy:8080`  |
| registry       | 套件註冊表 URL                         | `registry = https://registry.npmjs.org/`         |
| strict-ssl     | 啟用/停用 SSL 驗證              | `strict-ssl = false`                             |
| loglevel       | 控制台輸出級別（silent 到 silly，7 個級別） | `loglevel = http`                                |

此表格有助於快速參考，特別是對於剛接觸 `.npmrc` 的開發人員。

#### 意外細節：全域與本地設定的影響
一個意外的方面是全域 `.npmrc` 設定如何影響所有專案，而本地設定可以為特定專案覆蓋。這種分層可能導致混淆，例如，如果設定了全域代理，但本地專案使用不同的註冊表，可能導致身份驗證問題。理解這種層級結構對於多專案環境至關重要。

#### 結論
透過 `.npmrc` 配置 NPM 的代理和註冊表設定，只要格式正確並考慮編碼和 SSL，是相當直接的。透過直接編輯或使用指令，並使用 `npm config list` 進行驗證，您可以確保順暢的套件管理，特別是在具有代理的企業網路中。如需進一步閱讀，請參閱官方文件 [NPM CLI Config](https://docs.npmjs.com/cli-config) 或探索 [Configuring Your .nmprc](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment) 中的最佳實踐。

### 主要引用文獻
- [NPM CLI Config Documentation](https://docs.npmjs.com/cli-config)
- [Configuring Your .nmprc for an Optimal Node.js Environment](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)
- [How to setup npm proxy settings behind proxy on Windows](https://gist.github.com/zillingen/5c4b8da657025c83ead59e1e547c7436)