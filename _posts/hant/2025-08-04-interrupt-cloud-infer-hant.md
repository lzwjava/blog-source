---
audio: false
generated: true
image: false
lang: hant
layout: post
title: 中斷不影響雲端推論
translated: true
type: note
---

當你在 Python 腳本執行 `generate_images()` 呼叫期間中斷（例如使用 Ctrl-C）時，大致會發生以下情況：

1. **客戶端行為**
   – 當你終止 Python 進程時，底層的 HTTP/gRPC 連接會立即斷開。
   – GenAI 客戶端庫通常會捕捉到管道斷裂或連接重設錯誤，並拋出異常（你會在腳本中看到此錯誤）。

2. **Google 端的處理情況**
   – 在你取消時，你的請求已經送達 Google 的推理服務並進入佇列（或已開始運行）。
   – 大多數雲端推理端點**不會**因客戶端消失而自動取消工作。它們會繼續將你的圖像生成任務執行完成（消耗 GPU/TPU 資源並產生計費），即使已無有效連接可傳回結果。
   – 任務完成後，生成的圖像會被丟棄——除非你設定了長期運作操作或 webhook，否則不會有回調通知。

3. **Nginx（或其他代理）的影響因素**
   – 若推理服務前有 Nginx 反向代理，其默認行為是監控客戶端連接。一旦客戶端中止，Nginx 會立即關閉與上游推理進程的連接（發送 FIN/RST）。
   – 上游進程在最終嘗試寫入回應時會發現 socket 斷開。此時它可能記錄 I/O 錯誤，但關鍵在於——它**不會**回溯並停止你要求的運算；它只是無法傳輸資料位元組。
   – 你可以調整 Nginx 的 `proxy_ignore_client_abort` 指令——若設為 `on`，即使客戶端斷開連接，Nginx 仍會保持上游連接存活（讓你能完整寫入日誌或執行其他清理工作）。

4. **對你的腳本的重要啟示**

   * **中斷操作不會「撤銷」** 或取消 Google 伺服器上的模型運算——你仍需支付完整推理費用。
   * 若需要可取消的推理功能，必須採用不同模式：例如

     1. 提交非阻塞的批次處理或長期運作操作，
     2. 透過獨立 API 呼叫輪詢其狀態或明確取消。

簡而言之：在 5 秒時終止你的腳本會停止本地等待並關閉 socket，但 Google 的推理仍會在其硬體上運行至完成（而 Nginx 或類似服務在結果準備好時，只會將回應丟棄至虛空）。