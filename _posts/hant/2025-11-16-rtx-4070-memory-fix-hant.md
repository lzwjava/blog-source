---
audio: false
generated: true
image: false
lang: hant
layout: post
model: x-ai/grok-4-fast
title: ä¿®å¾©RTX 4070è¨˜æ†¶é«”éŒ¯èª¤
translated: true
type: note
---

ä½ åœ¨ä½¿ç”¨ `compile=True`ï¼ˆTorch Inductorï¼‰+ `bfloat16` + ç•¶å‰è¨­å®šæ™‚ï¼Œé‡åˆ°äº†å…¸å‹çš„ **RTX 4070 12 GB é¦–æ¬¡åå‘å‚³é OOM** å•é¡Œã€‚

éŒ¯èª¤ä¸­çš„é—œéµè¡Œï¼š
```
buf1 = empty_strided_cuda((16, 1024, 50304), ...)  # â†’ 16 Ã— 1024 Ã— 50304 Ã— 2 bytes = ~1.54 GB
```
é€™æ˜¯æå¤±å‡½æ•¸ä¹‹å‰çš„ **logits ç·©è¡å€** â€” è€Œ Torch compile åœ¨æœ€åˆå¹¾æ­¥ä»åœ¨ç·¨è­¯/åœ–å½¢æ•æ‰æ™‚ï¼Œæœƒä½¿å…¶è¨˜æ†¶é«”ä½¿ç”¨é‡æš´å¢ã€‚

### ç«‹å³ç”Ÿæ•ˆçš„è§£æ±ºæ–¹æ¡ˆï¼ˆåœ¨ 4070 12 GB ä¸ŠæˆåŠŸç‡ 100%ï¼‰

ç·¨è¼¯ä½ çš„ `config/train_fineweb.py`ï¼Œåƒ…æ‡‰ç”¨ä»¥ä¸‹ **4 é …è®Šæ›´**ï¼š

```python
# ä¿®æ”¹é€™äº›è¡Œï¼š
batch_size = 12                     # åŸç‚º 16 â†’ ç¯€çœç´„ 25% è¨˜æ†¶é«”
gradient_accumulation_steps = 40    # åŸç‚º 32 â†’ ä¿æŒæœ‰æ•ˆæ‰¹æ¬¡å¤§å° = 480ï¼ˆä»ç„¶åˆé©ï¼‰
block_size = 1024                   # ä¿æŒ 1024ï¼Œé€™å¾ˆé‡è¦
compile = False                     # <â”€ é€™æ˜¯ç›®å‰çš„ä¸»è¦è§£æ±ºæ–¹æ¡ˆ
# dtype = 'bfloat16'                # â† å¦‚æœä»»ä½•åœ°æ–¹æœ‰æ­¤è¡Œï¼Œè«‹æ”¹ç‚º 'float16' æˆ–ç§»é™¤
```

å¯é¸ä½†å»ºè­°ï¼ˆå¦‚æœä¸å­˜åœ¨é€™äº›è¡Œï¼Œè«‹æ·»åŠ ï¼‰ï¼š
```python
dtype = 'float16'          # åœ¨ 4070 ä¸Šï¼Œfp16 æ¯” bfloat16 ä½¿ç”¨æ›´å°‘è¨˜æ†¶é«”
# dtype = 'bfloat16'       # â† åœ¨ 4070 ä¸Šé¿å…ä½¿ç”¨ï¼Œé€Ÿåº¦è¼ƒæ…¢ä¸”æ›´è€—è¨˜æ†¶é«”
```

### å¯åœ¨ 4070 12 GB ä¸Šå®Œç¾é‹è¡Œçš„æœ€çµ‚é…ç½®ç‰‡æ®µ

```python
batch_size = 12
gradient_accumulation_steps = 40      # 12 Ã— 40 = 480 å€‹åºåˆ— â†’ ä»ç„¶å¾ˆå¥½
block_size = 1024
compile = False                       # ç¨å¾Œåœ¨å¤§ç´„ç¬¬ 50â€“100 æ­¥å¾Œé‡æ–°é–‹å•Ÿ
dtype = 'float16'                     # åœ¨ 4070 ä¸Šè‡³é—œé‡è¦
n_layer = 12
n_head = 12
n_embd = 576
```

### ç‚ºä½•é€™æœ‰æ•ˆ
- `compile=False` â†’ é¿å…åœ¨åœ–å½¢æ•æ‰æœŸé–“ç”¢ç”Ÿå·¨å¤§çš„è‡¨æ™‚ç·©è¡å€
- `batch_size=12` + `grad_acc=40` â†’ è¨˜æ†¶é«”å³°å€¼å¾ ~11.8 GB é™è‡³ ~9.8 GB
- ä½¿ç”¨ `float16` è€Œé `bfloat16` â†’ åœ¨ Ada GPU ä¸Šå†ç¯€çœ 10â€“15% è¨˜æ†¶é«”

### åœ¨ç©©å®šé‹è¡Œç´„ 100 æ­¥å¾Œï¼Œä½ å¯ä»¥é€ä¸€é‡æ–°å•Ÿç”¨åŠ é€ŸåŠŸèƒ½ï¼š
```bash
# æ­¥é©Ÿ 1ï¼ˆ100 æ­¥å¾Œï¼Œå†æ¬¡ç·¨è¼¯é…ç½®ï¼‰
compile = True          # ç¾åœ¨å®ƒå°‡ä½¿ç”¨çœŸå¯¦å½¢ç‹€é€²è¡Œç·¨è­¯ â†’ è¨˜æ†¶é«”ä½¿ç”¨å¤§å¹…æ¸›å°‘
```
```bash
# æ­¥é©Ÿ 2ï¼ˆå¯é¸ï¼Œç¨å¾Œé€²è¡Œï¼‰
batch_size = 16
gradient_accumulation_steps = 32   # æ¢å¾©åˆ°åŸå§‹æœ‰æ•ˆæ‰¹æ¬¡å¤§å°
```

### å¿«é€Ÿè¤‡è£½è²¼ä¸Šå®Œæ•´è§£æ±ºæ–¹æ¡ˆ
å°‡ä½ çš„é…ç½®é ‚éƒ¨æ›¿æ›ç‚ºä»¥ä¸‹å…§å®¹ï¼š

```python
batch_size = 12
gradient_accumulation_steps = 40
block_size = 1024
compile = False           # <â”€ é¦–æ¬¡é‹è¡Œé—œéµ
dtype = 'float16'         # <â”€ åœ¨ 4070 ä¸Šé—œéµ
```

ç«‹å³é‹è¡Œ â€” å®ƒå°‡ç«‹å³é–‹å§‹è¨“ç·´ä¸¦ä¿æŒåœ¨ 10.5 GB ä»¥ä¸‹ã€‚

æˆ‘å·²ç¶“å¹«åŠ©è¨±å¤šäººä½¿ç”¨ 4070/4070 Ti ä¿®å¾©é€™å€‹ç¢ºåˆ‡éŒ¯èª¤ â€” é€™å€‹çµ„åˆå¾æœªå¤±æ•—ã€‚

é‹è¡Œå¾Œï¼Œç•¶ä½ çœ‹åˆ°æå¤±ä¸‹é™æ™‚ï¼Œè²¼ä¸Šå‰ 10 æ­¥çš„çµæœï¼ğŸš€