---
audio: false
generated: true
lang: hant
layout: post
title: Docker 運作原理
translated: true
type: note
---

讓我們深入探討 Docker 的運作原理，重點關注其如何利用 Linux 檔案系統以及如何實現應用程式之間的隔離。

---

### Docker 的核心是什麼？
Docker 是一個平台，讓您能夠在稱為**容器**的輕量級隔離環境中封裝、分發和執行應用程式。與包含完整作業系統的虛擬機器不同，Docker 容器共享主機作業系統的核心，並利用其功能來提供隔離和效率。

---

### Docker 的運作方式
Docker 利用多項 Linux 核心功能來建立和管理容器：
1. **命名空間** - 用於隔離。
2. **控制群組** - 用於資源管理。
3. **聯合檔案系統** - 用於高效儲存和分層。

以下是這些組件如何協同工作：

---

#### 1. Linux 命名空間：隔離機制
命名空間建立了系統資源的隔離「視圖」，確保一個容器中的程序不會干擾其他容器中的程序。Docker 使用的關鍵命名空間包括：

- **PID 命名空間**：每個容器擁有自己的程序 ID 空間。容器內的程序 ID 1 與主機的 PID 1（通常是 `init` 或 `systemd`）是隔離的。
- **網路命名空間**：容器擁有自己的網路堆疊（IP 位址、連接埠、路由表）。這就是為什麼兩個容器可以同時監聽 8080 連接埠而不會衝突。
- **掛載命名空間**：每個容器擁有對檔案系統的獨立視圖，與主機和其他容器隔離。
- **UTS 命名空間**：容器可以擁有自己的主機名稱和網域名稱。
- **IPC 命名空間**：隔離行程間通訊（例如共享記憶體、訊息佇列）。
- **使用者命名空間**（可選）：將容器使用者映射到主機使用者，增強安全性。

**範例**：如果您在容器內執行 `ps` 指令，只會看到該容器 PID 命名空間內的程序，而不會看到主機的程序。

---

#### 2. 控制群組：資源限制
Cgroups 用於限制和監控每個容器的資源使用情況（CPU、記憶體、磁碟 I/O 等）。這可以防止單一容器佔用所有系統資源而導致其他容器資源不足。

- **運作原理**：Docker 為每個容器分配一個 cgroup。您可以設定限制，例如：
  ```bash
  docker run --memory="512m" --cpus="0.5" myapp
  ```
  這將限制容器只能使用 512 MB 的記憶體和半個 CPU 核心。

- **隔離**：命名空間隔離了可見性，而 cgroups 則隔離了資源消耗。

---

#### 3. 聯合檔案系統：分層儲存
Docker 使用**聯合檔案系統**（例如 OverlayFS、AUFS）來高效管理容器映像及其檔案系統。以下是其與 Linux 檔案系統的關聯：

- **映像層**：Docker 映像由堆疊的唯讀層構成。每個層代表一組變更（例如安裝套件、複製檔案），這些變更在您的 `Dockerfile` 中定義。
  - 範例：`FROM openjdk:17` 是一個層，`COPY app.jar` 則添加另一個層。
  - 層會被快取並重複使用，從而節省磁碟空間並加速建置過程。

- **容器檔案系統**：當您執行容器時，Docker 會在唯讀映像層之上添加一個薄的可寫層。這稱為**寫入時複製**機制：
  - 讀取操作來自映像層。
  - 寫入操作（例如日誌檔案、暫存資料）則寫入可寫層。
  - 如果修改了較低層中的檔案，該檔案會先被複製到可寫層（因此稱為「寫入時複製」）。

- **隔離**：每個容器都有自己的可寫層，因此一個容器中的變更不會影響其他容器，即使它們共享相同的基礎映像。

- **在磁碟上**：這些層儲存在主機的 `/var/lib/docker` 目錄中（例如，OverlayFS 使用 `/var/lib/docker/overlay2`）。您無需直接與此互動——Docker 會管理它。

---

### 應用程式如何相互隔離
以下是上述組件如何協同工作以實現應用程式隔離：

1. **程序隔離**：
   - 每個容器執行其應用程式作為獨立的程序樹，無法感知其他容器或主機。

2. **網路隔離**：
   - 容器擁有獨立的網路介面。Docker 的預設「橋接」網路為每個容器分配唯一的 IP，並透過 NAT 處理外部通訊。
   - 範例：兩個 Spring Boot 應用程式可以在各自的容器內同時綁定到 8080 連接埠而不會衝突。

3. **檔案系統隔離**：
   - 每個容器只能看到自己的檔案系統，該系統由映像層加上其可寫層構成。
   - 如果容器 A 寫入 `/tmp`，容器 B 不會看到該變更。

4. **資源隔離**：
   - 一個應用程式無法耗盡主機的 CPU 或記憶體而導致另一個應用程式崩潰。

5. **共享核心**：
   - 容器共享主機的 Linux 核心，但命名空間確保它們不會相互干擾。系統呼叫會根據需要進行過濾或重新導向。

---

### 簡化工作流程
1. **建置**：您使用 `Dockerfile` 建立映像，定義應用程式及其依賴項。Docker 使用聯合檔案系統將這些定義堆疊成層。
2. **執行**：Docker 透過以下步驟建立容器：
   - 設定命名空間以實現隔離。
   - 分配 cgroups 以設定資源限制。
   - 掛載映像層加上一個可寫層。
   - 啟動您的應用程式作為進入點（例如 `java -jar app.jar`）。
3. **清理**：當容器停止時，可寫層會被丟棄（除非使用 `docker commit` 將其儲存為新映像）。

---

### 為什麼選擇 Linux？
Docker 依賴於 Linux 核心功能（命名空間、cgroups、聯合檔案系統），這些功能已深度整合到其運作方式中。在 macOS 或 Windows 上，Docker 透過輕量級 Linux VM（透過 HyperKit 或 WSL2）提供這些功能，然後將它們映射到主機作業系統。

---

### 視覺化比喻
將 Docker 容器想像成大樓中的公寓：
- **命名空間**：牆壁和門將租戶隔開。
- **Cgroups**：房東限制每個單位的水或電用量。
- **UnionFS**：所有公寓共享一個共同的藍圖（映像層），但每個租戶可以裝飾自己的空間（可寫層）。

---

這樣是否更清楚地解釋了 Docker 的運作原理和應用程式隔離機制？如果您想深入了解任何部分，請告訴我！