---
audio: false
generated: true
lang: hant
layout: post
title: XNU 核心效能計數器分析
translated: true
type: note
---

您提供的 C 語言程式碼展示了在 macOS 和 iOS 上使用 **XNU 的 `kperf` 與 `kpc`（核心效能計數器）功能**，旨在**於底層級別分析系統與應用程式效能**。

以下是關於此程式碼的詳細說明：

* **效能計數器存取：** 它直接與核心的效能監控單元（PMU）互動，以極細粒度層級收集詳細效能指標（如週期數、指令數、分支預測失誤）。這通常用於深入的效能分析與優化。
* **私有框架：** 它逆向工程並使用了 macOS/iOS **私有框架**中的函式：
    * `kperf.framework`：提供控制核心級別效能分析的介面，包括啟動/停止取樣、設定計時器，以及依行程 ID 或任務進行篩選。
    * `kperfdata.framework`：用於存取和解釋 CPU 的 PMC（效能監控計數器）資料庫（位於 `/usr/share/kpep/` 的 `.plist` 檔案）。此資料庫定義了不同 CPU 架構（Intel、Apple Silicon）上可用的特定效能事件。
* **Kdebug 整合：** 它與 `kdebug` 追蹤機制整合，以收集取樣的效能資料。`kdebug` 是一個核心級別的記錄系統，允許高效能的事件記錄。
* **兩種示範模式：**
    * **示範 1（`main` 函式）：分析當前執行緒中的函式。** 此模式專門針對在當前行程內執行的已定義 C 函式（`profile_func`）測量效能計數器。它會取得計數器的「之前」和「之後」快照，以計算差異。
    * **示範 2（`main2` 函式）：分析選定的行程（或所有執行緒）。** 此模式針對指定的 `target_pid`（若 `target_pid` 為 -1 則為整個系統）在 `total_profile_time` 期間設定連續的效能取樣。它使用 `kperf` 計時器和 `kdebug` 來收集目標的定期效能計數器資料。
* **需要 root 權限：** 程式碼明確檢查 root 權限，因為直接與核心效能計數器和 `kperf` 互動需要提升的權限。
* **CPU 架構特殊性：** 程式碼考慮了不同的 CPU 架構（Intel、ARM64）及其各自的 PMC 資料庫。它嘗試在這些架構中尋找合適的效能事件。

**本質上，此程式碼為開發人員和系統管理員提供了一個底層工具，用於：**

* **理解 CPU 行為：** 深入了解 CPU 如何執行程式碼，包括指令吞吐量、快取使用率、分支預測準確度等。
* **識別效能瓶頸：** 精確定位消耗最多資源或表現出低效行為的特定函式或程式碼區段。
* **驗證優化效果：** 測量程式碼變更對效能指標的影響。
* **除錯效能問題：** 分析系統範圍或行程特定的效能特性。