---
audio: true
lang: hant
layout: post
title: 修正GitHub Workflow LaTeX 構建與 ChatGPT o1
translated: true
---

我最近在 GitHub 流程中遇到了 `fontawesome5` 套件的問題。4o-mini 提供的解決方案（使用 TeX Live 2021 和 `tlmgr install fontawesome5`）無效，但 4o 建議了一個更好的方法（使用 TeX Live 2023 並使用 `tlmgr` 安裝 `fontawesome5`），我目前正在嘗試。這並沒有完全解決問題，但從 2021 年切換到 2023 年的 TeX Live 已經有了顯著的改進。

---

## 4o-mini 答案

您看到的錯誤與 `tlmgr`（TeX Live Manager）在用戶模式下未正確初始化有關。具體來說，消息 `tlmgr: user mode not initialized, please read the documentation!` 表示 `tlmgr` 在用戶環境中未正確設置。

以下是如何修復它的分解：

### 修復 `tlmgr` 用戶模式錯誤

1. **正確設置 `tlmgr` 到用戶模式**：
   您需要明確告訴 `tlmgr` 在用戶模式下運行，並確保它被正確初始化。在您的腳本中，使用以下步驟：

   - 確保您使用的是用戶模式的 `tlmgr`，方法是設置正確的環境變量。
   - 您也可以在使用 `tlmgr` 之前初始化用戶特定的 TeX Live 目錄。

2. **在用戶模式下初始化 `tlmgr`**：
   在運行 `tlmgr` 命令之前，請確保使用以下命令初始化 `tlmgr`：
   bash
   tlmgr init-usertree
   

   這將在 `~/texmf` 中創建用戶特定的 TeX Live 樹。初始化後，您可以運行 `tlmgr update` 和 `install` 命令。

3. **修改您的 GitHub Actions 工作流程**：
   更新您的 GitHub Actions 工作流程文件以包含初始化步驟。以下是修改工作流程的示例：

   yaml
   - name: 設置 tlmgr 到用戶模式
     run: |
       # 初始化用戶模式 TeX Live 目錄
       tlmgr init-usertree
       tlmgr update --self
       tlmgr install fontawesome5
   

### 完整範例：

如果您將此作為更大 GitHub Actions 工作流程的一部分運行，您可以將這些更改合併到相關作業部分中：

yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安裝 TeX Live (xelatex)
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-xetex
          tlmgr init-usertree  # 初始化 TeX Live 用戶樹
          tlmgr update --self  # 更新 tlmgr 本身
          tlmgr install fontawesome5  # 安裝所需的包


### 命令說明：

- `tlmgr init-usertree`：這將初始化用戶特定的 TeX Live 樹（通常位於 `~/texmf`）。
- `tlmgr update --self`：將 `tlmgr` 包本身更新到最新版本。
- `tlmgr install fontawesome5`：安裝 `fontawesome5` 包。

### 其他注意事項：

- **權限**：確保運行 GitHub Actions 工作流程的用戶有權限安裝和修改 TeX Live 用戶目錄中的文件。
- **環境變量**：如果您處理自定義路徑，您可能需要調整 `TEXMFSYSVAR` 或 `TEXMFHOME` 以指向您的特定目錄。

通過確保在 GitHub Actions 工作流程中正確初始化和設置 `tlmgr` 的用戶模式，應該可以解決錯誤。請告訴我這是否有效或您是否遇到其他問題！

### o1 答案

我理解您在 GitHub Actions 工作流程中遇到 `tlmgr`（TeX Live Manager）的問題，特別是在嘗試安裝 `fontawesome5` 包時。錯誤消息：


TLPDB: not a directory, not loading: /home/runner/texmf
tlmgr: user mode not initialized, please read the documentation!
Error: Process completed with exit code 2.


表明 `tlmgr` 無法在“用戶模式”下運行，因為必要的目錄和配置未正確設置。這種情況經常發生在使用 `apt-get` 等包管理器提供的 TeX Live 安裝時，它們與 TUG（TeX Users Group）提供的完整 TeX Live 安裝相比功能有限。

為了解決這個問題，我建議**在您的 GitHub Actions 工作流程中手動安裝 TeX Live 2023**。這種方法確保 `tlmgr` 具有完整的功能，並且可以安裝其他包如 `fontawesome5` 而不會有問題。

### 逐步解決方案：

1. **移除系統 TeX Live 安裝**：
   - 避免使用 `apt-get install texlive-xetex`，因為它提供了部分 TeX Live 安裝，具有受限的 `tlmgr` 功能。

2. **手動安裝 TeX Live 2023**：
   - 直接從 TUG 下載和安裝 TeX Live。

3. **配置 PATH 環境變量**：
   - 確保 TeX Live 二進制文件可訪問，方法是更新 PATH。

4. **使用 `tlmgr` 安裝所需的包**：
   - 更新 `tlmgr` 並安裝 `fontawesome5`。

5. **使用緩存優化工作流程（可選）**：
   - 緩存 TeX Live 安裝以加速未來的工作流程運行。

### 更新的 GitHub Actions 工作流程：

以下是更新的 GitHub Actions 工作流程版本，其中包含手動安裝 TeX Live 2023 並正確設置 `tlmgr` 以安裝 `fontawesome5` 包。

yaml
name: Deploy Jekyll with GitHub Pages dependencies preinstalled

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  awesome-cv-copy:
    runs-on: ubuntu-latest
    steps:
      - name: 檢查存儲庫
        uses: actions/checkout@v4

      - name: 設置 Make
        run: sudo apt-get update && sudo apt-get install -y make

      - name: 緩存 TeX Live
        uses: actions/cache@v3
        with:
          path: /usr/local/texlive/2023
          key: ${{ runner.os }}-texlive-2023
          restore-keys: |
            ${{ runner.os }}-texlive-

      - name: 安裝 TeX Live 2023
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        run: |
          # 安裝 TeX Live 安裝程序的依賴項
          sudo apt-get update
          sudo apt-get install -y perl wget xz-utils

          # 下載 TeX Live 安裝程序
          wget http://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -xzf install-tl-unx.tar.gz
          cd install-tl-*/

          # 創建一個 texlive.profile 以進行自動化安裝
          cat <<EOF > texlive.profile
          selected_scheme scheme-full
          TEXDIR /usr/local/texlive/2023
          TEXMFCONFIG ~/.texlive2023/texmf-config
          TEXMFHOME ~/texmf
          TEXMFLOCAL /usr/local/texlive/2023/texmf-local
          TEXMFSYSCONFIG /usr/local/texlive/2023/texmf-config
          TEXMFSYSVAR /usr/local/texlive/2023/texmf-var
          binary_x86_64-linux 1
          collection-basic 1
          collection-latex 1
          collection-fontsrecommended 1
          EOF

          # 使用配置文件運行安裝程序
          sudo ./install-tl --profile=texlive.profile

      - name: 將 TeX Live 添加到 PATH
        run: echo "/usr/local/texlive/2023/bin/x86_64-linux" >> $GITHUB_PATH

      - name: 更新 tlmgr 並安裝 fontawesome5
        run: |
          tlmgr update --self
          tlmgr install fontawesome5

      - name: 運行 make awesome-cv-copy
        run: make awesome-cv-copy

  build:
    runs-on: ubuntu-latest
    needs: awesome-cv-copy
    steps:
      - name: 檢查存儲庫
        uses: actions/checkout@v4

      - name: 設置 Python 3
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安裝依賴項
        run: |
          python -m pip install --upgrade pip
          pip install python-frontmatter

      - name: 生成筆記鏈接
        run: |
          python scripts/generate_notes_link.py

      - name: 設置 Pages
        uses: actions/configure-pages@v5

      - name: 使用 Jekyll 構建
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: 上傳構件
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


### 詳細說明：

1. **檢查存儲庫**：
   - 使用 `actions/checkout@v4` 操作克隆您的存儲庫。

2. **設置 Make**：
   - 使用 `apt-get` 安裝 `make`，確保它可用於構建您的簡歷。

3. **緩存 TeX Live**：
   - 利用 `actions/cache@v3` 緩存位於 `/usr/local/texlive/2023` 的 TeX Live 安裝。這大大縮短了後續工作流程運行的安裝時間。

4. **安裝 TeX Live 2023**：
   - **條件執行**：`if: steps.cache-texlive.outputs.cache-hit != 'true'` 條件確保只有在未緩存 TeX Live 時才安裝。
   - **安裝依賴項**：安裝必要的依賴項如 Perl、`wget` 和 `xz-utils`。
   - **下載和提取安裝程序**：從 CTAN 下載最新的 TeX Live 安裝程序並提取。
   - **創建安裝配置文件**：創建 `texlive.profile` 以自動安裝過程。此配置文件指定：
     - **`selected_scheme scheme-full`**：安裝完整的 TeX Live 發行版。如果需要，您可以將其調整為最小方案。
     - **目錄**：指定安裝 TeX Live 及其配置的位置。
     - **收藏**：選擇基本集合如 `basic`、`latex` 和 `fontsrecommended`。
   - **運行安裝程序**：使用指定的配置文件執行安裝程序，將 TeX Live 2023 安裝到 `/usr/local/texlive/2023`。

5. **將 TeX Live 添加到 PATH**：
   - 通過附加 TeX Live 二進制文件目錄來更新 `PATH` 環境變量。這確保 `tlmgr` 和其他 TeX Live 命令在後續步驟中可訪問。

6. **更新 tlmgr 並安裝 `fontawesome5`**：
   - **更新 `tlmgr`**：確保 `tlmgr` 本身是最新的。
   - **安裝 `fontawesome5`**：使用 `tlmgr` 安裝 `fontawesome5` 包，解決您的初始問題。

7. **運行 Make 命令**：
   - 執行 `make awesome-cv-copy` 以使用安裝的 TeX Live 設置構建您的簡歷。

8. **構建和部署作業**：
   - 這些基本保持不變，但確保 TeX Live 安裝在整個工作流程中可用，因為更新了 PATH。

### 其他建議：

- **TeX Live 安裝時間**：
  - **緩存**：包含 `actions/cache@v3` 步驟有助於緩解首次運行後的冗長安裝時間。確保緩存鍵（`${{ runner.os }}-texlive-2023`）準確反映 TeX Live 版本，以避免緩存不匹配。

- **自定義 TeX Live 安裝**：
  - 如果您不需要完整的 TeX Live 發行版，您可以修改 `texlive.profile` 以僅安裝特定的集合，從而縮短安裝時間和磁盤使用量。例如，將 `scheme-full` 替換為 `scheme-basic`，並僅指定必要的集合。

- **驗證安裝**：
  - 要確保 TeX Live 安裝正確，您可以添加驗證步驟：
    yaml
    - name: 驗證 TeX Live 安裝
      run: |
        tex --version
        tlmgr --version
        kpsewhich fontawesome5.sty
    
    此步驟可幫助診斷問題，確認 TeX Live 命令可訪問，並且 `fontawesome5.sty` 已安裝。

- **正確處理 PATH**：
  - 使用 `echo "/usr/local/texlive/2023/bin/x86_64-linux" >> $GITHUB_PATH` 確保將 TeX Live 二進制文件添加到作業的後續步驟的 PATH 中。這是 `tlmgr` 和 LaTeX 命令正常工作的關鍵。

### 故障排除技巧：

1. **緩存未命中問題**：
   - 確保緩存鍵準確反映 TeX Live 版本。如果您更新了 TeX Live 或更改了安裝路徑，請相應更新緩存鍵。

2. **安裝失敗**：
   - 檢查 GitHub Actions 日誌以查找安裝過程中的任何錯誤。常見問題包括下載安裝程序時的網絡問題或權限不足。

3. **包安裝錯誤**：
   - 如果 `tlmgr` 無法安裝 `fontawesome5`，請確認包名稱正確，並且該包在 TeX Live 存儲庫中可用。

4. **PATH 問題**：
   - 確保 PATH 更新正確。您可以添加一步來打印 PATH 以進行調試：
     yaml
     - name: 打印 PATH
       run: echo $PATH
     

5. **磁盤空間限制**：
   - GitHub Actions 運行器具有有限的磁盤空間。完整的 TeX Live 安裝可能會佔用大量空間。如果您遇到磁盤空間問題，請考慮安裝最小的 TeX Live 設置。

### 最終工作流程示例與驗證：

以下是更全面的工作流程示例，包括驗證步驟以確保一切設置正確：

yaml
name: Deploy Jekyll with GitHub Pages dependencies preinstalled

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  awesome-cv-copy:
    runs-on: ubuntu-latest
    steps:
      - name: 檢查存儲庫
        uses: actions/checkout@v4

      - name: 設置 Make
        run: sudo apt-get update && sudo apt-get install -y make

      - name: 緩存 TeX Live
        uses: actions/cache@v3
        with:
          path: /usr/local/texlive/2023
          key: ${{ runner.os }}-texlive-2023
          restore-keys: |
            ${{ runner.os }}-texlive-

      - name: 安裝 TeX Live 2023
        if: steps.cache-texlive.outputs.cache-hit != 'true'
        run: |
          # 安裝 TeX Live 安裝程序的依賴項
          sudo apt-get update
          sudo apt-get install -y perl wget xz-utils

          # 下載 TeX Live 安裝程序
          wget http://mirror.ctan.org/systems/texlive/tlnet/install-tl-unx.tar.gz
          tar -xzf install-tl-unx.tar.gz
          cd install-tl-*/

          # 創建一個 texlive.profile 以進行自動化安裝
          cat <<EOF > texlive.profile
          selected_scheme scheme-full
          TEXDIR /usr/local/texlive/2023
          TEXMFCONFIG ~/.texlive2023/texmf-config
          TEXMFHOME ~/texmf
          TEXMFLOCAL /usr/local/texlive/2023/texmf-local
          TEXMFSYSCONFIG /usr/local/texlive/2023/texmf-config
          TEXMFSYSVAR /usr/local/texlive/2023/texmf-var
          binary_x86_64-linux 1
          collection-basic 1
          collection-latex 1
          collection-fontsrecommended 1
          EOF

          # 使用配置文件運行安裝程序
          sudo ./install-tl --profile=texlive.profile

      - name: 將 TeX Live 添加到 PATH
        run: echo "/usr/local/texlive/2023/bin/x86_64-linux" >> $GITHUB_PATH

      - name: 驗證 TeX Live 安裝
        run: |
          tex --version
          tlmgr --version
          kpsewhich fontawesome5.sty || echo "fontawesome5.sty 未找到"

      - name: 更新 tlmgr 並安裝 fontawesome5
        run: |
          tlmgr update --self
          tlmgr install fontawesome5

      - name: 驗證 fontawesome5 安裝
        run: kpsewhich fontawesome5.sty

      - name: 運行 make awesome-cv-copy
        run: make awesome-cv-copy

  build:
    runs-on: ubuntu-latest
    needs: awesome-cv-copy
    steps:
      - name: 檢查存儲庫
        uses: actions/checkout@v4

      - name: 設置 Python 3
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安裝依賴項
        run: |
          python -m pip install --upgrade pip
          pip install python-frontmatter

      - name: 生成筆記鏈接
        run: |
          python scripts/generate_notes_link.py

      - name: 設置 Pages
        uses: actions/configure-pages@v5

      - name: 使用 Jekyll 構建
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: 上傳構件
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


### 關鍵增強：

1. **驗證步驟**：
   - **驗證 TeX Live 安裝**：確保 `tex`、`tlmgr` 和 `fontawesome5.sty` 可訪問。
   - **驗證 `fontawesome5` 安裝**：確認 `fontawesome5.sty` 文件安裝正確。

2. **改進緩存**：
   - **緩存鍵準確性**：緩存鍵基於操作系統和 TeX Live 版本，確保對 TeX Live 的更改需要新的緩存。

3. **錯誤處理**：
   - **後備消息**：`kpsewhich fontawesome5.sty || echo "fontawesome5.sty 未找到"` 命令在未找到包時提供後備消息，有助於調試。

### 其他提示：

- **最小 TeX Live 安裝**：
  - 如果完整的 TeX Live 安裝過於耗時或佔用大量空間，請考慮安裝最小方案並僅添加必要的包。
  - 相應更新 `texlive.profile`：
    yaml
    selected_scheme scheme-basic
    collection-latexrecommended 1
    collection-fontsrecommended 1
    collection-fontsextra 1
    collection-luatex 1
    

- **並行化作業**：
  - 根據工作流程的複雜性，您可能考慮並行化作業或在作業之間重用步驟以優化運行時間。

- **處理 TeX Live 更新**：
  - 定期更新 `tlmgr` 和 TeX Live 以確保兼容性和訪問最新的包。

### 結論：

通過在 GitHub Actions 工作流程中手動安裝 TeX Live 2023 並正確配置環境，您可以克服與系統安裝的 TeX Live 包相關的限制和錯誤。這種設置提供了完整的 `tlmgr` 功能，允許您無縫安裝其他 LaTeX 包如 `fontawesome5`。

如果您繼續遇到問題，請提供更詳細的日誌或具體的錯誤消息，我將很樂意進一步幫助！

## 更新

yml
name: Test LaTeX

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  test_latex:
    runs-on: ubuntu-latest
    steps:
      - name: 檢查存儲庫
        uses: actions/checkout@v4
      - name: 安裝 Microsoft 核心字體
        run: |
          sudo apt-get install -y ttf-mscorefonts-installer
          fc-cache -fv

      - name: 列出已安裝的字體
        run: fc-list

      - name: 設置 TeX Live
        uses: teatimeguest/setup-texlive-action@v3
        with:
          packages: |
            xeCJK
            etoolbox
            adjustbox
            roboto
            sourcesanspro
            fontawesome5
            tcolorbox
            setspace
            unicode-math
            fancyvrb
            olyglossia
            polyglossia

      - name: 安裝 pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: 設置 Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: 安裝依賴項
        run: |
          pip install -r requirements.txt

      - name: 生成 PDF
        run: |
          pandoc '_posts/en/2025-01-13-gitmessageai-en.md' -o test.pdf -f markdown --pdf-engine xelatex -V CJKmainfont='DejaVu Sans' -V geometry:margin=1in -V classoption=16pt -V CJKoptions=Scale=1.1 -V linestretch=1.5


最終，嘗試了上述方法後，DeepSeek 修復了問題。