---
audio: false
generated: true
lang: hant
layout: post
title: Python 的 C 外部函式庫介面
translated: true
type: note
---

當你執行 Python 腳本 `fetch.py` 並使用指令 `python scripts/supabase/fetch.py` 時，遇到了以下錯誤：

```
ModuleNotFoundError: No module named '_cffi_backend'
```

這個錯誤，以及隨後的 Rust panic 和追蹤資訊，表明 Python 直譯器無法找到 `_cffi_backend` 模組，該模組是 `cffi` 函式庫的關鍵組件。`cffi` 函式庫是 `cryptography` 套件的依賴項，而 `cryptography` 又被你的腳本中的 `supabase` 客戶端所使用。下面，我將解釋此問題並提供逐步解決方案來解決它。

---

### 錯誤原因

`_cffi_backend` 模組是 `cffi` 函式庫的一部分，它使 Python 能夠與 C 程式碼互動。`cryptography` 函式庫是 `jwt` 和 `supabase` 的依賴項，它依賴 `cffi` 來執行加密操作。追蹤資訊顯示，錯誤源自 `cryptography` 嘗試導入 Rust 綁定時：

```
File "/usr/lib/python3/dist-packages/cryptography/hazmat/_oid.py", line 9, in <module>
    from cryptography.hazmat.bindings._rust import (
        ObjectIdentifier as ObjectIdentifier,
    )
pyo3_runtime.PanicException: Python API call failed
```

`_cffi_backend` 的 `ModuleNotFoundError` 表明 `cffi` 可能未安裝、未正確建置，或與你的 Python 環境不相容。這觸發了 Rust 綁定的失敗，導致 panic 並停止執行。

---

### 如何解決問題

請按照以下步驟解決錯誤並讓你的 Supabase 腳本正常執行：

#### 1. **檢查並安裝 `cffi` 函式庫**
`cffi` 函式庫可能遺失或未正確安裝。請驗證其是否存在，並在必要時安裝它。

- **檢查 `cffi` 是否已安裝：**
  ```bash
  pip show cffi
  ```
  如果 `cffi` 套件已安裝在你的當前 Python 環境中，此指令將顯示相關資訊。

- **安裝或重新安裝 `cffi`：**
  如果 `cffi` 未安裝，或者可能已損毀，請執行：
  ```bash
  pip install cffi
  ```
  為了確保乾淨安裝，你可以解除安裝並重新安裝它：
  ```bash
  pip uninstall cffi
  pip install cffi
  ```

#### 2. **安裝系統依賴項**
`cffi` 函式庫需要某些系統層級的依賴項來建置其 C 後端（`_cffi_backend`）。在 Ubuntu 上（根據你的提示 `lzwjava@lzwjava-XiaoXin-14-IAH8`），安裝 `libffi-dev` 套件：

```bash
sudo apt-get update
sudo apt-get install libffi-dev
```

此套件提供了 `libffi` 的開發檔案，這是 `cffi` 編譯其後端所需的。

#### 3. **驗證 Python 版本和環境**
你的追蹤資訊顯示了路徑如 `/home/lzwjava/.local/lib/python3.13/site-packages/` 和 `/usr/lib/python3/dist-packages/`，表明你正在使用 Python 3.13，並且可能安裝了多個 Python 版本。

- **確保你目標使用正確的 Python 版本：**
  使用明確的 Python 版本執行你的腳本，以避免衝突：
  ```bash
  python3.13 scripts/supabase/fetch.py
  ```
  使用相同的 Python 版本進行套件安裝：
  ```bash
  python3.13 -m pip install cffi
  ```

- **考慮使用虛擬環境：**
  為了避免系統範圍和用戶安裝的套件之間的衝突，請設定虛擬環境：
  ```bash
  python3.13 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
  然後執行你的腳本：
  ```bash
  python scripts/supabase/fetch.py
  ```

#### 4. **重新安裝相關套件**
`supabase` 客戶端依賴於 `cryptography` 和 `jwt`，這兩者都依賴於 `cffi`。重新安裝這些套件可確保它們與你的環境相容：

```bash
pip uninstall cryptography jwt supabase
pip install cryptography jwt supabase
```

#### 5. **檢查 Python 3.13 相容性**
Python 3.13 是一個較新的版本，某些套件（例如 `cryptography`）可能尚未完全與之測試相容。如果問題持續存在，請考慮切換到更穩定的版本，如 Python 3.11：

- 安裝 Python 3.11（在 Ubuntu 上）：
  ```bash
  sudo apt-get install python3.11 python3.11-dev python3.11-venv
  ```
- 使用 Python 3.11 建立虛擬環境：
  ```bash
  python3.11 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
- 再次執行你的腳本。

#### 6. **除錯持續性問題**
如果錯誤仍然存在，請收集更多詳細資訊：
- 使用 Rust backtrace 執行以獲取額外上下文：
  ```bash
  RUST_BACKTRACE=1 python scripts/supabase/fetch.py
  ```
- 檢查你的 `PYTHONPATH` 是否有衝突：
  ```bash
  echo $PYTHONPATH
  ```
  如果已設定，請確保它不會干擾套件位置。

---

### 為什麼這應該有效

該錯誤源於遺失或配置錯誤的 `cffi` 函式庫，這破壞了 `cryptography` 套件載入其 Rust 綁定的能力。通過確保 `cffi` 已安裝、系統依賴項已滿足，並且你的 Python 環境一致，`_cffi_backend` 模組應該會變得可用，從而讓你的腳本成功執行。

---

### 最後步驟
在應用這些修復後，再次測試你的腳本：
```bash
python scripts/supabase/fetch.py
```

如果你仍然遇到問題，請分享更新後的錯誤訊息，我們可以進一步完善解決方案。編程愉快！