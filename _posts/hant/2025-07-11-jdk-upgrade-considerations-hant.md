---
audio: false
generated: true
lang: hant
layout: post
title: 升級舊有程式碼庫至較新版本JDK
translated: true
type: note
---

將大型程式碼庫（數萬行程式碼）從 JDK 8 和 Spring 5.2.2 升級至較新的 JDK（如 11、17 或 21）需要謹慎規劃，以盡量減少中斷情況，特別是考慮到使用 IBM DB2 JCC 驅動程式、高度依賴 Spring 框架，以及部署至 WebSphere Liberty 的環境。以下將概述關鍵考量因素，包括相容性、潛在的中斷性變更、遷移步驟和建議。既然您提到可以同時升級 Spring，我將涵蓋可能需要或有益於升級 Spring 的情境。

### JDK 升級的通用考量
- **向後相容性與中斷性變更**：Java 力求保持強大的向後相容性，但從 JDK 8 升級會引入可能影響程式碼的變更：
  - **移除/棄用的 API**：JDK 9+ 移除了內部 API，如 `sun.misc.Unsafe` 和部分 `sun.*` 套件。若您的程式碼（或依賴庫）使用這些，需尋找替代方案（例如透過第三方函式庫的 `Unsafe` 替代方案或 Java 的 `VarHandle`）。
  - **模組系統（JPMS，自 JDK 9 起）**：封裝了內部 API，可能導致「非法存取」錯誤。可暫時使用 `--add-opens` 或 `--add-exports` 參數，但應重構程式碼以實現模組化。
  - **垃圾回收機制變更**：預設 GC 從 JDK 9 的 Parallel 改為 G1，後續版本還有進一步調整（例如 JDK 11+ 的 Shenandoah 或 ZGC）。需測試對記憶體密集型部分的效能影響。
  - **其他變更**：更嚴格的封裝、移除 Applet/瀏覽器外掛支援、更新安全管理器（JDK 17 棄用，21 移除），以及語言功能如紀錄類別（14+）、密封類別（17）和虛擬執行緒（21）。這些大多為新增功能，但若大量使用反射機制可能需要程式碼調整。
  - 從 8 到 11：中度變更（例如移除 Java EE 模組如 JAXB，這些在 JDK 9 被移除；需將其添加為依賴項）。
  - 從 11 到 17：較少中斷，主要是增強功能如改進的模式匹配。
  - 從 17 到 21：極少中斷性變更；主要是新功能如 switch 的模式匹配（21）且無重大移除。
- **逐步遷移**：不要直接跳至 21。應逐步升級（例如 8 → 11 → 17 → 21）以隔離問題。使用 OpenRewrite 或 jdeps 等工具掃描不相容處。
- **測試與工具**：
  - 在新 JDK 上執行全面測試（單元、整合、負載測試）。可使用 Maven/Gradle 外掛（如 `maven-enforcer-plugin`）強制執行相容性。
  - 更新建置工具：確保 Maven/Gradle 支援新 JDK（多數支援，但需驗證外掛如 Surefire）。
  - 多版本測試：使用 Docker 或 CI/CD（如 GitHub Actions）測試多個 JDK 版本。
- **依賴項與函式庫**：掃描所有第三方函式庫的相容性。使用 `mvn dependency:tree` 或 OWASP Dependency-Check 等工具。
- **效能與安全性**：較新的 JDK 提供更好的效能（例如 17+ 的更快啟動速度）、安全性修復和長期支援（LTS：11 支援至 2026，17 至 2029，21 至 2031+）。
- **大型程式碼庫的工作量**：由於高度使用 Spring，需專注於 Spring 管理的組件（例如 Bean、AOP）。預留重構時間（例如每個主要版本跳躍需 1-2 週，隨程式碼規模調整）。

### 按目標 JDK 的具體考量
#### 升級至 JDK 11
- **優點**：LTS 版本穩定性佳；更接近 JDK 8，變更較少。生命週期即將結束（2026），但仍廣泛支援。
- **缺點**：缺少現代功能如虛擬執行緒（21）或改進的 GC（17+）。
- **Spring 相容性**：Spring 5.2.2 可在 JDK 11 上運行，但建議升級至 Spring 5.3.x（5.x 系列最新版）以獲得更好的 JDK 11/17 支援和錯誤修復。無需重大 Spring 變更。
- **DB2 JCC 驅動程式**：與近期驅動程式版本（如 4.x+）相容。部分舊版驅動程式在 OpenJDK 11 上有問題，因此請更新至最新版（例如從 IBM 網站下載）並測試連線。
- **WebSphere Liberty**：完全支援（Liberty 可在 JDK 8/11/17/21 上運行）。
- **JDK 8 的主要變更**：
  - 為移除的模組添加依賴項（例如 JAXB 的 `javax.xml.bind:jaxb-api`）。
  - 修復任何非法反射存取（常見於舊版函式庫）。
  - 遷移方法：更新建置檔案（例如 Maven 的 `<java.version>11</java.version>`），重新編譯並執行測試。使用 Oracle 的 JDK 11 遷移指南進行逐步檢查。
- **工作量**：低至中度；若未使用內部 API，則程式碼變更極少。

#### 升級至 JDK 17
- **優點**：當前 LTS 版本，採用率高；包含文字區塊、紀錄類別和增強 switch 等功能。效能優於 11。
- **缺點**：SecurityManager 已棄用（若使用，需規劃移除）。部分函式庫可能需要更新。
- **Spring 相容性**：Spring 5.3.x 完全支援 JDK 17（已在 LTS 版本測試）。從 5.2.2 升級至 5.3.x 以獲得最佳相容性—Spring 本身無中斷性變更。
- **DB2 JCC 驅動程式**：近期版本（如 JCC 4.29+ 對應 DB2 11.5）明確支援。IBM 文件確認 JDK 17 運行時支援；需測試任何 SQLJ 增強功能。
- **WebSphere Liberty**：完全支援。
- **JDK 11 的主要變更**：
  - 更嚴格的封裝；對棄用功能發出更多警告。
  - 新 API（例如用於 HTTP/2 客戶端的 `java.net.http`）可現代化程式碼，但非強制要求。
  - 遷移方法：在 JDK 11 之後，於建置中切換至 17。使用遷移指南檢查 Applet/CORBA 移除（若有）。
- **工作量**：中度；基於 JDK 11 遷移的基礎上進行。

#### 升級至 JDK 21
- **優點**：最新 LTS 版本，具尖端功能（例如用於並行的虛擬執行緒、序列化集合）。最適合未來驗證。
- **缺點**：需升級 Spring（見下文）；極舊函式庫可能出現問題。
- **Spring 相容性**：Spring 5.x 不官方支援 JDK 21（最高支援至 JDK 17）。必須升級至 Spring 6.1+（其要求 JDK 17+ 基準）。這是重大轉變：
  - **Jakarta EE 遷移**：Spring 6 從 Java EE（javax.*）切換至 Jakarta EE 9+（jakarta.*）。需變更導入（例如 `javax.servlet` → `jakarta.servlet`），更新配置，並重構任何 EE 相關程式碼（例如 JPA、Servlets、JMS）。
  - **中斷性變更**：移除棄用的 API（例如舊版交易管理器）；支援 AOT 編譯；需更新依賴項如 Hibernate（至 6.1+）。
  - **遷移指南**：遵循 Spring 官方指南：先升級至 Spring 5.3.x，再至 6.0/6.1。使用 OpenRewrite 配方等工具自動化 javax → jakarta 替換。對大型程式碼庫而言，可能涉及數百項變更—需分模組測試。
  - 若使用 Spring Boot（由 Spring 使用推斷），Boot 3.x 與 Spring 6 和 JDK 17+ 對齊。
- **DB2 JCC 驅動程式**：透過與 JDK 17 支援的向後相容性實現相容；更新至最新驅動程式（如 4.32+）並驗證。
- **WebSphere Liberty**：完全支援（最高至 JDK 24）。
- **JDK 17 的主要變更**：
  - SecurityManager 已移除；若使用，需替換為替代方案。
  - 新功能如字串模板（預覽）不會破壞現有程式碼。
  - 遷移方法：先基於 JDK 17 建置，再切換。17 至 21 之間無重大刻意中斷性變更。
- **工作量**：若升級 Spring 則為高度；否則與 17 相似。

### 其他專案特定考量
- **IBM DB2 JCC 函式庫**：確保驅動程式版本與 DB2 發布版匹配（例如 DB2 11.5 使用 JCC 4.29+）。測試 JDBC 連線、SQLJ 和任何自訂查詢—較新的 JDK 可能暴露字元集或時區問題。
- **WebSphere Liberty 部署**：無阻礙；Liberty 對 JDK 具彈性。若需模組問題的 JVM 參數（例如 `--add-opens`），請更新 server.xml。及早測試部署。
- **大型程式碼庫與 Spring 使用**：優先進行模組化升級（例如先升級核心服務）。若 Spring 深度整合（例如 MVC、Data、Security），需稽核 5.2.2 中棄用的功能。升級 Spring 帶來如更好 AOT 和可觀測性等好處，但增加成本。
- **風險與緩解措施**：不相容導致的停機時間；透過回滾計畫緩解。若使用商業版 DB2/Liberty，需預算供應商支援費用。
- **成本**：時間（完整遷移需數週至數月）、潛在授權（例如 Oracle 等商業 JDK）及新功能培訓。

### 建議
- **首選路徑**：從 JDK 11 或 17 開始，同時保持/升級至 Spring 5.3.x—對程式碼庫風險較低。僅在需要 JDK 21 功能（如虛擬執行緒）且願意升級至 Spring 6 時才選擇 21（由於 Jakarta 變更，可能耗費大量精力）。
- **後續步驟**：
  1. 使用 jdeps/jlink 掃描程式碼問題。
  2. 設立分支進行遷移測試。
  3. 參考官方指南：Oracle JDK 遷移指南、Spring 版本 Wiki、IBM DB2 JDBC 下載、Liberty Java 支援。
  4. 若升級 Spring 至 6，遵循遷移指南處理 Jakarta 變更。

若您提供更多細節（例如特定 Spring 模組或 DB2 版本），我可進一步細化建議。