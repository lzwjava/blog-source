---
audio: false
generated: true
lang: hant
layout: post
title: 使用 VisualVM 分析 Java 應用程式
translated: true
type: note
---

這是一份清晰簡潔的 **VisualVM 使用指南**，幫助您監控和分析 Java 應用程式。VisualVM 是 JDK 內附的免費強大工具，能協助分析 Java 應用程式的效能、記憶體使用情況和線程活動。

---

### 步驟 1：安裝與啟動 VisualVM
- **檢查是否已安裝**：VisualVM 通常隨 JDK（版本 6 update 7 及更高版本）提供。請在 JDK 安裝目錄的 `bin` 資料夾中尋找（例如 Windows 系統的 `jdk/bin/visualvm.exe`）。
- **如需下載**：若未包含在 JDK 中，請從 [VisualVM 官方網站](https://visualvm.github.io/)下載。
- **啟動 VisualVM**：執行 `visualvm` 可執行檔。啟動後，您將看到本地機器上當前運行的 Java 程序列表。

---

### 步驟 2：連接至 Java 應用程式
- **本地應用程式**：VisualVM 會自動偵測本機運行的 Java 程序。雙擊要監控的程序即可連接。
- **遠端應用程式**：要監控其他機器上的 Java 程序：
  1. 啟動遠端 JVM 時需啟用 JMX（例如在 JVM 參數中加入 `-Dcom.sun.management.jmxremote`）。
  2. 在 VisualVM 左側面板右鍵點擊 **Remote**，選擇 **Add Remote Host**，輸入遠端機器的詳細資料。
  3. 連接成功後，選擇要監控的遠端程序。

---

### 步驟 3：監控應用程式效能
連接後，**Overview** 標籤頁會顯示基本資訊，如程序 ID 和 JVM 參數。切換至 **Monitor** 標籤頁可查看即時效能數據：
- **CPU 使用率**：追蹤應用程式的 CPU 使用量。
- **記憶體使用率**：顯示堆積記憶體和元空間的消耗趨勢。
- **線程**：顯示活躍線程的數量。
- **垃圾回收**：監控 GC 活動。

這些圖表能讓您全面掌握應用程式的健康狀態。

---

### 步驟 4：分析 CPU 與記憶體使用情況
要進行深度分析，請使用 **Profiler** 標籤頁：
- **CPU 分析**：識別消耗最多 CPU 時間的方法。
  1. 進入 **Profiler** 標籤頁，點擊 **CPU**。
  2. 點擊 **Start** 開始分析。
  3. 操作您的應用程式以產生待分析的工作負載。
  4. 點擊 **Stop** 後查看結果，找出最耗時的方法。
- **記憶體分析**：追蹤物件分配並檢測記憶體泄漏。
  1. 在 **Profiler** 標籤頁點擊 **Memory**。
  2. 點擊 **Start**，操作應用程式後點擊 **Stop**。
  3. 檢查物件數量與大小，找出潛在記憶體問題。

**注意**：分析會增加系統負擔，請在開發或測試環境中使用，勿用於生產環境。

---

### 步驟 5：分析堆積轉儲與線程轉儲
- **堆積轉儲**：擷取記憶體快照進行詳細分析。
  1. 在 **Monitor** 標籤頁點擊 **Heap Dump**。
  2. 於 **Classes** 或 **Instances** 視圖中檢視物件分配情況。
  3. 留意異常模式（例如過多物件）以判斷是否存在記憶體泄漏。
- **線程轉儲**：診斷死結等線程問題。
  1. 在 **Threads** 標籤頁點擊 **Thread Dump**。
  2. 檢查線程狀態（如 RUNNABLE、WAITING）以識別問題。

---

### 步驟 6：探索進階功能
- **取樣器**：位於 **Sampler** 標籤頁，提供輕量級 CPU 與記憶體分析，比完整分析的負擔更小。
- **Visual GC**：透過 **Tools > Plugins** 安裝 Visual GC 外掛，可視化垃圾回收行為。
- **MBeans**：使用 **MBeans** 標籤頁檢視和管理 JMX bean 以獲取自訂指標。

---

### 最佳實踐
- **避免在生產環境分析**：分析會拖慢應用程式速度，請僅在開發或測試環境使用。
- **從簡入手**：先使用 **Monitor** 標籤頁建立基準數據，再進行深度分析。
- **鎖定特定問題**：針對可疑問題區域進行分析以降低系統負擔。
- **檢視 GC 數據**：分析垃圾回收統計數據以優化記憶體使用。

---

### 疑難排解
- **應用程式未顯示**：請確認應用程式使用相容的 JVM 運行，且 VisualVM 具有存取權限。
- **遠端連接問題**：確認遠端 JVM 已配置 JMX 且網路設定（如防火牆）允許連接。
- **效能影響**：若分析速度過慢，可改用 **Sampler** 作為輕量替代方案。

---

VisualVM 是理解和優化 Java 應用程式的絕佳工具。遵循以上步驟即可有效監控效能、分析瓶頸並診斷問題。詳情請參閱 [VisualVM 官方文件](https://visualvm.github.io/documentation.html)。