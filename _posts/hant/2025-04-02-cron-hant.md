---
audio: false
generated: true
lang: hant
layout: post
title: Cron 完整指南
translated: true
type: note
---

Cron 是類 Unix 作業系統中一個強大的基於時間的任務排程器，允許使用者設定指令或腳本在指定時間或間隔自動執行。以下是一份完整指南，幫助您有效理解並使用 cron。

## 什麼是 Cron？

Cron 是一個守護程式（背景服務），用於執行排程指令。它讀取名為「crontabs」（cron 表格）的設定檔，以決定何時執行特定指令。Cron 非常適合用於：
- 例行系統維護
- 自動化備份
- 排程定期資料處理
- 在特定時間執行腳本
- 任何需要定期執行而無需手動介入的任務

## Cron 組件

### Crontab 檔案

Crontab（cron 表格）是一個設定檔，用於指定定期執行的 shell 指令。每位使用者都可以擁有自己的 crontab，同時也存在系統級的 crontab。

要編輯您的個人 crontab：
```bash
crontab -e
```

要檢視您當前的 crontab：
```bash
crontab -l
```

要移除您的 crontab：
```bash
crontab -r
```

### Crontab 語法

crontab 檔案中的每一行代表一個排程任務，並遵循以下格式：

```
* * * * * command-to-execute
│ │ │ │ │
│ │ │ │ └─── 星期幾 (0-6, 星期日=0)
│ │ │ └───── 月份 (1-12)
│ │ └─────── 日期 (1-31)
│ └───────── 小時 (0-23)
└─────────── 分鐘 (0-59)
```

每個位置可以包含：
- 一個特定數字
- 一個範圍（例如 `1-5`）
- 一個值列表（例如 `1,3,5`）
- 一個星號（`*`）表示「每」
- 一個步進值（`*/n`）表示「每 n」

五個時間/日期欄位之後是要執行的指令。

## 常見 Cron 排程範例

# 常見 Cron 排程範例

## 基本時間間隔

| Cron 表達式 | 描述 | 範例 |
|----------------|-------------|---------|
| `* * * * *` | 每分鐘執行 | `* * * * * date >> /tmp/date_log.txt` |
| `*/5 * * * *` | 每 5 分鐘執行 | `*/5 * * * * /scripts/check_server.sh` |
| `0 * * * *` | 每小時開始時執行 | `0 * * * * /scripts/hourly_backup.sh` |
| `0 0 * * *` | 每日午夜執行 | `0 0 * * * /scripts/daily_backup.sh` |
| `0 0 * * 0` | 每星期日午夜執行 | `0 0 * * 0 /scripts/weekly_maintenance.sh` |
| `0 0 1 * *` | 每月第一天午夜執行 | `0 0 1 * * /scripts/monthly_report.sh` |
| `0 0 1 1 *` | 每年 1 月 1 日午夜執行 | `0 0 1 1 * /scripts/yearly_cleanup.sh` |

## 特定時間

| Cron 表達式 | 描述 | 範例 |
|----------------|-------------|---------|
| `30 8 * * 1-5` | 週一至週五上午 8:30 執行 | `30 8 * * 1-5 /scripts/workday_start.sh` |
| `0 18 * * 1-5` | 週一至週五下午 6:00 執行 | `0 18 * * 1-5 /scripts/workday_end.sh` |
| `0 9-17 * * *` | 營業時間（上午 9 點至下午 5 點）每小時開始時執行 | `0 9-17 * * * /scripts/hourly_check.sh` |
| `0 0,12 * * *` | 午夜和中午執行 | `0 0,12 * * * /scripts/twice_daily.sh` |

## 多重時間規格

| Cron 表達式 | 描述 | 範例 |
|----------------|-------------|---------|
| `0 */4 * * *` | 每 4 小時執行 | `0 */4 * * * /scripts/periodic_task.sh` |
| `0 4,16 * * *` | 上午 4:00 和下午 4:00 執行 | `0 4,16 * * * /scripts/twice_daily_at_4.sh` |
| `15,45 * * * *` | 每小時的第 15 和 45 分鐘執行 | `15,45 * * * * /scripts/quarter_hourly.sh` |

## 特殊時間規格

| Cron 表達式 | 描述 | 範例 |
|----------------|-------------|---------|
| `@reboot` | 啟動時執行一次 | `@reboot /scripts/startup_task.sh` |
| `@yearly` 或 `@annually` | 每年執行一次（等同於 `0 0 1 1 *`） | `@yearly /scripts/annual_task.sh` |
| `@monthly` | 每月執行一次（等同於 `0 0 1 * *`） | `@monthly /scripts/monthly_task.sh` |
| `@weekly` | 每週執行一次（等同於 `0 0 * * 0`） | `@weekly /scripts/weekly_task.sh` |
| `@daily` 或 `@midnight` | 每日執行一次（等同於 `0 0 * * *`） | `@daily /scripts/daily_task.sh` |
| `@hourly` | 每小時執行一次（等同於 `0 0 * * *`） | `@hourly /scripts/hourly_task.sh` |

## 複雜範例

| Cron 表達式 | 描述 | 範例 |
|----------------|-------------|---------|
| `0 0 */2 * *` | 每隔一日午夜執行 | `0 0 */2 * * /scripts/every_other_day.sh` |
| `0 3 * * 1,3,5` | 每週一、三、五凌晨 3:00 執行 | `0 3 * * 1,3,5 /scripts/mwf_task.sh` |
| `30 23 * * 2,4` | 每週二和週四晚上 11:30 執行 | `30 23 * * 2,4 /scripts/tue_thu_night.sh` |
| `45 11 1-7 * *` | 每月第一週上午 11:45 執行 | `45 11 1-7 * * /scripts/first_week_task.sh` |
| `0 20 * 10,11,12 *` | 10 月、11 月和 12 月晚上 8:00 執行 | `0 20 * 10,11,12 * /scripts/q4_evening_task.sh` |
| `0 9-17/2 * * 1-5` | 週一至週五營業時間內每隔兩小時執行 | `0 9-17/2 * * 1-5 /scripts/biweekly_workday.sh` |


## 特殊 Cron 字串

Cron 也支援幾個特殊字串用於常見的時間規格：

- `@reboot`：啟動時執行一次
- `@yearly` 或 `@annually`：每年執行一次（等同於 `0 0 1 1 *`）
- `@monthly`：每月執行一次（等同於 `0 0 1 * *`）
- `@weekly`：每週執行一次（等同於 `0 0 * * 0`）
- `@daily` 或 `@midnight`：每日執行一次（等同於 `0 0 * * *`）
- `@hourly`：每小時執行一次（等同於 `0 0 * * *`）

## 處理輸出和錯誤

預設情況下，cron 會透過電子郵件將指令的輸出傳送給 crontab 的擁有者。您可以將輸出重新導向到檔案或丟棄它：

```bash
# 將輸出附加到日誌檔案
30 5 * * * /path/to/script.sh >> /path/to/logfile.log 2>&1

# 丟棄所有輸出
0 12 * * * /path/to/script.sh > /dev/null 2>&1
```

## Cron 中的環境變數

Cron 任務在最小環境中執行，這可能導致腳本失敗。您可以在 crontab 檔案中設定變數：

```bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
SHELL=/bin/bash
MAILTO=your-email@example.com

# 任務現在將使用這些環境變數
0 5 * * * /path/to/script.sh
```

## Cron 安全性考量

1. 對所有指令和腳本使用絕對路徑
2. 限制 crontab 檔案權限
3. 設定 cron 任務時遵循最小權限原則
4. 記錄和監控 cron 任務輸出以進行除錯
5. 考慮為敏感的 cron 任務使用專用使用者

## 疑難排解 Cron 任務

Cron 任務的常見問題包括：

1. **任務未執行**：檢查權限和路徑
2. **時間問題**：確認時間格式正確
3. **環境問題**：確保設定了必要的變數
4. **腳本錯誤**：首先手動測試腳本

檢查系統日誌以獲取與 cron 相關的訊息：
```bash
grep CRON /var/log/syslog
```

## Cron 替代方案

雖然 cron 很普遍，但也有一些替代方案：

- **Anacron**：更適合非 24/7 運行的系統
- **Systemd Timers**：在基於 systemd 的系統上的現代替代方案
- **Fcron**：具有類似 anacron 功能的增強型 cron
- **Schedule**：常用於 Web 應用程式的高階任務排程器

## 進階 Cron 用法

### 以不同使用者身份執行任務

要編輯其他使用者的 crontab（需要 root 權限）：
```bash
sudo crontab -u username -e
```

### 系統級 Crontabs

系統級的 cron 任務可以添加到：
- `/etc/crontab`
- `/etc/cron.d/` 中的檔案
- 如 `/etc/cron.daily/`、`/etc/cron.hourly/` 等目錄

系統 crontab 的語法包含一個額外的使用者欄位：
```
* * * * * user command-to-execute
```

### 使用特定環境執行 Cron 任務

建立一個包裝腳本，在執行實際指令前設定環境：

```bash
#!/bin/bash
source /home/user/.profile
cd /path/to/working/directory
/path/to/actual/command
```

然後從 cron 呼叫此包裝腳本。

## Cron 任務的最佳實踐

1. **記錄您的 cron 任務**：添加註解解釋每個任務的作用
2. **使用描述性腳本名稱**：使維護更容易
3. **記錄輸出**：儲存任務輸出以進行疑難排解
4. **監控任務執行**：為關鍵任務實施監控
5. **優雅處理失敗**：在腳本中添加錯誤處理
6. **使用鎖定檔案**：當任務執行時間超過預期時防止重疊執行
7. **考慮時區**：注意系統時區設定

遵循本指南，您應該能夠在類 Unix 系統上有效設定、管理和疑難排解 cron 任務。