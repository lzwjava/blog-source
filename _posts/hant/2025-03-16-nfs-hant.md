---
audio: false
generated: true
lang: hant
layout: post
title: 在 Ubuntu 上設定 NFS 伺服器以共享媒體
translated: true
type: note
---

若要在 Ubuntu 上設定 NFS（網路檔案系統）伺服器來提供媒體檔案，請按照以下詳細步驟操作。本指南假設您希望安全且高效地在網路上共享包含媒體檔案（例如影片、音樂）的目錄。

---

### 步驟 1：安裝 NFS 伺服器軟體
首先，您需要在 Ubuntu 系統上安裝 NFS 伺服器套件。

1. 更新套件清單以確保獲取最新版本：
   ```bash
   sudo apt update
   ```

2. 安裝 `nfs-kernel-server` 套件，該套件提供 NFS 伺服器功能：
   ```bash
   sudo apt install nfs-kernel-server
   ```

這將安裝運行 NFS 伺服器所需的軟體。

---

### 步驟 2：建立並設定媒體目錄
您需要一個目錄來儲存媒體檔案，並將其設定為共享。

1. 建立一個目錄來存放媒體檔案（例如 `/media/share`）：
   ```bash
   sudo mkdir -p /media/share
   ```

2. 將所有權設定給您的使用者帳戶（如果需要，請將 `$USER` 替換為您的實際使用者名稱）：
   ```bash
   sudo chown $USER:$USER /media/share
   ```

3. 調整權限以允許存取。對於客戶端主要為唯讀的媒體檔案，您可以設定：
   - 目錄：`755`（其他人可讀取和執行）
   - 檔案：`644`（其他人可讀取）
   但為簡化操作，如果不需要細粒度控制，可遞迴應用 `755`：
   ```bash
   sudo chmod -R 755 /media/share
   ```
   - **注意**：媒體檔案不需要可執行，但對檔案設定 `755` 不會影響 NFS 功能，因為執行操作在客戶端本地進行。

4. 將媒體檔案放入 `/media/share`（例如，將影片或音樂複製到此目錄中）。

---

### 步驟 3：設定 NFS 匯出
NFS 伺服器使用 `/etc/exports` 檔案來定義要共享的目錄以及誰可以存取它們。

1. 使用文字編輯器開啟 exports 檔案：
   ```bash
   sudo nano /etc/exports
   ```

2. 添加一行以共享 `/media/share`。語法為：
   ```
   /目錄/路徑 客戶端(選項)
   ```
   - **範例 1**：與特定客戶端 IP（例如 `192.168.1.100`）共享，並提供讀寫存取權限：
     ```
     /media/share 192.168.1.100(rw,sync,no_subtree_check)
     ```
   - **範例 2**：與子網路上的所有裝置（例如 `192.168.1.0/24`）共享，並提供唯讀存取權限：
     ```
     /media/share 192.168.1.0/24(ro,sync,no_subtree_check)
     ```
   - **範例 3**：與任何裝置共享（安全性較低，請謹慎使用）：
     ```
     /media/share *(rw,sync,no_subtree_check)
     ```

   **選項說明**：
   - `rw`：讀寫存取權限（對於媒體串流，如果偏好唯讀，請使用 `ro`）。
   - `sync`：確保在確認操作之前將資料寫入磁碟（更安全但較慢；為提高性能可使用 `async`，但需承擔崩潰時資料遺失的風險）。
   - `no_subtree_check`：透過停用子樹檢查來提高性能（建議用於大多數設定）。

3. 儲存檔案（在 nano 中按 `Ctrl+O`，然後按 `Enter`）並退出（`Ctrl+X`）。

---

### 步驟 4：應用 NFS 設定
編輯 exports 檔案後，更新 NFS 伺服器以反映您的變更。

1. 匯出共享：
   ```bash
   sudo exportfs -a
   ```

2. 重新啟動 NFS 伺服器以應用設定：
   ```bash
   sudo systemctl restart nfs-kernel-server
   ```

3. 驗證服務是否正在運行：
   ```bash
   sudo systemctl status nfs-kernel-server
   ```
   - 在輸出中尋找 "active (running)"。

4. 檢查匯出的目錄：
   ```bash
   sudo exportfs -v
   ```
   - 這應列出 `/media/share` 及您指定的選項。

---

### 步驟 5：設定防火牆
NFS 使用特定端口，您需要確保防火牆允許通往這些端口的流量。Ubuntu 通常使用 UFW（簡易防火牆）。

1. **預設 NFS 端口**：
   - NFS：2049 (TCP/UDP)
   - RPC：111 (TCP/UDP)
   - 其他服務（mountd、statd、lockd）：預設為動態端口，但可設定為靜態端口。

2. 為簡化操作，允許具有動態設定的基本端口（如果未設定靜態端口）：
   ```bash
   sudo ufw allow 2049
   sudo ufw allow 111
   ```
   - **注意**：如果 mountd、statd 或 lockd 使用隨機端口，這可能無法涵蓋所有 NFS 流量。

3. **可選：設定靜態端口以更好地控制**（建議用於精確的防火牆規則）：
   - 編輯 `/etc/default/nfs-kernel-server`：
     ```bash
     sudo nano /etc/default/nfs-kernel-server
     ```
     添加或修改：
     ```
     RPCMOUNTDOPTS="-p 4001"
     ```
   - 編輯 `/etc/default/nfs-common`：
     ```bash
     sudo nano /etc/default/nfs-common
     ```
     添加或修改：
     ```
     STATDOPTS="-p 4002"
     ```
   - 建立 `/etc/modprobe.d/nfs.conf` 用於 lockd：
     ```bash
     sudo nano /etc/modprobe.d/nfs.conf
     ```
     添加：
     ```
     options lockd nlm_udp_port=4003 nlm_tcp_port=4003
     ```
   - 重新啟動 NFS 伺服器：
     ```bash
     sudo systemctl restart nfs-kernel-server
     ```

4. 在 UFW 中允許靜態端口：
   ```bash
   sudo ufw allow 2049/tcp
   sudo ufw allow 2049/udp
   sudo ufw allow 111/tcp
   sudo ufw allow 111/udp
   sudo ufw allow 4001/tcp
   sudo ufw allow 4001/udp
   sudo ufw allow 4002/tcp
   sudo ufw allow 4002/udp
   sudo ufw allow 4003/tcp
   sudo ufw allow 4003/udp
   ```

5. 如果 UFW 尚未啟用，請啟用它：
   ```bash
   sudo ufw enable
   ```

---

### 步驟 6：驗證設定
確保 NFS 伺服器正常運作。

1. 從伺服器檢查匯出的共享：
   ```bash
   showmount -e localhost
   ```
   - 您應該看到 `/media/share` 列出，並帶有正確的客戶端/選項。

2. 驗證監聽端口：
   ```bash
   sudo ss -tuln | grep -E "2049|111|4001|4002|4003"
   ```
   - 確認這些端口已開啟並綁定到 NFS 服務。

---

### 步驟 7：從客戶端測試（可選）
在客戶端機器（例如另一個 Ubuntu 系統）上，測試掛載共享：
```bash
sudo mount -t nfs <伺服器_ip>:/media/share /mnt
```
- 將 `<伺服器_ip>` 替換為您的 NFS 伺服器 IP 地址。
- 確保 `/mnt` 存在（如果需要，請使用 `sudo mkdir /mnt` 建立）。
- 存取 `/mnt` 以驗證您可以看到並播放媒體檔案。

---

### 媒體檔案的附加說明
- **唯讀存取**：如果客戶端僅需要串流媒體，請在 `/etc/exports` 中使用 `ro` 以防止修改。
- **權限**：確保客戶端可以讀取媒體檔案。伺服器和客戶端之間的 UID/GID 不匹配可能導致存取問題；如果需要，請調整檔案權限或使用 NFS 選項如 `all_squash`（進階用法）。
- **性能**：對於大型媒體檔案，預設的 `sync` 選項較安全但較慢。如果性能是優先考慮且可接受資料遺失風險，請測試 `async`。
- **NFS 版本**：Ubuntu 預設使用 NFSv4，適用於媒體服務。除非支援舊版客戶端（NFSv3），否則通常不需要額外設定。

---

### 指令摘要
以下是基本設定的快速參考（不含靜態端口）：
```bash
sudo apt update
sudo apt install nfs-kernel-server
sudo mkdir -p /media/share
sudo chown $USER:$USER /media/share
sudo chmod -R 755 /media/share
echo "/media/share *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo ufw allow 2049
sudo ufw allow 111
```

透過此設定，您的 Ubuntu NFS 伺服器應準備好在網路上提供媒體檔案。請根據您的安全性和網路需求調整 IP 地址、權限和防火牆規則。