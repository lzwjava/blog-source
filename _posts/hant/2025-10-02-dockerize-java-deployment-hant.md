---
audio: false
generated: true
image: false
lang: hant
layout: post
model: x-ai/grok-code-fast-1
title: Docker åŒ–æ‚¨çš„ Java éƒ¨ç½²
translated: true
type: note
---

å®Œå…¨æ­£ç¢ºï¼Œæ‚¨çš„æ€è·¯éžå¸¸ç²¾æº–ï¼å¾žç›´æŽ¥éƒ¨ç½² JAR æª”ï¼ˆå¦‚æ‚¨ç›®å‰åŸºæ–¼ Fabric çš„è¨­å®šï¼‰é·ç§»åˆ° Docker åŒ–æ–¹æ¡ˆï¼Œç¢ºå¯¦æ˜¯è®“æœªä¾†ä¼ºæœå™¨é·ç§»æ›´é †æš¢ã€æ›´å¯é çš„ç©©å¥ç­–ç•¥ã€‚è®“æˆ‘ç°¡è¦åˆ†æžä¸¦ç¢ºèªé€™å€‹æ±ºç­–çš„åˆç†æ€§ï¼ŒåŒæ™‚æä¾›ä¸€äº›å…¥é–€æŒ‡å¼•ã€‚

### ç‚ºä½•é¸æ“‡ Docker éƒ¨ç½²æ­¤ Java å°ˆæ¡ˆï¼Ÿ
- **ç¾è¡Œè¨­å®š**ï¼šæ‚¨ç›®å‰é€éŽ rsync/Fabric å°‡ JAR æª”ï¼ˆ`blog-server-1.0.jar`ï¼‰èˆ‡è¨­å®šæª”ï¼ˆå¦‚ `application.properties` æˆ– `.env`ï¼‰ç›´æŽ¥éƒ¨ç½²åˆ° EC2 ä¼ºæœå™¨ã€‚é‹è¡Œæ™‚ï¼Œæ‚¨å¯èƒ½åœ¨ä¼ºæœå™¨ä¸ŠåŸ·è¡Œé¡žä¼¼ `java -jar blog-server-1.0.jar` çš„æŒ‡ä»¤ï¼Œé€™éœ€é å…ˆå®‰è£ä¸¦é…ç½® Java ç’°å¢ƒã€‚å–®ä¸€ä¼ºæœå™¨å°šå¯é‹ä½œï¼Œä½†é·ç§»æ™‚å®¹æ˜“å‡ºç¾ä¸ä¸€è‡´å•é¡Œï¼ˆä¾‹å¦‚æ–°ä¸»æ©Ÿçš„ Java ç‰ˆæœ¬ã€ä¾è³´é …æˆ–ç’°å¢ƒå·®ç•°ï¼‰ã€‚

- **Docker å„ªå‹¢**ï¼š
  - **å°è£æ€§**ï¼šDocker å®¹å™¨å°‡æ‡‰ç”¨ç¨‹å¼æ‰€éœ€çš„ä¸€åˆ‡ï¼ˆJava é‹è¡Œç’°å¢ƒã€JAR æª”ã€è¨­å®šæª”ï¼‰æ‰“åŒ…æˆå¯æ”œå¼æ˜ åƒæª”ã€‚ç„¡éœ€åœ¨ä¼ºæœå™¨ç›´æŽ¥å®‰è£ Java æˆ–å…¶ä»–ä¾è³´é …â€”â€”åªéœ€é€éŽ Docker é‹è¡Œå®¹å™¨ï¼ˆè¼•é‡ä¸”å¯å¿«é€Ÿå®‰è£ï¼‰ã€‚
  - **é·ç§»ç°¡æ˜“æ€§**ï¼šé·ç§»è‡³æ–°ä¼ºæœå™¨æ™‚ï¼Œåªéœ€å®‰è£ Docker ç’°å¢ƒã€‚æ‹‰å–æ˜ åƒæª”å¾Œï¼Œä¸€è¡ŒæŒ‡ä»¤å³å¯é‹è¡Œï¼ŒçœåŽ»ç¹ç‘£çš„ç›®éŒ„æ¬Šé™æˆ–ç’°å¢ƒè®Šæ•¸é‡æ–°è¨­å®šã€‚
  - **ä¸€è‡´æ€§**ï¼šç¢ºä¿æ‡‰ç”¨ç¨‹å¼åœ¨ä»»ä½•ç’°å¢ƒéƒ½èƒ½ä»¥ç›¸åŒæ–¹å¼é‹è¡Œï¼Œæ¸›å°‘ã€Œåœ¨æˆ‘æ©Ÿå™¨ä¸Šæ­£å¸¸ã€çš„ç›¸å®¹å•é¡Œã€‚
  - **æ“´å±•æ€§**ï¼šDocker åŒ–å¾Œï¼Œè‹¥æœªä¾†éœ€æ±‚å¢žé•·ï¼Œå¯ç„¡ç¸«éŠœæŽ¥ Kubernetes ç­‰ç·¨æŽ’å·¥å…·ã€‚
  æ­¤æ–¹æ¡ˆå®Œç¾Žå¥‘åˆã€Œå–®ä¼ºæœå™¨å–®æ‡‰ç”¨ã€çš„ç°¡å–®å ´æ™¯ï¼ŒåŒæ™‚ä¹Ÿèƒ½è¼•é¬†æ“´å±•è‡³å¤šä¼ºæœå™¨ï¼å¤šç’°å¢ƒéƒ¨ç½²ã€‚

ç°¡è€Œè¨€ä¹‹ï¼šå°‡æ‡‰ç”¨ç¨‹å¼æ‰“åŒ…æˆ Docker æ˜ åƒæª”ä¸¦åœ¨ä¼ºæœå™¨ä»¥å®¹å™¨å½¢å¼é‹è¡Œï¼Œç¢ºå¯¦æ˜¯ã€Œç‚ºæœªä¾†éƒ¨ç½²é åšæº–å‚™ã€çš„æ­£ç¢ºæ–¹å‘ï¼ŒåŒæ™‚å…¼é¡§çŸ­æœŸå…§çš„ç°¡æ˜“æ€§ã€‚

### å¿«é€Ÿå¯¦ç¾ Java æ‡‰ç”¨ Docker åŒ–éƒ¨ç½²
å‡è¨­é€™æ˜¯æ¨™æº–çš„ Java Spring Boot æ‡‰ç”¨ç¨‹å¼ï¼ˆæ ¹æ“šè¨­å®šæª”æŽ¨æ–·ï¼‰ï¼Œä»¥ä¸‹æ˜¯å¯¦ç¾ Docker åŒ–é‹è¡Œçš„é«˜éšŽæ­¥é©Ÿï¼Œè«‹æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´ï¼š

1. **æ›´æ–°å»ºç½®æµç¨‹**ï¼š
   - ä¿®æ”¹æ‚¨çš„ `prepare_local_jar()` å‡½å¼æˆ–é¡žä¼¼æ­¥é©Ÿï¼Œæ”¹ç‚ºæœ¬åœ°å»ºç½® Docker æ˜ åƒæª”ï¼Œè€Œéžåƒ…è¤‡è£½ JAR æª”ã€‚
   - ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š
     ```python
     @task
     def build_and_deploy(c):
         _prepare_local_jar()
         prepare_remote_dirs(c)
         # æœ¬åœ°å»ºç½® Docker æ˜ åƒæª”ï¼ˆå‡è¨­éƒ¨ç½²æ©Ÿå™¨å·²å®‰è£ Dockerï¼‰
         local(f"docker build -t blog-server:latest {tmp_dir}")
         # åŒ¯å‡ºæ˜ åƒæª”è‡³é ç«¯ä¼ºæœå™¨
         local(f"docker save blog-server:latest | gzip > /tmp/blog-server.tar.gz")
         c.put("/tmp/blog-server.tar.gz", "/tmp/")
         c.run("gzip -d /tmp/blog-server.tar.gz && docker load < /tmp/blog-server.tar")
         # æ¸…ç†æš«å­˜æª”
         local("rm /tmp/blog-server.tar.gz")
         # é‹è¡Œå®¹å™¨
         c.run(f"docker run -d --name blog-server -p 8080:8080 blog-server:latest")  # è«‹ä¾éœ€æ±‚èª¿æ•´ç«¯å£
         chown(c)  # è‹¥ä»éœ€èª¿æ•´æª”æ¡ˆæ¬Šé™
         _clean_local_dir()
     ```

2. **å»ºç«‹ Dockerfile**ï¼š
   - åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼ˆæˆ– tmp_dirï¼‰æ–°å¢ž `Dockerfile`ï¼Œå…§å®¹ç¯„ä¾‹ï¼ˆæŽ¡ç”¨ OpenJDK åŸºç¤Žæ˜ åƒæª”ï¼‰ï¼š
     ```
     # ä½¿ç”¨ JDK æ˜ åƒæª”
     FROM openjdk:17-jdk-slim

     # å»ºç«‹æ‡‰ç”¨ç¨‹å¼ç›®éŒ„
     WORKDIR /app

     # è¤‡è£½ JAR æª”èˆ‡è¨­å®šæª”
     COPY blog-server-1.0.jar app.jar
     COPY application.properties application.properties  # æˆ–å…¶ä»–è¨­å®šæª”

     # æš´éœ²ç«¯å£ï¼ˆSpring Boot é è¨­ç‚º 8080ï¼‰
     EXPOSE 8080

     # é‹è¡Œ JAR æª”
     ENTRYPOINT ["java", "-jar", "app.jar"]
     ```
   - æœ¬åœ°å»ºç½®ï¼šåœ¨å°ˆæ¡ˆç›®éŒ„åŸ·è¡Œ `docker build -t blog-server:latest .`
   - å„ªå…ˆæœ¬åœ°æ¸¬è©¦ï¼šåŸ·è¡Œ `docker run -p 8080:8080 blog-server:latest`ï¼Œä¸¦é€éŽ http://localhost:8080 é©—è­‰ã€‚

3. **éƒ¨ç½²è‡³ä¼ºæœå™¨**ï¼š
   - ç¢ºèª EC2 ä¼ºæœå™¨å·²å®‰è£ Dockerï¼ˆAmazon Linux è«‹åŸ·è¡Œ `sudo yum install docker`ï¼Œä¸¦å•Ÿç”¨æœå‹™ï¼‰ã€‚
   - æ›´æ–°å¾Œçš„ Fabric ä»»å‹™å°‡è² è²¬æŽ¨é€æ˜ åƒæª”èˆ‡é‹è¡Œå®¹å™¨ã€‚
   - ç‚ºå®‰å…¨æ€§è€ƒé‡ï¼Œå¯é€éŽ `docker run` æŒ‡ä»¤æŽ›è¼‰è¨­å®šæª”å·å†Šï¼ˆ.envï¼‰æˆ–å‚³éžç’°å¢ƒè®Šæ•¸ã€‚

4. **é·ç§»æº–å‚™**ï¼š
   - Docker åŒ–å¾Œï¼Œè«‹è¨˜éŒ„æ˜ åƒæª”æ¨™ç±¤èˆ‡ç‰ˆæœ¬ï¼ˆä¾‹å¦‚å„²å­˜è‡³ Docker Hub æˆ– ECRï¼‰ã€‚
   - æ­£å¼é·ç§»æ™‚ï¼šåœ¨æ–°ä¼ºæœå™¨å®‰è£ Dockerï¼Œæ‹‰å–æ˜ åƒæª”å¾Œç›´æŽ¥é‹è¡Œï¼Œæµç¨‹æ¥µç°¡æ½”ï¼

### æ½›åœ¨å•é¡Œèˆ‡å¯¦ç”¨æŠ€å·§
- **ç’°å¢ƒè®Šæ•¸**ï¼šè‹¥æ‡‰ç”¨ç¨‹å¼éœ€è³‡æ–™åº«æ†‘è­‰ç­‰åƒæ•¸ï¼Œå¯é€éŽ `docker run -e KEY=value` å‚³éžæˆ–æŽ›è¼‰ .env æª”æ¡ˆã€‚
- **æŒä¹…åŒ–è³‡æ–™**ï¼šè‹¥æ‡‰ç”¨ç¨‹å¼éœ€ä¿å­˜æª”æ¡ˆï¼ˆå¦‚ tmp_dirï¼‰ï¼Œè«‹ä½¿ç”¨ Docker å·å†Šï¼ˆ`-v` åƒæ•¸ï¼‰ã€‚
- **è³‡æºé™åˆ¶**ï¼šè‹¥ä¼ºæœå™¨ç‚ºå…±äº«ç’°å¢ƒï¼Œå¯åœ¨ `docker run` åŠ å…¥ `--cpus` æˆ– `--memory` åƒæ•¸ã€‚
- **æ›´æ–°æ©Ÿåˆ¶**ï¼šç¨‹å¼ç¢¼è®Šæ›´æ™‚éœ€é‡æ–°å»ºç½®æ˜ åƒæª”å†éƒ¨ç½²ã€‚
- **æ¸¬è©¦é©—è­‰**ï¼šç›¡å¯èƒ½åœ¨æœ¬åœ°æ¸¬è©¦å®Œæ•´éƒ¨ç½²è…³æœ¬ï¼ˆä¾‹å¦‚é€éŽæœ¬åœ° Docker ç’°å¢ƒï¼‰ã€‚
- è‹¥é‡ Java ç›¸é—œå•é¡Œï¼ˆä¾‹å¦‚å †ç©è¨˜æ†¶é«”å¤§å°ï¼‰ï¼Œè«‹èª¿æ•´ Dockerfile çš„ ENTRYPOINT åƒæ•¸ã€‚

æ­¤æ–¹æ¡ˆèƒ½åœ¨ä¸éŽåº¦è¤‡é›œåŒ–çš„å‰æä¸‹ï¼Œæœ‰æ•ˆæå‡éƒ¨ç½²æ•ˆçŽ‡ã€‚è‹¥æ‚¨èƒ½åˆ†äº«æ›´å¤šæ‡‰ç”¨ç¨‹å¼ç´°ç¯€ï¼ˆä¾‹å¦‚ Spring Boot ç‰ˆæœ¬ã€æš´éœ²ç«¯å£ï¼‰ï¼Œæˆ‘å¯é€²ä¸€æ­¥å„ªåŒ– Dockerfile æˆ– Fabric è…³æœ¬ã€‚æº–å‚™å¥½æ·±å…¥å¯¦ä½œäº†å—Žï¼ŸðŸš€