---
audio: false
generated: true
image: false
lang: hant
layout: post
model: moonshotai/kimi-k2-thinking
title: 多路徑傳輸控制協議概述
translated: true
type: note
---

MPTCP 是一種傳輸層協議擴展，它從根本上改變了網絡連接的運作方式，使單一邏輯連接能夠同時使用多個物理路徑。以下是詳細解析：

## **1. 核心問題：單一路徑的限制**

傳統 TCP 將每個連接限制在由五元組（源 IP、源端口、目標 IP、目標端口、協議）定義的單一網絡路徑上。這帶來了幾個關鍵限制：

- **無接口聚合**：同時擁有 Wi-Fi 和流動網絡的設備每次只能使用一個接口
- **單點故障**：如果所選路徑出現擁塞或故障，整個連接就會中斷
- **資源利用不足**：當一條路徑擁塞時，其他未擁塞的路徑仍處於閒置狀態
- **移動性中斷**：在不同網絡間切換（例如從 Wi-Fi 切換到 4G）需要重新建立所有連接

現代設備本質上都是多宿主設備——智能手機、筆記本電腦和服務器都擁有多個網絡接口——但 TCP 無法利用這種多樣性。

## **2. MPTCP 的工作原理：子流架構**

MPTCP（RFC 8684）**並非**一種新協議，而是 TCP 的向後兼容擴展。它通過創建**子流**——在不同路徑上的獨立 TCP 連接——這些子流共同形成一個邏輯 MPTCP 連接。

### 連接建立過程：

1. **初始握手**：客戶端和服務器在標準 TCP 三次握手期間協商 MPTCP 能力
2. **路徑發現**：對等端交換它們可以使用的其他 IP 地址
3. **子流創建**：在可用接口/路徑上建立額外的 TCP 連接
4. **數據分發**：**調度器**將應用程序的字節流拆分到各個子流
5. **重組**：接收方使用連接級序列號將來自多個子流的數據重新排序為原始序列

```
傳統 TCP：應用數據 → 單一 TCP 流 → 單一路徑
MPTCP：應用數據 → 調度器 → 多個 TCP 子流 → 多個路徑 → 重組
```

您可以在 Linux 上使用 `ss -M` 可視化此過程，該命令顯示在一個 MPTCP 連接下分組的子流。

## **3. 性能關鍵機制**

### **頻寬聚合**
MPTCP 可以合併所有可用路徑的吞吐量。一個 9 Mbps 的數據流可以拆分為三個 3 Mbps 的子流，通過不同的接口傳輸，從而有效利用所有網絡容量。這在服務器之間存在多個物理鏈路的數據中心中尤其強大。

### **智能調度**
調度器持續監控：
- 路徑延遲和擁塞情況
- 數據包丟失率
- 可用頻寬
- 鏈路成本/優先級

它動態調整通過每個子流發送的數據量，防止慢速路徑過載，同時充分利用快速路徑。

### **耦合擁塞控制**
MPTCP 使用專門的算法（如 LIA、OLIA、BALIA），這些算法能夠：
- 平衡各條路徑上的擁塞
- 確保與常規 TCP 流的公平性
- 防止單個 MPTCP 連接使其他流量飢餓
- 當某條路徑出現擁塞時做出適當反應

## **4. 優勢：韌性與吞吐量**

### **增強韌性**
- **自動故障轉移**：如果 Wi-Fi 中斷，流動網絡子流可以維持連接，不會中斷應用程序
- **路徑冗餘**：一條路徑上的數據包丟失不會導致連接中斷——流量會重新路由到健康的子流
- **優雅降級**：部分路徑故障會降低頻寬，但不會導致連接中斷
- **恢復時間**：模擬顯示 MPTCP 通過快速將流量轉移到替代路徑來最小化中斷

### **提升吞吐量**
- **資源池化**：同時利用所有可用的網絡資源
- **擁塞避免**：通過使用較少擁塞的替代路徑來繞過瓶頸
- **負載均衡**：分發流量以防止任何單一路徑成為瓶頸

### **無縫移動性**
Apple 自 iOS 7 起就將 MPTCP 用於 Siri，使得語音請求在 Wi-Fi 和流動網絡之間切換時能夠持續不中斷。連接能夠持續是因為子流會隨著接口可用或不可用而動態添加和移除。

## **5. 實際應用場景**

- **流動設備**：智能手機在網絡間無縫切換
- **數據中心**：利用路徑多樣性實現更高吞吐量和容錯能力
- **物聯網/機器對機器系統**：在多接口設備中最大化資源利用率
- **混合網絡**：結合固定寬頻和流動網絡以實現更快的文件傳輸
- **雲服務**：需要高可用性的內容分發網絡和企業環境

## **6. 實施與採用情況**

### **操作系統支援**
- **Linux**：完整的內核支援，帶有 `mptcpd` 守護進程（RHEL 9+、現代發行版）
- **iOS**：自 2013 年起用於 Siri 和部分選定應用
- **Android**：近期版本中有部分支援
- **Windows**：有限的本地支援

### **應用程序透明性**
應用程序通常**無需更改**——操作系統網絡堆棧透明地處理 MPTCP。僅在需要高級功能時可能需對套接字選項進行少量修改。

### **部署狀態**
MPTCP 仍在成熟過程中。雖然 Apple 在內部使用它，但大多數互聯網服務尚未支援它。採用需要客戶端和服務器同時支援，儘管回退到常規 TCP 是自動的。

## **7. 權衡與挑戰**

### **複雜性**
- 更複雜的協議狀態機
- 中間設備支援有限——部分防火牆/NAT 可能會阻止 MPTCP 選項
- 網絡故障排除變得更加困難

### **安全影響**
- **檢查盲點**：防火牆和入侵防禦系統難以重組拆分的流，從而產生安全漏洞
- **流量模式混淆**：雖然這可以提升隱私性，但使安全監控複雜化
- **Cisco 產品**：許多檢查功能不支援 MPTCP，需要仔細配置

### **性能考量**
- **數據包重排序**：不同的路徑延遲可能導致數據包亂序到達，如果管理不當可能損害性能
- **隊頭阻塞**：如果調度器不夠智能，慢速子流可能會延遲整體交付
- **緩衝區要求**：接收端需要更多緩衝來對數據包進行重新排序

### **公平性**
MPTCP 的耦合擁塞控制必須在共享鏈路上仔細平衡多路徑的侵略性與對單路徑 TCP 流的公平性。

## **8. 與類似技術的比較**

- **鏈路綁定/聚合**：在第二層運作，通常需要相同介質，並且對單個 TCP 連接沒有幫助
- **等價多路徑**：網絡層路由，可以拆分流，但無法拆分*單個*連接
- **SCTP**：具有多宿主功能的替代傳輸協議，但採用率低且 NAT 穿越存在問題

MPTCP 的關鍵優勢在於它在現有的 TCP 生態系統內工作，同時提供真正的**連接級**多路徑。

---

**總結**：MPTCP 通過智能地匯聚多個網絡資源，將僵化的單路徑 TCP 模型轉變為靈活、有韌性且以性能為導向的架構。儘管在成熟度和安全性方面仍存在挑戰，但它代表了在現代網絡中利用多宿主端點的最實用解決方案。