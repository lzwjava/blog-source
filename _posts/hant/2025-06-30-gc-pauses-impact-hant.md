---
audio: false
generated: true
lang: hant
layout: post
title: Go GC 停頓：Cloudflare 對比 TiDB
translated: true
type: note
---

是的，Go 語言的垃圾回收（GC）暫停確實會對 Cloudflare 的服務和 TiDB 數據庫產生影響，因為兩者都在其架構中大量使用 Go。然而，這些暫停的性質、影響及其緩解方式各有不同。

以下為詳細分析：

**Go 垃圾回收及其特性：**

* **標記-清除垃圾回收：** Go 使用並行的三色標記-清除垃圾回收器。這意味著大部分 GC 工作（標記存活物件）是與應用程式執行並行進行的。
* **全局暫停（STW）：** 儘管是並行處理，Go 的 GC 仍需要短暫的「全局暫停」。這些暫停發生在特定階段（例如初始標記設置、最終標記終止和清除終止階段），此時應用程式的 goroutine 會暫停以確保記憶體一致性。Go 運行時工程師的目標是盡量縮短這些 STW 時間，通常將其控制在微秒級別。
* **影響 GC 的因素：** GC 暫停的頻率和持續時間受以下因素影響：
    * **分配速率：** 應用程式分配新記憶體的速度。
    * **堆積大小：** Go 運行時管理的記憶體總量。
    * **`GOGC` 參數：** 控制垃圾回收目標百分比的參數（預設值為 100%）。較低的 `GOGC` 值意味著更頻繁的 GC。
    * **`GOMEMLIMIT` 參數：** 新增參數（Go 1.19+），用於設定目標堆積大小的上限，有助於防止記憶體不足並更可預測地管理記憶體。

**對 Cloudflare 的影響：**

Cloudflare 在其多項關鍵服務中廣泛使用 Go，包括 DNS 基礎設施、SSL 處理、負載測試等。對於像 Cloudflare 這樣的高效能、低延遲系統，即使是微秒級的暫停也可能產生顯著影響。

* **對延遲敏感的服務：** 處理高請求率的服務（如 DNS 或代理）對延遲峰值非常敏感。即使 GC 暫停時間很短，也可能導致這些峰值，影響用戶體驗。
* **記憶體密集型應用：** 某些 Cloudflare 服務可能是記憶體密集型，若未適當調優，可能導致更頻繁的 GC 循環。
* **Cloudflare 的緩解措施：** Cloudflare 工程師積極採取以下措施：
    * **調優 `GOGC` 和 `GOMEMLIMIT`：** 通過實驗調整這些參數，以平衡記憶體使用量和 GC 頻率。
    * **性能剖析與程式碼優化：** 識別並減少 Go 程式碼中不必要的記憶體分配。
    * **Profile-Guided Optimizations (PGO)：** Cloudflare 透過利用 Go 的 PGO 功能，實現了顯著的 CPU 節省（從而可能降低 GC 壓力）。
    * **架構考量：** 設計具有足夠冗餘的服務，或透過處理請求的方式來最小化單一 goroutine 暫停的影響，從而提高服務對短暫暫停的韌性。

**對 TiDB 數據庫的影響：**

TiDB 是由 PingCAP 開發的分散式 SQL 數據庫，其 SQL 層（`tidb-server`）主要使用 Go 編寫。作為數據庫，其性能特性和要求與代理服務有所不同。

* **數據庫專用的 GC：** TiDB 擁有自己的垃圾回收機制，用於處理 MVCC（多版本並行控制）數據（清理其儲存引擎 TiKV 中的舊數據版本）。這與 Go 運行時的 GC 不同，儘管 TiDB 的「協調器」（使用 Go 編寫）會啟動和管理此過程。
* **TiDB 中的 Go 運行時 GC：** Go GC 確實會影響 TiDB，因為 `tidb-server` 負責處理 SQL 請求、管理查詢計劃和結果的記憶體，以及其他運行時數據。
    * **延遲抖動：** 頻繁的 STW 暫停可能導致查詢執行出現延遲峰值，影響數據庫的響應能力。
    * **CPU 開銷：** GC 活動會消耗 CPU 資源，這些資源本可用於處理查詢。
    * **自適應 GC 觸發：** TiDB 在記憶體使用量達到特定閾值時（可透過 `tidb_server_memory_limit` 和 `tidb_server_memory_limit_gc_trigger` 配置）會主動觸發 Go GC。同時，它對 `tidb_server_memory_limit_gc_trigger` 使用自適應策略，以避免過於頻繁的 GC。
* **監控與調優：** PingCAP 提供廣泛的監控工具（如 TiDB Runtime Dashboard），用於觀察 Go GC 行為（GC 頻率、持續時間、STW 延遲、GC 消耗的 CPU 時間），並允許用戶配置 `GOGC` 和 `GOMEMLIMIT` 以優化性能。
* **持續努力：** PingCAP 工程師持續優化 TiDB 的 Go 記憶體管理和 GC 行為，以最小化其對性能和穩定性的影響。

**總結：**

Cloudflare 和 TiDB 作為依賴 Go 的高效能系統，都容易受到 Go GC 暫停的影響。儘管 Go 的 GC 針對短 STW 時間進行了高度優化，但在大規模應用中，這些暫停仍可能導致延遲峰值和 CPU 開銷。兩家公司都積極監控、調優和優化其 Go 應用程式和基礎設施，透過利用 Go 的運行時參數及其特定的架構設計來緩解這些影響。