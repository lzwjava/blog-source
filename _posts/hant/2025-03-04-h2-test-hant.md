---
audio: false
generated: true
lang: hant
layout: post
title: 使用 H2 資料庫進行測試
translated: true
---

在 Spring 專案中使用 H2 資料庫，特別是用於測試目的，您需要將這個輕量級的內存資料庫整合到您的 Spring 應用程式中。H2 資料庫適合測試，因為它在記憶體中運行，速度快，並且可以輕鬆設置和拆除，而不會將數據持久化到磁碟。以下，我將解釋如何將 H2 納入您的 Spring 專案，假設您使用 Spring Boot（這是 Spring 專案的常見設置），並澄清對 `com.h2database.h2` 的引用，這可能是指 Maven 依賴項而不是包或類名（實際的驅動程序類是 `org.h2.Driver`）。

---

### 第 1 步：添加 H2 依賴項
要在 Spring 專案中使用 H2，您必須在構建文件中包含其依賴項。由於您提到 `com.h2database.h2`，這與 Maven 坐標對應 H2 資料庫工件。以下是如何添加它的方法：

#### 針對 Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **注意**：`<scope>test</scope>` 確保 H2 只在測試階段可用，這符合您的測試重點。

#### 針對 Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

如果您使用 Spring Boot 並包含了 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc` 等啟動器，當您為測試配置 H2 資料源時，Spring Boot 的依賴管理會自動拉取一個兼容的 H2 版本。在這種情況下，明確添加 H2 依賴項是可選的，除非您需要特定版本。

---

### 第 2 步：配置 H2 作為測試資料源
在 Spring Boot 專案中，您可以通過屬性配置資料庫，通常在 `application.properties` 或 `application.yml` 中。對於測試，將這些配置放在 `src/test/resources` 中，以覆蓋主應用程式設置。

#### 配置在 `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **說明**：
  - `spring.datasource.url=jdbc:h2:mem:testdb`：指定一個名為 `testdb` 的內存 H2 資料庫。`mem` 關鍵字確保數據存儲在 RAM 中。
  - `spring.datasource.driverClassName=org.h2.Driver`：H2 的 JDBC 驅動程序類（不是 `com.h2database.h2`，這可能是對 Maven 工件的誤解或拼寫錯誤）。
  - `spring.datasource.username=sa`：默認 H2 用戶名。
  - `spring.datasource.password=`：默認空密碼。

#### 最小配置與自動配置：
如果您使用 Spring Boot 並且有 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc`，並且 H2 在類路徑上，Spring Boot 可以自動配置一個嵌入式 H2 資料庫，而不需要顯式屬性。它會生成一個隨機資料庫名稱（例如 `jdbc:h2:mem:<random-uuid>`）。然而，指定上述屬性可以讓您控制資料庫名稱和設置。

---

### 第 3 步：在測試中使用 H2
Spring Boot 提供測試註解來簡化使用 H2 的資料庫測試。方法取決於您是測試存儲庫（單元測試）還是整個應用程式堆疊（集成測試）。

#### 選項 1：使用 `@DataJpaTest` 測試存儲庫
對於測試 Spring Data JPA 存儲庫，使用 `@DataJpaTest` 注釋。它會自動配置一個內存 H2 資料庫，掃描 `@Entity` 類，並設置存儲庫。

**範例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // 假設數據已加載（例如，通過 data.sql）
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **優點**：
  - H2 自動設置。
  - 測試是事務性的，並且默認回滾，確保每個測試的資料庫狀態一致。

#### 選項 2：使用 `@SpringBootTest` 進行集成測試
對於全堆疊集成測試（例如測試控制器、服務和存儲庫），使用 `@SpringBootTest`。通過測試特定屬性配置 H2。

**範例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // 測試與資料庫交互的服務邏輯
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **配置**：使用 `src/test/resources` 中的 `application.properties` 如上所示，以確保使用 H2 而不是生產資料庫。

#### 替代配置方法：
- **使用 `@TestPropertySource`**：
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **使用配置文件**：
  - 創建 `src/test/resources/application-test.properties`，其中包含 H2 配置。
  - 使用 `@ActiveProfiles("test")` 注釋測試。

---

### 第 4 步：初始化測試數據（可選）
要用測試數據填充 H2 資料庫：

- **使用 `schema.sql` 和 `data.sql`**：
  - 將這些文件放在 `src/test/resources` 中。
  - Spring Boot 在嵌入式資料庫啟動時執行 `schema.sql` 以創建表，並執行 `data.sql` 以插入數據。
  - 範例 `data.sql`：
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **使用 `@Sql`**：
  - 在測試方法之前或之後執行特定 SQL 腳本。
  - 範例：
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // 測試邏輯
    }
    ```

---

### 第 5 步：確保測試隔離（可選）
為防止測試方法相互干擾：
- 在測試類或方法上使用 `@Transactional`。對於 `@DataJpaTest`，這是默認啟用的，並在每個測試後回滾更改。對於 `@SpringBootTest`，如果需要，則顯式添加它：
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- 這確保每個測試都以一致的資料庫狀態開始。

---

### 第 6 步：模擬生產資料庫（可選）
如果您的生產資料庫不同（例如 MySQL、PostgreSQL），請配置 H2 使用兼容模式：
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- 支持的模式包括 `MySQL`、`PostgreSQL` 等，使 H2 的 SQL 語法和行為與您的生產資料庫一致。

---

### 第 7 步：使用 H2 控制台進行調試（可選）
為了在測試期間檢查資料庫：
- 啟用 H2 控制台：
  ```properties
  spring.h2.console.enabled=true
  ```
- 如果運行 Web 伺服器（例如，使用 `@SpringBootTest(webEnvironment = RANDOM_PORT)`），則可以在 `http://localhost:<port>/h2-console` 訪問它。
- 這對於調試很有用，但在自動化測試運行中不常見。

---

### 關鍵說明
- **H2 驅動程序**：正確的驅動程序類是 `org.h2.Driver`，而不是 `com.h2database.h2`。後者是 Maven 的 `groupId:artifactId`。
- **Spring Boot 優勢**：自動配置簡化了 H2 的設置，特別是用於測試。
- **內存特性**：H2 的數據在 JVM 停止時丟失，使其適合隔離測試運行。

通過遵循這些步驟，您可以在 Spring 專案中有效地使用 H2 資料庫進行測試，利用其速度和簡單性來驗證您的數據層或整個應用程式堆疊。