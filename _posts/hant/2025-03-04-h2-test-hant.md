---
audio: false
generated: true
lang: hant
layout: post
title: 測試使用 H2 數據庫
translated: true
type: note
---

要在 Spring 專案中使用 H2 資料庫，特別是用於測試目的，您需要將這個輕量級的記憶體資料庫整合到 Spring 應用程式中。H2 資料庫非常適合測試，因為它在記憶體中運行、速度快，並且可以輕鬆設定和拆卸，無需將資料持久化到磁碟。接下來，我將說明如何將 H2 整合到您的 Spring 專案中（假設您使用 Spring Boot，這是 Spring 專案的常見設定），並釐清對 `com.h2database.h2` 的引用，這很可能指的是 Maven 依賴項，而不是套件或類別名稱（實際的驅動程式類別是 `org.h2.Driver`）。

---

### 步驟 1：新增 H2 依賴項
要在 Spring 專案中使用 H2，您必須在建置檔案中包含其依賴項。由於您提到了 `com.h2database.h2`，這與 H2 資料庫產品的 Maven 座標一致。以下是新增方法：

#### 對於 Maven (`pom.xml`)：
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **注意**：`<scope>test</scope>` 確保 H2 僅在測試階段可用，這符合您的測試重點。

#### 對於 Gradle (`build.gradle`)：
```gradle
testImplementation 'com.h2database:h2'
```

如果您使用 Spring Boot 並包含了 starter（例如 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc`），當您為測試設定 H2 資料來源時，Spring Boot 的依賴項管理會自動拉取相容的 H2 版本。在這種情況下，除非您需要特定版本，否則明確新增 H2 依賴項是可選的。

---

### 步驟 2：設定 H2 作為測試用的資料來源
在 Spring Boot 專案中，您可以透過屬性來設定資料庫，通常在 `application.properties` 或 `application.yml` 中設定。對於測試，請將這些設定放在 `src/test/resources` 中，以覆蓋主應用程式設定。

#### 在 `src/test/resources/application.properties` 中的設定：
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **說明**：
  - `spring.datasource.url=jdbc:h2:mem:testdb`：指定一個名為 `testdb` 的記憶體 H2 資料庫。`mem` 關鍵字確保資料儲存在 RAM 中。
  - `spring.datasource.driverClassName=org.h2.Driver`：H2 的 JDBC 驅動程式類別（不是 `com.h2database.h2`，後者可能是拼寫錯誤或與 Maven 產品混淆）。
  - `spring.datasource.username=sa`：預設的 H2 使用者名稱。
  - `spring.datasource.password=`：預設為空密碼。

#### 使用自動設定的最小設定：
如果您使用 Spring Boot 並搭配 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc`，且 H2 在類別路徑上，Spring Boot 可以在沒有明確屬性的情況下自動設定嵌入式 H2 資料庫。它會生成一個隨機的資料庫名稱（例如 `jdbc:h2:mem:<random-uuid>`）。然而，指定上述屬性可以讓您控制資料庫名稱和設定。

---

### 步驟 3：在測試中使用 H2
Spring Boot 提供了測試註解來簡化使用 H2 的資料庫測試。具體方法取決於您是測試儲存庫（類似單元測試）還是完整應用程式堆疊（整合測試）。

#### 選項 1：使用 `@DataJpaTest` 測試儲存庫
對於測試 Spring Data JPA 儲存庫，請使用 `@DataJpaTest` 註解。它會自動設定記憶體 H2 資料庫、掃描 `@Entity` 類別並設定儲存庫。

**範例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // 假設資料已載入（例如透過 data.sql）
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **優點**：
  - H2 會自動設定。
  - 測試預設是事務性的並會回滾，確保每個測試都有乾淨的資料庫狀態。

#### 選項 2：使用 `@SpringBootTest` 進行整合測試
對於完整堆疊的整合測試（例如測試控制器、服務和儲存庫），請使用 `@SpringBootTest`。透過測試專用屬性來設定 H2。

**範例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // 測試與資料庫互動的服務邏輯
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **設定**：使用 `src/test/resources` 中的 `application.properties`，如前所述，以確保使用 H2 而不是生產資料庫。

#### 替代設定方法：
- **使用 `@TestPropertySource`**：
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **使用設定檔**：
  - 在 `src/test/resources/application-test.properties` 中建立 H2 設定。
  - 在測試上使用 `@ActiveProfiles("test")` 註解。

---

### 步驟 4：初始化測試資料（可選）
要將測試資料填入 H2 資料庫：

- **使用 `schema.sql` 和 `data.sql`**：
  - 將這些檔案放在 `src/test/resources` 中。
  - 當嵌入式資料庫啟動時，Spring Boot 會執行 `schema.sql` 來建立表格，並執行 `data.sql` 來插入資料。
  - 範例 `data.sql`：
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **使用 `@Sql`**：
  - 在測試方法之前或之後執行特定的 SQL 腳本。
  - 範例：
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // 測試邏輯
    }
    ```

---

### 步驟 5：確保測試隔離（可選）
為防止測試方法相互干擾：
- 在測試類別或方法上使用 `@Transactional`。在 `@DataJpaTest` 中，這預設是啟用的，每個測試後都會回滾變更。對於 `@SpringBootTest`，如果需要，請明確新增：
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- 這確保每個測試都從一致的資料庫狀態開始。

---

### 步驟 6：模擬生產資料庫（可選）
如果您的生產資料庫不同（例如 MySQL、PostgreSQL），請使用相容性模式設定 H2 來模擬它：
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- 支援的模式包括 `MySQL`、`PostgreSQL` 等，使 H2 的 SQL 語法和行為與您的生產資料庫保持一致。

---

### 步驟 7：使用 H2 主控台進行除錯（可選）
要在測試期間檢查資料庫：
- 啟用 H2 主控台：
  ```properties
  spring.h2.console.enabled=true
  ```
- 如果運行 Web 伺服器（例如使用 `@SpringBootTest(webEnvironment = RANDOM_PORT)`），可以在 `http://localhost:<port>/h2-console` 存取它。
- 這在除錯時很有用，但在自動化測試運行中較少使用。

---

### 關鍵注意事項
- **H2 驅動程式**：正確的驅動程式類別是 `org.h2.Driver`，而不是 `com.h2database.h2`。後者指的是 Maven 的 `groupId:artifactId`。
- **Spring Boot 優勢**：自動設定簡化了 H2 的設定，特別是用於測試時。
- **記憶體特性**：當 JVM 停止時，H2 的資料會丟失，這使其成為隔離測試運行的理想選擇。

透過遵循這些步驟，您可以在 Spring 專案中有效地使用 H2 資料庫進行測試，利用其速度和簡單性來驗證您的資料層或完整應用程式堆疊。