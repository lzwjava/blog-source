---
audio: false
generated: true
image: false
lang: hant
layout: post
model: x-ai/grok-4-fast
title: 高效數據庫索引的 B 樹
translated: true
type: note
---

### 什麼是 B-樹？

B-樹（"平衡樹"的縮寫）是一種自平衡樹狀資料結構，專為高效儲存、插入、刪除和檢索大量資料而設計。它特別針對資料儲存在磁碟上的系統（如資料庫）進行優化，通過保持樹結構盡可能淺層來最小化昂貴的磁碟 I/O 操作次數。

#### B-樹的關鍵特性
- **階數（或度數）**：由參數 *t*（最小度數）定義，每個節點可包含 *t-1* 到 *2t-1* 個鍵值（以及最多 *2t* 個子節點）。這使得節點能容納多個鍵值，讓樹結構更寬更淺。
- **平衡結構**：所有葉節點位於同一層級，確保操作時間複雜度為對數級別（O(log n)，其中 n 為鍵值數量）。
- **排序鍵值**：每個節點中的鍵值按排序順序儲存，且樹結構維持此特性。鍵值左側的子樹包含較小值，右側則包含較大值。
- **節點結構**：內部節點包含用於引導搜索至子節點的鍵值。葉節點儲存實際資料（或指向資料的指標）。

與二元搜尋樹（BST）不同（後者每個節點僅限兩個子節點且可能失衡，導致最壞情況下 O(n) 的性能），B-樹是多路樹，通過在插入/刪除時分裂和合併節點來保持平衡。

#### 簡單範例
假設有一個 3 階 B-樹（*t=3*，每個節點可容納 2-5 個鍵值）。一個小型樹的文字形式可能如下：

```
       [10, 20, 30]
      /    |    |    \
 [5,7]  [15] [22,25] [35,40]
```

- 搜尋 25：從根節點開始，與 10/20/30 比較 → 向右移動至 [22,25] → 找到目標。

這種結構允許高效執行範圍查詢（例如所有介於 15 到 25 之間的鍵值），僅需遍歷少數節點。

### 資料庫如何運用 B-樹

資料庫（如關聯式資料庫：MySQL、PostgreSQL、SQL Server）大量依賴 B-樹（或其變體如 B+ 樹）進行**索引**，以加速對儲存在磁碟上的大型資料表的查詢。若無索引，查詢將需要全表掃描（O(n) 時間，對數百萬行資料而言極為緩慢）。

#### 在資料庫中的主要用途
1. **主索引與次要索引**：
   - **主索引**建立在主鍵（唯一識別符）上，按 B-樹順序組織資料表行以實現快速查找。
   - **次要索引**建立於其他欄位（例如姓名、日期），其葉節點指向實際行的位置（透過行 ID）。

2. **高效磁碟存取**：
   - 磁碟以區塊為單位讀取資料（例如 4KB 頁面）。B-樹節點的大小設計為恰好容納一個磁碟區塊，因此搜尋通常僅需讀取 3-4 個區塊（樹高度），相較於鏈結串列可能需讀取數千個。
   - 高度呈對數成長：對於 10 億個鍵值，高度可能僅有 4-5 層。

3. **B+ 樹變體（資料庫常用）**：
   - 多數資料庫使用 **B+ 樹**，這是 B-樹的改良版本：
     - 僅葉節點儲存資料/指標。
     - 內部節點僅包含用於路由的鍵值。
     - 葉節點以鏈結串列形式連接（雙向鏈結串列），實現高效的順序掃描和範圍查詢（例如 `SELECT * WHERE age BETWEEN 20 AND 30`）。
   - 這提升了範圍操作和快取效率。

4. **實務操作**：
   - **插入/更新/刪除**：樹結構通過分裂或合併節點來維持平衡。資料庫透過鎖定機制處理並行操作。
   - **查詢優化**：查詢計劃器使用索引統計數據來選擇 B-樹索引而非全表掃描。
   - **叢集與非叢集索引**：在叢集索引中（例如 MySQL 的 InnoDB），資料表資料實際按 B-樹葉節點順序儲存。非叢集索引僅指向資料位置。

#### 優勢與權衡
- **優點**：對於等值查詢、範圍查詢和排序查詢速度快；能良好處理增長中的資料。
- **缺點**：插入/刪除操作有維護開銷；對於極頻繁的更新操作（若未批次處理）並非最理想選擇。

總而言之，B-樹透過其平衡且適合磁碟操作的設計，成為資料庫索引存取的骨幹技術，將原本可能是線性搜尋的操作轉變為近乎常數時間的操作。

#### 參考資料
- [B-tree - Wikipedia](https://en.wikipedia.org/wiki/B-tree)
- [B+ Tree in DBMS - GeeksforGeeks](https://www.geeksforgeeks.org/introduction-of-b-tree/)
- [How Indexes Work in SQL Databases - Use The Index, Luke](https://use-the-index-luke.com/sql/anatomy/index-btree)