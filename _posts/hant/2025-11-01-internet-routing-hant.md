---
audio: false
generated: true
image: false
lang: hant
layout: post
model: x-ai/grok-4-fast
title: 互聯網路由運作原理
translated: true
type: note
---

是的，你對高層級流程的理解完全正確——一旦你的電腦取得 IP 位址（例如 weibo.com 的 106.63.15.9），它就會啟動一個連接，這個連接會經過你的本地網路、路由器、ISP 的基礎設施，並穿越網際網路上相互連接的路由器（「一層一層地」），直到抵達目標伺服器。這一切都是由 TCP/IP 協定堆疊自動處理的，除了輸入 URL 或執行像 `ping` 這樣的指令外，你無需手動進行任何操作。

我將逐步分解這個過程，並結合你的 `ping` 和 `traceroute` 輸出內容來解釋。我會保持實用性，專注於背後發生的過程，並假設是像你這樣的典型家庭設定（Mac 透過 Wi-Fi/乙太網路連接，位於路由器後方）。

### 1. **DNS 解析（取得 IP）**
   - 在進行任何連接之前，你的電腦首先透過 DNS（網域名稱系統）將網域名稱（例如 "weibo.com"）轉換為 IP。這是透過你作業系統的 DNS 解析器來完成的，它會查詢公共 DNS 伺服器（例如 Google 的 8.8.8.8）。
   - 在你的情況中，`ping weibo.com` 會自動進行這個解析，確認 106.63.15.9 是 IPv4 位址。（注意：像你本地的 127.0.0.1:7890 這樣的代理通常處理 HTTP/HTTPS 流量，但 `ping` 使用原始 IP/ICMP，因此它會繞過代理。）
   - 如果 DNS 失敗，連接就不會發生——一切到此為止。

### 2. **你的電腦準備封包（本地端）**
   - 一旦取得 IP，你的 Mac 會使用 TCP/IP 層來建立一個**封包**（一段資料）：
     - **應用層**：指令或應用程式（例如瀏覽器或 `ping`）請求資料。`Ping` 發送一個 ICMP "echo request"（一個簡單的「嘿，你在嗎？」訊息）。
     - **傳輸層**：添加 TCP/UDP 標頭（用於可靠性/通訊埠號）或用於 ping 的 ICMP。你的 ping 使用 ICMP，帶有 56 位元組的資料 + 標頭 = 64 位元組的封包。
     - **網路層（IP）**：用 IP 標頭封裝它，包含來源（你的本地 IP，例如 192.168.1.x）和目的地（106.63.15.9）。路由決策從這裡開始。
     - **連結層（乙太網路/Wi-Fi）**：為本地網路躍點添加 MAC 位址。你的電腦使用 ARP（位址解析協定）來尋找路由器的 MAC 位址。
     - **實體層**：透過你的有線/Wi-Fi 轉換為電氣訊號。
   - 你的電腦知道它無法直接到達 106.63.15.9（它不在你的本地 192.168.1.0/24 子網路上），因此它將封包發送到**預設閘道**——你在 192.168.1.1 的路由器。

### 3. **本地躍點：電腦 → 路由器**
   - 這是第一步（也是最快的一步），顯示在你的 `traceroute` 輸出中：
     ```
     1  192.168.1.1 (192.168.1.1) 26.903 ms 3.150 ms 3.161 ms
     ```
     - `Traceroute`（它發送 TTL——存活時間——遞增的封包來映射路徑）確認這個躍點需要約 3-27 毫秒的往返時間。
     - 你的路由器接收封包，剝離本地乙太網路標頭，並為下一個躍點重新封裝它。它使用其路由表將其轉發到網際網路（透過其 WAN/ISP 連接）。
     - 代理不影響這一點——你的本地代理（通訊埠 7890）僅用於應用層流量，如網頁瀏覽，而不是原始 IP 路由。

### 4. **路由器 → ISP → 網際網路骨幹（「一層一層」的路由）**
   - 你的路由器撥接到你的 ISP（例如，透過 PPPoE、DHCP 或數據機），並將封包交給 ISP 的邊緣路由器。這可能涉及你路由器上的 NAT（網路位址轉譯），將你的私有 IP（192.168.1.x）換成 ISP 分配給你的公共 IP。
   - 從這裡開始，它是一連串穿越網際網路的**路由器**：
     - **ISP 路由器**：你的 ISP（例如 Comcast 或 China Telecom）透過其核心網路路由它。每個路由器遞減 TTL（在你的 traceroute 中從 64 開始），並基於 BGP（邊界閘道協定）表進行轉發——本質上是通往 106.63.15.9 的最佳路徑的全球地圖。
     - **ISP 間/骨幹躍點**：封包穿越 ISP 之間的「對等互連點」（例如，透過海底電纜、光纖）。這可能是總共 5-20 個躍點，取決於地理位置。Weibo.com 的 IP（106.63.15.9）在中國，因此從你的位置（根據代理猜測在美國/歐盟）來看，它會經過跨太平洋的路由。
     - 每個躍點都是一個路由器檢查 IP 標頭，決定下一個閘道，並進行轉發。沒有一個單一裝置知道完整路徑——它是分散式的。
   - 你的 `traceroute` 被中斷了（可能用 ^Z 暫停了），但如果你完整執行它，你會看到另外 10-15 行，例如：
     ```
     2  [ISP router IP] 10 ms ...
     3  [ISP core] 15 ms ...
     ...
     15  106.63.15.9  40 ms ...
     ```
     - 時間累加：你的 ping 顯示總共約 40 毫秒的 RTT（往返時間），因此到伺服器的單程時間約為 20 毫秒。

### 5. **目標伺服器接收並回應**
   - 封包到達 Weibo 的伺服器（或 106.63.15.9 的負載平衡器）。它反向進行過程：回應一個 ICMP echo reply（用於 ping）或 TCP SYN-ACK（用於網路連接）。
   - 回應沿著類似的路徑返回，通常是同一條路線，但不總是如此（網際網路路由是不對稱的）。
   - 你的 `ping` 確認成功：TTL=52 表示約 12 個躍點（64-52=12），而 40 毫秒的延遲符合中國-美國的往返時間。

### 為什麼它感覺「神奇」（以及常見問題）
- **自動化**：你的作業系統/核心透過網路堆疊處理所有這些（例如，`ifconfig` 或 `ip route` 顯示你的路由）。除非你在除錯，否則無需手動設定。
- **你的代理**：它對 ping/traceroute 是透明的，但會攔截到 weibo.com 的瀏覽器流量，透過 127.0.0.1:7890 路由它（可能用於 VPN/繞過審查）。如果測試原始連接，請使用 `unset HTTP_PROXY HTTPS_PROXY` 來停用它。
- **如果失敗**：防火牆、MTU 不匹配或路由黑洞可能會丟棄封包。像 `tcpdump` 或 Wireshark 這樣的工具讓你可以本地嗅探這一點。
- **安全注意**：IP 可能會改變（DNS TTL），而 HTTPS 在此之上添加了加密（在 TCP 連接之後進行 TLS 握手）。

總之，是的——電腦 → 路由器 → ISP → 全球路由器網格 → 伺服器。這是一個建立在 IP 路由之上的美麗分散式系統。如果你分享完整的 traceroute 或想深入了解特定部分（例如，網路的 TCP 握手），請告訴我！

[TCP/IP Illustrated (Book on Networking Basics)](https://www.oreilly.com/library/view/tcp-ip-illustrated-volume/0201633469/)  
[How Traceroute Works (Cloudflare Explanation)](https://www.cloudflare.com/learning/network-layer/what-is-traceroute/)