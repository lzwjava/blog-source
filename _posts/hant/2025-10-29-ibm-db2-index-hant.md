---
audio: false
generated: true
image: false
lang: hant
layout: post
model: x-ai/grok-4-fast
title: IBM DB2 索引結構詳解
translated: true
type: note
---

### IBM DB2 索引運作原理

IBM DB2 使用 **B+ 樹**作為其索引的主要資料結構。這是一種平衡樹變體，專為關聯式資料庫中常見的基於磁碟的儲存和範圍查詢進行了優化。B+ 樹確保了高效的搜尋、插入和刪除操作，具有對數時間複雜度（O(log n)），使其非常適合大型資料集。以下我將分解其結構、關鍵操作以及 DB2 的特定說明。

#### DB2 中的 B+ 樹結構
DB2 中的 B+ 樹組織成一個由**頁面**（也稱為節點）組成的層次結構，每個頁面在磁碟上的大小通常為 4KB。該樹是自平衡的，意味著所有葉節點都位於同一深度，並且它會隨著資料變化而動態增長或縮小。以下是詳細分解：

- **根頁面**：樹頂部的入口點。它包含排序的鍵值以及指向下方子頁面的指標。對於小型索引，根頁面可能直接指向葉頁面。
  
- **內部（非葉）頁面**：這些中間層級充當目錄。每個頁面包含：
  - 一個排序的**索引鍵**列表（來自索引欄位的值，例如員工 ID）。
  - 指向子頁面的指標（指標數量比鍵多一個，用於分隔範圍）。
  - 具體來說，每個條目是其下方子樹中的**最高鍵值**，並配有一個**記錄識別碼 (RID)**——一個指向實際資料列在表中所在頁面和槽位的唯一指標。
  
  非葉頁面*不*儲存實際的資料指標；它們僅引導遍歷。

- **葉頁面**：最底層，雙向連結（向前和向後）以實現高效的範圍掃描。每個葉頁面包含：
  - 來自索引欄位的完整排序**鍵值**。
  - 關聯的 **RID**，直接指向表中的資料列。
  - 指向相鄰葉頁面的指標，實現順序存取（例如，用於 `WHERE column BETWEEN x AND y`）。

該樹從至少 2 層（根 + 葉）開始，對於大型表（數百萬列）可以增長到 3–5+ 層。層級數 (NLEVELS) 可透過 `SYSCAT.INDEXES` 查詢，並影響效能——層級越少意味著遍歷越快，但 DB2 會自動管理這一點。

索引與表分開儲存在自己的表空間中，消耗的磁碟空間與索引資料量成正比（例如，在 100 萬列的表上的唯一索引可能佔用約 10–20% 的表大小）。

#### 搜尋運作原理
1. 從**根頁面**開始，並將其載入記憶體。
2. 將搜尋鍵（例如 `WHERE id = 123`）與目前頁面中的排序鍵進行比較。
3. 選擇適當的子指標（例如，如果搜尋鍵 > 目前鍵，則向右）。
4. 沿樹向下重複（通常為 1–5 次 I/O 操作），直到到達**葉頁面**。
5. 在葉頁面中，掃描排序鍵以找到匹配項，然後使用 RID 從表中獲取確切的資料列（再多一次 I/O）。

這種路徑壓縮使遍歷保持淺層。對於範圍查詢，一旦到達起始葉頁面，就跟隨兄弟連結進行順序掃描，而無需跳回樹的上層。

#### 插入與刪除
- **插入**：
  1. 遍歷到正確的葉頁面（如同搜尋）。
  2. 將新的鍵 + RID 插入到排序的葉頁面中。
  3. 如果頁面溢出（超過最大條目數，約 200–500，取決於鍵大小），則將其拆分為兩個頁面，並將一個分隔鍵插入到父（內部）頁面中。
  4. 如果父頁面溢出，則向上拆分（可能建立新的根）。DB2 會短暫鎖定頁面以實現並行控制。

- **刪除**：
  1. 遍歷到葉頁面並移除鍵 + RID。
  2. 如果頁面下溢（條目過少），則從兄弟頁面借用或與其合併，並從父頁面移除分隔鍵。
  3. 如果需要，向上傳播合併。DB2 可能會延遲重組以批量處理變更，提高效率。

這些操作會自動保持平衡，頁面拆分/合併的發生率極低（約佔操作的 1%）。

#### DB2 特定功能
- **優化 B+ 樹**（在 DB2 for z/OS 中）：針對大型主機的並行處理進行了增強，具有分形預取功能，可預測並預先載入頁面，減少 I/O。
- **叢集**：索引可以設定為「叢集」（資料按索引順序物理排序），以獲得更好的範圍查詢效能。
- **類型**：支援唯一、複合（多欄位）和點陣圖索引，均基於 B+ 樹。沒有原生雜湊索引。
- **維護**：在批量變更後執行 `RUNSTATS` 以更新優化器的統計資料。使用像 `INSPECT` 這樣的工具來檢查問題。

B+ 樹在 DB2 中表現出色，因為它們最大限度地減少了隨機 I/O（對於磁碟密集型系統至關重要），並支援排序存取而無需進行全表掃描。

[索引結構 - IBM](https://www.ibm.com/docs/en/db2/11.1.0?topic=indexes-index-structure)  
[DB2 LUW 索引：B-樹詳情](https://datageek.blog/2013/09/19/db2-luw-basics-indexes/)  
[深入 Db2 for z/OS：優化 B+ 樹如何驅動高速索引](https://planetmainframe.com/2025/06/inside-db2-for-z-os-how-optimized-b-trees-power-high-speed-indexing/)  
[如何快速理解 DB2 B-樹索引](https://srinimf.com/2021/07/26/db2-how-to-understand-b-tree-structure-of-index/)  
[Db2 索引概述](https://www.idug.org/news/db2-index-overview)