---
audio: false
generated: true
image: false
lang: hi
layout: post
model: x-ai/grok-code-fast-1
title: वीचैट एकीकरण कोड स्पष्टीकरण
translated: true
type: note
---

नीचे दी गई PHP कोड स्निपेट का विस्तृत विवरण दिया गया है। मैं इसे चरण-दर-चरण समझाऊंगा, जिसमें कोड क्या करता है, इसकी संरचना, और **यह वीचैट के साथ कैसे इंटरैक्ट करता है** पर ध्यान केंद्रित किया जाएगा। यह कोड एक CodeIgniter-आधारित वेब एप्लिकेशन (एक PHP फ्रेमवर्क) का हिस्सा प्रतीत होता है, विशेष रूप से `Wechat` नामक एक कंट्रोलर क्लास जो वीचैट के इकोसिस्टम के साथ एकीकृत होती है। यह एक ऐसी सेवा के लिए डिज़ाइन किया गया है जिसमें लाइव स्ट्रीमिंग, यूज़र प्रमाणीकरण, भुगतान और सूचनाएं (जैसे, लाइव ब्रॉडकास्ट ऐप जैसा प्लेटफॉर्म) शामिल होने की संभावना है।

मैं मानकर चलूंगा कि आप बुनियादी PHP और CodeIgniter (जैसे, लोडर, मॉडल, लाइब्रेरी) से परिचित हैं। यदि नहीं, तो कोड CodeIgniter के कन्वेंशन्स का उपयोग करता है: कंट्रोलर HTTP अनुरोधों को संभालते हैं, मॉडल डेटाबेस के साथ इंटरैक्ट करते हैं, और लाइब्रेरी बाहरी API को समाहित करती हैं। कोड बाहरी कॉन्स्टेंट (जैसे, `WECHAT_APP_ID`, `WECHAT_APP_SECRET`), कुंजियों (जैसे, `KEY_URL`), और एरर कोड (जैसे, `ERROR_GET_ACCESS_TOKEN`) पर भी निर्भर करता है, जो यहां परिभाषित नहीं हैं लेकिन संभवतः एक कॉन्फ़िग फ़ाइल में हैं।

### 1. **समग्र संरचना और उद्देश्य**
   - **क्लास अवलोकन**: `Wechat` `BaseController` (संभवतः एक कस्टम बेस क्लास) का विस्तार करती है। यह मॉडल (जैसे, सोशल लॉगिन डेटा के लिए `SnsUserDao`, यूज़र प्रबंधन के लिए `UserDao`) और लाइब्रेरी (जैसे, वीचैट JS SDK के लिए `JSSDK`, भुगतान के लिए `WxPay`, मिनी-प्रोग्राम डेटा डिक्रिप्शन के लिए `WXBizDataCrypt`) लोड करती है।
   - **निर्भरताएं और लाइब्रेरी**:
     - `JSSDK`: वेब इंटरैक्शन (जैसे, शेयरिंग, भुगतान) के लिए वीचैट के JavaScript SDK को रैप करती है।
     - `WeChatPlatform`: संभवतः वीचैट संदेश भेजने या हैंडल करने के लिए कस्टम कोड।
     - `WxPay` / `WxPayCallback`: वीचैट पे (जैसे, भुगतान और सूचनाएं) को संभालती है।
     - `WXBizDataCrypt`: मिनी-प्रोग्राम से एन्क्रिप्टेड डेटा को डिक्रिप्ट करने के लिए आधिकारिक वीचैट लाइब्रेरी।
     - `WxDao`, `WxSessionDao` जैसे मॉडल डेटाबेस में वीचैट-विशिष्ट डेटा (जैसे, सत्र, सब्सक्रिप्शन) प्रबंधित करते हैं।
   - **मुख्य उद्देश्य**: यह कंट्रोलर यूज़र प्रमाणीकरण (OAuth), भुगतान, संदेश/घटना हैंडलिंग (जैसे, चैट के जवाब), सब्सक्रिप्शन प्रबंधन और ऐप सुविधाओं के लिए वीचैट API के साथ ऐप को जोड़ती है। यह एक स्टैंडअलोन स्क्रिप्ट नहीं है बल्कि आपके ऐप के फ्रंटएंड या वीचैट के सर्वर से आने वाले HTTP GET/POST अनुरोधों का जवाब देती है।
   - **सुरक्षा नोट्स**: सत्यापन के लिए SHA1 सिग्नेचर का उपयोग करती है (जैसे, `checkSignature()` में) और संवेदनशील डेटा को एन्क्रिप्ट करती है (जैसे, मिनी-प्रोग्राम में वीचैट के AES डिक्रिप्शन के माध्यम से)। SQL इंजेक्शन से बचाव प्रिपेयर्ड स्टेटमेंट (मॉडल में माना गया) के साथ करती है और सुरक्षा के लिए XML एंटिटी लोडिंग को अक्षम करती है।

### 2. **यह वीचैट के साथ कैसे इंटरैक्ट करता है**
   कोड कई तरीकों से वीचैट के साथ इंटरैक्ट करता है, मुख्य रूप से **API कॉल** (वीचैट सर्वर को आउटगोइंग अनुरोध) और **वेबहुक** (वीचैट से इनकमिंग अनुरोध) के माध्यम से। वीचैट पब्लिक अकाउंट, वेब ऐप, ऐप और मिनी-प्रोग्राम के लिए API प्रदान करता है। इंटरैक्शन वीचैट के OAuth फ्लो, भुगतान प्रोटोकॉल और मैसेजिंग मानकों का पालन करते हैं।

   - **मुख्य इंटरैक्शन तंत्र**:
     - **आउटगोइंग अनुरोध**: वीचैट API को HTTP GET/POST का उपयोग करता है (`JSSDK` मेथड जैसे `httpGetAccessToken()` या `wechatHttpGet()` के माध्यम से)। ये एक्सेस टोकन, यूज़र इन्फो जैसे डेटा फ़ेच करते हैं, या QR कोड जनरेट करते हैं।
     - **इनकमिंग वेबहुक**: वीचैट आपके ऐप को POST अनुरोध भेजता है (जैसे, `/callback` एंडपॉइंट पर) संदेशों, घटनाओं (जैसे, यूज़र आपके पब्लिक अकाउंट को सब्सक्राइब करता है), या भुगतान सूचनाओं के लिए। आपका ऐप XML (जैसे, ऑटो-रिप्लाई) के साथ प्रोसेस करता है और जवाब देता है।
     - **प्रमाणीकरण**: API एक्सेस के लिए ऐप क्रेडेंशियल (`WECHAT_APP_ID`, `WECHAT_APP_SECRET`, `WECHAT_TOKEN`) पर निर्भर करता है। स्पूफिंग को रोकने के लिए सिग्नेचर के माध्यम से अनुरोधों को सत्यापित करता है।
     - **कवर किए गए प्लेटफॉर्म**: वीचैट पब्लिक अकाउंट (जैसे, वेब के लिए), वीचैट ऐप, वीचैट मिनी-प्रोग्राम (जैसे, नेटिव ऐप के लिए), और वेब OAuth का समर्थन करता है। `unionId` (एक अद्वितीय वीचैट पहचानकर्ता) के माध्यम से यूजरों को प्लेटफॉर्म में मैप करता है।

   आइए अब वीचैट इंटरैक्शन के उदाहरणों के साथ, कार्यक्षमता के आधार पर समूहीकृत, प्रमुख विधियों/विधि समूहों की व्याख्या करते हैं।

#### **A. आरंभीकरण और साझा उपयोगिताएँ**
   - **कंस्ट्रक्टर (`__construct`)**: लाइब्रेरी और मॉडल लोड करता है। आपके वीचैट ऐप क्रेडेंशियल के साथ `JSSDK` सेटअप करता है। यहां कोई सीधा वीचैट इंटरैक्शन नहीं है—यह API कॉल की तैयारी है।
   - **सिग्नेचर सत्यापन (`checkSignature`)**: वीचैट से आने वाले अनुरोधों को सत्यापित करता है (जैसे, `callback_get` में)। `timestamp`, `nonce`, और आपके `WECHAT_TOKEN` को SHA1 है में मिलाता है। यदि यह वीचैट के `signature` से मेल खाता है, तो अनुरोध प्रामाणिक है। यह वेबहुक को सुरक्षित करता है।
   - **डेटा रूपांतरण**: `xmlToArray()` और `arrayToXml()`: वीचैट XML में संचार करता है। आने वाले XML (जैसे, संदेश) को एरे में और आउटगोइंग प्रतिक्रियाओं (जैसे, जवाब) को वापस XML में बदलता है।
   - **वीचैट के साथ इंटरैक्शन**: सुनिश्चित करता है कि सभी वेबहुक/एंडपॉइंट इंटरैक्शन सत्यापित हैं। आप वीचैट के डेवलपर कंसोल में इन सुरक्षित अनुरोधों को प्राप्त करने के लिए एक URL कॉन्फ़िगर करते हैं (जैसे, `yourdomain.com/wechat/callback`)।

#### **B. OAuth और यूज़र प्रमाणीकरण/लॉगिन**
   ये विधियां वीचैट OAuth के माध्यम से यूज़र लॉगिन, यूज़र प्रोफाइल प्राप्त करने और अकाउंट बाइंडिंग को संभालती हैं। वीचैट OAuth यूजरों को अनुमति के लिए वीचैट पर रीडायरेक्ट करता है, फिर आपके ऐप पर एक `code` के साथ वापस भेजता है जिसे आप टोकन के लिए एक्सचेंज करते हैं।

   - **सामान्य प्रवाह**:
     - यूज़र "वीचैट के साथ लॉगिन" पर क्लिक करता है → वीचैट पर रीडायरेक्ट होता है → वीचैट आपके ऐप को एक `code` भेजता है → आपका ऐप `code` को `access_token` और यूज़र इन्फो के लिए एक्सचेंज करता है → अपने डेटाबेस में यूज़र बनाता है/लॉगिन करता है।
     - यूजरों को वीचैट प्लेटफॉर्म (जैसे, वेब और मिनी-प्रोग्राम) में लिंक करने के लिए `unionId` का उपयोग करता है।

   - **`sign_get()`**: आपके वेब पेजों पर वीचैट JS SDK के लिए एक सिग्नेचर पैकेज जनरेट करता है। शेयरिंग या लोकेशन जैसी सुविधाओं की अनुमति देता है। *वीचैट इंटरैक्शन*: कोई सीधी API कॉल नहीं; ऐप सीक्रेट का उपयोग करके सिग्नेचर की गणना करता है। JS SDK आपके पेज को सत्यापित करने और वीचैट सुविधाओं को सक्षम करने के लिए इसका उपयोग करता है।
   
   - **`oauth_get()`**: वीचैट वेब के लिए पूर्ण OAuth को संभालता है। `code` को एक्सेस टोकन के लिए एक्सचेंज करता है, यूज़र इन्फो फ़ेच करता है, और यूज़र को लॉगिन या रजिस्टर करता है। यदि आवश्यक हो तो `unionId` से बाइंड करता है। *वीचैट इंटरैक्शन*: `/sns/oauth2/access_token` (टोकन प्राप्त करें) और `/sns/userinfo` (प्रोफाइल प्राप्त करें) के लिए API कॉल। यदि नया यूज़र है, तो डेटाबेस में जोड़ता है; मौजूदा यूजरों को लॉगिन करता है।

   - **`silentOauth_get()`**: साइलेंट (नो-पॉपअप) OAuth। टोकन प्राप्त करता है लेकिन विस्तृत यूज़र इन्फो को छोड़ देता है। सब्सक्रिप्शन की जांच करता है। *वीचैट इंटरैक्शन*: ऊपर के समान API कॉल, लेकिन `/userinfo` नहीं। यूज़र के पिछले लॉगिन को सत्यापित करने के लिए `/sns/auth` का उपयोग करता है।

   - **`webOauth_get()`**: ओपन-प्लेटफॉर्म OAuth (वेबसाइटों के लिए)। `unionId` फ़ेच करता है और यदि बाउंड है तो लॉगिन करता है। *वीचैट इंटरैक्शन*: ओपन प्लेटफॉर्म API (पब्लिक अकाउंट API से अलग) का उपयोग करता है।

   - **`bind_get()`**: एक लॉग्ड-इन यूज़र को वीचैट से बाइंड करता है। `code` को टोकन के लिए एक्सचेंज करता है और `unionId` के माध्यम से यूज़र को लिंक करता है। *वीचैट इंटरैक्शन*: ऐप-लेवल OAuth (`/sns/oauth2/accesstoken`), फिर DB में बाइंड करें।

   - **`appOauth_get()`**: वीचैट ऐप (मिनी-प्रोग्राम नहीं) के लिए। जांचता है कि क्या यूज़र `unionId` द्वारा मौजूद है; यदि नहीं, तो रजिस्ट्रेशन के लिए तैयारी करता है। *वीचैट इंटरैक्शन*: `/sns/userinfo` जैसे API के साथ मोबाइल ऐप OAuth फ्लो।

   - **मिनी-प्रोग्राम विशिष्ट (`login_post()` और `registerByApp_post()`)**: वीचैट मिनी-प्रोग्राम (नेटिव ऐप) के लिए लॉगिन/रजिस्ट्रेशन संभालता है।
     - `login_post()`: वीचैट मिनी-प्रोग्राम `code` को `session_key` (अस्थायी कुंजी) के लिए एक्सचेंज करता है। Redis ( `WxSessionDao` के माध्यम से) में स्टोर करता है। *वीचैट इंटरैक्शन*: `/jscode2session` API को कॉल करता है।
     - `registerByApp_post()`: `WXBizDataCrypt` (AES डिक्रिप्शन) का उपयोग करके यूज़र डेटा को डिक्रिप्ट करता है। सिग्नेचर सत्यापित करता है, `unionId` के माध्यम से यूज़र को रजिस्टर/लॉगिन करता है। *वीचैट इंटरैक्शन*: वीचैट से एन्क्रिप्टेड भेजे गए डेटा को डिक्रिप्ट करता है; यदि डेटा वैध है तो कोई आउटबाउंड API नहीं।

   - **इंटरैक्शन नोट्स**: OAuth वह मुख्य तरीका है जिससे वीचैट यूजरों को "पहचानता है"। आपके ऐप को ID/सीक्रेट प्राप्त करने के लिए वीचैट के कंसोल (पब्लिक अकाउंट, ऐप, या मिनी-प्रोग्राम) में पंजीकृत होना चाहिए। एरर (जैसे, अमान्य टोकन) को फेल्योर रिस्पांस के माध्यम से संभाला जाता है।

#### **C. भुगतान हैंडलिंग**
   - **`wxpayNotify_post()`**: वीचैट पे सूचनाओं (जैसे, भुगतान पुष्टि) को प्रोसेस करता है। हैंडलिंग के लिए `WxPayCallback` को पास करता है। *वीचैट इंटरैक्शन*: वीचैट के भुगतान सर्वर से वेबहुक (POST `/wxpayNotify` पर)। कोई प्रतिक्रिया आवश्यक नहीं; केवल परिणाम लॉग करता है।
   - **इंटरैक्शन नोट्स**: वीचैट पे में मर्चेंट सेटअप की आवश्यकता होती है। लेन-देन को सुरक्षित रूप से संभालता है—यहां से भुगतान ट्रिगर न करें; यह सिर्फ पुष्टि है।

#### **D. संदेश और घटना हैंडलिंग (वेबहुक)**
   ये वीचैट के सर्वर से आने वाले संदेशों/घटनाओं को संभालते हैं, जो `/callback` पर POST अनुरोधों के रूप में भेजे जाते हैं।

   - **`callback_get()`**: सेटअप के दौरान वीचैट को सत्यापित करता है। यदि वैध है तो `echostr` को प्रतिध्वनित करता है (एक बार की डेव जांच)। *वीचैट इंटरैक्शन*: सत्यापन के लिए सिग्नेचर के साथ इनकमिंग GET।

   - **`callback_post()`**: संदेशों/घटनाओं (जैसे, यूजर आपके पब्लिक अकाउंट को टेक्स्ट करना, सब्सक्राइब करना, या QR कोड स्कैन करना) के लिए मुख्य वेबहुक हैंडलर।
     - XML इनपुट को एरे में पार्स करता है।
     - टेक्स्ट संदेशों को संभालता है (जैसे, लाइव स्ट्रीम खोजें, अनसब्सक्राइब कीवर्ड), सब्सक्रिप्शन (वेलकम संदेश), अनसब्सक्रिप्शन, QR स्कैन/दृश्य (जैसे, लाइव इवेंट या रेड पैकेट के लिए)।
     - XML के साथ जवाब देता है (जैसे, `WeChatPlatform` के माध्यम से टेक्स्ट या कस्टम संदेश)।
     - घटनाओं को लॉग करता है (जैसे, अनसब्सक्राइब) DB में।
     - *वीचैट इंटरैक्शन*: वीचैट से XML प्राप्त करता है (जैसे, `<xml><MsgType>text</MsgType>...</xml>`)। 5 सेकंड के भीतर XML के साथ प्रतिक्रिया करता है। यहां कोई आउटबाउंड API नहीं है—यह निष्क्रिय है।

   - **इंटरैक्शन नोट्स**: `EVENT_SUBSCRIBE` जैसी घटनाएं कस्टम लॉजिक (जैसे, DB सब्सक्रिप्शन अपडेट करें, लिंक के साथ वेलकम संदेश भेजें) को ट्रिगर करती हैं। QR कोड दृश्यों (जैसे, प्रोमो पेज) के लिए JSON को एनकोड करते हैं।

#### **E. अन्य विशेषताएं**
   - **`isSubscribe_get()` और `fixAllSubscribe_get()`**: वीचैट API के माध्यम से जांचता है कि क्या कोई यूज़र आपके पब्लिक अकाउंट को फॉलो करता है। बल्क में सभी यूजरों की सब्सक्रिप्शन स्थिति को ठीक करता है। *वीचैट इंटरैक्शन*: openId के साथ `/cgi-bin/user/info` API को कॉल करता है।
   
   - **मेनू/मैसेजिंग**: `menu_get()`, `createMenu_get()`, `addNews_get()`, `sendMassMsg_get()`: पब्लिक अकाउंट मेनू प्रबंधित करें, आर्टिकल बनाएं/भेजें, और मास संदेश भेजें। *वीचैट इंटरैक्शन*: `/cgi-bin/menu/get`, `/cgi-bin/menu/create`, आदि जैसे API।
   
   - **`uploadImg_get()`**: आर्टिकल के लिए इमेज अपलोड करता है। *वीचैट इंटरैक्शन*: अपलोड API।
   
   - **`qrcode_get()`**: दृश्यों (जैसे, प्रोमो लिंक) के लिए QR कोड जनरेट करता है। *वीचैट इंटरैक्शन*: `/cgi-bin/qrcode/create` को कॉल करता है।
   
   - **`group_get()`**: एक स्थिर इमेज URL लौटाता है (वीचैट से असंबंधित प्रतीत होता है)।

### 3. **सामान्य पैटर्न और प्रवाह**
   - **सफलता/विफलता हैंडलिंग**: प्रतिक्रिया देने के लिए `succeed()` और `failure()` (संभवतः `BaseController` से) का उपयोग करता है। डीबगिंग के लिए एरर/इन्फो लॉग करता है।
   - **डेटाबेस एकीकरण**: मॉडल (जैसे, `UserDao`, `SnsUserDao`) यूज़र निर्माण, बाइंडिंग और सब्सक्रिप्शन संभालते हैं। `unionId` के माध्यम से क्रॉस-प्लेटफॉर्म का समर्थन करता है।
   - **एरर और एज केस**: API विफलताओं (जैसे, अमान्य कोड), SQL समस्याओं, और एन्क्रिप्शन एरर को संभालता है। मिनी-प्रोग्राम फ्लो सुरक्षा के लिए सत्र कुंजी (संक्षेप में संग्रहीत) का उपयोग करते हैं।
   - **प्रदर्शन/सुरक्षा**: DB अपडेट को बैच करता है (जैसे, `fixAllSubscribe_get` में)। वीचैट की दर सीमा और सिग्नेचर जांच पर निर्भर करता है।

### 4. **इसका उपयोग/डिप्लॉय कैसे करें**
   - एक CodeIgniter ऐप में, रूट इन विधियों (जैसे, `GET /wechat/oauth` `oauth_get()` को कॉल करता है) को निर्देशित करते हैं।
   - वीचैट कॉन्फ़िगर करें: वीचैट डेवलपर कंसोल में URL/IP सेट करें।