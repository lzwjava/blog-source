---
audio: false
generated: false
image: false
lang: hi
layout: post
title: рдСрдЯреЛрдореЗрдЯрд┐рдВрдЧ рдХреНрд▓реИрд╢ рдкреНрд░реЙрдХреНрд╕реА рдкреНрд░рдмрдВрдзрди
translated: true
type: post
---

рдпрд╣ рдкреЛрд╕реНрдЯ рдПрдХ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ, `clash.py` рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рддреА рд╣реИ, рдЬрд┐рд╕реЗ **рдЖрдкрдХреЗ рдХреНрд▓реИрд╢ рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд┐рдЧрд░реЗрд╢рди рдХреЗ рдкреНрд░рдмрдВрдзрди рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣ **рд╕рдордп-рд╕рдордп рдкрд░ рдЕрдкрдбреЗрдЯреЗрдб рдкреНрд░реЙрдХреНрд╕реА рдХреЙрдиреНрдлрд┐рдЧрд░реЗрд╢рди рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ**, **рдХреНрд▓реИрд╢ рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░рдиреЗ**, рдФрд░ **рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рдореВрд╣ рдХреЗ рднреАрддрд░ рдЙрдкрд▓рдмреНрдз рд╕рдмрд╕реЗ рддреЗрдЬрд╝ рдкреНрд░реЙрдХреНрд╕реА рдХреЛ рдЪреБрдирдиреЗ рдФрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ** рд╕рд╣рд┐рдд рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рд╕рдВрднрд╛рд▓рддрд╛ рд╣реИред `clash.py` рдХреЗ рд╕рд╛рде, `speed.py` рдореЙрдбреНрдпреВрд▓ **рд╡реНрдпрдХреНрддрд┐рдЧрдд рдХреНрд▓реИрд╢ рдкреНрд░реЙрдХреНрд╕реА рдХреА рд╕рдорд╡рд░реНрддреА рд╡рд┐рд▓рдВрдмрддрд╛ рдкрд░реАрдХреНрд╖рдг** рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддрд╛ рд╣реИ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдЖрдкрдХрд╛ рдХрдиреЗрдХреНрд╢рди рд╣рдореЗрд╢рд╛ рдЗрд╖реНрдЯрддрдо рд╕рд░реНрд╡рд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд░реВрдЯ рд╣реЛрддрд╛ рд╣реИред

## clash.py

```python
import os
import subprocess
import time
import shutil
import argparse
import logging
import requests
import json
import urllib.parse

# рдорд╛рди рд▓реЗрдВ рдХрд┐ speed.py рдПрдХ рд╣реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╣реИ рдпрд╛ PYTHONPATH рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ
from speed import get_top_proxies 

# --- рдХреЙрдиреНрдлрд┐рдЧрд░реЗрд╢рди ---
CLASH_CONTROLLER_HOST = "127.0.0.1"
CLASH_CONTROLLER_PORT = 9090
CLASH_API_BASE_URL = f"http://{CLASH_CONTROLLER_HOST}:{CLASH_CONTROLLER_PORT}"
# рд╡рд╣ рдкреНрд░реЙрдХреНрд╕реА рд╕рдореВрд╣ рдирд╛рдо рдЬрд┐рд╕рдореЗрдВ рд╕рд░реНрд╡рд╢реНрд░реЗрд╖реНрда рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкреНрд░реЙрдХреНрд╕реА рдХреЛ рдирд┐рдпреБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
# рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдпрд╣ рд╕рдореВрд╣ рдЖрдкрдХреЗ рдХреНрд▓реИрд╢ рдХреЙрдиреНрдлрд┐рдЧрд░реЗрд╢рди рдореЗрдВ рдореМрдЬреВрдж рд╣реИред
TARGET_PROXY_GROUP = "ЁЯЪзProxy" 

def setup_logging():
    """рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд▓рд┐рдП рдмреЗрд╕рд┐рдХ рд▓реЙрдЧрд┐рдВрдЧ рдХреЙрдиреНрдлрд┐рдЧрд░ рдХрд░рддрд╛ рд╣реИред"""
    logging.basicConfig(
        filename='clash.log', 
        level=logging.INFO,
        format='%(asctime)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

def start_system_proxy(global_proxy_address):
    """рд╕рд┐рд╕реНрдЯрдо-рд╡рд╛рдЗрдб рдкреНрд░реЙрдХреНрд╕реА рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред"""
    os.environ["GLOBAL_PROXY"] = global_proxy_address # рдпрджрд┐ рдХрд╣реАрдВ рдФрд░ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рддреЛ рд╕реНрдерд┐рд░рддрд╛ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд░реЗрдВ
    os.environ["HTTP_PROXY"] = f"http://{global_proxy_address}"
    os.environ["HTTPS_PROXY"] = f"http://{global_proxy_address}"
    os.environ["http_proxy"] = f"http://{global_proxy_address}"
    os.environ["https_proxy"] = f"http://{global_proxy_address}"
    # рдЖрдорддреМрд░ рдкрд░ рдЗрдиреНрд╣реЗрдВ рдЖрдзреБрдирд┐рдХ рдЯреВрд▓реНрд╕ рдХреЗ рд╕рд╛рде "false" рдкрд░ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ,
    # рд▓реЗрдХрд┐рди рдЖрдкрдХреА рдореВрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдЗрд░рд╛рджреЗ рдХреЗ рдЕрдиреБрд░реВрдк рд░рдЦрд╛ рдЧрдпрд╛ рд╣реИред
    os.environ["HTTP_PROXY_REQUEST_FULLURI"] = "false" 
    os.environ["HTTPS_PROXY_REQUEST_FULLURI"] = "false"
    os.environ["ALL_PROXY"] = os.environ["http_proxy"]
    logging.info(f"рд╕рд┐рд╕реНрдЯрдо-рд╡рд╛рдЗрдб рдкреНрд░реЙрдХреНрд╕реА рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛: {global_proxy_address}")

def stop_system_proxy():
    """рд╕рд┐рд╕реНрдЯрдо-рд╡рд╛рдЗрдб рдкреНрд░реЙрдХреНрд╕реА рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЛ рд╕рд╛рдл рдХрд░рддрд╛ рд╣реИред"""
    os.environ["http_proxy"] = ""
    os.environ["HTTP_PROXY"] = ""
    os.environ["https_proxy"] = ""
    os.environ["HTTPS_PROXY"] = ""
    os.environ["HTTP_PROXY_REQUEST_FULLURI"] = "true" # рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкрд░ рд╡рд╛рдкрд╕
    os.environ["HTTPS_PROXY_REQUEST_FULLURI"] = "true"
    os.environ["ALL_PROXY"] = ""
    logging.info("рд╕рд┐рд╕реНрдЯрдо-рд╡рд╛рдЗрдб рдкреНрд░реЙрдХреНрд╕реА рдмрдВрдж рдХрд┐рдпрд╛ рдЧрдпрд╛ (рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рд╕рд╛рдл рдХрд┐рдП рдЧрдП)ред")

def switch_clash_proxy_group(group_name, proxy_name):
    """
    рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреНрд▓реИрд╢ рдкреНрд░реЙрдХреНрд╕реА рд╕рдореВрд╣ рдореЗрдВ рд╕рдХреНрд░рд┐рдп рдкреНрд░реЙрдХреНрд╕реА рдХреЛ рдПрдХ рдирдП рдкреНрд░реЙрдХреНрд╕реА рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рддрд╛ рд╣реИред
    """
    encoded_group_name = urllib.parse.quote(group_name)
    url = f"{CLASH_API_BASE_URL}/proxies/{encoded_group_name}"
    headers = {"Content-Type": "application/json"}
    payload = {"name": proxy_name}
    
    try:
        response = requests.put(url, headers=headers, data=json.dumps(payload), timeout=5)
        response.raise_for_status()
        logging.info(f"рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ '{group_name}' рдХреЛ '{proxy_name}' рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ред")
        return True
    except requests.exceptions.ConnectionError:
        logging.error(f"рддреНрд░реБрдЯрд┐: рдХреНрд▓реИрд╢ API рд╕реЗ {CLASH_API_BASE_URL} рдкрд░ рдХрдиреЗрдХреНрдЯ рдирд╣реАрдВ рд╣реЛ рдкрд╛рдпрд╛ рдкреНрд░реЙрдХреНрд╕реА рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред")
        logging.error("рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдХреНрд▓реИрд╢ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ external-controller рдХреЙрдиреНрдлрд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред")
        return False
    except requests.exceptions.Timeout:
        logging.error(f"рддреНрд░реБрдЯрд┐: '{group_name}' рдХреЗ рд▓рд┐рдП рдкреНрд░реЙрдХреНрд╕реА рд╕реНрд╡рд┐рдЪ рдХрд░рддреЗ рд╕рдордп рдХреНрд▓реИрд╢ API рд╕реЗ рдХрдиреЗрдХреНрд╢рди рдЯрд╛рдЗрдордЖрдЙрдЯ рд╣реЛ рдЧрдпрд╛ред")
        return False
    except requests.exceptions.RequestException as e:
        logging.error(f"'{group_name}' рдХреЗ рд▓рд┐рдП рдкреНрд░реЙрдХреНрд╕реА рд╕реНрд╡рд┐рдЪ