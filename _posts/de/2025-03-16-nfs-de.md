---
audio: false
generated: true
lang: de
layout: post
title: Einrichtung eines NFS-Servers für Medienfreigabe unter Ubuntu
translated: true
type: note
---

Um einen NFS (Network File System) Server auf Ubuntu einzurichten, um Mediendateien bereitzustellen, befolgen Sie diese detaillierten Schritte. Diese Anleitung geht davon aus, dass Sie ein Verzeichnis mit Mediendateien (z.B. Videos, Musik) sicher und effizient über Ihr Netzwerk freigeben möchten.

---

### Schritt 1: Installieren der NFS-Server-Software
Zuerst müssen Sie das NFS-Server-Paket auf Ihrem Ubuntu-System installieren.

1. Aktualisieren Sie die Paketliste, um sicherzustellen, dass Sie die neuesten Versionen erhalten:
   ```bash
   sudo apt update
   ```

2. Installieren Sie das Paket `nfs-kernel-server`, das die NFS-Server-Funktionalität bereitstellt:
   ```bash
   sudo apt install nfs-kernel-server
   ```

Dies installiert die notwendige Software, um einen NFS-Server zu betreiben.

---

### Schritt 2: Erstellen und Konfigurieren des Medienverzeichnisses
Sie benötigen ein Verzeichnis, um Ihre Mediendateien zu speichern und es für die Freigabe zu konfigurieren.

1. Erstellen Sie ein Verzeichnis für Ihre Mediendateien (z.B. `/media/share`):
   ```bash
   sudo mkdir -p /media/share
   ```

2. Setzen Sie den Besitzer auf Ihr Benutzerkonto (ersetzen Sie `$USER` durch Ihren tatsächlichen Benutzernamen, falls nötig):
   ```bash
   sudo chown $USER:$USER /media/share
   ```

3. Passen Sie die Berechtigungen an, um Zugriff zu erlauben. Für Mediendateien, die für Clients primär schreibgeschützt sind, können Sie setzen:
   - Verzeichnisse: `755` (Lesen und Ausführen für andere)
   - Dateien: `644` (Lesen für andere)
   Der Einfachheit halber können Sie `755` rekursiv anwenden, wenn Sie keine feingranulare Kontrolle benötigen:
   ```bash
   sudo chmod -R 755 /media/share
   ```
   - **Hinweis**: Mediendateien müssen nicht ausführbar sein, aber `755` auf Dateien schadet der NFS-Funktionalität nicht, da die Ausführung lokal auf dem Client erfolgt.

4. Platzieren Sie Ihre Mediendateien in `/media/share` (z.B. kopieren Sie Videos oder Musik in dieses Verzeichnis).

---

### Schritt 3: Konfigurieren der NFS-Exports
Der NFS-Server verwendet die Datei `/etc/exports`, um festzulegen, welche Verzeichnisse freigegeben werden und wer darauf zugreifen darf.

1. Öffnen Sie die exports-Datei mit einem Texteditor:
   ```bash
   sudo nano /etc/exports
   ```

2. Fügen Sie eine Zeile hinzu, um `/media/share` freizugeben. Die Syntax lautet:
   ```
   /pfad/zum/verzeichnis client(optionen)
   ```
   - **Beispiel 1**: Für einen bestimmten Client freigeben (z.B. `192.168.1.100`) mit Lese-Schreib-Zugriff:
     ```
     /media/share 192.168.1.100(rw,sync,no_subtree_check)
     ```
   - **Beispiel 2**: Für alle Geräte in Ihrem Subnetz freigeben (z.B. `192.168.1.0/24`) mit Nur-Lese-Zugriff:
     ```
     /media/share 192.168.1.0/24(ro,sync,no_subtree_check)
     ```
   - **Beispiel 3**: Für jedes Gerät freigeben (weniger sicher, mit Vorsicht verwenden):
     ```
     /media/share *(rw,sync,no_subtree_check)
     ```

   **Erklärte Optionen**:
   - `rw`: Lese-Schreib-Zugriff (verwenden Sie `ro` für Nur-Lese, z.B. für Media-Streaming).
   - `sync`: Stellt sicher, dass Daten auf die Festplatte geschrieben werden, bevor Operationen bestätigt werden (sicherer, aber langsamer; verwenden Sie `async` für bessere Performance, mit dem Risiko von Datenverlust bei Abstürzen).
   - `no_subtree_check`: Verbessert die Performance durch Deaktivieren der Subtree-Überprüfung (für die meisten Setups empfohlen).

3. Speichern Sie die Datei (`Strg+O`, dann `Eingabe` in nano) und beenden Sie den Editor (`Strg+X`).

---

### Schritt 4: Anwenden der NFS-Konfiguration
Nach dem Bearbeiten der exports-Datei müssen Sie den NFS-Server aktualisieren, um Ihre Änderungen zu übernehmen.

1. Exportieren Sie die Freigaben:
   ```bash
   sudo exportfs -a
   ```

2. Starten Sie den NFS-Server neu, um die Konfiguration anzuwenden:
   ```bash
   sudo systemctl restart nfs-kernel-server
   ```

3. Überprüfen Sie, ob der Dienst läuft:
   ```bash
   sudo systemctl status nfs-kernel-server
   ```
   - Suchen Sie nach "active (running)" in der Ausgabe.

4. Überprüfen Sie die exportierten Verzeichnisse:
   ```bash
   sudo exportfs -v
   ```
   - Dies sollte `/media/share` mit den von Ihnen festgelegten Optionen auflisten.

---

### Schritt 5: Konfigurieren der Firewall
NFS verwendet spezifische Ports, und Sie müssen sicherstellen, dass Ihre Firewall Datenverkehr zu diesen erlaubt. Ubuntu verwendet oft UFW (Uncomplicated Firewall).

1. **Standard NFS-Ports**:
   - NFS: 2049 (TCP/UDP)
   - RPC: 111 (TCP/UDP)
   - Andere Dienste (mountd, statd, lockd): Standardmäßig dynamisch, können aber auf statische Ports gesetzt werden.

2. Der Einfachheit halber, erlauben Sie die wesentlichen Ports mit dynamischen Einstellungen (wenn Sie keine statischen Ports setzen):
   ```bash
   sudo ufw allow 2049
   sudo ufw allow 111
   ```
   - **Hinweis**: Dies deckt möglicherweise nicht den gesamten NFS-Datenverkehr ab, wenn mountd, statd oder lockd zufällige Ports verwenden.

3. **Optional: Statische Ports für bessere Kontrolle setzen** (empfohlen für präzise Firewall-Regeln):
   - Bearbeiten Sie `/etc/default/nfs-kernel-server`:
     ```bash
     sudo nano /etc/default/nfs-kernel-server
     ```
     Fügen Sie hinzu oder modifizieren Sie:
     ```
     RPCMOUNTDOPTS="-p 4001"
     ```
   - Bearbeiten Sie `/etc/default/nfs-common`:
     ```bash
     sudo nano /etc/default/nfs-common
     ```
     Fügen Sie hinzu oder modifizieren Sie:
     ```
     STATDOPTS="-p 4002"
     ```
   - Erstellen Sie `/etc/modprobe.d/nfs.conf` für lockd:
     ```bash
     sudo nano /etc/modprobe.d/nfs.conf
     ```
     Fügen Sie hinzu:
     ```
     options lockd nlm_udp_port=4003 nlm_tcp_port=4003
     ```
   - Starten Sie den NFS-Server neu:
     ```bash
     sudo systemctl restart nfs-kernel-server
     ```

4. Erlauben Sie die statischen Ports in UFW:
   ```bash
   sudo ufw allow 2049/tcp
   sudo ufw allow 2049/udp
   sudo ufw allow 111/tcp
   sudo ufw allow 111/udp
   sudo ufw allow 4001/tcp
   sudo ufw allow 4001/udp
   sudo ufw allow 4002/tcp
   sudo ufw allow 4002/udp
   sudo ufw allow 4003/tcp
   sudo ufw allow 4003/udp
   ```

5. Aktivieren Sie UFW, falls es noch nicht aktiv ist:
   ```bash
   sudo ufw enable
   ```

---

### Schritt 6: Überprüfen des Setups
Stellen Sie sicher, dass der NFS-Server korrekt funktioniert.

1. Überprüfen Sie die exportierten Freigaben vom Server:
   ```bash
   showmount -e localhost
   ```
   - Sie sollten `/media/share` mit den korrekten Clients/Optionen aufgelistet sehen.

2. Überprüfen Sie die lauschenden Ports:
   ```bash
   sudo ss -tuln | grep -E "2049|111|4001|4002|4003"
   ```
   - Bestätigen Sie, dass diese Ports offen und an die NFS-Dienste gebunden sind.

---

### Schritt 7: Test von einem Client (Optional)
Testen Sie auf einem Client-Rechner (z.B. einem anderen Ubuntu-System) das Mounten der Freigabe:
```bash
sudo mount -t nfs <server_ip>:/media/share /mnt
```
- Ersetzen Sie `<server_ip>` mit der IP-Adresse Ihres NFS-Servers.
- Stellen Sie sicher, dass `/mnt` existiert (`sudo mkdir /mnt` falls nötig).
- Greifen Sie auf `/mnt` zu, um zu überprüfen, ob Sie die Mediendateien sehen und abspielen können.

---

### Zusätzliche Hinweise für Mediendateien
- **Nur-Lese-Zugriff**: Wenn Clients nur streamen müssen, verwenden Sie `ro` in `/etc/exports`, um Modifikationen zu verhindern.
- **Berechtigungen**: Stellen Sie sicher, dass Mediendateien von Clients lesbar sind. UID/GID-Unterschiede zwischen Server und Client können Zugriffsprobleme verursachen; passen Sie Dateiberechtigungen an oder verwenden Sie NFS-Optionen wie `all_squash` bei Bedarf (fortgeschritten).
- **Performance**: Für große Mediendateien ist die Standardoption `sync` sicher, aber langsamer. Testen Sie mit `async`, wenn Performance priorisiert wird und das Risiko von Datenverlust akzeptabel ist.
- **NFS-Version**: Ubuntu standardisiert auf NFSv4, was für das Bereitstellen von Medien geeignet ist. Typischerweise ist keine zusätzliche Konfiguration nötig, es sei denn, ältere Clients (NFSv3) müssen unterstützt werden.

---

### Befehlszusammenfassung
Hier ist eine kurze Referenz für das grundlegende Setup (ohne statische Ports):
```bash
sudo apt update
sudo apt install nfs-kernel-server
sudo mkdir -p /media/share
sudo chown $USER:$USER /media/share
sudo chmod -R 755 /media/share
echo "/media/share *(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
sudo ufw allow 2049
sudo ufw allow 111
```

Mit diesem Setup sollte Ihr Ubuntu NFS-Server bereit sein, um Mediendateien über das Netzwerk bereitzustellen. Passen Sie IP-Adressen, Berechtigungen und Firewall-Regeln basierend auf Ihren Sicherheits- und Netzwerkanforderungen an.