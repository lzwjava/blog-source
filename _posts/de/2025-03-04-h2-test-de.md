---
audio: false
generated: true
lang: de
layout: post
title: Verwenden Sie die H2-Datenbank für das Testen
translated: true
---

Um die H2-Datenbank in einem Spring-Projekt, insbesondere für Testzwecke, zu verwenden, müssen Sie diese leichte, in-memory-Datenbank in Ihre Spring-Anwendung integrieren. Die H2-Datenbank ist ideal für Tests, da sie im Speicher läuft, schnell ist und leicht eingerichtet und wieder abgebaut werden kann, ohne Daten auf die Festplatte zu speichern. Im Folgenden werde ich erklären, wie Sie H2 in Ihr Spring-Projekt einbinden, vorausgesetzt, Sie verwenden Spring Boot (eine gängige Konfiguration für Spring-Projekte), und die Referenz auf `com.h2database.h2` klären, die wahrscheinlich auf die Maven-Abhängigkeit und nicht auf ein Paket oder eine Klassenbezeichnung hinweist (die Treiberklasse ist tatsächlich `org.h2.Driver`).

---

### Schritt 1: H2-Abhängigkeit hinzufügen
Um H2 in Ihrem Spring-Projekt zu verwenden, müssen Sie seine Abhängigkeit in Ihre Build-Datei aufnehmen. Da Sie `com.h2database.h2` erwähnt haben, stimmt dies mit den Maven-Koordinaten für das H2-Datenbank-Artifact überein. Hier ist, wie Sie es hinzufügen:

#### Für Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **Hinweis**: Der `<scope>test</scope>` stellt sicher, dass H2 nur während der Testphase verfügbar ist, was Ihrem Testfokus entspricht.

#### Für Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

Wenn Sie Spring Boot verwenden und Starter wie `spring-boot-starter-data-jpa` oder `spring-boot-starter-jdbc` enthalten haben, wird Spring Boot automatisch eine kompatible H2-Version herunterladen, wenn Sie eine H2-Datenquelle für Tests konfigurieren. In solchen Fällen ist das explizite Hinzufügen der H2-Abhängigkeit optional, es sei denn, Sie benötigen eine spezifische Version.

---

### Schritt 2: H2 als Datenquelle für Tests konfigurieren
In einem Spring Boot-Projekt konfigurieren Sie die Datenbank über Eigenschaften, typischerweise in `application.properties` oder `application.yml`. Für Tests platzieren Sie diese Konfigurationen in `src/test/resources`, um die Hauptanwendungseinstellungen zu überschreiben.

#### Konfiguration in `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **Erklärung**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: Gibt eine In-Memory-H2-Datenbank mit dem Namen `testdb` an. Das Schlüsselwort `mem` stellt sicher, dass die Daten im RAM gespeichert werden.
  - `spring.datasource.driverClassName=org.h2.Driver`: Die JDBC-Treiberklasse für H2 (nicht `com.h2database.h2`, was wahrscheinlich ein Tippfehler oder eine Verwechslung mit dem Maven-Artifact ist).
  - `spring.datasource.username=sa`: Standardbenutzername für H2.
  - `spring.datasource.password=`: Standardmäßig leeres Passwort.

#### Minimale Konfiguration mit Auto-Konfiguration:
Wenn Sie Spring Boot mit `spring-boot-starter-data-jpa` oder `spring-boot-starter-jdbc` verwenden und H2 auf dem Klassenspeicher ist, kann Spring Boot eine eingebettete H2-Datenbank ohne explizite Eigenschaften auto-konfigurieren. Es erzeugt einen zufälligen Datenbanknamen (z.B. `jdbc:h2:mem:<random-uuid>`). Das Angeben der oben genannten Eigenschaften gibt Ihnen jedoch die Kontrolle über den Datenbanknamen und die Einstellungen.

---

### Schritt 3: H2 in Tests verwenden
Spring Boot bietet Test-Anmerkungen, um die Datenbanktests mit H2 zu vereinfachen. Der Ansatz hängt davon ab, ob Sie Repositories (unit-ähnliche Tests) oder den gesamten Anwendungsstapel (Integrationstests) testen.

#### Option 1: Repositories mit `@DataJpaTest` testen
Zum Testen von Spring Data JPA-Repositories verwenden Sie die `@DataJpaTest`-Anmerkung. Sie konfiguriert automatisch eine In-Memory-H2-Datenbank, scannt nach `@Entity`-Klassen und richtet Repositories ein.

**Beispiel**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // Angenommen, Daten werden geladen (z.B. über data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **Vorteile**:
  - H2 wird automatisch eingerichtet.
  - Tests sind transaktional und rollen standardmäßig zurück, was einen sauberen Datenbankzustand pro Test gewährleistet.

#### Option 2: Integrationstests mit `@SpringBootTest`
Für Vollständigkeitstests (z.B. Testen von Controllern, Diensten und Repositories zusammen) verwenden Sie `@SpringBootTest`. Konfigurieren Sie H2 über test-spezifische Eigenschaften.

**Beispiel**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // Testen Sie die Dienstlogik, die mit der Datenbank interagiert
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **Konfiguration**: Verwenden Sie die `application.properties` in `src/test/resources`, wie oben gezeigt, um sicherzustellen, dass H2 anstelle der Produktionsdatenbank verwendet wird.

#### Alternative Konfigurationsmethoden:
- **Verwenden von `@TestPropertySource`**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **Verwenden von Profilen**:
  - Erstellen Sie `src/test/resources/application-test.properties` mit der H2-Konfiguration.
  - Kennzeichnen Sie den Test mit `@ActiveProfiles("test")`.

---

### Schritt 4: Testdaten initialisieren (optional)
Um die H2-Datenbank mit Testdaten zu füllen:

- **Verwenden von `schema.sql` und `data.sql`**:
  - Platzieren Sie diese Dateien in `src/test/resources`.
  - Spring Boot führt `schema.sql` aus, um Tabellen zu erstellen, und `data.sql`, um Daten einzufügen, wenn die eingebettete Datenbank startet.
  - Beispiel `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **Verwenden von `@Sql`**:
  - Führen Sie spezifische SQL-Skripte vor oder nach Testmethoden aus.
  - Beispiel:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // Testlogik
    }
    ```

---

### Schritt 5: Testisolierung sicherstellen (optional)
Um zu verhindern, dass Testmethoden sich gegenseitig beeinflussen:
- Verwenden Sie `@Transactional` auf Testklassen oder -methoden. Mit `@DataJpaTest` ist dies standardmäßig aktiviert und rollt Änderungen nach jedem Test zurück. Für `@SpringBootTest` fügen Sie es explizit hinzu, falls erforderlich:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- Dies stellt sicher, dass jeder Test mit einem konsistenten Datenbankzustand beginnt.

---

### Schritt 6: Produktionsdatenbank emulieren (optional)
Wenn Ihre Produktionsdatenbank unterschiedlich ist (z.B. MySQL, PostgreSQL), konfigurieren Sie H2, um sie mit Kompatibilitätsmodi zu emulieren:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- Unterstützte Modi umfassen `MySQL`, `PostgreSQL` usw., um die SQL-Syntax und das Verhalten von H2 an Ihre Produktionsdatenbank anzupassen.

---

### Schritt 7: Debugging mit H2-Konsole (optional)
Zum Untersuchen der Datenbank während der Tests:
- Aktivieren Sie die H2-Konsole:
  ```properties
  spring.h2.console.enabled=true
  ```
- Greifen Sie darauf zu unter `http://localhost:<port>/h2-console`, wenn ein Webserver läuft (z.B. mit `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- Dies ist nützlich für das Debuggen, aber weniger üblich in automatisierten Testläufen.

---

### Wichtige Hinweise
- **H2-Treiber**: Die richtige Treiberklasse ist `org.h2.Driver`, nicht `com.h2database.h2`. Letzteres bezieht sich auf die Maven `groupId:artifactId`.
- **Spring Boot-Vorteil**: Die Auto-Konfiguration vereinfacht die H2-Einrichtung, insbesondere für Tests.
- **In-Memory-Natur**: Die Daten von H2 gehen verloren, wenn die JVM stoppt, was sie ideal für isolierte Testläufe macht.

Durch das Befolgen dieser Schritte können Sie die H2-Datenbank effektiv in Ihrem Spring-Projekt für Tests verwenden und ihre Geschwindigkeit und Einfachheit nutzen, um Ihre Datenebene oder den gesamten Anwendungsstapel zu validieren.