---
audio: false
generated: true
lang: de
layout: post
title: Verwenden Sie die H2-Datenbank für Tests
translated: true
type: note
---

Um die H2-Datenbank in einem Spring-Projekt zu verwenden, insbesondere für Testzwecke, müssen Sie diese schlanke In-Memory-Datenbank in Ihre Spring-Anwendung integrieren. Die H2-Datenbank ist ideal für Tests, da sie im Speicher läuft, schnell ist und einfach eingerichtet sowie abgebaut werden kann, ohne Daten dauerhaft auf der Festplatte zu speichern. Im Folgenden werde ich erläutern, wie Sie H2 in Ihr Spring-Projekt einbinden, unter der Annahme, dass Sie Spring Boot verwenden (eine gängige Konfiguration für Spring-Projekte), und kläre den Verweis auf `com.h2database.h2`, der sich wahrscheinlich auf die Maven-Abhängigkeit und nicht auf einen Paket- oder Klassennamen bezieht (die Treiberklasse lautet tatsächlich `org.h2.Driver`).

---

### Schritt 1: Fügen Sie die H2-Abhängigkeit hinzu
Um H2 in Ihrem Spring-Projekt zu verwenden, müssen Sie dessen Abhängigkeit in Ihrer Build-Datei angeben. Da Sie `com.h2database.h2` erwähnt haben, stimmt dies mit den Maven-Koordinaten für das H2-Datenbank-Artefakt überein. So fügen Sie es hinzu:

#### Für Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **Hinweis**: Der `<scope>test</scope>` stellt sicher, dass H2 nur während der Testphase verfügbar ist, was Ihrem Testfokus entspricht.

#### Für Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

Wenn Sie Spring Boot verwenden und Starter wie `spring-boot-starter-data-jpa` oder `spring-boot-starter-jdbc` eingebunden haben, wird die Abhängigkeitsverwaltung von Spring Boot automatisch eine kompatible H2-Version einbinden, wenn Sie eine H2-Datenquelle für Tests konfigurieren. In solchen Fällen ist das explizite Hinzufügen der H2-Abhängigkeit optional, es sei denn, Sie benötigen eine bestimmte Version.

---

### Schritt 2: Konfigurieren Sie H2 als Datenquelle für Tests
In einem Spring Boot-Projekt konfigurieren Sie die Datenbank über Properties, typischerweise in `application.properties` oder `application.yml`. Platzieren Sie diese Konfigurationen für Tests in `src/test/resources`, um die Haupteinstellungen der Anwendung zu überschreiben.

#### Konfiguration in `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **Erklärung**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: Gibt eine H2-In-Memory-Datenbank mit dem Namen `testdb` an. Das Schlüsselwort `mem` stellt sicher, dass Daten im RAM gespeichert werden.
  - `spring.datasource.driverClassName=org.h2.Driver`: Die JDBC-Treiberklasse für H2 (nicht `com.h2database.h2`, was wahrscheinlich ein Tippfehler oder eine Verwechslung mit dem Maven-Artefakt ist).
  - `spring.datasource.username=sa`: Standard-H2-Benutzername.
  - `spring.datasource.password=`: Standardmäßig leeres Passwort.

#### Minimale Konfiguration mit Auto-Konfiguration:
Wenn Sie Spring Boot mit `spring-boot-starter-data-jpa` oder `spring-boot-starter-jdbc` verwenden und H2 sich im Classpath befindet, kann Spring Boot eine eingebettete H2-Datenbank ohne explizite Properties automatisch konfigurieren. Es generiert einen zufälligen Datenbanknamen (z.B. `jdbc:h2:mem:<random-uuid>`). Das Angeben der obigen Properties gibt Ihnen jedoch Kontrolle über den Datenbanknamen und die Einstellungen.

---

### Schritt 3: Verwenden Sie H2 in Tests
Spring Boot bietet Test-Annotationen, um das Testen der Datenbank mit H2 zu vereinfachen. Der Ansatz hängt davon ab, ob Sie Repositorys (einheitartige Tests) oder den gesamten Anwendungsstack (Integrationstests) testen.

#### Option 1: Testen von Repositorys mit `@DataJpaTest`
Um Spring Data JPA-Repositorys zu testen, verwenden Sie die Annotation `@DataJpaTest`. Sie konfiguriert automatisch eine H2-In-Memory-Datenbank, scannt nach `@Entity`-Klassen und richtet Repositorys ein.

**Beispiel**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // Angenommen, Daten wurden geladen (z.B. via data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **Vorteile**:
  - H2 wird automatisch eingerichtet.
  - Tests sind standardmäßig transaktional und führen ein Rollback durch, was einen sauberen Datenbankzustand pro Test gewährleistet.

#### Option 2: Integrationstests mit `@SpringBootTest`
Für vollständige Integrationstests (z.B. Testen von Controllern, Services und Repositorys zusammen) verwenden Sie `@SpringBootTest`. Konfigurieren Sie H2 über test-spezifische Properties.

**Beispiel**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // Testen Sie Service-Logik, die mit der Datenbank interagiert
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **Konfiguration**: Verwenden Sie die `application.properties` in `src/test/resources`, wie zuvor gezeigt, um sicherzustellen, dass H2 anstelle der Produktionsdatenbank verwendet wird.

#### Alternative Konfigurationsmethoden:
- **Verwenden von `@TestPropertySource`**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **Verwenden von Profilen**:
  - Erstellen Sie `src/test/resources/application-test.properties` mit der H2-Konfiguration.
  - Kommentieren Sie den Test mit `@ActiveProfiles("test")`.

---

### Schritt 4: Testdaten initialisieren (Optional)
Um die H2-Datenbank mit Testdaten zu füllen:

- **Verwenden von `schema.sql` und `data.sql`**:
  - Platzieren Sie diese Dateien in `src/test/resources`.
  - Spring Boot führt `schema.sql` zum Erstellen von Tabellen und `data.sql` zum Einfügen von Daten aus, wenn die eingebettete Datenbank startet.
  - Beispiel `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **Verwenden von `@Sql`**:
  - Führen Sie bestimmte SQL-Skripte vor oder nach Testmethoden aus.
  - Beispiel:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // Testlogik
    }
    ```

---

### Schritt 5: Testisolation sicherstellen (Optional)
Um zu verhindern, dass Testmethoden sich gegenseitig beeinflussen:
- Verwenden Sie `@Transactional` für Testklassen oder -methoden. Bei `@DataJpaTest` ist dies standardmäßig aktiviert und macht Änderungen nach jedem Test rückgängig. Für `@SpringBootTest` fügen Sie es bei Bedarf explizit hinzu:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- Dies stellt sicher, dass jeder Test mit einem konsistenten Datenbankzustand beginnt.

---

### Schritt 6: Produktionsdatenbank emulieren (Optional)
Wenn sich Ihre Produktionsdatenbank unterscheidet (z.B. MySQL, PostgreSQL), konfigurieren Sie H2 so, dass sie diese mithilfe von Kompatibilitätsmodi emuliert:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- Unterstützte Modi umfassen `MySQL`, `PostgreSQL` usw., um die SQL-Syntax und das Verhalten von H2 an Ihre Produktionsdatenbank anzupassen.

---

### Schritt 7: Debugging mit der H2-Konsole (Optional)
Um die Datenbank während der Tests zu inspizieren:
- Aktivieren Sie die H2-Konsole:
  ```properties
  spring.h2.console.enabled=true
  ```
- Greifen Sie unter `http://localhost:<port>/h2-console` darauf zu, wenn ein Webserver läuft (z.B. mit `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- Dies ist nützlich zum Debuggen, aber weniger üblich in automatisierten Testläufen.

---

### Wichtige Hinweise
- **H2-Treiber**: Die korrekte Treiberklasse ist `org.h2.Driver`, nicht `com.h2database.h2`. Letzteres bezieht sich auf die Maven-`groupId:artifactId`.
- **Spring Boot-Vorteil**: Die Auto-Konfiguration vereinfacht die H2-Einrichtung, insbesondere für Tests.
- **In-Memory-Charakter**: Die Daten von H2 gehen verloren, wenn die JVM stoppt, was es ideal für isolierte Testläufe macht.

Indem Sie diese Schritte befolgen, können Sie die H2-Datenbank effektiv in Ihrem Spring-Projekt für Tests verwenden, indem Sie ihre Geschwindigkeit und Einfachheit nutzen, um Ihre Datenzugriffsschicht oder den gesamten Anwendungsstack zu validieren.