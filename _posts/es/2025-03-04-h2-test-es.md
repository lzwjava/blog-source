---
audio: false
generated: true
lang: es
layout: post
title: Utilizar H2 Database para Pruebas
translated: true
type: note
---

Para utilizar la base de datos H2 en un proyecto Spring, especialmente con fines de prueba, necesitas integrar esta base de datos ligera en memoria en tu aplicación Spring. La base de datos H2 es ideal para pruebas porque se ejecuta en memoria, es rápida y puede configurarse y eliminarse fácilmente sin persistir datos en el disco. A continuación, explicaré cómo incorporar H2 en tu proyecto Spring, asumiendo que estás usando Spring Boot (una configuración común para proyectos Spring), y aclararé la referencia a `com.h2database.h2`, que probablemente se refiere a la dependencia de Maven en lugar de un nombre de paquete o clase (la clase del controlador es en realidad `org.h2.Driver`).

---

### Paso 1: Agregar la Dependencia de H2
Para usar H2 en tu proyecto Spring, debes incluir su dependencia en tu archivo de compilación. Dado que mencionaste `com.h2database.h2`, esto coincide con las coordenadas de Maven para el artefacto de la base de datos H2. Aquí se explica cómo agregarla:

#### Para Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **Nota**: El `<scope>test</scope>` garantiza que H2 solo esté disponible durante la fase de prueba, lo que se adapta a tu enfoque de testing.

#### Para Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

Si estás usando Spring Boot y has incluido starters como `spring-boot-starter-data-jpa` o `spring-boot-starter-jdbc`, la gestión de dependencias de Spring Boot incluirá automáticamente una versión compatible de H2 cuando configures un origen de datos H2 para pruebas. En tales casos, agregar explícitamente la dependencia de H2 es opcional a menos que necesites una versión específica.

---

### Paso 2: Configurar H2 como el Origen de Datos para Pruebas
En un proyecto Spring Boot, configuras la base de datos a través de propiedades, típicamente en `application.properties` o `application.yml`. Para las pruebas, coloca estas configuraciones en `src/test/resources` para anular la configuración de la aplicación principal.

#### Configuración en `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **Explicación**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: Especifica una base de datos H2 en memoria llamada `testdb`. La palabra clave `mem` garantiza que los datos se almacenen en la RAM.
  - `spring.datasource.driverClassName=org.h2.Driver`: La clase del controlador JDBC para H2 (no `com.h2database.h2`, que probablemente sea un error tipográfico o una confusión con el artefacto de Maven).
  - `spring.datasource.username=sa`: Nombre de usuario predeterminado de H2.
  - `spring.datasource.password=`: Contraseña vacía predeterminada.

#### Configuración Mínima con Auto-Configuración:
Si estás usando Spring Boot con `spring-boot-starter-data-jpa` o `spring-boot-starter-jdbc` y H2 está en el classpath, Spring Boot puede auto-configurar una base de datos H2 integrada sin propiedades explícitas. Genera un nombre de base de datos aleatorio (por ejemplo, `jdbc:h2:mem:<random-uuid>`). Sin embargo, especificar las propiedades anteriores te da control sobre el nombre y la configuración de la base de datos.

---

### Paso 3: Usar H2 en las Pruebas
Spring Boot proporciona anotaciones de prueba para simplificar las pruebas de base de datos con H2. El enfoque depende de si estás probando repositorios (pruebas tipo unitarias) o toda la pila de la aplicación (pruebas de integración).

#### Opción 1: Probar Repositorios con `@DataJpaTest`
Para probar repositorios de Spring Data JPA, usa la anotación `@DataJpaTest`. Configura automáticamente una base de datos H2 en memoria, escanea las clases `@Entity` y configura los repositorios.

**Ejemplo**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // Asumiendo que los datos se cargan (por ejemplo, via data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **Beneficios**:
  - H2 se configura automáticamente.
  - Las pruebas son transaccionales y se revierten por defecto, garantizando un estado de base de datos limpio por prueba.

#### Opción 2: Pruebas de Integración con `@SpringBootTest`
Para pruebas de integración de pila completa (por ejemplo, probar controladores, servicios y repositorios juntos), usa `@SpringBootTest`. Configura H2 a través de propiedades específicas de prueba.

**Ejemplo**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // Probar la lógica del servicio que interactúa con la base de datos
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **Configuración**: Usa el `application.properties` en `src/test/resources` como se mostró anteriormente para garantizar que se use H2 en lugar de la base de datos de producción.

#### Métodos Alternativos de Configuración:
- **Usando `@TestPropertySource`**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **Usando Perfiles**:
  - Crea `src/test/resources/application-test.properties` con la configuración de H2.
  - Anota la prueba con `@ActiveProfiles("test")`.

---

### Paso 4: Inicializar Datos de Prueba (Opcional)
Para poblar la base de datos H2 con datos de prueba:

- **Usando `schema.sql` y `data.sql`**:
  - Coloca estos archivos en `src/test/resources`.
  - Spring Boot ejecuta `schema.sql` para crear tablas y `data.sql` para insertar datos cuando se inicia la base de datos integrada.
  - Ejemplo de `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **Usando `@Sql`**:
  - Ejecuta scripts SQL específicos antes o después de los métodos de prueba.
  - Ejemplo:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // Lógica de prueba
    }
    ```

---

### Paso 5: Garantizar el Aislamiento de las Pruebas (Opcional)
Para evitar que los métodos de prueba interfieran entre sí:
- Usa `@Transactional` en las clases o métodos de prueba. Con `@DataJpaTest`, esto está habilitado por defecto, revirtiendo los cambios después de cada prueba. Para `@SpringBootTest`, agrégalo explícitamente si es necesario:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- Esto garantiza que cada prueba comience con un estado de base de datos consistente.

---

### Paso 6: Emular la Base de Datos de Producción (Opcional)
Si tu base de datos de producción es diferente (por ejemplo, MySQL, PostgreSQL), configura H2 para emularla usando modos de compatibilidad:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- Los modos admitidos incluyen `MySQL`, `PostgreSQL`, etc., alineando la sintaxis y el comportamiento SQL de H2 con tu base de datos de producción.

---

### Paso 7: Depuración con la Consola H2 (Opcional)
Para inspeccionar la base de datos durante las pruebas:
- Habilita la consola H2:
  ```properties
  spring.h2.console.enabled=true
  ```
- Accede a ella en `http://localhost:<port>/h2-console` si se está ejecutando un servidor web (por ejemplo, con `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- Esto es útil para la depuración pero menos común en ejecuciones de prueba automatizadas.

---

### Notas Clave
- **Controlador H2**: La clase correcta del controlador es `org.h2.Driver`, no `com.h2database.h2`. Este último se refiere al `groupId:artifactId` de Maven.
- **Ventaja de Spring Boot**: La auto-configuración simplifica la configuración de H2, especialmente para pruebas.
- **Naturaleza en Memoria**: Los datos de H2 se pierden cuando se detiene la JVM, lo que la hace ideal para ejecuciones de prueba aisladas.

Siguiendo estos pasos, puedes usar efectivamente la base de datos H2 en tu proyecto Spring para pruebas, aprovechando su velocidad y simplicidad para validar tu capa de datos o toda la pila de la aplicación.