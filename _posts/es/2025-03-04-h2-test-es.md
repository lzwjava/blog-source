---
audio: false
generated: true
lang: es
layout: post
title: Usar la Base de Datos H2 para Pruebas
translated: true
---

Para usar la base de datos H2 en un proyecto de Spring, especialmente para fines de prueba, necesitas integrar esta base de datos ligera y en memoria en tu aplicación Spring. La base de datos H2 es ideal para pruebas porque se ejecuta en memoria, es rápida y se puede configurar y desmontar fácilmente sin persistir datos en disco. A continuación, explicaré cómo incorporar H2 en tu proyecto de Spring, asumiendo que estás utilizando Spring Boot (una configuración común para proyectos de Spring), y aclararé la referencia a `com.h2database.h2`, que probablemente se refiere a la dependencia de Maven en lugar de un nombre de paquete o clase (la clase del controlador es en realidad `org.h2.Driver`).

---

### Paso 1: Agregar la Dependencia de H2
Para usar H2 en tu proyecto de Spring, debes incluir su dependencia en tu archivo de construcción. Dado que mencionaste `com.h2database.h2`, esto coincide con las coordenadas de Maven para el artefacto de la base de datos H2. Aquí te muestro cómo agregarlo:

#### Para Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **Nota**: El `<scope>test</scope>` asegura que H2 esté disponible solo durante la fase de prueba, lo cual se adapta a tu enfoque de pruebas.

#### Para Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

Si estás utilizando Spring Boot e has incluido starters como `spring-boot-starter-data-jpa` o `spring-boot-starter-jdbc`, la gestión de dependencias de Spring Boot traerá automáticamente una versión compatible de H2 cuando configures una fuente de datos H2 para pruebas. En tales casos, agregar explícitamente la dependencia de H2 es opcional a menos que necesites una versión específica.

---

### Paso 2: Configurar H2 como la Fuente de Datos para Pruebas
En un proyecto de Spring Boot, configuras la base de datos a través de propiedades, generalmente en `application.properties` o `application.yml`. Para pruebas, coloca estas configuraciones en `src/test/resources` para anular la configuración de la aplicación principal.

#### Configuración en `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **Explicación**:
  - `spring.datasource.url=jdbc:h2:mem:testdb`: Especifica una base de datos H2 en memoria llamada `testdb`. La palabra clave `mem` asegura que los datos se almacenen en RAM.
  - `spring.datasource.driverClassName=org.h2.Driver`: La clase del controlador JDBC para H2 (no `com.h2database.h2`, que probablemente es un error tipográfico o confusión con el artefacto de Maven).
  - `spring.datasource.username=sa`: Nombre de usuario predeterminado de H2.
  - `spring.datasource.password=`: Contraseña predeterminada vacía.

#### Configuración Mínima con Auto-Configuración:
Si estás utilizando Spring Boot con `spring-boot-starter-data-jpa` o `spring-boot-starter-jdbc` y H2 está en el classpath, Spring Boot puede configurar automáticamente una base de datos H2 integrada sin propiedades explícitas. Genera un nombre de base de datos aleatorio (por ejemplo, `jdbc:h2:mem:<random-uuid>`). Sin embargo, especificar las propiedades anteriores te da control sobre el nombre y la configuración de la base de datos.

---

### Paso 3: Usar H2 en Pruebas
Spring Boot proporciona anotaciones de prueba para simplificar las pruebas de base de datos con H2. El enfoque depende de si estás probando repositorios (pruebas similares a unidades) o la pila completa de la aplicación (pruebas de integración).

#### Opción 1: Probar Repositorios con `@DataJpaTest`
Para probar repositorios de Spring Data JPA, usa la anotación `@DataJpaTest`. Configura automáticamente una base de datos H2 en memoria, escanea las clases `@Entity` y configura los repositorios.

**Ejemplo**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // Supongamos que los datos están cargados (por ejemplo, a través de data.sql)
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **Beneficios**:
  - H2 se configura automáticamente.
  - Las pruebas son transaccionales y se revierten automáticamente, asegurando un estado de base de datos limpio por prueba.

#### Opción 2: Pruebas de Integración con `@SpringBootTest`
Para pruebas de integración de pila completa (por ejemplo, probar controladores, servicios y repositorios juntos), usa `@SpringBootTest`. Configura H2 a través de propiedades específicas de prueba.

**Ejemplo**:
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // Prueba la lógica del servicio que interactúa con la base de datos
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **Configuración**: Usa el `application.properties` en `src/test/resources` como se mostró anteriormente para asegurarte de que H2 se utilice en lugar de la base de datos de producción.

#### Métodos de Configuración Alternativos:
- **Usando `@TestPropertySource`**:
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **Usando Perfiles**:
  - Crea `src/test/resources/application-test.properties` con la configuración de H2.
  - Anota la prueba con `@ActiveProfiles("test")`.

---

### Paso 4: Inicializar Datos de Prueba (Opcional)
Para poblar la base de datos H2 con datos de prueba:

- **Usando `schema.sql` y `data.sql`**:
  - Coloca estos archivos en `src/test/resources`.
  - Spring Boot ejecuta `schema.sql` para crear tablas y `data.sql` para insertar datos cuando la base de datos integrada comienza.
  - Ejemplo `data.sql`:
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **Usando `@Sql`**:
  - Ejecuta scripts SQL específicos antes o después de los métodos de prueba.
  - Ejemplo:
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // Lógica de prueba
    }
    ```

---

### Paso 5: Asegurar el Aislamiento de Pruebas (Opcional)
Para evitar que los métodos de prueba interfieran entre sí:
- Usa `@Transactional` en las clases o métodos de prueba. Con `@DataJpaTest`, esto está habilitado por defecto, revirtiendo los cambios después de cada prueba. Para `@SpringBootTest`, agrégalo explícitamente si es necesario:
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- Esto asegura que cada prueba comience con un estado de base de datos consistente.

---

### Paso 6: Emular la Base de Datos de Producción (Opcional)
Si tu base de datos de producción difiere (por ejemplo, MySQL, PostgreSQL), configura H2 para emularla utilizando modos de compatibilidad:
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- Los modos compatibles incluyen `MySQL`, `PostgreSQL`, etc., alineando el comportamiento y la sintaxis SQL de H2 con tu base de datos de producción.

---

### Paso 7: Depurar con la Consola de H2 (Opcional)
Para inspeccionar la base de datos durante las pruebas:
- Habilita la consola de H2:
  ```properties
  spring.h2.console.enabled=true
  ```
- Accede a ella en `http://localhost:<port>/h2-console` si estás ejecutando un servidor web (por ejemplo, con `@SpringBootTest(webEnvironment = RANDOM_PORT)`).
- Esto es útil para la depuración pero menos común en ejecuciones de pruebas automatizadas.

---

### Notas Clave
- **Controlador de H2**: La clase del controlador correcta es `org.h2.Driver`, no `com.h2database.h2`. Este último se refiere al `groupId:artifactId` de Maven.
- **Ventaja de Spring Boot**: La auto-configuración simplifica la configuración de H2, especialmente para pruebas.
- **Naturaleza en Memoria**: Los datos de H2 se pierden cuando se detiene la JVM, lo que la hace ideal para ejecuciones de pruebas aisladas.

Siguiendo estos pasos, puedes usar eficazmente la base de datos H2 en tu proyecto de Spring para pruebas, aprovechando su velocidad y simplicidad para validar tu capa de datos o la pila completa de la aplicación.