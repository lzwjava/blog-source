---
audio: false
generated: true
lang: zh
layout: post
title: 配置NPM
translated: true
type: note
---

### 核心要点
- 配置 NPM 似乎涉及编辑 `.npmrc` 文件来设置代理和注册表配置，可通过手动或命令方式完成。
- 研究表明代理设置需要遵循 `proxy = http://user:password@proxy_server:port` 格式，特殊字符需进行 URL 编码。
- 证据倾向于将注册表默认设置为 `registry = https://registry.npmjs.org/`，必要时可禁用 SSL 验证。

### 配置 NPM 与使用 `.npmrc`
NPM（Node Package Manager）是管理 JavaScript 依赖的工具，其配置通常涉及通过 `.npmrc` 文件设置注册表和代理等参数。

#### 什么是 `.npmrc` 及其存储位置？
`.npmrc` 是 NPM 的配置文件，支持自定义其行为模式。它存在于：
- **全局配置**：类 Unix 系统位于 `~/.npmrc`，Windows 系统位于 `%APPDATA%\npm\npmrc`（通常为 `C:\Users\<用户名>\AppData\Roaming\npm\npmrc`）
- **项目本地配置**：位于项目根目录的 `./package/.npmrc`。本地配置会覆盖全局配置。

#### 设置代理与 HTTPS 代理
在代理环境下工作需在 `.npmrc` 中添加：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

注意：即使是 `https_proxy` 也需使用 `http://` 协议。若用户名或密码包含特殊字符（如 `\`、`@`），需进行 URL 编码（例如 `domain\user` 应转为 `domain%5Cuser`）。也可通过命令设置：
- `npm config set proxy http://user:password@proxy_server:port`
- `npm config set https_proxy http://user:password@proxy_server:port`

#### 设置注册表
注册表是 NPM 获取软件包的地址，通常设置为：
- `registry = https://registry.npmjs.org/`

若使用自定义注册表（如企业私有注册表），可替换为对应地址。通过以下命令设置：
- `npm config set registry https://your_custom_registry.com/`

#### SSL 证书验证处理
遇到 SSL 问题时可考虑：
- 在 `.npmrc` 中设置 `strict-ssl = false` 以忽略 SSL 错误（会降低安全性）。通过命令设置：
- `npm config set strict-ssl false`

#### 配置使用与验证
可直接用文本编辑器编辑 `.npmrc`，或使用 `npm config set` 命令。验证方式：
- 通过 `npm config list` 查看所有设置
- 通过 `npm config get proxy` 检查特定设置
- 使用 `npm install --verbose` 获取详细输出来调试问题

示例 `.npmrc` 文件内容：
```
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

### 调研笔记：通过 `.npmrc` 配置 NPM 的完整指南
本节深入探讨如何通过 `.npmrc` 文件配置 NPM 的注册表和代理设置，在直接答案基础上扩展更多技术细节和上下文信息。

#### `.npmrc` 概述及其作用
`.npmrc` 是 NPM 的核心配置文件，采用 INI 格式的键值对结构（注释以分号 `;` 开头）。其存储位置包括：
- **全局位置**：类 Unix 系统为 `~/.npmrc`；Windows 系统为 `%APPDATA%\npm\npmrc`（通常为 `C:\Users\<用户名>\AppData\Roaming\npm\npmrc`）
- **本地位置**：项目根目录下的 `./package/.npmrc`。本地配置可覆盖全局配置，便于实现项目级定制。

这种层级结构确保了灵活性，特别适合多项目环境或共享系统下的配置管理。

#### 代理配置详解
在代理环境下需要同时设置 `proxy` 和 `https_proxy`：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

需特别注意：`https_proxy` 使用 `http://` 协议而非 `https://`，因为代理服务器处理的是连接本身，而非到代理的加密传输。这是常见误解点，实际上到目标地址的有效载荷仍保持 SSL 加密。

认证信息中的特殊字符必须进行 URL 编码：
- 反斜线 `\` 转为 `%5C`
- @ 符号 `@` 转为 `%40`
- 冒号 `:` 转为 `%3A`

例如用户名为 `domain\user`、密码为 `pass@word` 时，应设置为 `proxy = http://domain%5Cuser:pass%40word@proxy_server:8080`。编码能确保 NPM 正确解析参数。

Windows 用户（特别是企业 Active Directory 环境）可能遇到反斜线处理问题。有报告称 `.npmrc` 中的 `domain\username` 在读取时可能被转换为 `domain/username`，导致认证失败。此时可借助 NTLM 授权代理服务器或 Cntlm 等工具解决（这已超出 `.npmrc` 的直接配置范围）。

#### 注册表配置与 SSL 考量
注册表设置决定 NPM 获取软件包的源地址，默认为 `https://registry.npmjs.org/`。使用自定义注册表时设置：
- `registry = https://your_custom_registry.com/`

若 SSL 验证失败（通常因企业代理使用自签名证书引起），可关闭严格 SSL 验证：
- `strict-ssl = false`

但这会降低安全性（绕过证书验证）。替代方案是配置证书颁发机构：
- 使用 `npm config -g set cafile [证书目录]/[证书名称].crt` 指定受信任的 CA 文件

部分开发者选择 `registry = http://registry.npmjs.org/` 彻底避开 SSL，但出于安全考虑不推荐在生产环境使用。

#### `.npmrc` 使用方式：手动编辑与命令行
可直接用文本编辑器编辑 `.npmrc`，确保每行设置遵循 `key = value` 格式。注释以 `;` 开头，例如：
```
; 企业网络代理设置
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

也可使用 NPM 命令便捷设置：
- 设置代理：`npm config set proxy http://user:password@proxy_server:port`
- 设置注册表：`npm config set registry https://registry.npmjs.org/`
- 设置 SSL 验证：`npm config set strict-ssl false`

这些命令会根据上下文（全局或本地）更新对应的 `.npmrc` 文件。使用 `-g` 参数可指定全局设置，例如 `npm config set -g proxy ...`。

#### 验证与故障排查
验证配置的方法：
- `npm config list` 列出所有设置（包含生效值和默认值）
- `npm config get proxy` 获取特定设置值

代理环境下的故障排查可运行：
- `npm install --verbose` 查看详细日志，帮助识别连接问题（如 `ECONNREFUSED` 或 `socket hang up`）

若设置未生效，请检查可能覆盖 `.npmrc` 的环境变量（`HTTP_PROXY`、`HTTPS_PROXY`）。这些系统级变量会优先生效，需要保持配置一致性。

#### 最佳实践与补充说明
- **安全性**：生产环境避免使用 `strict-ssl = false`，应配置可信证书
- **环境变量**：注意 `NODE_ENV` 和 `HTTPS_PROXY` 可能覆盖 `.npmrc` 设置（在 CI/CD 流水线中很有用，但可能造成本地环境混淆）
- **日志级别**：通过设置 `loglevel`（如 `loglevel = http`）调整调试输出详细程度，共有从 `silent` 到 `silly` 7 个级别
- **企业代理**：对于 NTLM 代理，可考虑使用 Cntlm 等工具建立本地代理服务器，然后将 `.npmrc` 指向 `localhost:3128` 以简化认证

#### 配置表示例
以下是代理和注册表常用设置的速查表：

| **设置项**     | **说明**                                      | **示例**                                          |
|----------------|-----------------------------------------------|---------------------------------------------------|
| proxy          | HTTP 代理服务器地址                           | `proxy = http://user:password@proxy:8080`         |
| https_proxy    | HTTPS 代理服务器地址                          | `https_proxy = http://user:password@proxy:8080`   |
| registry       | 软件包注册表地址                              | `registry = https://registry.npmjs.org/`          |
| strict-ssl     | 启用/禁用 SSL 验证                            | `strict-ssl = false`                              |
| loglevel       | 控制台输出级别（7 级，从 silent 到 silly）    | `loglevel = http`                                 |

该表格特别适合刚接触 `.npmrc` 的开发者快速参考。

#### 意外细节：全局与本地设置的相互影响
一个容易被忽视的细节是：全局 `.npmrc` 设置会影响所有项目，而本地设置可针对特定项目进行覆盖。这种分层机制可能导致混淆，例如当全局设置代理而本地项目使用不同注册表时，可能引发认证问题。理解这种层级关系对多项目环境至关重要。

#### 总结
通过 `.npmrc` 配置 NPM 的代理和注册表设置，在确保格式正确、编码适当且考虑 SSL 因素后并不复杂。通过直接编辑文件或使用配置命令，配合 `npm config list` 进行验证，可以确保在代理环境下的软件包管理顺畅运行。延伸阅读请参考 [NPM CLI 配置文档](https://docs.npmjs.com/cli-config) 或 [优化 Node.js 环境的 .nmprc 配置指南](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)。

### 关键引用
- [NPM CLI 配置文档](https://docs.npmjs.com/cli-config)
- [优化 Node.js 环境的 .nmprc 配置指南](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)
- [Windows 系统下设置 npm 代理配置的方法](https://gist.github.com/zillingen/5c4b8da657025c83ead59e1e547c7436)