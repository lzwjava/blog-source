---
audio: false
generated: false
lang: zh
layout: post
title: 配置NPM
translated: true
---

### 关键要点
- 配置 NPM 似乎涉及编辑 `.npmrc` 文件以设置代理和注册表设置，可以手动完成或通过命令完成。
- 研究表明，代理设置需要格式 `proxy = http://user:password@proxy_server:port`，特殊字符 URL 编码。
- 证据倾向于将注册表设置为 `registry = https://registry.npmjs.org/` 作为默认值，如果需要可以禁用 SSL 验证。

### 配置 NPM 并使用 `.npmrc`
NPM（Node Package Manager）是一个用于管理 JavaScript 依赖项的工具，配置它通常涉及 `.npmrc` 文件，用于设置注册表和代理等设置。

#### 什么是 `.npmrc` 以及它的位置？
`.npmrc` 文件是 NPM 的配置文件，允许自定义其行为。它可以是：
- **全局**：在类 Unix 系统上位于 `~./.npmrc`，在 Windows 上位于 `%APPDATA%\npm\npmrc`（通常是 `C:\Users\<username>\AppData\Roaming\npm\npmrc`）。
- **项目本地**：位于项目根目录的 `./package/.npmrc`。本地设置会覆盖全局设置。

#### 设置代理和 HTTPS 代理
要在代理后工作，将以下行添加到 `.npmrc`：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

请注意，即使对于 `https_proxy`，也使用 `http://` 作为协议。如果用户名或密码包含特殊字符（例如 `\`, `@`），请对其进行 URL 编码（例如，`domain\user` 变为 `domain%5Cuser`）。也可以通过命令设置这些：
- `npm config set proxy http://user:password@proxy_server:port`
- `npm config set https_proxy http://user:password@proxy_server:port`

#### 设置注册表
注册表是 NPM 用于获取包的 URL，通常设置为：
- `registry = https://registry.npmjs.org/`

对于自定义注册表，用您的 URL 替换（例如，公司的私有注册表）。通过以下方式设置：
- `npm config set registry https://your_custom_registry.com/`

#### 处理 SSL 和验证
如果遇到 SSL 问题，请考虑：
- 在 `.npmrc` 中设置 `strict-ssl = false` 以忽略 SSL 错误，尽管这不太安全。通过以下方式设置：
- `npm config set strict-ssl false`

#### 使用和验证配置
直接使用文本编辑器编辑 `.npmrc`，或者使用 `npm config set` 命令。要验证：
- 使用 `npm config list` 列出所有设置。
- 使用 `npm config get proxy` 检查特定设置。
- 使用 `npm install --verbose` 调试问题以获取详细输出。

示例 `.npmrc` 文件可能如下所示：
```
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

### 调查说明：使用 `.npmrc` 配置 NPM 的全面指南
本节详细探讨了配置 NPM，重点介绍了 `.npmrc` 文件的注册表和代理设置，并扩展了直接答案，提供了更多上下文和技术细节。

#### 介绍 `.npmrc` 及其作用
`.npmrc` 文件是 NPM 的关键配置文件，使包管理行为可自定义。它支持 INI 格式，使用键值对，注释以分号（`;`）开头。它可以全局或本地定位：
- **全局位置**：在类 Unix 系统上，位于 `~./.npmrc`；在 Windows 上，位于 `%APPDATA%\npm\npmrc`，通常是 `C:\Users\<username>\AppData\Roaming\npm\npmrc`。
- **本地位置**：在项目根目录中的 `./package/.npmrc`。本地设置会覆盖全局设置，提供项目特定的配置。

这种层次结构提供了灵活性，使开发人员能够在用户和项目级别管理设置，这在具有多个项目或共享系统的环境中特别有用。

#### 详细代理配置
在代理后工作需要在 `.npmrc` 中设置 `proxy` 和 `https_proxy`。格式为：
- `proxy = http://user:password@proxy_server:port`
- `https_proxy = http://user:password@proxy_server:port`

值得注意的是，`https_proxy` 使用 `http://` 作为协议，而不是 `https://`，因为代理服务器处理连接，而不是将其加密到代理本身。这是一个常见的混淆点，因为到目的地的有效负载仍然是 SSL 加密的。

对于身份验证，包括用户名和密码，但如果它们包含特殊字符，则需要 URL 编码：
- 反斜杠（`\`）变为 `%5C`。
- 于符号（`@`）变为 `%40`。
- 冒号（`:`）变为 `%3A`。

例如，如果用户名是 `domain\user` 并且密码是 `pass@word`，则为 `proxy = http://domain%5Cuser:pass%40word@proxy_server:8080`。这种编码确保 NPM 正确解析。

Windows 用户，特别是在使用 Active Directory 的企业环境中，可能会遇到反斜杠问题。一些报告表明，`.npmrc` 中的 `domain\username` 可能在读取时转换为 `domain/username`，可能导致身份验证失败。在这种情况下，可以使用 NTLM Authorization Proxy Server 或 Cntlm 等工具，尽管它们不在直接 `.npmrc` 配置之外。

#### 注册表配置和 SSL 考虑
注册表设置定义了 NPM 获取包的位置，默认为 `https://registry.npmjs.org/`。对于自定义或私有注册表，设置：
- `registry = https://your_custom_registry.com/`

如果 SSL 验证失败，通常是由于具有自签名证书的企业代理，可以禁用严格的 SSL：
- `strict-ssl = false`

然而，这会降低安全性，因为它绕过了证书验证。或者，配置证书机构：
- 使用 `npm config -g set cafile [YOUR_CERTIFICATE_DIR]/[CERTIFICATE_NAME].crt` 指定受信任的 CA 文件。

一些开发人员选择 `registry = http://registry.npmjs.org/` 以避免 SSL，但这在安全性方面不推荐，特别是在生产中。

#### 使用 `.npmrc`：手动编辑与命令行
可以使用任何文本编辑器直接编辑 `.npmrc`，确保每个设置在新行上，格式为 `key = value`。注释以 `;` 开头，例如：
```
; 企业网络的代理设置
proxy = http://user:password@proxy_server:8080
https_proxy = http://user:password@proxy_server:8080
registry = https://registry.npmjs.org/
strict-ssl = false
```

或者，使用 NPM 命令方便：
- 设置代理：`npm config set proxy http://user:password@proxy_server:port`
- 设置注册表：`npm config set registry https://registry.npmjs.org/`
- 设置 strict-ssl：`npm config set strict-ssl false`

这些命令根据上下文（全局或本地）更新相应的 `.npmrc` 文件。要在全局和本地之间切换，使用 `-g` 表示全局，例如 `npm config set -g proxy ...`。

#### 验证和故障排除
要验证配置，请使用：
- `npm config list` 列出所有设置，显示有效值和默认值。
- `npm config get proxy` 检索特定设置。

对于故障排除，特别是在代理后，运行：
- `npm install --verbose` 查看详细日志，这可以帮助识别连接问题，例如 `ECONNREFUSED` 或 `socket hang up`。

如果设置未生效，请检查可能覆盖 `.npmrc` 的环境变量（`HTTP_PROXY`，`HTTPS_PROXY`）。这些可以系统范围设置并优先，因此请确保一致性。

#### 最佳实践和其他考虑
- **安全**：在生产中避免 `strict-ssl = false`；相反，配置受信任的证书。
- **环境变量**：请注意 `NODE_ENV` 和 `HTTPS_PROXY` 可能会覆盖 `.npmrc` 设置，这对于 CI/CD 管道很有用，但在本地可能会引起混淆。
- **日志级别**：在调试期间，调整 `.npmrc` 中的 `loglevel`（例如 `loglevel = http`），详细输出有 7 个级别，从 `silent` 到 `silly`。
- **企业代理**：对于 NTLM 代理，请考虑使用 Cntlm 等工具，设置本地代理服务器，并配置 `.npmrc` 指向 `localhost:3128`，简化身份验证。

#### 示例配置
以下是总结常见 `.npmrc` 设置的表格，代理和注册表示例：

| **设置**    | **描述**                              | **示例**                                      |
|----------------|----------------------------------------------|--------------------------------------------------|
| proxy          | HTTP 代理服务器 URL                        | `proxy = http://user:password@proxy:8080`        |
| https_proxy    | HTTPS 代理服务器 URL                       | `https_proxy = http://user:password@proxy:8080`  |
| registry       | 包注册表 URL                         | `registry = https://registry.npmjs.org/`         |
| strict-ssl     | 启用/禁用 SSL 验证              | `strict-ssl = false`                             |
| loglevel       | 控制台输出级别（静默到愚蠢，7 个级别） | `loglevel = http`                                |

此表有助于快速参考，特别是对于新手开发人员。

#### 意外细节：全局与本地设置的影响
意外的方面是全局 `.npmrc` 设置会影响所有项目，而本地设置可以为特定项目覆盖。这种分层可能会导致混淆，例如，如果全局代理设置但本地项目使用不同的注册表，可能会导致身份验证问题。理解这种层次结构对于多项目环境至关重要。

#### 结论
通过 `.npmrc` 配置 NPM 的代理和注册表设置是简单的，只要使用正确的格式和考虑编码和 SSL。通过直接编辑或使用命令，并使用 `npm config list` 验证，可以确保平滑的包管理，特别是在具有代理的企业网络中。有关进一步阅读，请参阅官方文档 [NPM CLI Config](https://docs.npmjs.com/cli-config) 或探索最佳实践 [Configuring Your .nmprc](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)。

### 关键引用
- [NPM CLI Config 文档](https://docs.npmjs.com/cli-config)
- [为优化 Node.js 环境配置您的 .nmprc](https://nodesource.com/blog/configuring-your-nmprc-for-an-optimal-node-js-environment)
- [如何在 Windows 上设置 NPM 代理设置](https://gist.github.com/zillingen/5c4b8da657025c83ead59e1e547c7436)