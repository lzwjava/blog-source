---
audio: false
generated: true
lang: zh
layout: post
title: Python库cffi
translated: true
type: note
---

当你运行 Python 脚本 `fetch.py` 并执行命令 `python scripts/supabase/fetch.py` 时，遇到了以下错误：

```
ModuleNotFoundError: No module named '_cffi_backend'
```

这个错误以及随后的 Rust panic 和 traceback 表明 Python 解释器无法找到 `_cffi_backend` 模块，该模块是 `cffi` 库的关键组件。`cffi` 库是 `cryptography` 包的依赖项，而 `cryptography` 包又被你脚本中的 `supabase` 客户端使用。下面我将解释这个问题，并提供逐步解决方案来解决它。

---

### 错误原因

`_cffi_backend` 模块是 `cffi` 库的一部分，它使 Python 能够与 C 代码交互。`cryptography` 库（`jwt` 和 `supabase` 的依赖项）依赖 `cffi` 来执行加密操作。Traceback 显示错误源于 `cryptography` 尝试导入 Rust 绑定时：

```
File "/usr/lib/python3/dist-packages/cryptography/hazmat/_oid.py", line 9, in <module>
    from cryptography.hazmat.bindings._rust import (
        ObjectIdentifier as ObjectIdentifier,
    )
pyo3_runtime.PanicException: Python API call failed
```

`_cffi_backend` 的 `ModuleNotFoundError` 表明 `cffi` 要么未安装，要么未正确构建，要么与你的 Python 环境不兼容。这触发了 Rust 绑定的失败，导致 panic 并停止执行。

---

### 如何修复此问题

按照以下步骤解决错误并运行你的 Supabase 脚本：

#### 1. **检查并安装 `cffi` 库**
`cffi` 库可能缺失或安装不正确。验证其是否存在，并在必要时安装。

- **检查 `cffi` 是否已安装：**
  ```bash
  pip show cffi
  ```
  如果 `cffi` 包已安装在你当前的 Python 环境中，此命令将显示相关信息。

- **安装或重新安装 `cffi`：**
  如果 `cffi` 未安装或可能已损坏，请运行：
  ```bash
  pip install cffi
  ```
  为确保干净安装，你可以卸载并重新安装它：
  ```bash
  pip uninstall cffi
  pip install cffi
  ```

#### 2. **安装系统依赖项**
`cffi` 库需要某些系统级依赖项来构建其 C 后端（`_cffi_backend`）。在 Ubuntu 上（根据你的提示 `lzwjava@lzwjava-XiaoXin-14-IAH8`），安装 `libffi-dev` 包：

```bash
sudo apt-get update
sudo apt-get install libffi-dev
```

这个包提供了 `libffi` 的开发文件，`cffi` 需要它来编译其后端。

#### 3. **验证 Python 版本和环境**
你的 traceback 显示了诸如 `/home/lzwjava/.local/lib/python3.13/site-packages/` 和 `/usr/lib/python3/dist-packages/` 的路径，表明你正在使用 Python 3.13，并且可能安装了多个 Python 版本。

- **确保你针对正确的 Python 版本：**
  使用明确的 Python 版本来运行脚本以避免冲突：
  ```bash
  python3.13 scripts/supabase/fetch.py
  ```
  使用相同的 Python 版本安装包：
  ```bash
  python3.13 -m pip install cffi
  ```

- **考虑使用虚拟环境：**
  为避免系统范围内安装的包与用户安装的包之间的冲突，请设置一个虚拟环境：
  ```bash
  python3.13 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
  然后运行你的脚本：
  ```bash
  python scripts/supabase/fetch.py
  ```

#### 4. **重新安装相关包**
`supabase` 客户端依赖于 `cryptography` 和 `jwt`，这两者都依赖于 `cffi`。重新安装这些包可确保它们与你的环境兼容：

```bash
pip uninstall cryptography jwt supabase
pip install cryptography jwt supabase
```

#### 5. **检查 Python 3.13 兼容性**
Python 3.13 是一个较新的版本，一些包（例如 `cryptography`）可能尚未完全与其兼容。如果问题仍然存在，考虑切换到更稳定的版本，如 Python 3.11：

- 安装 Python 3.11（在 Ubuntu 上）：
  ```bash
  sudo apt-get install python3.11 python3.11-dev python3.11-venv
  ```
- 使用 Python 3.11 创建虚拟环境：
  ```bash
  python3.11 -m venv venv
  source venv/bin/activate
  pip install supabase
  ```
- 再次运行你的脚本。

#### 6. **调试持续存在的问题**
如果错误仍然存在，请收集更多详细信息：
- 使用 Rust backtrace 运行以获得额外上下文：
  ```bash
  RUST_BACKTRACE=1 python scripts/supabase/fetch.py
  ```
- 检查你的 `PYTHONPATH` 是否存在冲突：
  ```bash
  echo $PYTHONPATH
  ```
  如果已设置，请确保它不会干扰包的位置。

---

### 为什么这应该有效

该错误源于 `cffi` 库缺失或配置错误，这破坏了 `cryptography` 包加载其 Rust 绑定的能力。通过确保 `cffi` 已安装、系统依赖项已满足且你的 Python 环境一致，`_cffi_backend` 模块应该变得可用，从而允许你的脚本成功运行。

---

### 最后步骤
应用这些修复后，再次测试你的脚本：
```bash
python scripts/supabase/fetch.py
```

如果你仍然遇到问题，请分享更新后的错误信息，我们可以进一步优化解决方案。编码愉快！