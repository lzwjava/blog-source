---
audio: false
generated: true
lang: zh
layout: post
title: 编写Windows批处理文件
translated: true
type: note
---

Windows 批处理文件（.bat 或 .cmd）是一种包含由 Windows 命令提示符（cmd.exe）执行的一系列命令的脚本文件。批处理文件可用于自动化重复性任务、管理系统操作或执行程序。以下是关于编写 Windows 批处理文件的全面介绍，涵盖其用途、语法、常用命令和最佳实践。

### 什么是批处理文件？
批处理文件是一个带有 `.bat` 或 `.cmd` 扩展名的纯文本文件，其中包含由 Windows 命令提示符解释的命令。执行时，命令会按顺序运行，从而实现对文件管理、系统配置或软件安装等任务的自动化。

### 为什么要使用批处理文件？
- **自动化**：通过单个脚本执行多个命令。
- **简单性**：无需高级编程知识。
- **系统管理**：执行备份、用户管理或环境设置等任务。
- **兼容性**：适用于所有带有命令提示符的 Windows 版本。

### 创建批处理文件
1. **编写脚本**：使用文本编辑器（如记事本、VS Code）编写命令。
2. **使用正确的扩展名保存**：将文件保存为 `.bat` 或 `.cmd` 扩展名（例如 `script.bat`）。
3. **执行**：双击文件或通过命令提示符运行。

### 基本语法和结构
- **命令**：批处理文件使用命令提示符命令（如 `dir`、`copy`、`del`）和批处理特定命令（如 `echo`、`set`、`goto`）。
- **注释**：使用 `REM` 或 `::` 添加注释以提高可读性。
- **不区分大小写**：命令和变量不区分大小写。
- **逐行执行**：除非由 `if`、`for` 或 `goto` 等流程控制命令控制，否则命令会逐行执行。

### 常用命令和功能
#### 1. **基本命令**
- `ECHO`：控制命令回显或显示文本。
  - 示例：`ECHO Hello, World!` 显示 "Hello, World!"。
  - `ECHO OFF`：在执行期间抑制命令显示。
- `CLS`：清除命令提示符屏幕。
- `PAUSE`：暂停执行，等待用户输入。
- `EXIT`：终止脚本或命令提示符会话。

#### 2. **变量**
- **设置变量**：使用 `SET` 创建或修改变量。
  - 示例：`SET MY_VAR=Hello` 创建一个变量 `MY_VAR`。
- **使用变量**：通过 `%变量名%` 引用。
  - 示例：`ECHO %MY_VAR%` 显示 "Hello"。
- **环境变量**：内置变量如 `%PATH%`、`%USERNAME%` 或 `%DATE%`。

#### 3. **输入和输出**
- **用户输入**：使用 `SET /P` 提示输入。
  - 示例：`SET /P NAME=请输入您的姓名：` 将用户输入存储在 `NAME` 中。
- **重定向输出**：使用 `>` 将输出写入文件，或使用 `>>` 追加。
  - 示例：`DIR > filelist.txt` 将目录列表保存到 `filelist.txt`。

#### 4. **条件语句**
- 使用 `IF` 根据条件执行命令。
  - 语法：`IF 条件 命令 [ELSE 命令]`
  - 示例：`IF "%NAME%"=="Admin" ECHO 欢迎，管理员！ ELSE ECHO 访问被拒绝。`

#### 5. **循环**
- **FOR 循环**：遍历文件、目录或值。
  - 示例：`FOR %i IN (*.txt) DO ECHO %i` 列出所有 `.txt` 文件。
  - 注意：在批处理文件中，对变量使用 `%%i` 而不是 `%i`。
- **类似 WHILE 的循环**：使用 `GOTO` 和 `IF` 模拟。

#### 6. **子程序和标签**
- **标签**：使用 `:标签` 标记代码段。
- **GOTO**：跳转到带标签的代码段。
  - 示例：`GOTO :EOF` 跳转到文件末尾。
- **CALL**：调用另一个批处理文件或子程序。
  - 示例：`CALL :mySubroutine` 运行带标签的子程序。

#### 7. **错误处理**
- 使用 `%ERRORLEVEL%` 检查命令是否成功。
  - 示例：`IF %ERRORLEVEL% NEQ 0 ECHO 命令执行失败。`

### 最佳实践
- **使用 `ECHO OFF`**：通过隐藏命令输出来减少混乱。
- **添加注释**：使用 `REM` 或 `::` 记录代码。
- **增量测试**：运行小段代码进行调试。
- **处理错误**：检查 `%ERRORLEVEL%` 以应对失败情况。
- **对路径使用引号**：将文件路径用引号括起来以处理空格（例如 `"C:\Program Files\"`）。
- **避免保留名称**：不要使用 `CON`、`NUL` 或 `PRN` 等名称作为文件或变量名。
- **使用 `@` 静默执行**：在命令前加上 `@` 以抑制单个命令的回显（例如 `@ECHO OFF`）。

### 批处理文件示例
以下是一个示例批处理文件，演示了常见功能：提示用户输入、创建目录和记录输出。

```batch
@echo off
REM 示例批处理文件：创建目录并记录操作
ECHO 脚本启动中...

:: 提示输入目录名
SET /P DIRNAME=请输入目录名：

:: 检查输入是否为空
IF "%DIRNAME%"=="" (
    ECHO 错误：未提供目录名。
    PAUSE
    EXIT /B 1
)

:: 创建目录并记录结果
MKDIR "%DIRNAME%"
IF %ERRORLEVEL%==0 (
    ECHO 目录 "%DIRNAME%" 创建成功。
    ECHO %DATE% %TIME%: 目录 "%DIRNAME%" 创建成功 >> log.txt
) ELSE (
    ECHO 目录 "%DIRNAME%" 创建失败。
    ECHO %DATE% %TIME%: 目录 "%DIRNAME%" 创建失败 >> log.txt
)

::mettere:PAUSE
ECHO 完成。
EXIT /B
```

### 运行批处理文件
- 将上述代码保存为 `sample.bat`。
- 双击或通过命令提示符运行（`cmd.exe /c sample.bat`）。

### 高级技巧
- **延迟扩展**：在循环中使用 `SETLOCAL EnableDelayedExpansion` 处理更新的变量（例如使用 `!VAR!` 而不是 `%VAR%`）。
- **错误级别**：使用 `IF ERRORLEVEL n` 测试特定退出代码。
- **外部工具**：集成如 `PowerShell` 或 `curl` 等工具以实现高级功能。
- **安全性**：避免运行来自不受信任来源的批处理文件，以防恶意代码。

### 局限性
- **复杂性**：对于复杂任务，批处理文件的功能不如 PowerShell 或 Python 强大。
- **错误处理**：与现代脚本语言相比，错误处理能力有限。
- **跨平台性**：批处理文件是 Windows 特有的。

### 资源
- **官方文档**：微软的命令提示符参考（在 cmd.exe 中使用 `help` 命令）。
- **教程**：如 SS64.com 等网站提供详细的命令参考。
- **社区**：在 X 或 Stack Overflow 等论坛上搜索批处理文件示例。

本介绍为编写批处理文件提供了基础。通过简单的脚本进行练习，并通过命令提示符中的 `help` 命令探索更多命令，以提升您的技能。