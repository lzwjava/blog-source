---
audio: false
generated: true
lang: zh
layout: post
title: 使用 H2 数据库进行测试
translated: true
---

在 Spring 项目中使用 H2 数据库，特别是用于测试目的，需要将这个轻量级的内存数据库集成到 Spring 应用程序中。H2 数据库适合测试，因为它在内存中运行，速度快，并且可以轻松设置和拆除，而不会将数据持久化到磁盘。下面，我将解释如何将 H2 集成到 Spring 项目中，假设你使用的是 Spring Boot（这是 Spring 项目的常见设置），并澄清对 `com.h2database.h2` 的引用，这可能指的是 Maven 依赖项而不是包或类名（实际的驱动程序类是 `org.h2.Driver`）。

---

### 第 1 步：添加 H2 依赖
要在 Spring 项目中使用 H2，必须在构建文件中包含其依赖项。由于你提到 `com.h2database.h2`，这与 Maven 协调 H2 数据库工件一致。以下是如何添加它的方法：

#### 对于 Maven (`pom.xml`):
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **注意**：`<scope>test</scope>` 确保 H2 仅在测试阶段可用，这符合你的测试重点。

#### 对于 Gradle (`build.gradle`):
```gradle
testImplementation 'com.h2database:h2'
```

如果你使用 Spring Boot 并且包含了 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc` 等启动器，Spring Boot 的依赖管理会在你为测试配置 H2 数据源时自动拉取兼容的 H2 版本。在这种情况下，显式添加 H2 依赖项是可选的，除非你需要特定版本。

---

### 第 2 步：配置 H2 作为测试数据源
在 Spring Boot 项目中，通过属性配置数据库，通常在 `application.properties` 或 `application.yml` 中。对于测试，将这些配置放在 `src/test/resources` 中，以覆盖主应用程序设置。

#### 配置在 `src/test/resources/application.properties`:
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **解释**：
  - `spring.datasource.url=jdbc:h2:mem:testdb`：指定一个名为 `testdb` 的内存 H2 数据库。`mem` 关键字确保数据存储在 RAM 中。
  - `spring.datasource.driverClassName=org.h2.Driver`：H2 的 JDBC 驱动程序类（不是 `com.h2database.h2`，这可能是对 Maven 工件的误解或混淆）。
  - `spring.datasource.username=sa`：默认 H2 用户名。
  - `spring.datasource.password=`：默认空密码。

#### 最小配置与自动配置：
如果你使用 Spring Boot 并包含 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc`，并且 H2 在类路径上，Spring Boot 可以在没有显式属性的情况下自动配置嵌入式 H2 数据库。它会生成一个随机数据库名称（例如，`jdbc:h2:mem:<random-uuid>`）。然而，指定上述属性可以让你控制数据库名称和设置。

---

### 第 3 步：在测试中使用 H2
Spring Boot 提供了测试注解，简化了使用 H2 的数据库测试。方法取决于你是测试仓库（类似于单元测试）还是整个应用程序堆栈（集成测试）。

#### 选项 1：使用 `@DataJpaTest` 测试仓库
对于测试 Spring Data JPA 仓库，使用 `@DataJpaTest` 注解。它会自动配置内存 H2 数据库，扫描 `@Entity` 类，并设置仓库。

**示例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // 假设数据已加载（例如，通过 data.sql）
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **优点**：
  - H2 自动设置。
  - 测试是事务性的，默认情况下回滚，确保每个测试的数据库状态一致。

#### 选项 2：使用 `@SpringBootTest` 进行集成测试
对于全栈集成测试（例如，测试控制器、服务和仓库），使用 `@SpringBootTest`。通过测试特定属性配置 H2。

**示例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // 测试与数据库交互的服务逻辑
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **配置**：使用 `src/test/resources` 中的 `application.properties`，如上所述，以确保使用 H2 而不是生产数据库。

#### 替代配置方法：
- **使用 `@TestPropertySource`**：
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **使用配置文件**：
  - 创建 `src/test/resources/application-test.properties`，其中包含 H2 配置。
  - 使用 `@ActiveProfiles("test")` 注解测试。

---

### 第 4 步：初始化测试数据（可选）
要用测试数据填充 H2 数据库：

- **使用 `schema.sql` 和 `data.sql`**：
  - 将这些文件放在 `src/test/resources` 中。
  - Spring Boot 在嵌入式数据库启动时执行 `schema.sql` 创建表，并执行 `data.sql` 插入数据。
  - 示例 `data.sql`：
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, 'Test');
    ```

- **使用 `@Sql`**：
  - 在测试方法之前或之后执行特定的 SQL 脚本。
  - 示例：
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // 测试逻辑
    }
    ```

---

### 第 5 步：确保测试隔离（可选）
为了防止测试方法相互干扰：
- 在测试类或方法上使用 `@Transactional`。对于 `@DataJpaTest`，这默认启用，并在每个测试后回滚更改。对于 `@SpringBootTest`，如果需要，可以显式添加：
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- 这确保每个测试都以一致的数据库状态开始。

---

### 第 6 步：模拟生产数据库（可选）
如果你的生产数据库不同（例如，MySQL、PostgreSQL），可以使用兼容模式配置 H2：
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- 支持的模式包括 `MySQL`、`PostgreSQL` 等，使 H2 的 SQL 语法和行为与生产数据库一致。

---

### 第 7 步：使用 H2 控制台调试（可选）
用于在测试期间检查数据库：
- 启用 H2 控制台：
  ```properties
  spring.h2.console.enabled=true
  ```
- 访问 `http://localhost:<port>/h2-console`，如果运行 Web 服务器（例如，使用 `@SpringBootTest(webEnvironment = RANDOM_PORT)`）。
- 这对于调试很有用，但在自动化测试运行中不太常见。

---

### 关键说明
- **H2 驱动程序**：正确的驱动程序类是 `org.h2.Driver`，而不是 `com.h2database.h2`。后者是 Maven 的 `groupId:artifactId`。
- **Spring Boot 优势**：自动配置简化了 H2 的设置，特别是用于测试。
- **内存特性**：H2 的数据在 JVM 停止时丢失，使其适合隔离的测试运行。

通过遵循这些步骤，你可以在 Spring 项目中有效地使用 H2 数据库进行测试，利用其速度和简单性来验证数据层或整个应用程序堆栈。