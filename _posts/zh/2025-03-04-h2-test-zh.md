---
audio: false
generated: true
lang: zh
layout: post
title: 使用H2数据库进行测试
translated: true
type: note
---

在 Spring 项目中使用 H2 数据库（特别是用于测试目的）时，需要将这款轻量级内存数据库集成到 Spring 应用程序中。H2 数据库非常适合测试场景，因为它运行在内存中、速度极快，且能够轻松创建和销毁而无需将数据持久化到磁盘。下面我将说明如何将 H2 集成到 Spring 项目中（假设您使用 Spring Boot——这是 Spring 项目的常见配置），并澄清对 `com.h2database.h2` 的引用——这很可能指的是 Maven 依赖项而非包名或类名（实际的驱动类名为 `org.h2.Driver`）。

---

### 步骤 1：添加 H2 依赖项
要在 Spring 项目中使用 H2，必须在构建文件中包含其依赖项。鉴于您提到了 `com.h2database.h2`，这与 H2 数据库构件的 Maven 坐标一致。添加方式如下：

#### Maven 配置（`pom.xml`）：
```xml
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>
```
- **注意**：`<scope>test</scope>` 可确保 H2 仅在测试阶段可用，这符合您的测试需求。

#### Gradle 配置（`build.gradle`）：
```gradle
testImplementation 'com.h2database:h2'
```

如果您正在使用 Spring Boot 并包含了诸如 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc` 等 starter 依赖，Spring Boot 的依赖管理会在您为测试配置 H2 数据源时自动引入兼容的 H2 版本。在这种情况下，除非需要特定版本，否则显式添加 H2 依赖项是可选的。

---

### 步骤 2：配置 H2 作为测试数据源
在 Spring Boot 项目中，通常通过属性文件（如 `application.properties` 或 `application.yml`）配置数据库。对于测试，请将这些配置放置在 `src/test/resources` 目录下，以覆盖主应用程序的设置。

#### 在 `src/test/resources/application.properties` 中的配置：
```properties
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
```
- **说明**：
  - `spring.datasource.url=jdbc:h2:mem:testdb`：指定名为 `testdb` 的内存 H2 数据库。`mem` 关键字确保数据存储在 RAM 中。
  - `spring.datasource.driverClassName=org.h2.Driver`：H2 的 JDBC 驱动类名（而非 `com.h2database.h2`，后者很可能是对 Maven 构件的误写或混淆）。
  - `spring.datasource.username=sa`：默认的 H2 用户名。
  - `spring.datasource.password=`：默认空密码。

#### 使用自动配置的最小化配置：
如果您在使用 Spring Boot 并搭配 `spring-boot-starter-data-jpa` 或 `spring-boot-starter-jdbc`，且 H2 位于类路径上，Spring Boot 可以自动配置嵌入式 H2 数据库而无需显式属性。它会生成一个随机的数据库名称（例如 `jdbc:h2:mem:<random-uuid>`）。然而，指定上述属性可以让您控制数据库名称和设置。

---

### 步骤 3：在测试中使用 H2
Spring Boot 提供了测试注解来简化使用 H2 的数据库测试。具体方法取决于您是测试存储库（类单元测试）还是完整的应用程序栈（集成测试）。

#### 选项 1：使用 `@DataJpaTest` 测试存储库
对于测试 Spring Data JPA 存储库，使用 `@DataJpaTest` 注解。它会自动配置内存 H2 数据库，扫描 `@Entity` 类并设置存储库。

**示例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import static org.assertj.core.api.Assertions.assertThat;

@DataJpaTest
public class MyRepositoryTest {

    @Autowired
    private MyRepository myRepository;

    @Test
    public void testFindById() {
        // 假设数据已加载（例如通过 data.sql）
        MyEntity entity = myRepository.findById(1L).orElse(null);
        assertThat(entity).isNotNull();
    }
}
```
- **优势**：
  - H2 自动设置。
  - 测试默认是事务性的并在测试后回滚，确保每个测试都有干净的数据库状态。

#### 选项 2：使用 `@SpringBootTest` 进行集成测试
对于全栈集成测试（例如，测试控制器、服务和存储库一起工作），使用 `@SpringBootTest`。通过测试专用的属性文件配置 H2。

**示例**：
```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
public class MyIntegrationTest {

    @Autowired
    private MyService myService;

    @Test
    public void testServiceMethod() {
        // 测试与数据库交互的服务逻辑
        String result = myService.someMethod();
        assertThat(result).isEqualTo("expected");
    }
}
```
- **配置**：使用前面展示的 `src/test/resources/application.properties` 来确保使用 H2 而不是生产数据库。

#### 替代配置方法：
- **使用 `@TestPropertySource`**：
  ```java
  @SpringBootTest
  @TestPropertySource(properties = {
      "spring.datasource.url=jdbc:h2:mem:testdb",
      "spring.datasource.driverClassName=org.h2.Driver",
      "spring.datasource.username=sa",
      "spring.datasource.password="
  })
  public class MyIntegrationTest {
      // ...
  }
  ```
- **使用 Profiles**：
  - 在 `src/test/resources/application-test.properties` 中创建包含 H2 配置的文件。
  - 在测试类上使用注解 `@ActiveProfiles("test")`。

---

### 步骤 4：初始化测试数据（可选）
要为 H2 数据库填充测试数据：

- **使用 `schema.sql` 和 `data.sql`**：
  - 将这些文件放在 `src/test/resources` 目录下。
  - Spring Boot 在启动嵌入式数据库时会执行 `schema.sql` 来创建表，执行 `data.sql` 来插入数据。
  - `data.sql` 示例：
    ```sql
    INSERT INTO my_table (id, name) VALUES (1, '测试');
    ```

- **使用 `@Sql`**：
  - 在测试方法之前或之后执行特定的 SQL 脚本。
  - 示例：
    ```java
    @Test
    @Sql("/test-schema.sql")
    @Sql("/test-data.sql")
    public void testSomething() {
        // 测试逻辑
    }
    ```

---

### 步骤 5：确保测试隔离（可选）
为防止测试方法相互干扰：
- 在测试类或方法上使用 `@Transactional`。在使用 `@DataJpaTest` 时，默认启用此功能，每个测试后都会回滚更改。对于 `@SpringBootTest`，如果需要则显式添加：
  ```java
  @SpringBootTest
  @Transactional
  public class MyIntegrationTest {
      // ...
  }
  ```
- 这确保了每个测试都从一个一致的数据库状态开始。

---

### 步骤 6：模拟生产数据库（可选）
如果您的生产数据库不同（例如 MySQL、PostgreSQL），可以配置 H2 使用兼容模式来模拟它：
```properties
spring.datasource.url=jdbc:h2:mem:testdb;MODE=MySQL
```
- 支持的模式包括 `MySQL`、`PostgreSQL` 等，使 H2 的 SQL 语法和行为与您的生产数据库保持一致。

---

### 步骤 7：使用 H2 控制台进行调试（可选）
要在测试期间检查数据库：
- 启用 H2 控制台：
  ```properties
  spring.h2.console.enabled=true
  ```
- 如果运行了 Web 服务器（例如使用 `@SpringBootTest(webEnvironment = RANDOM_PORT)`），可通过 `http://localhost:<port>/h2-console` 访问。
- 这在调试时很有用，但在自动化测试运行中较少使用。

---

### 关键要点
- **H2 驱动**：正确的驱动类是 `org.h2.Driver`，而非 `com.h2database.h2`。后者指的是 Maven 的 `groupId:artifactId`。
- **Spring Boot 优势**：自动配置简化了 H2 的设置，尤其是在测试方面。
- **内存特性**：H2 的数据在 JVM 停止时会丢失，这使其成为隔离测试运行的理想选择。

通过遵循这些步骤，您可以在 Spring 项目中有效地使用 H2 数据库进行测试，利用其速度和简单性来验证数据层或完整的应用程序栈。