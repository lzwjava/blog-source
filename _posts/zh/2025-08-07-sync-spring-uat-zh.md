---
audio: false
generated: true
image: false
lang: zh
layout: post
title: 同步Spring用户验收测试分支与代码
translated: true
type: note
---

以下是一套可供灵活组合的最佳实践和模式，用于保持三个UAT分支的同步、维护清晰的历史记录，以及处理Spring应用中的国家特定代码——同时还会探讨AI在哪些环节能提供助力。

---

## 1. 分支管理与同步

1. **基于主干开发配合短生命周期功能分支**

   * 保留单一的 **main**（或 **develop**）主干分支。
   * 针对每个Jira工单（如FT-103）和国家，创建功能分支并命名如下：

     ```
     feature/FT-103-cn
     feature/FT-103-sg
     feature/FT-103-tw
     ```
   * 开发完成后先合并至 **main**，再通过拣选或合并方式同步到各`uat_cn`、`uat_sg`、`uat_tw`分支。
   * 优势：只需向主干合并一次；各国分支仅获取所需内容。

2. **定期同步UAT分支**

   * 设置每日（或每次构建时）定时任务，将各`uat_*`分支变基至`main`分支，避免差异过大。
   * 通过CI流程自动化实现（例如GitHub Action每晚自动变基`uat_cn`）。

3. **强制代码审查机制**

   * 所有功能分支向主干合并必须通过拉取请求。
   * 确保分支名和PR标题/描述中均包含"FT-xxx"工单编号。

---

## 2. 提交信息规范与压缩合并

1. **包含JIRA编号的规范格式**

   ```
   FT-103: 修复客户查询中的空指针异常
   ```

2. **开发时细粒度提交→合并时压缩**

   * 开发过程中可多次提交：

     ```
     FT-103 #1: 初始化服务Bean配置
     FT-103 #2: 增加验证逻辑
     FT-103 #3: 更新错误处理
     ```
   * PR合并时使用“压缩合并”将所有FT-103相关提交合并为单个提交：

     ```
     FT-103: 客户服务验证与错误处理
     ```

3. **工单内部分支编号**

   * 同一工单内需要区分多个开发步骤时，开发阶段可使用编号（`#1`、`#2`）。
   * 合并后压缩为*单个*FT-103提交，保持历史记录整洁且每个工单对应一个逻辑变更。

4. **自动化提交校验**

   * 使用Git钩子或CI插件（如[commitlint](https://commitlint.js.org)）强制要求提交信息以`FT-\d+`开头。
   * 可选配置作用域：`FT-103(sg): …`。

---

## 3. Spring应用中的国家特定代码处理

1. **配置剖面与条件化Bean**

   * 为国家分别定义Spring配置剖面：`@Profile("cn")`、`@Profile("sg")`、`@Profile("tw")`。
   * 在`application-cn.yml`、`application-sg.yml`等配置文件中设置国家特定参数。
   * 启动时通过`--spring.profiles.active=cn`（或sg/tw）启用对应Bean。

2. **策略模式/插件化模块**

   * 创建`PaymentProcessor`接口及三个实现类（`CnPaymentProcessor`等）。
   * 使用`@Component` + `@Profile`组合，或基于运行时标识的工厂模式选择Bean。

3. **资源文件/特性开关**

   * 若差异较小（如日期格式、接口地址），可保持统一代码路径，将差异外化至属性文件或特性开关服务。

4. **模块化分离（适用于差异较大场景）**

   * 对于逻辑差异显著的情况，拆分为子模块：

     ```
     /core
     /country-cn
     /country-sg
     /country-tw
     ```
   * 主应用在构建/部署时仅引入当前国家模块。

---

## 4. 任务分配：按工单vs按作者

* **以工单为单位，非以人员为单位**。任务应围绕*功能特性*（Jira编号）进行组织。
* 若多名开发者共同处理FT-103，应在同一分支协作或创建子主题分支——最终统一合并回FT-103分支。
* 作者信息保留在提交元数据中，无需按作者进行提交压缩。

---

## 5. AI技术赋能

1. **提交信息生成**

   * GitHub Copilot或OpenAI等工具可根据代码差异生成规范的提交信息。
   * 集成预提交钩子运行`ai-commit --preview`生成待审核的提交信息草稿。

2. **PR描述与变更日志**

   * 使用AI助手将工单内所有提交总结为连贯的PR描述或发布说明：

     > “将feature/FT-103的变更总结为要点列表。”

3. **代码审查辅助**

   * 集成AI的代码分析工具（如带AI插件的SonarQube、DeepCode）可识别国家特定代码路径中的问题。

4. **自动化拣选/变基**

   * 编写脚本（或使用低代码平台），当FT-103合并至`main`后，自动拣选到各`uat_*`分支，并为冲突合并创建PR。

---

### 全流程整合

1. **开发阶段**：基于`feature/FT-XXX-<cn/sg/tw>`分支进行开发。
2. **提交规范**：自由提交（可编号），需包含JIRA编号。
3. **代码合并**：创建PR→main分支，选择**压缩合并**确保每个FT-XXX对应单个整洁提交。
4. **CI自动化**：自动将提交变基/合并到各`uat_cn`、`uat_sg`、`uat_tw`分支。
5. **运行时隔离**：通过Spring配置剖面加载对应国家逻辑——无需在三个分支中维护重复代码。
6. **AI赋能**：辅助规范提交格式、生成PR摘要、管理合并流程。

该工作流既能保持历史记录整洁，确保每个工单在所有环境中对应单个可追溯提交，又通过运行时隔离（而非Git历史记录）实现国家逻辑分离，同时在最具价值的环节充分利用AI技术。