---
audio: false
generated: false
image: false
lang: zh
layout: post
title: è‡ªåŠ¨åŒ–Clashä»£ç†ç®¡ç†
translated: true
---

è¿™ç¯‡å¸–å­è¯¦ç»†ä»‹ç»äº†ä¸€ä¸ªPythonè„šæœ¬`clash.py`ï¼Œæ—¨åœ¨**è‡ªåŠ¨åŒ–ç®¡ç†æ‚¨çš„Clashä»£ç†é…ç½®**ã€‚å®ƒèƒ½å¤„ç†ä»**å®šæœŸä¸‹è½½æ›´æ–°çš„ä»£ç†é…ç½®**å’Œ**é‡å¯ClashæœåŠ¡**ï¼Œåˆ°**æ™ºèƒ½é€‰æ‹©å¹¶åˆ‡æ¢è‡³æŒ‡å®šç»„å†…æœ€å¿«çš„å¯ç”¨ä»£ç†**ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚é…åˆ`clash.py`ä½¿ç”¨çš„`speed.py`æ¨¡å—ï¼Œå¯**å¹¶å‘æµ‹è¯•å„Clashä»£ç†çš„å»¶è¿Ÿ**ï¼Œç¡®ä¿æ‚¨çš„è¿æ¥å§‹ç»ˆé€šè¿‡æœ€ä¼˜æœåŠ¡å™¨è·¯ç”±ã€‚

## clash.py

```python
import os
import subprocess
import time
import shutil
import argparse
import logging
import requests
import json
import urllib.parse

# å‡è®¾speed.pyä½äºåŒä¸€ç›®å½•æˆ–PYTHONPATHå¯è®¿é—®è·¯å¾„
from speed import get_top_proxies 

# --- é…ç½®é¡¹ ---
CLASH_CONTROLLER_HOST = "127.0.0.1"
CLASH_CONTROLLER_PORT = 9090
CLASH_API_BASE_URL = f"http://{CLASH_CONTROLLER_HOST}:{CLASH_CONTROLLER_PORT}"
# ç›®æ ‡ä»£ç†ç»„åç§°ï¼Œæœ€ä½³ä»£ç†å°†è¢«åˆ†é…è‡³æ­¤
# è¯·ç¡®ä¿è¯¥ç»„å­˜åœ¨äºæ‚¨çš„Clashé…ç½®ä¸­
TARGET_PROXY_GROUP = "ğŸš§ä»£ç†" 

def setup_logging():
    """é…ç½®è„šæœ¬åŸºç¡€æ—¥å¿—"""
    logging.basicConfig(
        filename='clash.log', 
        level=logging.INFO,
        format='%(asctime)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

def start_system_proxy(global_proxy_address):
    """è®¾ç½®ç³»ç»Ÿå…¨å±€ä»£ç†ç¯å¢ƒå˜é‡"""
    os.environ["GLOBAL_PROXY"] = global_proxy_address # è®¾ç½®ä¸ºå…¨å±€å˜é‡ä»¥å¤‡ä»–ç”¨
    os.environ["HTTP_PROXY"] = f"http://{global_proxy_address}"
    os.environ["HTTPS_PROXY"] = f"http://{global_proxy_address}"
    os.environ["http_proxy"] = f"http://{global_proxy_address}"
    os.environ["https_proxy"] = f"http://{global_proxy_address}"
    # ç°ä»£å·¥å…·é€šå¸¸æ— éœ€æ˜¾å¼è®¾ç½®ä¸º"false"ï¼Œæ­¤å¤„ä¿ç•™ä»¥å…¼å®¹åŸè„šæœ¬é€»è¾‘
    os.environ["HTTP_PROXY_REQUEST_FULLURI"] = "false" 
    os.environ["HTTPS_PROXY_REQUEST_FULLURI"] = "false"
    os.environ["ALL_PROXY"] = os.environ["http_proxy"]
    logging.info(f"ç³»ç»Ÿå…¨å±€ä»£ç†å·²è®¾ç½®ä¸º: {global_proxy_address}")

def stop_system_proxy():
    """æ¸…é™¤ç³»ç»Ÿå…¨å±€ä»£ç†ç¯å¢ƒå˜é‡"""
    os.environ["http_proxy"] = ""
    os.environ["HTTP_PROXY"] = ""
    os.environ["https_proxy"] = ""
    os.environ["HTTPS_PROXY"] = ""
    os.environ["HTTP_PROXY_REQUEST_FULLURI"] = "true" # æ¢å¤é»˜è®¤å€¼
    os.environ["HTTPS_PROXY_REQUEST_FULLURI"] = "true"
    os.environ["ALL_PROXY"] = ""
    logging.info("ç³»ç»Ÿå…¨å±€ä»£ç†å·²åœç”¨ï¼ˆç¯å¢ƒå˜é‡å·²æ¸…é™¤ï¼‰")

def switch_clash_proxy_group(group_name, proxy_name):
    """
    å°†æŒ‡å®šClashä»£ç†ç»„ä¸­çš„æ´»åŠ¨ä»£ç†åˆ‡æ¢ä¸ºæ–°ä»£ç†
    """
    encoded_group_name = urllib.parse.quote(group_name)
    url = f"{CLASH_API_BASE_URL}/proxies/{encoded_group_name}"
    headers = {"Content-Type": "application/json"}
    payload = {"name": proxy_name}
    
    try:
        response = requests.put(url, headers=headers, data=json.dumps(payload), timeout=5)
        response.raise_for_status()
        logging.info(f"æˆåŠŸå°†'{group_name}'åˆ‡æ¢è‡³'{proxy_name}'")
        return True
    except requests.exceptions.ConnectionError:
        logging.error(f"é”™è¯¯ï¼šæ— æ³•è¿æ¥è‡³Clash APIæ¥å£ {CLASH_API_BASE_URL} ä»¥åˆ‡æ¢ä»£ç†")
        logging.error("è¯·ç¡®ä¿Clashæ­£åœ¨è¿è¡Œä¸”external-controlleré…ç½®æ­£ç¡®")
        return False
    except requests.exceptions.Timeout:
        logging.error(f"é”™è¯¯ï¼šåˆ‡æ¢'{group_name}'ä»£ç†æ—¶è¿æ¥Clash APIè¶…æ—¶")
        return False
    except requests.exceptions.RequestException as e:
        logging.error(f"åˆ‡æ¢'{group_name}'ä»£ç†æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: {e}")
        return False

def main():
    """ä¸»å‡½æ•°ï¼šç®¡ç†Clashé…ç½®ã€é‡å¯åŠé€‰æ‹©æœ€ä½³ä»£ç†"""
    setup_logging()
    
    parser = argparse.ArgumentParser(description="Clashé…ç½®ç®¡ç†è„šæœ¬")
    parser.add_argument("--minutes", type=int, default=10, help="æ›´æ–°é—´éš”åˆ†é’Ÿæ•°ï¼ˆé»˜è®¤ï¼š10ï¼‰")
    parser.add_argument("--iterations", type=int, default=1000, help="å¾ªç¯æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š1000ï¼‰")
    parser.add_argument(
        "--config-url", 
        type=str, 
        default=os.getenv("CLASH_DOWNLOAD_URL"),
        help="Clashé…ç½®ä¸‹è½½URLã€‚é»˜è®¤ä½¿ç”¨CLASH_DOWNLOAD_URLç¯å¢ƒå˜é‡ï¼Œè‹¥æ— åˆ™éœ€æ‰‹åŠ¨æŒ‡å®š"
    )
    args = parser.parse_args()

    ITERATIONS = args.iterations
    SLEEP_SECONDS = args.minutes * 60
    config_download_url = args.config_url

    if not config_download_url:
        logging.critical("é”™è¯¯ï¼šæœªæä¾›é…ç½®ä¸‹è½½URLã€‚è¯·è®¾ç½®CLASH_DOWNLOAD_URLç¯å¢ƒå˜é‡æˆ–ä½¿ç”¨--config-urlå‚æ•°")
        return # æ— å¯ç”¨URLæ—¶é€€å‡º

    clash_executable_path = "/home/lzw/clash-linux-386-v1.17.0/clash-linux-386"
    clash_config_dir = os.path.expanduser("~/.config/clash")
    clash_config_path = os.path.join(clash_config_dir, "config.yaml")

    for i in range(1, ITERATIONS + 1):
        logging.info(f"--- å¼€å§‹ç¬¬ {i} æ¬¡å¾ªç¯ï¼ˆå…± {ITERATIONS} æ¬¡ï¼‰ ---")

        # æ­¥éª¤1ï¼šåœæ­¢ç°æœ‰ç³»ç»Ÿä»£ç†è®¾ç½®
        stop_system_proxy()
        
        # æ­¥éª¤2ï¼šä¸‹è½½å¹¶æ›´æ–°Clashé…ç½®
        try:
            logging.info(f"ä»ä»¥ä¸‹åœ°å€ä¸‹è½½æ–°é…ç½®: {config_download_url}")
            subprocess.run(["wget", config_download_url, "-O", "zhs4.yaml"], check=True, capture_output=True)
            os.makedirs(clash_config_dir, exist_ok=True)
            shutil.move("zhs4.yaml", clash_config_path)
            logging.info("Clashé…ç½®æ›´æ–°æˆåŠŸï¼")
        except subprocess.CalledProcessError as e:
            logging.error(f"ä¸‹è½½æˆ–ç§»åŠ¨é…ç½®æ–‡ä»¶å¤±è´¥: {e.stderr.decode().strip()}")
            logging.error("è·³è¿‡æœ¬æ¬¡å¾ªç¯")
            time.sleep(10) # é‡è¯•å‰çŸ­æš‚ç­‰å¾…
            continue
        except Exception as e:
            logging.error(f"é…ç½®æ›´æ–°æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: {e}")
            logging.error("è·³è¿‡æœ¬æ¬¡å¾ªç¯")
            time.sleep(10)
            continue

        # æ­¥éª¤3ï¼šåå°å¯åŠ¨Clash
        clash_process = None
        try:
            # ç¡®ä¿Clashå¯åŠ¨æ—¶å¯ç”¨äº†external-controller
            # è¿™é€šå¸¸å·²åœ¨config.yamlä¸­é…ç½®
            clash_process = subprocess.Popen([clash_executable_path], 
                                             stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            logging.info(f"Clashå·²å¯åŠ¨ï¼ŒPIDä¸º {clash_process.pid}")
            # ç­‰å¾…Clashå®Œå…¨åˆå§‹åŒ–å¹¶å¼€æ”¾APIç«¯å£
            time.sleep(5) 
        except FileNotFoundError:
            logging.critical(f"æœªæ‰¾åˆ°Clashå¯æ‰§è¡Œæ–‡ä»¶: {clash_executable_path}")
            logging.critical("è¯·ç¡®è®¤è·¯å¾„æ­£ç¡®ä¸”Clashå·²å®‰è£…")
            return # å…³é”®é”™è¯¯ï¼Œé€€å‡ºè„šæœ¬
        except Exception as e:
            logging.error(f"å¯åŠ¨Clashå¤±è´¥: {e}")
            logging.error("è·³è¿‡æœ¬æ¬¡å¾ªç¯")
            if clash_process: clash_process.terminate()
            time.sleep(10)
            continue

        # æ­¥éª¤4ï¼šæµ‹è¯•ä»£ç†é€Ÿåº¦å¹¶é€‰æ‹©æœ€ä½³èŠ‚ç‚¹
        best_proxy_name = None
        try:
            logging.info("æ­£åœ¨æµ‹è¯•ä»£ç†é€Ÿåº¦ä»¥å¯»æ‰¾æœ€ä½³èŠ‚ç‚¹...")
            top_proxies = get_top_proxies(num_results=1) # ä»…è·å–æœ€ä½³å•ä¸ªä»£ç†
            if top_proxies:
                best_proxy_name = top_proxies[0]['name']
                logging.info(f"å·²è¯†åˆ«æœ€ä½³ä»£ç†: '{best_proxy_name}'ï¼Œå»¶è¿Ÿ {top_proxies[0]['latency']}ms")
            else:
                logging.warning("æ— æˆåŠŸä»£ç†æµ‹è¯•ç»“æœã€‚æœ¬æ¬¡å¾ªç¯æ— æ³•é€‰æ‹©æœ€ä½³ä»£ç†")
        except Exception as e:
            logging.error(f"ä»£ç†é€Ÿåº¦æµ‹è¯•æ—¶å‡ºé”™: {e}")

        # æ­¥éª¤5ï¼šå°†Clashä»£ç†ç»„åˆ‡æ¢è‡³æœ€ä½³ä»£ç†ï¼ˆå¦‚æ‰¾åˆ°ï¼‰
        if best_proxy_name:
            # è®¾ç½®ç³»ç»Ÿä»£ç†å‰ç¡®ä¿Clashé…ç½®æ­£ç¡®
            # å°†ç³»ç»Ÿä»£ç†æŒ‡å‘Clashæœ¬åœ°HTTPä»£ç†ç«¯å£
            # Clashé€šå¸¸è¿è¡Œåœ¨7890ç«¯å£ï¼ˆè¯·æ ¹æ®å®é™…é…ç½®è°ƒæ•´ï¼‰
            clash_local_proxy_address = f"{CLASH_CONTROLLER_HOST}:7890" 
            start_system_proxy(clash_local_proxy_address)
            
            if not switch_clash_proxy_group(TARGET_PROXY_GROUP, best_proxy_name):
                logging.error(f"æ— æ³•å°†Clashç»„'{TARGET_PROXY_GROUP}'åˆ‡æ¢è‡³'{best_proxy_name}'")
        else:
            logging.warning("æœªæ‰¾åˆ°æœ€ä½³ä»£ç†ï¼Œæœ¬æ¬¡å¾ªç¯è·³è¿‡ä»£ç†ç»„åˆ‡æ¢å’Œç³»ç»Ÿä»£ç†è®¾ç½®")
            
        # æ­¥éª¤6ï¼šç­‰å¾…æŒ‡å®šæ—¶é•¿
        logging.info(f"ç­‰å¾… {SLEEP_SECONDS / 60} åˆ†é’Ÿåè¿›å…¥ä¸‹ä¸€å¾ªç¯...")
        time.sleep(SLEEP_SECONDS)

        # æ­¥éª¤7ï¼šåœæ­¢Clashè¿›ç¨‹
        if clash_process:
            logging.info("æ­£åœ¨ç»ˆæ­¢Clashè¿›ç¨‹...")
            clash_process.terminate()
            try:
                clash_process.wait(timeout=10) # ç»™äºˆClashä¼˜é›…é€€å‡ºçš„æ—¶é—´
                logging.info("Clashå·²æˆåŠŸåœæ­¢")
            except subprocess.TimeoutExpired:
                logging.warning("Clashæœªæ­£å¸¸ç»ˆæ­¢ï¼Œå¼ºåˆ¶ç»“æŸè¿›ç¨‹")
                clash_process.kill()
                clash_process.wait() # ç¡®ä¿è¿›ç¨‹å®Œå…¨ç»ˆæ­¢
            except Exception as e:
                logging.error(f"ç­‰å¾…Clashåœæ­¢æ—¶å‡ºé”™: {e}")
        
        logging.info(f"--- ç¬¬ {i} æ¬¡å¾ªç¯å®Œæˆ ---")

    logging.info(f"å·²å®Œæˆ {ITERATIONS} æ¬¡å¾ªç¯ã€‚è„šæœ¬æ‰§è¡Œç»“æŸ")

if __name__ == "__main__":
    main()
```

## speed.py

```python
import requests
import json
import urllib.parse
import time
from concurrent.futures import ThreadPoolExecutor, as_completed
import logging # å¯¼å…¥æ—¥å¿—æ¨¡å—

# --- é…ç½®é¡¹ ---
CLASH_CONTROLLER_HOST = "127.0.0.1"  # æ§åˆ¶å™¨ä½äºæœ¬æœº
CLASH_CONTROLLER_PORT = 9090
CLASH_API_BASE_URL = f"http://{CLASH_CONTROLLER_HOST}:{CLASH_CONTROLLER_PORT}"
LATENCY_TEST_URL = "https://github.com" # æ›´æ–°æµ‹è¯•URL
LATENCY_TEST_TIMEOUT_MS = 5000  # æ¯«ç§’
CONCURRENT_CONNECTIONS = 10 # å¹¶å‘æµ‹è¯•æ•°

# éœ€è¦æ’é™¤çš„ä»£ç†ç»„åç§°åˆ—è¡¨
# è¿™äº›é€šå¸¸æ˜¯ç­–ç•¥ç»„æˆ–ç‰¹æ®Šä»£ç†è€Œéç‹¬ç«‹èŠ‚ç‚¹
EXCLUDE_PROXY_GROUPS = [
    "DIRECT",
    "REJECT",
    "GLOBAL", # é»˜è®¤å·²åœ¨APIä¸­æ’é™¤
    "ğŸ‡¨ğŸ‡³å›½å†…ç½‘ç«™æˆ–èµ„æº",
    "ğŸŒµå…¶å®ƒè§„åˆ™å¤–",
    "ğŸ¬Netflixç­‰å›½å¤–æµåª’ä½“",
    "ğŸ“¦ChatGPT",
    "ğŸ“¹Youtube",
    "ğŸ“ºçˆ±å¥‡è‰ºç­‰å›½å†…æµåª’ä½“",
    "ğŸš§ä»£ç†",
    # å¯åœ¨æ­¤æ·»åŠ å…¶ä»–éœ€è¦æ’é™¤çš„ç»„å
]

# --- speed.pyæ—¥å¿—é…ç½® ---
# ä¸ºè¯¥è„šæœ¬å•ç‹¬é…ç½®æ—¥å¿—
# ç¡®ä¿å½“speed.pyè¢«å¯¼å…¥æ—¶ï¼Œå…¶è¾“å‡ºå†™å…¥speed.logè€Œéclash_manager.log
logging.basicConfig(
    filename='clash.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

def get_all_proxy_names():
    """ä»Clash APIè·å–æ‰€æœ‰ä»£ç†åç§°ï¼Œæ’é™¤å·²çŸ¥ç»„"""
    try:
        response = requests.get(f"{CLASH_API_BASE_URL}/proxies", timeout=5)
        response.raise_for_status()  # å¯¹HTTPé”™è¯¯ï¼ˆ4xxæˆ–5xxï¼‰æŠ›å‡ºå¼‚å¸¸
        proxies_data = response.json()
        
        all_names = proxies_data.get("proxies", {}).keys()
        
        # è¿‡æ»¤ç»„å
        filtered_names = [name for name in all_names if name not in EXCLUDE_PROXY_GROUPS]
        
        logging.info(f"æˆåŠŸè·å– {len(filtered_names)} ä¸ªå¯æµ‹è¯•ä»£ç†åç§°")
        return filtered_names
    except requests.exceptions.ConnectionError:
        logging.error(f"æ— æ³•è¿æ¥è‡³Clash APIæ¥å£ {CLASH_API_BASE_URL}ã€‚è¯·ç¡®ä¿Clashæ­£åœ¨è¿è¡Œ")
        return []
    except requests.exceptions.Timeout:
        logging.error(f"è¿æ¥Clash APIè¶…æ—¶ï¼ˆ5ç§’ï¼‰")
        return []
    except requests.exceptions.RequestException as e:
        logging.error(f"è·å–ä»£ç†åç§°æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: {e}")
        return []

def test_proxy_latency(proxy_name):
    """é€šè¿‡Clash APIæµ‹è¯•å•ä¸ªä»£ç†å»¶è¿Ÿ
    è¿”å›å…ƒç»„ (proxy_name, latency) æˆ–å¤±è´¥æ—¶è¿”å› (proxy_name, None)
    """
    encoded_proxy_name = urllib.parse.quote(proxy_name)
    url = f"{CLASH_API_BASE_URL}/proxies/{encoded_proxy_name}/delay"
    params = {
        "url": LATENCY_TEST_URL,
        "timeout": LATENCY_TEST_TIMEOUT_MS
    }
    try:
        # requestsè¶…æ—¶å•ä½ä¸ºç§’ï¼Œéœ€è½¬æ¢æ¯«ç§’
        response = requests.get(url, params=params, timeout=(LATENCY_TEST_TIMEOUT_MS / 1000) + 1)
        response.raise_for_status()
        latency_data = response.json()
        latency = latency_data.get("delay")
        logging.info(f"ä»£ç†: {proxy_name} - å»¶è¿Ÿ: {latency}ms")
        return proxy_name, latency
    except requests.exceptions.RequestException as e:
        logging.warning(f"æµ‹è¯•'{proxy_name}'æ—¶å‡ºé”™: {e}")
        return proxy_name, None

def get_top_proxies(num_results=5):
    """
    å¹¶å‘æµ‹è¯•Clashä»£ç†é€Ÿåº¦å¹¶è¿”å›å‰Nä¸ªæœ€å¿«ç‹¬ç«‹ä»£ç†

    è¿”å›:
        list: åŒ…å«'name'å’Œ'latency'çš„å­—å…¸åˆ—è¡¨
              è‹¥æ— å¯ç”¨ä»£ç†æˆ–å‡ºé”™åˆ™è¿”å›ç©ºåˆ—è¡¨
    """
    logging.info("å¼€å§‹é€šè¿‡External Controller APIå¹¶å‘æµ‹è¯•Clashä»£ç†é€Ÿåº¦...")
    logging.info(f"æµ‹è¯•URL: {LATENCY_TEST_URL}")
    logging.info(f"å¹¶å‘æµ‹è¯•æ•°: {CONCURRENT_CONNECTIONS}ã€‚è¯·ç¨å€™...")

    proxy_names_to_test = get_all_proxy_names()
    if not proxy_names_to_test:
        logging.warning("æœªæ‰¾åˆ°å¯æµ‹è¯•ä»£ç†æˆ–è·å–ä»£ç†åç§°æ—¶å‡ºé”™")
        return []

    logging.info(f"å‘ç° {len(proxy_names_to_test)} ä¸ªç‹¬ç«‹ä»£ç†å¾…æµ‹è¯•")

    proxy_latencies = {}
    
    with ThreadPoolExecutor(max_workers=CONCURRENT_CONNECTIONS) as executor:
        future_to_proxy = {executor.submit(test_proxy_latency, name): name for name in proxy_names_to_test}

        for future in as_completed(future_to_proxy):
            proxy_name = future_to_proxy[future]
            try:
                name, latency = future.result()
                if latency is not None:
                    proxy_latencies[name] = latency
                else:
                    logging.info(f"ä»£ç†: {name} - æµ‹è¯•å¤±è´¥æˆ–è¶…æ—¶ï¼ˆè¯¦è§è­¦å‘Šæ—¥å¿—ï¼‰")
            except Exception as exc:
                logging.error(f"ä»£ç† {proxy_name} æµ‹è¯•æ—¶å‘ç”Ÿæ„å¤–å¼‚å¸¸: {exc}")

    sorted_proxies = sorted([item for item in proxy_latencies.items() if item[1] is not None], 
                            key=lambda item: item[1])

    top_proxies_list = []
    if not sorted_proxies:
        logging.warning("æœªå®Œæˆä»»ä½•æˆåŠŸçš„ç‹¬ç«‹ä»£ç†æµ‹è¯•")
    else:
        logging.info(f"--- å‰ {num_results} ä¸ªæœ€å¿«ç‹¬ç«‹ä»£ç† ---")
        for i, (name, latency) in enumerate(sorted_proxies[:num_results]):
            top_proxies_list.append({"name": name, "latency": latency})
            logging.info(f"  {i+1}. {name}: {latency}ms")
        logging.info(f"é€Ÿåº¦æµ‹è¯•å®Œæˆã€‚å·²è¯†åˆ«å‰ {num_results} ä¸ªæœ€å¿«ä»£ç†")
            
    return top_proxies_list

if __name__ == "__main__":
    # ç›´æ¥è¿è¡Œspeed.pyæ—¶ä»ä¼šè¾“å‡ºè‡³speed.log
    top_5_proxies = get_top_proxies(num_results=5)
    print("\nå‡½æ•°è¿”å›çš„å‰5ä¸ªä»£ç†:", top_5_proxies)
```