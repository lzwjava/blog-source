---
audio: false
generated: true
image: false
lang: zh
layout: post
model: x-ai/grok-code-fast-1
title: ä½¿ç”¨Dockeréƒ¨ç½²Javaåº”ç”¨
translated: true
type: note
---

å®Œå…¨æ­£ç¡®ï¼Œæ‚¨çš„æ€è·¯éžå¸¸æ¸…æ™°ï¼ä»Žç›´æŽ¥éƒ¨ç½² JAR åŒ…ï¼ˆå¦‚æ‚¨å½“å‰åŸºäºŽ Fabric çš„éƒ¨ç½²æ–¹å¼ï¼‰è¿ç§»åˆ° Docker åŒ–æ–¹æ¡ˆï¼Œç¡®å®žæ˜¯è®©æœªæ¥æœåŠ¡å™¨è¿ç§»æ›´é¡ºç•…ã€æ›´å¯é çš„ç»ä½³ç­–ç•¥ã€‚è®©æˆ‘ç®€è¦åˆ†æžå¹¶ç¡®è®¤è¿™ä¸ªæ–¹æ¡ˆçš„åˆç†æ€§ï¼ŒåŒæ—¶æä¾›ä¸€äº›å…¥é—¨æŒ‡å¯¼ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© Docker éƒ¨ç½²è¿™ä¸ª Java é¡¹ç›®ï¼Ÿ
- **å½“å‰éƒ¨ç½²æ–¹å¼**ï¼šæ‚¨ç›®å‰é€šè¿‡ rsync/Fabric å°† JAR æ–‡ä»¶ï¼ˆ`blog-server-1.0.jar`ï¼‰å’Œé…ç½®æ–‡ä»¶ï¼ˆå¦‚ `application.properties` æˆ– `.env`ï¼‰ç›´æŽ¥éƒ¨ç½²åˆ° EC2 æœåŠ¡å™¨ã€‚è¿è¡Œæ—¶ï¼Œæ‚¨å¯èƒ½åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œç±»ä¼¼ `java -jar blog-server-1.0.jar` çš„å‘½ä»¤ï¼Œè¿™è¦æ±‚æœåŠ¡å™¨å·²å®‰è£…å¹¶é…ç½®å¥½ Java çŽ¯å¢ƒã€‚å•æœåŠ¡å™¨éƒ¨ç½²å°šå¯ï¼Œä½†è¿ç§»æ—¶å®¹æ˜“å› çŽ¯å¢ƒå·®å¼‚ï¼ˆå¦‚ Java ç‰ˆæœ¬ã€ä¾èµ–é¡¹æˆ–çŽ¯å¢ƒå˜é‡ä¸åŒï¼‰å¯¼è‡´é—®é¢˜ã€‚
  
- **Docker çš„ä¼˜åŠ¿**ï¼š
  - **çŽ¯å¢ƒå°è£…**ï¼šDocker å®¹å™¨å°†åº”ç”¨æ‰€éœ€çš„ä¸€åˆ‡ï¼ˆJava è¿è¡Œæ—¶ã€JAR æ–‡ä»¶ã€é…ç½®æ–‡ä»¶ï¼‰æ‰“åŒ…æˆå¯ç§»æ¤çš„é•œåƒã€‚æ— éœ€åœ¨æœåŠ¡å™¨ä¸Šå®‰è£… Java æˆ–å…¶ä»–ä¾èµ–â€”â€”åªéœ€å®‰è£… Dockerï¼ˆè½»é‡ä¸”å¿«é€Ÿå®‰è£…ï¼‰å³å¯è¿è¡Œå®¹å™¨ã€‚
  - **è¿ç§»ç®€ä¾¿æ€§**ï¼šè¿ç§»åˆ°æ–°æœåŠ¡å™¨æ—¶ï¼Œåªéœ€ç¡®ä¿ Docker å·²å®‰è£…ã€‚æ‹‰å–é•œåƒåŽï¼Œä¸€æ¡å‘½ä»¤å³å¯è¿è¡Œï¼Œæ— éœ€é‡æ–°è®¾ç½®ç›®å½•ã€æƒé™æˆ–çŽ¯å¢ƒå˜é‡ã€‚
  - **çŽ¯å¢ƒä¸€è‡´æ€§**ï¼šç¡®ä¿åº”ç”¨åœ¨ä»»ä½•çŽ¯å¢ƒè¿è¡Œä¸€è‡´ï¼Œå‡å°‘â€œåœ¨æˆ‘è¿™é‡Œæ­£å¸¸â€çš„é—®é¢˜ã€‚
  - **å¯æ‰©å±•æ€§**ï¼šDocker åŒ–åŽï¼Œæœªæ¥è‹¥éœ€æ±‚å¢žé•¿ï¼Œå¯ä»¥è½»æ¾è¿ç§»åˆ° Kubernetes ç­‰ç¼–æŽ’å·¥å…·ã€‚
  - è¿™ç§æ–¹æ¡ˆéžå¸¸é€‚åˆå½“å‰â€œå•æœåŠ¡å™¨å•åº”ç”¨â€çš„åœºæ™¯ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ— ç¼é€‚åº”å¤šæœåŠ¡å™¨/å¤šçŽ¯å¢ƒéƒ¨ç½²ã€‚

ç®€è€Œè¨€ä¹‹ï¼šå°†åº”ç”¨æ‰“åŒ…æˆ Docker é•œåƒå¹¶åœ¨æœåŠ¡å™¨ä¸Šä»¥å®¹å™¨å½¢å¼è¿è¡Œï¼Œæ˜¯â€œé¢å‘æœªæ¥â€éƒ¨ç½²çš„æ­£ç¡®é€‰æ‹©ï¼Œæ—¢èƒ½ä¿æŒçŸ­æœŸéƒ¨ç½²çš„ç®€æ´æ€§ï¼Œåˆä¸ºé•¿æœŸå‘å±•é¢„ç•™ç©ºé—´ã€‚

### Docker åŒ–å¹¶è¿è¡Œ Java åº”ç”¨çš„ç®€æ˜Žæ­¥éª¤
å‡è®¾è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Java Spring Boot åº”ç”¨ï¼ˆåŸºäºŽé…ç½®æ–‡ä»¶åˆ¤æ–­ï¼‰ï¼Œä»¥ä¸‹æ˜¯ Docker åŒ–è¿è¡Œçš„é«˜é˜¶æ­¥éª¤ã€‚è¯·æ ¹æ®å®žé™…éœ€æ±‚è°ƒæ•´ï¼š

1. **æ›´æ–°æž„å»ºæµç¨‹**ï¼š
   - ä¿®æ”¹æ‚¨çš„ `prepare_local_jar()` å‡½æ•°æˆ–ç±»ä¼¼æ­¥éª¤ï¼Œæ”¹ä¸ºæœ¬åœ°æž„å»º Docker é•œåƒï¼Œè€Œéžä»…å¤åˆ¶ JAR æ–‡ä»¶ã€‚
   - ç¤ºä¾‹ä»£ç ï¼š
     ```python
     @task
     def build_and_deploy(c):
         _prepare_local_jar()
         prepare_remote_dirs(c)
         # æœ¬åœ°æž„å»º Docker é•œåƒï¼ˆå‡è®¾éƒ¨ç½²æœºå™¨å·²å®‰è£… Dockerï¼‰
         local(f"docker build -t blog-server:latest {tmp_dir}")
         # å°†é•œåƒä¿å­˜å¹¶ä¼ è¾“åˆ°è¿œç¨‹æœåŠ¡å™¨
         local(f"docker save blog-server:latest | gzip > /tmp/blog-server.tar.gz")
         c.put("/tmp/blog-server.tar.gz", "/tmp/")
         c.run("gzip -d /tmp/blog-server.tar.gz && docker load < /tmp/blog-server.tar")
         # æ¸…ç†æœ¬åœ°ä¸´æ—¶æ–‡ä»¶
         local("rm /tmp/blog-server.tar.gz")
         # è¿è¡Œå®¹å™¨
         c.run(f"docker run -d --name blog-server -p 8080:8080 blog-server:latest")  # æŒ‰éœ€è°ƒæ•´ç«¯å£
         chown(c)  # è‹¥ä»éœ€è°ƒæ•´æ–‡ä»¶æƒé™
         _clean_local_dir()
     ```

2. **åˆ›å»º Dockerfile**ï¼š
   - åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆæˆ– tmp_dir ä¸­ï¼‰åˆ›å»º `Dockerfile`ï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆä»¥ OpenJDK åŸºç¡€é•œåƒä¸ºä¾‹ï¼‰ï¼š
     ```
     # ä½¿ç”¨ JDK åŸºç¡€é•œåƒ
     FROM openjdk:17-jdk-slim

     # åˆ›å»ºåº”ç”¨ç›®å½•
     WORKDIR /app

     # å¤åˆ¶ JAR æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
     COPY blog-server-1.0.jar app.jar
     COPY application.properties application.properties  # æˆ–å…¶ä»–é…ç½®æ–‡ä»¶

     # æš´éœ²ç«¯å£ï¼ˆä¾‹å¦‚ Spring Boot é»˜è®¤çš„ 8080ï¼‰
     EXPOSE 8080

     # å¯åŠ¨ JAR
     ENTRYPOINT ["java", "-jar", "app.jar"]
     ```
   - æœ¬åœ°æž„å»ºï¼šåœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œ `docker build -t blog-server:latest .`
   - æœ¬åœ°æµ‹è¯•ï¼šè¿è¡Œ `docker run -p 8080:8080 blog-server:latest`ï¼Œç„¶åŽè®¿é—® http://localhost:8080 éªŒè¯ã€‚

3. **éƒ¨ç½²åˆ°æœåŠ¡å™¨**ï¼š
   - ç¡®ä¿ EC2 æœåŠ¡å™¨å·²å®‰è£… Dockerï¼ˆAmazon Linux æ‰§è¡Œ `sudo yum install docker`ï¼Œå¹¶å¯ç”¨/å¯åŠ¨æœåŠ¡ï¼‰ã€‚
   - æ›´æ–°åŽçš„ Fabric ä»»åŠ¡å°†è´Ÿè´£æŽ¨é€é•œåƒå¹¶è¿è¡Œå®¹å™¨ã€‚
   - ä¸ºå®‰å…¨èµ·è§ï¼Œå¯é€šè¿‡ `docker run` å‘½ä»¤æŒ‚è½½é…ç½®æ–‡ä»¶å·ï¼ˆå¦‚ .envï¼‰æˆ–ä¼ é€’çŽ¯å¢ƒå˜é‡ã€‚

4. **è¿ç§»å‡†å¤‡**ï¼š
   - Docker åŒ–åŽï¼Œå°†é•œåƒæ ‡ç­¾/ç‰ˆæœ¬ä¿¡æ¯è®°å½•åœ¨é•œåƒä»“åº“ï¼ˆå¦‚ Docker Hub æˆ– ECRï¼‰ã€‚
   - è¿ç§»æ—¶ï¼šåœ¨æ–°æœåŠ¡å™¨å®‰è£… Dockerï¼Œæ‹‰å–é•œåƒå¹¶è¿è¡Œå³å¯ã€‚æžå…¶ç®€æ´ï¼

### æ³¨æ„äº‹é¡¹ä¸Žå®žç”¨æŠ€å·§
- **çŽ¯å¢ƒå˜é‡**ï¼šè‹¥åº”ç”¨éœ€è¦æ•°æ®åº“å‡­è¯ç­‰é…ç½®ï¼Œé€šè¿‡ `docker run -e KEY=value` ä¼ é€’æˆ–æŒ‚è½½ .env æ–‡ä»¶ã€‚
- **æŒä¹…åŒ–æ•°æ®**ï¼šè‹¥åº”ç”¨éœ€è¦æŒä¹…åŒ–æ–‡ä»¶ï¼ˆå¦‚ tmp_dirï¼‰ï¼Œä½¿ç”¨ Docker å·ï¼ˆ`-v` å‚æ•°ï¼‰ã€‚
- **èµ„æºé™åˆ¶**ï¼šè‹¥æœåŠ¡å™¨èµ„æºå—é™ï¼Œå¯åœ¨ `docker run` ä¸­æ·»åŠ  `--cpus` æˆ– `--memory` å‚æ•°ã€‚
- **æ›´æ–°ç­–ç•¥**ï¼šä»£ç å˜æ›´æ—¶é‡æ–°æž„å»ºé•œåƒå¹¶éƒ¨ç½²ã€‚
- **æµ‹è¯•éªŒè¯**ï¼šå°½å¯èƒ½åœ¨æœ¬åœ° Docker çŽ¯å¢ƒä¸­æµ‹è¯•å®Œæ•´éƒ¨ç½²è„šæœ¬ã€‚
- è‹¥é‡åˆ° Java ç‰¹å®šé—®é¢˜ï¼ˆå¦‚å †å†…å­˜å¤§å°ï¼‰ï¼Œè°ƒæ•´ Dockerfile ä¸­çš„ ENTRYPOINT å‚æ•°ã€‚

è¿™ä¸ªæ–¹æ¡ˆèƒ½è®©éƒ¨ç½²æ›´è½»æ¾ä¸”ä¸ä¼šè¿‡åº¦å¤æ‚åŒ–ã€‚å¦‚æžœæ‚¨èƒ½åˆ†äº«æ›´å¤šåº”ç”¨ç»†èŠ‚ï¼ˆå¦‚ Spring Boot ç‰ˆæœ¬ã€æš´éœ²ç«¯å£ï¼‰ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ– Dockerfile æˆ– Fabric è„šæœ¬ã€‚å‡†å¤‡å¥½å¼€å§‹äº†ä¹ˆï¼ŸðŸš€