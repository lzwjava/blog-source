---
audio: false
generated: true
lang: zh
layout: post
title: 浅克隆环境下使用Git拉取与推送操作
translated: true
type: note
---

是的，在使用 `--depth=20` 克隆具有有限历史的仓库后，你仍然可以使用 `git pull` 或 `git push`。但需要注意以下几点重要事项：

### 1. **`--depth=20` 的作用**
   - `--depth=20` 选项会创建一个*浅克隆*，仅获取默认分支（或使用 `--branch` 指定的分支）最近的 20 次提交（或指定数量的提交）。
   - 这会减少下载的历史记录量，使克隆速度更快、体积更小，但仓库不会包含完整的提交历史。

### 2. **在浅克隆中使用 `git pull`**
   - **是的，你可以使用 `git pull`** 在浅克隆中获取并合并远程仓库的新提交。
   - 默认情况下，`git pull` 会获取新提交并更新浅历史记录，使其与远程分支保持一致。
   - 如果远程分支添加了新提交，`git pull` 会获取这些提交并扩展本地仓库的历史记录，同时仍保持克隆的浅特性。

   **注意**：如果分支的历史记录以影响比你浅历史更早提交的方式发生变化（例如，远程仓库进行了强制推送或变基），你可能会遇到问题。在这种情况下，你可能需要加深历史记录（使用 `git fetch --deepen=<n>` 或 `git fetch --unshallow` 来获取完整历史）以解决冲突或继续工作。

### 3. **在浅克隆中使用 `git push`**
   - **是的，你可以使用 `git push`** 将本地提交推送到远程仓库。
   - 只要远程仓库接受你的更改，浅克隆不会限制你创建新提交并将其推送到远程仓库的能力。
   - 但是，如果远程仓库需要依赖完整历史记录的操作（例如，涉及较早提交的合并或变基），你可能需要获取更多历史记录才能成功完成推送。

### 4. **浅克隆的限制**
   - **有限的历史记录**：某些 Git 操作（如 `git log`、`git blame` 或 `git rebase`）可能会受到限制，因为较早的提交在本地不可用。
   - **合并和变基**：如果需要与浅历史记录之外的提交进行合并或变基，你可能需要使用 `git fetch --deepen=<n>` 或 `git fetch --unshallow` 获取更多历史记录。
   - **强制推送**：如果远程分支被重写（例如使用 `git push --force`），你的浅克隆可能没有足够的上下文来处理更改，需要你加深历史记录或重新克隆。

### 5. **如何加深浅克隆（如果需要）**
   如果由于历史记录有限而遇到 `git pull` 或 `git push` 的问题，可以获取额外的历史记录：
   - **按指定提交数量加深**：
     ```bash
     git fetch --deepen=20
     ```
     这会再获取 20 次提交的历史记录。
   - **获取完整历史记录**：
     ```bash
     git fetch --unshallow
     ```
     这会将你的浅克隆转换为具有完整历史记录的完整克隆。

### 6. **实用建议**
   - 对于大多数工作流程，使用 `--depth=20` 的浅克隆通常足够，特别是如果你只处理近期更改或贡献小更新。
   - 如果你预计需要完整历史记录（例如，用于复杂合并、变基或调试），请考虑不使用 `--depth` 选项克隆完整仓库，或根据需要稍后加深历史记录。
   - 在尝试推送之前，请确保你对远程仓库（例如 `git@github.com:cisco/ChezScheme.git`）具有写入权限。

### 示例工作流程
```bash
# 使用有限历史记录克隆
git clone git@github.com:cisco/ChezScheme.git --depth=20
cd ChezScheme

# 进行更改并提交
git commit -m "我的更改"

# 拉取最新更改
git pull origin main

# 推送你的更改
git push origin main
```

如果由于浅克隆遇到问题，请按上述方法加深历史记录。

### 总结
是的，你可以在使用 `--depth=20` 创建的浅克隆中使用 `git pull` 和 `git push`。但是，对于某些操作，如果浅历史记录不足，你可能需要获取额外的历史记录。使用 `git fetch --deepen` 或 `git fetch --unshallow` 来解决任何限制。